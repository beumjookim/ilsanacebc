<!DOCTYPE html>
<html lang="ko">
<head>
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>Ace Bowling V18.0 (Final)</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<link rel="manifest" href="./manifest.json?v=5">
<link rel="apple-touch-icon" href="ace.png?v=5">
<meta name="theme-color" content="#3498db">

<meta property="og:type" content="website">
<meta property="og:title" content="ì¼ì‚° ì—ì´ìŠ¤ ë³¼ë§ í´ëŸ½">
<meta property="og:description" content="âš–ï¸ ì •ê¸°ëª¨ì„ & âš¡ ë²ˆê°œëª¨ì„ ì‹ ì²­í•˜ê¸°">
<meta property="og:image" content="https://beumjookim.github.io/ilsanacebc/ace.png?v=5">
<meta property="og:url" content="https://beumjookim.github.io/ilsanacebc/">

    <style>
    :root { 
        --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; 
        --warning: #f39c12; --bg: #f8f9fa; --green: #27ae60; 
        --dark: #34495e; --purple: #8e44ad; 
    }

    /* 1. ì „ì²´ í‹€ ì„¤ì • (ìŠ¤í¬ë¡¤ ê°€ëŠ¥ + í—¤ë” ì—¬ë°±) */
    html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    
    /* 1. ë°”ê¹¥ìª½ ìŠ¤í¬ë¡¤ë°”ë¥¼ ì•„ì˜ˆ ì œê±°í•©ë‹ˆë‹¤ (í•µì‹¬) */
    overflow: auto; 
    
    /* 2. íŒ¨ë”©ì´ ì „ì²´ ë†’ì´(100%)ì— í¬í•¨ë˜ë„ë¡ ì„¤ì • (5Gì²˜ëŸ¼ ì‚ì ¸ë‚˜ì˜¤ëŠ” ê²ƒ ë°©ì§€) */
    box-sizing: border-box; 
    padding-top: 57px; 

    position: relative;
    width: 100%;
    background-color: var(--bg);
    font-family: 'Noto Sans KR', sans-serif;

    /* ëª¨ë°”ì¼ ìµœì í™” ìœ ì§€ */
    -webkit-text-size-adjust: 100%; 
    -moz-text-size-adjust: 100%;
    text-size-adjust: 100%;
    font-size: 14px;
}
        
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        /* 2. ì†ì•Œë§¹ì´ ìŠ¤í¬ë¡¤ (ì ìˆ˜íŒë§Œ ë¶€ë“œëŸ½ê²Œ ì˜¤ë¥´ë‚´ë¦¼) */
/* style íƒœê·¸ ì•ˆì˜ .container ë¶€ë¶„ì„ ì°¾ì•„ì„œ ì´ë ‡ê²Œ ë‹¨ìˆœí•˜ê²Œ ë°”ê¾¸ì„¸ìš” */
.container {
    display: flex;
    flex-direction: column;
    height: 100%; /* â˜… í™”ë©´ ë†’ì´ 100%ë¡œ ê³ ì • */
    overflow: hidden; /* â˜… ì—¬ê¸°ì„œë„ ìŠ¤í¬ë¡¤ ê¸ˆì§€ */
}
        .header {
    /* padding: 15px;  <-- ê¸°ì¡´ ê±° ì§€ìš°ê³  ì•„ë˜ë¡œ ë³€ê²½ */
    padding: 15px 25px; /* ì–‘ì˜† ì—¬ë°±ì„ 25pxë¡œ ëŠ˜ë¦¼ */
    background: #fff;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 2000;
}
        
        /* style íƒœê·¸ ì•ˆì˜ .tab-menu ë¶€ë¶„ì„ ì´ë ‡ê²Œ ê³ ì³ë³´ì„¸ìš” */
/* ğŸ“Œ íƒ­ ë©”ë‰´ë¥¼ í—¤ë” ë°”ë¡œ ë°‘ì— ê°•ì œë¡œ ê³ ì •ì‹œí‚¤ëŠ” ì½”ë“œ */
.tab-menu {
    display: flex;
    gap: 5px;
    padding: 10px 15px; /* ì–‘ì˜† ì—¬ë°± ì ë‹¹íˆ */
    background: #fff;
    border-bottom: 1px solid #ddd;
    
    /* âœ… í•µì‹¬ ìˆ˜ì •: sticky ëŒ€ì‹  fixedë¥¼ ì”ë‹ˆë‹¤! */
    position: fixed; 
    
    /* í—¤ë” ë†’ì´ê°€ ì•½ 55~60px ì •ë„ ë©ë‹ˆë‹¤. ê·¸ ë°”ë¡œ ì•„ë˜ì— ìœ„ì¹˜ì‹œí‚µë‹ˆë‹¤. */
    top: 40px; 
    
    left: 0;
    width: 100%; /* ê°€ë¡œ ê½‰ ì±„ìš°ê¸° */
    z-index: 1900; /* í—¤ë”ë³´ë‹¤ëŠ” ì•„ë˜, ë³¸ë¬¸ë³´ë‹¤ëŠ” ìœ„ì— */
    overflow-x: auto; /* ë©”ë‰´ê°€ ë§ìœ¼ë©´ ì˜†ìœ¼ë¡œ ìŠ¤í¬ë¡¤ */
    white-space: nowrap;
    box-sizing: border-box; /* íŒ¨ë”© í¬í•¨í•´ì„œ ë„ˆë¹„ ê³„ì‚° */
}

        .tab-btn { flex: 1; padding: 12px 0; border: 1px solid #eee; background: #f8f9fa; border-radius: 8px; font-weight: bold; cursor: pointer; min-width: 60px; text-align: center; color: #555; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* 3. ì…ë ¥ì°½ì´ ê°€ë ¤ì§€ì§€ ì•Šê²Œ í•˜ë‹¨ ì—¬ë°± í™•ë³´ */
.content-area {
    flex: 1; /* ë‚¨ì€ ê³µê°„ ê½‰ ì±„ìš°ê¸° */
    overflow-y: auto; /* â˜… ì˜¤ì§ ì—¬ê¸°ë§Œ ìŠ¤í¬ë¡¤ í—ˆìš©! */
    -webkit-overflow-scrolling: touch; /* ì•„ì´í°ì—ì„œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤ */
    padding-bottom: 100px; /* ë§¨ ì•„ë˜ ë‚´ìš©ì´ ê°€ë ¤ì§€ì§€ ì•Šê²Œ ì—¬ìœ  ê³µê°„ */
    /* [ì¶”ê°€] ë¶€ëª¨ë¡œë¶€í„° ë†’ì´ë¥¼ í™•ì‹¤íˆ ë¬¼ë ¤ë°›ë„ë¡ ì„¤ì • */
    display: flex;
    flex-direction: column;
}
        .panel {
    display: none;
    padding: 0 20px; /* â˜… ì–‘ì˜†ì— 20px ê³µë°± ì¶”ê°€! (ë°•ìŠ¤ê°€ í™”ë©´ ëì— ì•ˆ ë¶™ê²Œ í•¨) */
} .panel.active { display: block; }
        .input-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .universal-btn { width: 100%; padding: 15px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; color: white; font-size: 1rem; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-sm { padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; font-size: 0.8rem; font-weight: bold; background: white; color: #333; }
        
        /* íŒ€ì¹´ë“œ ë””ìì¸ */
        .team-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .team-header { background: var(--purple); color: white; padding: 12px 15px; font-weight: bold; display: flex; justify-content: space-between; cursor: pointer; font-size:1.1rem; }
        .team-body { padding: 0; background: white; }
        
        .lane-divider { display: flex; border-bottom: 1px solid #eee; }
        .lane-half { flex: 1; padding: 10px; }
        .lane-half:first-child { border-right: 1px dashed #ddd; }
        .lane-title { font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 5px; font-weight: bold; }

        .member-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f5f5f5; }
        
        /* ë­í¬ íƒ­ */
        .rank-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .rank-tab { flex: 1; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; text-align: center; font-weight: bold; min-width: 50px; }
        .rank-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* ì…ë ¥ì°½ ë””ìì¸ ê°œì„  */
        .input-team-box { border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px; overflow: hidden; }
        .input-team-header { background: #f1f3f5; padding: 10px; font-weight: bold; text-align: center; border-bottom: 1px solid #ddd; color: var(--primary); font-size: 1.1rem; }
        .score-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; background: white; }
        .score-name { font-size: 1.2rem; font-weight: bold; color: #333; }
        .score-input { width: 90px; padding: 12px; text-align: center; border: 2px solid #ccc; border-radius: 8px; font-size: 1.4rem; font-weight: bold; background: #fff; }
        .score-input:focus { border-color: var(--accent); background: #f0f8ff; outline: none; }

        /* í•„í„° ì•ˆë‚´ ë°•ìŠ¤ */
        #filterInfo { display:none; background:#f3e5f5; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; color:#8e44ad; border:1px solid #e1bee7; }

        /* ì¡°í¸ì„± ì„¤ì • */
        .lane-config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px; }
        .lane-input { width: 100%; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-weight: bold; font-size:1.1rem; box-sizing: border-box; margin-top: 5px; background: #fff; }
        
        .zone-btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-weight: bold; color: #555; }
        .zone-btn.selected { background: #34495e; color: white; border-color: #34495e; }

        table.stats-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 10px; }
        table.stats-table th { background: #f1f3f5; padding: 8px; border: 1px solid #ddd; }
        table.stats-table td { padding: 8px; border: 1px solid #ddd; text-align: center; }

        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        .big-input { width: 100%; padding: 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 10px; box-sizing: border-box; }
        .big-select { width: 100%; padding: 12px; font-size: 1rem; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 10px; background:white; font-weight:bold; }
        
        .filter-btn { padding: 6px 10px; border: 1px solid #ddd; background: white; border-radius: 15px; cursor: pointer; margin-right: 3px; font-size: 0.8rem; margin-bottom: 5px; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .settings-label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); margin: 20px 0 10px 0; border-left: 4px solid var(--accent); padding-left: 10px; }
        
        #landingPage, #globalLoginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; color: white; }
        .enter-btn {
    margin-top: 40px;
    padding: 15px 50px;
    font-size: 1.2rem;
    font-weight: bold;
    color: white;
    background: rgba(255,255,255,0.1);
    border: 2px solid white;
    border-radius: 50px;
    cursor: pointer;

    /* â˜… ì•„ë˜ 3ì¤„ì„ ê¼­ ì¶”ê°€í•˜ì„¸ìš”! (ë‚©ì‘í•´ì§ ë°©ì§€ & ì¤‘ì•™ ì •ë ¬) â˜… */
    max-height: none !important;  /* ë†’ì´ ì œí•œ í’€ê¸° */
    display: flex;                /* ìœ ì—°í•œ ë°•ìŠ¤ë¡œ ë³€ê²½ */
    align-items: center;          /* ì„¸ë¡œ ì •ì¤‘ì•™ ë§ì¶¤ */
}
        
        .login-card { background: white; padding: 30px; border-radius: 15px; width: 80%; max-width: 350px; text-align: center; color: #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        
        /* ì»¨íŠ¸ë¡¤ ë©”ë‰´ */
        /* ì¹´ì§€ë…¸ ë°°ì • ë²„íŠ¼ (íŠ¹ì • ìœ„ì¹˜ì˜ ë²„íŠ¼ë§Œ ì¡°ì ˆ) */
.control-top-container .universal-btn {
    font-size: 0.9rem !important; /* ê¸€ì”¨ í¬ê¸° ì¶•ì†Œ */
    padding: 10px !important;    /* êµ¬ì—­ ë²„íŠ¼ê³¼ ë¹„ìŠ·í•œ ëŠë‚Œìœ¼ë¡œ íŒ¨ë”© ì¡°ì ˆ */
}
        .box-manager { flex: 1; background: #e3f2fd; border: 2px solid #90caf9; color: #1565c0; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; display: flex; flex-direction: column; justify-content: center; }
        /* ì¼ë°˜ ë°°ì • ë²„íŠ¼ */
.btn-run-v13 { 
    flex: 1.2; 
    background: #2980b9; 
    color: white; 
    border: none; 
    border-radius: 8px; 
    font-size: 0.9rem !important; /* ê¸€ì”¨ í¬ê¸° ì¶•ì†Œ */
    font-weight: bold; 
    cursor: pointer; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
}

/* ì´ˆê¸°í™” ë²„íŠ¼ */
.btn-reset-v13 { 
    flex: 0.8; 
    background: white; 
    color: #c0392b; 
    border: 2px solid #c0392b; 
    border-radius: 8px; 
    font-size: 0.85rem !important; /* ê¸€ì”¨ í¬ê¸° ì¶•ì†Œ */
    font-weight: bold; 
    cursor: pointer; 
}
        
        .lane-box-v13 { background: white; border: 1px solid #ccc; border-radius: 8px; padding: 5px; text-align: center; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .lane-label { color: #8e44ad; font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }      

        /* â˜…â˜…â˜… [ë°˜ì‘í˜• í•µì‹¬] ëª¨ë°”ì¼(800px ì´í•˜)ì—ì„œ ì„¸ë¡œë¡œ ê°•ì œ ë³€ê²½ â˜…â˜…â˜… */
        @media screen and (max-width: 800px) {
            .lane-divider { display: flex !important; flex-direction: column !important; }
            .lane-half { width: 100% !important; border-right: none !important; border-bottom: 2px dashed #d1c4e9 !important; padding: 15px 10px !important; box-sizing: border-box; }
            .lane-half:last-child { border-bottom: none !important; }
            .lane-config-grid { grid-template-columns: repeat(2, 1fr) !important; }
            input, select, button { font-size: 16px !important; }
        }
        /* --- ì¹´ì§€ë…¸ ì¹© & í…Œì´ë¸” ìŠ¤íƒ€ì¼ --- */
        #casinoPanel { background: #1a472a; border-radius: 15px; padding: 20px; color: white; }
        .casino-table { background: radial-gradient(circle, #27ae60, #1a472a); border: 10px solid #5d4037; border-radius: 30px; padding: 20px; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); text-align: center; }
        .chip-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 15px; }

        .chip { width: 75px; height: 75px; border-radius: 50%; position: relative; cursor: pointer; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; justify-content: center; align-items: center; box-shadow: 0 6px 10px rgba(0,0,0,0.5); border: 5px dashed rgba(255,255,255,0.3); }
        .chip:hover { transform: translateY(-5px) scale(1.05); }
        .chip.selected { opacity: 0.6; cursor: default; transform: scale(0.9); filter: grayscale(0.5); }
        .chip.red { background: radial-gradient(circle, #ff4d4d, #b30000); }
        .chip.blue { background: radial-gradient(circle, #4da6ff, #0059b3); }
        .chip.green { background: radial-gradient(circle, #5cd65c, #1e7b1e); }
        .chip.yellow { background: radial-gradient(circle, #f1c40f, #f39c12); }

        .chip-inner { width: 48px; height: 48px; background: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #333; font-weight: 900; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .chip-num { font-size: 1.3rem; }
        .chip-owner { font-size: 0.65rem; color: #d63031; font-weight: bold; margin-top: -3px; }
        .chip-lane { font-size: 1.1rem; color: #0984e3; }

        .lane-input-touch { width: 100%; height: 40px; line-height: 40px; text-align: center; border: 1px solid #ccc; border-radius: 6px; font-weight: bold; font-size: 1.2rem; background: #fff; cursor: pointer; user-select: none; margin-top: 5px; }
        .lane-input-touch:active { background: #e3f2fd; transform: scale(0.95); }
        .team-input-touch { background: #f9f9f9; color: var(--purple); }

        .admin-btn, #settings button { width: 280px !important; height: 45px !important; line-height: 45px !important; padding: 0 !important; margin: 10px auto !important; display: block !important; font-size: 16px !important; font-weight: bold !important; border-radius: 8px !important; text-align: center !important; border: none !important; cursor: pointer !important; }
        .excel-green { background-color: #28a745 !important; color: white !important; }
        .over-200 { color: #ff0000 !important; font-weight: bold !important; }
   /* ëª¨ë°”ì¼ì—ì„œ ì…ë ¥ì°½ ê¸€ì”¨ê°€ ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šê²Œ ì¡°ì ˆ */
    input, select, button {
        font-size: 14px !important; /* ê°•ì œë¡œ 14pxë¡œ ê³ ì • */
        max-height: 40px;           /* ë†’ì´ë„ ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šê²Œ */
    }

    /* ì ìˆ˜ ì…ë ¥ì¹¸ì€ ì¡°ê¸ˆ ì»¤ë„ ë˜ì§€ë§Œ ë„ˆë¬´ í¬ì§€ ì•Šê²Œ */
    .score-input {
        font-size: 1.2rem !important; /* 1.4remì—ì„œ ì•½ê°„ ì¤„ì„ */
        padding: 8px !important;      /* ì—¬ë°±ë„ ì¤„ì„ */
        height: 40px !important;
    }
   </style>
</head>
<body>

    <div id="landingPage">
        <h1 style="color:white; margin-bottom:20px; font-size:2.5rem;">ACE BOWLING</h1>
        <p style="color:#eee; font-weight:bold;">V18.0</p>
        <button class="enter-btn" onclick="window.showGlobalLogin()">ì•± ì‹œì‘í•˜ê¸°</button>
    </div>
<div id="admin-menu" style="display: none; background: #f0f0f0; padding: 10px; text-align: center; border-bottom: 1px solid #ccc;">
        <button onclick="toggleNoticePanel()" style="background:none; border:none; cursor:pointer;">
    <span style="font-size:2rem;">ğŸ“¢</span> 
    <br>
    <span style="font-size:0.8rem; font-weight:bold;">ê³µì§€ ë°œì†¡</span>
</button>
    </div>

    <div id="main-content">
    <div id="globalLoginScreen" style="display:none;">
        <div class="login-card">
            <h2 style="color:var(--primary); margin-bottom:20px;">ğŸ” íšŒì› ë¡œê·¸ì¸</h2>
            <input type="text" id="globalId" class="login-input" placeholder="ì´ë¦„">
            <input type="password" id="globalPw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="universal-btn" onclick="window.doGlobalLogin()" style="background:var(--accent);">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display:none;">
        <div class="header" style="
    position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: #ffffff; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 10px 15px; display: flex; 
    justify-content: space-between; align-items: center; box-sizing: border-box;
">
    
    <div style="display: flex; align-items: center; gap: 12px;">
        <h2 style="margin: 0; font-size: 0.9rem; white-space: nowrap; color: #333;">Ilsan Ace Team V18.0</h2>
        
        <div style="display: flex; align-items: center; gap: 6px;">
            <button onclick="openNoticePanel('app')" style="background: #3498db; border: 1px solid #2980b9; border-radius: 4px; padding: 4px 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 1.1rem; line-height: 1;">ğŸ“¢</span>
            </button>

            <button onclick="openNoticePanel('cafe')" style="background: #FFEB33; border: 1px solid #ebcf00; border-radius: 4px; padding: 4px 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 1.1rem; line-height: 1;">ğŸ’¬</span>
            </button>
        </div>
    </div>

    <div style="display: flex; align-items: center; gap: 6px;">
        <span id="userInfo" style="font-weight: bold; color: var(--primary); font-size: 0.75rem; white-space: nowrap;"></span>
        <button id="logoutBtn" onclick="window.logout()" style="padding: 3px 6px; background: var(--danger); color: white; border: none; border-radius: 4px; font-size: 0.7rem; font-weight: bold; cursor: pointer; white-space: nowrap;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>



<div class="tab-menu" id="mainTabMenu">
    <button class="tab-btn active" onclick="window.showPanel('attendPanel', this)">1.ì°¸ì„</button>
    <button class="tab-btn" onclick="window.showPanel('groupPanel', this)">2.ì¡°í¸ì„±</button>
    <button class="tab-btn" onclick="window.showPanel('casinoPanel', this)">ğŸ° ì¹´ì§€ë…¸</button>
    <button class="tab-btn" onclick="window.showPanel('progressPanel', this)">3.ì§„í–‰</button>
    <button class="tab-btn" onclick="window.clickInputTab(this)">4.ì…ë ¥</button>
    <button class="tab-btn" onclick="window.showPanel('statsPanel', this)">í†µê³„</button>
    <button class="tab-btn" onclick="window.showPanel('memberPanel', this)">íšŒì›ê´€ë¦¬</button>
    <button class="tab-btn" id="settingsTabBtn" onclick="window.showPanel('settingsPanel', this)" style="display:none;">âš™ï¸ ì„¤ì •</button>
</div>

        <div class="content-area">
            
            <div id="attendPanel" class="panel active">
                <div id="adminEventCreate" class="input-box" style="display:none; border:2px solid var(--accent);">
                    <h4 style="margin-top:0; color:var(--accent);">ğŸ“… ìƒˆ ëª¨ì„ ì¼ì • ë“±ë¡ (ê³µì§€)</h4>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="date" id="eventDate" class="big-input" style="flex:1.5; margin-bottom:0;">
                        <input type="time" id="eventExactTime" class="big-input" style="flex:1.2; margin-bottom:0;" value="14:00">
                    </div>
                    <select id="eventMode" class="big-select">
                        <option value="regular">âš–ï¸ ì •ê¸°ëª¨ì„ (4G)</option>
                        <option value="lightning">âš¡ ë²ˆê°œëª¨ì„ (6G)</option>
                    </select>
                    <button class="universal-btn" style="background:var(--accent); margin-bottom:0;" onclick="window.createEvent()">ëª¨ì„ ì¼ì • ë“±ë¡</button>
                </div>

                <div class="section-title">ğŸ—“ï¸ ì˜ˆì •ëœ ëª¨ì„ ë° ì°¸ì„ ì‹ ì²­</div>
                <div id="eventListArea"></div>

                <input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none;">
            </div>

            <div id="groupPanel" class="panel">
    <div class="input-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 id="modeDisplay" style="margin:0; font-size:1.1rem; color:var(--primary);">âš–ï¸ ì •ê¸°ëª¨ì„ (4ê²Œì„)</h3>
            <button class="btn-sm" onclick="window.toggleMode()" style="background:var(--dark); color:white;">ğŸ”„ ëª¨ë“œ ì „í™˜</button>
        </div>

        <div id="assignGameTabs" class="rank-tabs" style="margin: 15px 0;"></div>

        <label style="font-weight:bold; color:var(--warning); display:block; margin-bottom:5px;">1. êµ¬ì—­ ì„ íƒ (ë ˆì¸ êµ¬ì¡°)</label>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button class="zone-btn" id="z1" onclick="window.toggleZone(1)">1êµ¬ì—­</button>
            <button class="zone-btn" id="z2" onclick="window.toggleZone(2)">2êµ¬ì—­</button>
            <button class="zone-btn" id="z3" onclick="window.toggleZone(3)">3êµ¬ì—­</button>
            <button class="zone-btn" id="z4" onclick="window.toggleZone(4)">4êµ¬ì—­</button>
            <button class="zone-btn" id="z5" onclick="window.toggleZone(5)">5êµ¬ì—­</button>
        </div>
    </div>

    <label style="font-weight:bold; color:var(--primary); display:block; margin-bottom:5px;">2. ì°¸ì„ í˜„í™© ë° ë ˆì¸ ë°°ì •</label>
    <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
    
    <label style="font-weight:bold; color:#27ae60; display:block; margin-bottom:5px;">1. ì¡°í¸ì„± ë°©ì‹ ì„ íƒ</label>
    <select id="groupAssignMethod" class="big-select" style="margin-bottom:15px;" onchange="window.changeAssignMethod(this.value)">
        <option value="ai">ğŸ¤– AI ë°¸ëŸ°ìŠ¤</option>
        <option value="random">ğŸ² ëœë¤ (ë¬´ì‘ìœ„)</option>
    </select>

    <label style="font-weight:bold; color:#8e44ad; display:block; margin-bottom:8px;">2. ë ˆì¸ë³„ ì¸ì› ì„¤ì •</label>
    
    <div class="box-manager" style="background:#e8f4fc; border:1px solid #3498db; color:#2980b9; padding:8px; border-radius:6px; text-align:center; font-size:0.9rem; font-weight:bold; margin-bottom:5px; display:block;">
        <span style="font-size:0.8rem; opacity:0.8; margin-right:5px;">ğŸ‘‘ ì •ëª¨ì¥:</span>
        <span id="displayJungmoName">ë¯¸ì •</span>
    </div>

    <div style="display:flex; gap:6px; margin-bottom:15px;">
        <button type="button" onclick="window.runGeneralAssignment()" 
                style="flex:1; height:38px; background:#3498db; color:white; border:none; border-radius:6px; font-weight:bold; font-size:0.9rem; cursor:pointer; padding:0; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            âš–ï¸ ì¼ë°˜ ë°°ì •
        </button>

        <button type="button" onclick="window.startCasinoAssignment()" 
                style="flex:1; height:38px; background:#e67e22; color:white; border:none; border-radius:6px; font-weight:bold; font-size:0.9rem; cursor:pointer; padding:0; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            ğŸ° ì¹´ì§€ë…¸
        </button>

        <button type="button" onclick="window.resetAssignment()" 
                style="flex:1; height:38px; background:white; border:1px solid #c0392b; color:#c0392b; border-radius:6px; font-weight:bold; font-size:0.9rem; cursor:pointer; padding:0; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            ğŸ—‘ï¸ ì´ˆê¸°í™”
        </button>
    </div>

    <div id="laneConfigArea" class="lane-config-grid"></div>
    <div style="text-align:right; font-weight:bold; margin-top:10px;">
        ì„¤ì • ì¸ì› í•©ê³„: <span id="totalConfigCount" style="color:var(--danger); font-size:1.1rem;">0</span>ëª…
    </div>

    <div style="background:#fff; padding:15px; border-radius:10px; border:1px solid #ddd; margin-top:10px;">
    <h4 style="margin-top:0; color:#e67e22;">âš¡ ë²ˆê°œì¥(ğŸ‘‘) ì„ íƒ</h4>
    <p style="font-size:0.85rem; color:#888; margin-bottom:10px;">ì˜¤ëŠ˜ ì°¸ì„ ì‹ ì²­í•œ ëª…ë‹¨ì…ë‹ˆë‹¤. ë²ˆê°œì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
    
    <div id="bangaeMemberList" style="display: flex; flex-direction: column; gap: 8px;">
        <div style="text-align:center; padding:20px; color:#ccc;">ì°¸ì„ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
</div>
    
    
</div>
            <div id="casinoPanel" class="panel">
                <div class="casino-table">
                    <h2 style="color: #f1c40f; margin-top:0; text-shadow: 2px 2px 4px #000;">ğŸ° ACE CASINO TABLE</h2>
                    <div id="casinoStatus" style="font-size:1rem; margin-bottom:20px; color:#fff; font-weight:bold;">
                        ì›í•˜ëŠ” ë²ˆí˜¸ì˜ ì¹©ì„ ë¹ ë¥´ê²Œ ì„ íƒí•˜ì„¸ìš”!
                    </div>
                    
                    <div class="tier-zone" id="zone_red">
                        <div style="color:#ff7675; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">ğŸ”´ RED CHIPS (ìƒìœ„)</div>
                        <div id="chips_red" class="chip-container"></div>
                    </div>
                    <div class="tier-zone" id="zone_blue" style="margin-top:25px;">
                        <div style="color:#74b9ff; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">ğŸ”µ BLUE CHIPS (ì¤‘ìœ„)</div>
                        <div id="chips_blue" class="chip-container"></div>
                    </div>
                    <div class="tier-zone" id="zone_green" style="margin-top:25px; display:none;">
                        <div style="color:#55efc4; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">ğŸŸ¢ GREEN CHIPS (í•˜ìœ„)</div>
                        <div id="chips_green" class="chip-container"></div>
                    </div>
                    <div class="tier-zone" id="zone_yellow" style="margin-top:25px; display:none;">
                        <div style="color:#f1c40f; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">ğŸŸ¡ YELLOW CHIPS (ìµœí•˜ìœ„)</div>
                        <div id="chips_yellow" class="chip-container"></div>
                    </div>
                    <div id="adminCasinoControls" style="margin-top:40px; border-top:1px solid rgba(255,255,255,0.2); padding-top:20px;">
                        <button class="universal-btn" style="background:#f1c40f; color:#000;" onclick="window.initCasino()">ğŸ² ì¹´ì§€ë…¸íŒ ìƒˆë¡œ ê¹”ê¸° (ì¹© ìƒì„±)</button>
                        <button class="universal-btn" style="background:#e67e22; margin-top:10px;" onclick="window.finishCasino()">ğŸ‘» ê³ ìŠ¤íŠ¸ í™•ì¸ ë° ë°°ì • ì¢…ë£Œ</button>
                    </div>
                </div>
            </div>

            <div id="progressPanel" class="panel">
                <div class="input-box">
                    <input type="date" id="progDate" class="big-input" style="width:auto; margin-bottom:15px;" onchange="window.renderGameProgress()">
                    <div id="progTabs" class="rank-tabs"></div>
                    <div id="teamCardArea"></div>
                </div>
            </div>

            <div id="inputPanel" class="panel">
                <div id="scoreSection">
                    <div class="input-box">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="margin:0;">ğŸ“ ì ìˆ˜ ì…ë ¥ (<span id="inputGameTitle">1G</span>)</h3>
                            <button class="btn-sm" onclick="window.saveAllScores()" style="background:var(--accent); color:white; border:none;">ğŸ’¾ ì €ì¥</button>
                        </div>
                        
                        <div id="filterInfo" style="display:none; background:#f3e5f5; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; color:#8e44ad; border:1px solid #e1bee7;">
                            <span id="filterTeamName"></span> ì ìˆ˜ ì…ë ¥ ì¤‘...
                        </div>

                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <input type="date" id="inputDate" class="big-input" style="width:60%; margin:0;" onchange="window.renderInputs()">
                            <button class="btn-sm" onclick="window.showAllTeams()" style="background:#95a5a6; color:white;">ğŸ“‚ ì „ì²´ ë³´ê¸°</button>
                        </div>
                        
                        <div id="inputTabs" class="rank-tabs"></div>
                        <div id="inputGridArea" style="margin-top:15px;"></div>
                        
                        <button class="universal-btn" onclick="window.saveAllScores()" style="background:var(--accent); margin-top:20px;">ğŸ’¾ ì ìˆ˜ ì €ì¥ ì™„ë£Œ</button>
                    </div>
                </div>
            </div>

            <div id="statsPanel" class="panel">
                <div class="input-box">
                    <div class="section-title">ğŸ“ˆ ê¸°ê°„ë³„ ê°œì¸ ì—ë²„ (ê¸°ë¡)</div>
                    <div style="margin-bottom:15px; display:flex; flex-wrap:wrap;">
                        <button class="filter-btn active" id="btn_period_all" onclick="window.setStatsPeriod('all', this)">ì „ì²´</button>
                        <button class="filter-btn" onclick="window.setStatsPeriod('1m', this)">1ê°œì›”</button>
                        <button class="filter-btn" onclick="window.setStatsPeriod('3m', this)">3ê°œì›”</button>
                        <button class="filter-btn" onclick="window.setStatsPeriod('6m', this)">6ê°œì›”</button>
                        <button class="filter-btn" onclick="window.setStatsPeriod('12m', this)">12ê°œì›”</button>
                    </div>
                    <div id="historicalStatsTable"></div>
                    <hr style="margin: 20px 0;">
                    <div class="section-title">âš¡ ê¸ˆì¼ ê²Œì„ë³„ ìˆœìœ„</div>
                    <div id="statsGameTabs" class="rank-tabs"></div>
                    <h4 style="margin-top:10px;">ğŸ† íŒ€ ìˆœìœ„</h4>
                    <div id="currentTeamRankTable"></div>
                    <h4 style="margin-top:20px;">ğŸ… ê°œì¸ ìˆœìœ„</h4>

                    <div style="margin-bottom:10px; display:flex; gap:5px;">
                        <button class="filter-btn active" onclick="window.filterCurrentStats('all', this)">ì „ì²´</button>
                        <button class="filter-btn" onclick="window.filterCurrentStats('ë‚¨', this)">ë‚¨ì„±</button>
                        <button class="filter-btn" onclick="window.filterCurrentStats('ì—¬', this)">ì—¬ì„±</button>
                    </div>
                    <div id="currentIndivRankTable"></div>
                    <div class="section-title" style="margin-top:40px; border-left:4px solid var(--danger);">ğŸ‘‘ ì˜¤ëŠ˜ì˜ ìµœì¢… í•©ê³„ ìˆœìœ„ (ì „ì²´ ê²Œì„ ëˆ„ì )</div>
                    <div id="todayTotalRankTable"></div>      
                </div>
            </div>

            <div id="memberPanel" class="panel">
                <div id="adminMemberControls" class="input-box" style="display:none; border:2px solid var(--green);">
                    <h4 style="margin-top:0;">â• ì‹ ê·œ íšŒì› ì¶”ê°€</h4>
                    <input type="text" id="newMemName" class="big-input" placeholder="ì´ë¦„ ì…ë ¥">
                    <div style="display:flex; gap:10px;">
                        <select id="newMemGender" class="big-select" onchange="window.checkGender(this)">
                            <option value="ë‚¨">ë‚¨ì„±</option>
                            <option value="ì—¬">ì—¬ì„±</option>
                        </select>
                        <input type="number" id="newMemHandicap" class="big-input" placeholder="í•¸ë””" value="0">
                    </div>
                    <button class="universal-btn" style="background:var(--green);" onclick="window.addMember()">íšŒì› ì €ì¥</button>
                </div>
                <div class="input-box">
                    <h4>ğŸ“‚ íšŒì› ëª©ë¡</h4>
                    <div id="memberListArea"></div>
                </div>
            </div>

            <div id="settingsPanel" class="panel">
                <div id="adminJungmoSetting" class="input-box" style="display:none; border:2px solid var(--primary);">
                    <h3>ğŸ‘‘ ì •ëª¨ì¥ ì„ëª…</h3>
                    <div style="margin-bottom:10px; font-weight:bold; color:var(--primary);">
                        í˜„ì¬ ì •ëª¨ì¥: <span id="currentJungmoJangSetting" style="color:var(--accent);">ì—†ìŒ</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="jungmoJangInput" class="big-input" placeholder="íšŒì› ì´ë¦„ ì…ë ¥">
                        <button class="btn-sm" style="background:var(--primary); color:white;" onclick="window.setJungmoManager()">ì €ì¥</button>
                    </div>
                </div>

                <div class="input-box" style="border:2px solid var(--accent);">
                    <h3 style="color:var(--accent); margin-top:0;">âš™ï¸ ìš´ì˜ ê¸°ì¤€ ì„¤ì •</h3>
                    <button onclick="document.getElementById('excelInput').click()" class="admin-btn excel-green">ğŸ“Š ì •ëª¨ì ìˆ˜ëª…ë‹¨ ì—…ë¡œë“œ</button>
                    <button onclick="downloadExcel()" class="admin-btn">ğŸ“Š ì •ëª¨ì ìˆ˜ ë‹¤ìš´ë¡œë“œ</button>
                    
                    <label class="settings-label">ê°€ì¤‘ì¹˜ ì—ë²„ ë°˜ì˜ ê¸°ê°„ (ê°œì›”)</label>
                    <input type="number" id="setAvgCriteria" class="big-input" value="6" placeholder="ê¸°ë³¸ 6ê°œì›”">
                    <small style="color:#666; display:block; margin-bottom:15px;">* ì„¤ì •í•œ ê¸°ê°„ë§Œí¼ì˜ ì„±ì ì„ ê³„ì‚°í•˜ì—¬ ì‹¤ë ¥ì„ í‰ê°€í•©ë‹ˆë‹¤.</small>

                    <label class="settings-label">ê¸°ë³¸ ì¡°í¸ì„± ë°©ì‹</label>
                    <select id="setAssignMethod" class="big-select">
                        <option value="ai">ğŸ¤– AI ë°¸ëŸ°ìŠ¤</option>
                        <option value="random">ğŸ² ëœë¤ (ë¬´ì‘ìœ„)</option>
                    </select>

                    <button class="universal-btn" style="background:var(--accent); margin-top:10px;" onclick="window.saveSettings()">âš™ï¸ ê¸°ì¤€ê°’ ì €ì¥</button>
                </div>
                <div class="input-box" style="border:2px solid var(--purple);">
                    <h4 style="color:var(--purple); margin-top:0;">ğŸ’¾ ë°ì´í„° ë°±ì—… ë° ë³µêµ¬</h4>
                    <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">* í˜„ì¬ ëª¨ë“  ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ê±°ë‚˜ ë³´ê´€ëœ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
                    
                    <div style="display:flex; gap:5px;">
                        <button class="universal-btn" style="background:var(--purple); flex:1;" onclick="window.exportData()">íŒŒì¼ ë‚´ë³´ë‚´ê¸°</button>
                        <button class="universal-btn" style="background:var(--dark); flex:1;" onclick="document.getElementById('importFile').click()">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                    <input type="file" id="importFile" style="display:none;" accept=".json" onchange="window.importData(event)">
                </div>
                <div class="input-box" style="border:1px solid var(--danger);">
                    <h4 style="color:var(--danger); margin-top:0;">ğŸš¨ ë°ì´í„° ê´€ë¦¬</h4>
                    <button class="universal-btn" style="background:var(--danger);" onclick="window.deleteToday()">ğŸ—‘ï¸ ì˜¤ëŠ˜ ì ìˆ˜ë§Œ ì‚­ì œ</button>
                    <button class="universal-btn" style="background:#8e44ad; margin-top:5px;" onclick="window.deleteAllData()">ğŸ’¥ ë°ì´í„° ì™„ì „ ì´ˆê¸°í™”</button>
                    <button class="universal-btn" style="background:#95a5a6; margin-top:5px;" onclick="window.resetAttendance()">ğŸ”„ ì°¸ì„ ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

    <div id="modalOverlay" onclick="window.closeModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 id="modalTitle" style="margin-top:0;"></h3>
            <div id="modalContent"></div>
            <button class="universal-btn" style="background:#333; margin-top:20px;" onclick="window.closeModal()">ë‹«ê¸°</button>
        </div>
    </div>

<script>
    let members=[], attendees=[], records=[], gameTeams={}, events={};
    let settings = { mode: 'regular', gameCount: 4, avgCriteria: 6, assignMethod: 'ai' };
    window.isConfigEditing = false; // ë ˆì¸ ì„¤ì • ì…ë ¥ ì¤‘ì¸ì§€ í™•ì¸í•˜ëŠ” ê¹ƒë°œ
    let managers = { jungmo: '', lightning: '' }; 
    let selectedBlocks = [], laneSettings = {};   
    let db = null;
    // [ì¶”ê°€] ì£¼ì†Œì°½ì—ì„œ íŠ¹ì • ì´ë²¤íŠ¸ IDê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ê¸°ì–µí•¨
const urlParams = new URLSearchParams(window.location.search);
const jumpTarget = urlParams.get('eventId');
if (jumpTarget) sessionStorage.setItem('jumpToEvent', jumpTarget);
    let loggedInUser = localStorage.getItem('loggedInUser');
    let isAdmin = localStorage.getItem('ace_admin') === 'true';
    
    let currentRankView = 1, currentInputGame = 1, currentTargetGame = 1;
    let currentStatsGame = 1, currentStatsPeriod = 'all', currentGenderFilter = 'all';
    let currentInputTeam = null; 

    firebase.initializeApp({ databaseURL: "https://ilsan-ace-bowling-team-default-rtdb.asia-southeast1.firebasedatabase.app" });
    db = firebase.database();


// ========================================================
// ğŸ› ï¸ ì´ ë©ì–´ë¦¬ë¥¼ í†µì§¸ë¡œ ë³µì‚¬í•´ì„œ ì—ëŸ¬ ë‚˜ëŠ” ìœ„ì¹˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
// ========================================================
// 1. ì„¤ì • ë° í™”ë©´ ì´ë™ ë™ê¸°í™”
db.ref('bowling_v14/settings').on('value', sn => {
    const val = sn.val();
    if (!val || !val.currentTab) return;

    if (val.currentAssignGame) currentTargetGame = val.currentAssignGame;
    if (val.currentRankView) currentRankView = val.currentRankView;
    if (val.currentInputGame) currentInputGame = val.currentInputGame;

    if (val.currentInputGame && window.renderInputs) {
        window.renderInputs();
    }

    const tabBtns = document.querySelectorAll('.tab-btn');
    let btnIdx = 0; 
    if (val.currentTab === 'groupPanel') btnIdx = 1;
    else if (val.currentTab === 'casinoPanel') btnIdx = 2;
    else if (val.currentTab === 'progressPanel') btnIdx = 3;
    else if (val.currentTab === 'inputPanel') btnIdx = 4;
    else if (val.currentTab === 'statsPanel') btnIdx = 5;

    window.showPanel(val.currentTab, tabBtns[btnIdx]);
});

// 2. ì¹´ì§€ë…¸ ì‹¤ì‹œê°„ ê°ì§€
db.ref('bowling_v14/casino').on('value', () => {
    if(window.renderCasino) window.renderCasino();
});   

// 3. ì—”í„°í‚¤ë¡œ ë‹¤ìŒ ì…ë ¥ì¹¸ ì´ë™
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        const inputs = Array.from(document.querySelectorAll('.lane-input'));
        const index = inputs.indexOf(document.activeElement);
        if (index > -1 && index < inputs.length - 1) {
            e.preventDefault(); 
            inputs[index + 1].focus(); 
            if(inputs[index + 1].value) inputs[index + 1].select();
        }
    }
});

// 4. ì•± ì§„ì… í•¨ìˆ˜
window.enterApp = function() {
    const landing = document.getElementById('landingPage');
    if(landing) landing.style.display = 'none';
    if(typeof window.showGlobalLogin === 'function') window.showGlobalLogin();
};

    window.showGlobalLogin = function() {
        if(localStorage.getItem('loggedInUser')) {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('globalLoginScreen').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            window.updateUI();

            const firstTabBtn = document.querySelectorAll('.tab-btn')[0];
            window.showPanel('attendPanel', firstTabBtn);
            
        } else {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('globalLoginScreen').style.display = 'flex';
        }
    };

    window.doGlobalLogin = function() {
        const i = document.getElementById('globalId').value.trim();
        const p = document.getElementById('globalPw').value.trim();
        if((i==='ê´€ë¦¬ì'||i==='ê¹€ë²”ì£¼') && p==='6884') {
            localStorage.setItem('loggedInUser', i);
            localStorage.setItem('ace_admin', 'true');
            location.reload();
        } else {
            const m = members.find(x=>x.name===i);
            if(m && (m.pw||'1234')===p) {
                localStorage.setItem('loggedInUser', i);
                localStorage.setItem('ace_admin', 'false');
                location.reload();
            } else alert("ë¡œê·¸ì¸ ì‹¤íŒ¨! ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        }
    };

    
window.updateUI = function() {
    if(!loggedInUser) return;
    if(window.isConfigEditing || window.isScoreEditing) return;

    const myName = loggedInUser.trim();
    const isL = settings.mode === 'lightning';
    const uInfo = document.getElementById('userInfo');
    const settingsTab = document.getElementById('settingsTabBtn');
    
    if(uInfo) uInfo.innerText = `${loggedInUser} ${isAdmin ? '(ê´€ë¦¬ì)' : ''}`;
    if(settingsTab) settingsTab.style.display = isAdmin ? 'block' : 'none';

    for(let i=1; i<=5; i++) {
        const btn = document.getElementById('z'+i);
        if(btn) {
            if(selectedBlocks.includes(i)) btn.classList.add('selected');
            else btn.classList.remove('selected');
        }
    }
    if(window.renderCustomLaneConfig) window.renderCustomLaneConfig(); 

    const panelTitle = document.getElementById('modeDisplay');
    if(panelTitle) {
        panelTitle.innerHTML = isL ? 
            '<span style="color:#e67e22;">âš¡ ë²ˆê°œëª¨ì„ (6ê²Œì„)</span>' : 
            '<span style="color:#2c3e50;">âš–ï¸ ì •ê¸°ëª¨ì„ (4ê²Œì„)</span>';
    }

    const jName = document.getElementById('displayJungmoName');
    const managerLabel = document.querySelector('.box-manager span:first-child');

    if (jName) {
        jName.innerText = isL ? (managers.lightning || 'ë¯¸ì •') : (managers.jungmo || 'ë¯¸ì •');
        
        if (managerLabel) {
            managerLabel.innerText = isL ? 'âš¡ ë²ˆê°œì¥' : 'ğŸ‘‘ ì •ëª¨ì¥';
        }
    }

    const currentJungmoJang = (managers.jungmo || "").trim();
    const currentBungaeJang = (managers.lightning || "").trim();
    let hasPower = isAdmin || (isL ? currentBungaeJang === myName : currentJungmoJang === myName);

    const eventCreateBox = document.getElementById('adminEventCreate');
    const eventSelectBox = document.getElementById('activeMeetingSelector');
    const memAdminBox = document.getElementById('adminMemberControls');
    const jungmoSettingBox = document.getElementById('adminJungmoSetting');
    const bBox = document.getElementById('lightningManagerSelect');

    if(eventCreateBox) eventCreateBox.style.display = hasPower ? 'block' : 'none';
    if(eventSelectBox) eventSelectBox.style.display = hasPower ? 'block' : 'none';
    if(memAdminBox) memAdminBox.style.display = hasPower ? 'block' : 'none';
    if(jungmoSettingBox) jungmoSettingBox.style.display = isAdmin ? 'block' : 'none';
    
    if(bBox) {
        bBox.style.display = isL ? 'block' : 'none';
    }

    const jSettingName = document.getElementById('currentJungmoJangSetting');
    if (jSettingName) jSettingName.innerText = managers.jungmo || 'ì—†ìŒ';

    const bNameSpan = document.getElementById('currentBungaeJang');
    if (bNameSpan) bNameSpan.innerText = managers.lightning || 'ì—†ìŒ';

    // â–¼â–¼â–¼ í™”ë©´ ê·¸ë¦¬ê¸° í•¨ìˆ˜ë“¤ ëª¨ìŒ â–¼â–¼â–¼
    if(typeof window.renderEventList === 'function') window.renderEventList();
    if(typeof window.renderAssignGameTabs === 'function') window.renderAssignGameTabs(); 
    if(typeof window.renderMembers === 'function') window.renderMembers();
    if(typeof window.renderCasino === 'function') window.renderCasino();
    
    // â˜… [ì¶”ê°€ëœ í•œ ì¤„] ë²ˆê°œì¥ ëª…ë‹¨ ê·¸ë¦¬ê¸° (ì—¬ê¸°ì— ë„£ì–´ì•¼ í™•ì‹¤í•˜ê²Œ ëœ¹ë‹ˆë‹¤!)
    if(typeof window.renderBungaeJangSelect === 'function') window.renderBungaeJangSelect();

    if(document.getElementById('groupAssignMethod')) 
        document.getElementById('groupAssignMethod').value = settings.assignMethod || 'snake';
    if(document.getElementById('setAssignMethod')) 
        document.getElementById('setAssignMethod').value = settings.assignMethod || 'snake';

    const activePanel = document.querySelector('.panel.active');
    if(activePanel) {
        // ì§„í–‰ í™”ë©´ì´ë©´ ì ìˆ˜íŒ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if(activePanel.id === 'progressPanel' && typeof window.renderGameProgress === 'function') {
            window.renderGameProgress();
        }
        // ì…ë ¥ í™”ë©´ì´ë©´ ì…ë ¥ì°½ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if(activePanel.id === 'inputPanel' && typeof window.renderInputs === 'function') {
            window.renderInputs();
        }
        // í†µê³„ í™”ë©´ì´ë©´ í†µê³„í‘œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if(activePanel.id === 'statsPanel' && typeof window.renderAllStats === 'function') {
            window.renderAllStats();
        }
        if(typeof window.jumpToSpecificEvent === 'function') window.jumpToSpecificEvent();
    }
};
window.createEvent = function() {
    const date = document.getElementById('eventDate').value;
    const exactTime = document.getElementById('eventExactTime').value; 
    const mode = document.getElementById('eventMode').value;
    
    if(!date || !exactTime) return alert("ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ í™•ì¸í•´ ì£¼ì„¸ìš”!");

    const combinedTime = exactTime; 
    const id = `${date}_${exactTime.replace(':', '')}`; 
    
    db.ref('bowling_v14/events/' + id).set({ 
        id, 
        date, 
        time: combinedTime, 
        mode, 
        attendees: [] 
    }).then(() => {
        alert("âœ… ëª¨ì„ ê³µì§€ ì™„ë£Œ!");
    });
};
    const formatTime = (t) => {
        if(!t) return "";
        let [h, m] = t.split(':');
        h = parseInt(h);
        const ampm = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
        h = h % 12 || 12; // 0ì‹œëŠ” 12ì‹œë¡œ í‘œì‹œ
        return `${ampm} ${String(h).padStart(2, '0')}:${m}`;
    };
// [ë²ˆê°œì¥ ì„ íƒ] ì°¸ì„ì ëª…ë‹¨ì´ ì­‰ ëœ¨ê³ , í´ë¦­í•˜ë©´ ë°”ë¡œ ë²ˆê°œì¥ìœ¼ë¡œ ì§€ì •ë©ë‹ˆë‹¤.
window.renderBungaeJangSelect = function() {
    const listArea = document.getElementById('bangaeMemberList'); 
    if (!listArea) return;

    // 1. [ì¤‘ìš”] ì°¸ì„ì ëª…ë‹¨ì—ì„œ ê³ ìŠ¤íŠ¸ëŠ” ì œì™¸í•˜ê³  ì§„ì§œ ì‚¬ëŒë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const realAttendees = attendees.filter(n => n && !n.includes("ê³ ìŠ¤íŠ¸"));

    if (realAttendees.length === 0) {
        listArea.innerHTML = '<div style="color:#999; text-align:center; padding:20px; border:1px dashed #ddd;">ì°¸ì„ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    const currentBoss = managers.lightning || "";

    // 2. ì´ë¦„ë“¤ì„ ë‚˜ì—´í•˜ì—¬ ì„ íƒ ê°€ëŠ¥í•œ ë²„íŠ¼ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
    let html = realAttendees.map(name => {
        const isSelected = (name === currentBoss);
        const style = isSelected 
            ? "background:#fff9db; border:2px solid #fab005; color:#e67e22; font-weight:bold;" 
            : "background:#f8f9fa; border:1px solid #eee; color:#333;";

        return `
            <div style="padding:12px 15px; border-radius:8px; cursor:pointer; display:flex; align-items:center; ${style}"
                 onclick="window.setLightningBoss('${name}')">
                <div style="width:18px; height:18px; border-radius:50%; border:2px solid ${isSelected?'#fab005':'#ccc'}; margin-right:10px; background:white; display:flex; align-items:center; justify-content:center;">
                    ${isSelected ? '<div style="width:10px; height:10px; border-radius:50%; background:#fab005;"></div>' : ''}
                </div>
                <span style="flex:1; font-size:1.1rem;">${name}</span>
                ${isSelected ? '<span>ğŸ‘‘</span>' : ''}
            </div>
        `;
    }).join('');

    listArea.innerHTML = html;
};

// ë²ˆê°œì¥ í´ë¦­ ì‹œ ì €ì¥ í•¨ìˆ˜
window.setLightningBoss = function(name) {
    if(!confirm(`âš¡ [${name}] ë‹˜ì„ ì˜¤ëŠ˜ì˜ ë²ˆê°œì¥ìœ¼ë¡œ ì§€ì •í• ê¹Œìš”?`)) return;
    
    db.ref('bowling_v14/managers/lightning').set(name).then(() => {
        // ì„±ê³µ ì‹œ ì¦‰ì‹œ UI ê°±ì‹ 
        window.updateUI();
    });
};

// [ë²ˆê°œì¥ ì €ì¥] ë¼ë””ì˜¤ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ DBì— ì €ì¥
window.setLightningBoss = function(name) {
    if(!confirm(`âš¡ [${name}] ë‹˜ì„ ë²ˆê°œì¥ìœ¼ë¡œ ì„ëª…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    managers.lightning = name; // ë¡œì»¬ ë°˜ì˜
    db.ref('bowling_v14/managers/lightning').set(name).then(() => {
        alert(`ğŸ‘‘ ${name} ë‹˜ì´ ë²ˆê°œì¥ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        window.updateUI(); // í™”ë©´ ê°±ì‹  (ìƒ‰ê¹” ë°”ë€Œê²Œ)
    });
};
    window.renderEventList = function() {
    const area = document.getElementById('eventListArea');
    if(!area) return;

    const now = new Date().toISOString().split('T')[0];
    let html = '';

    const myName = (loggedInUser || "").trim();
    const isL = settings.mode === 'lightning';
    const hasPower = isAdmin || (isL ? (managers.lightning === myName) : (managers.jungmo === myName));

    const sortedIds = Object.keys(events || {}).sort((a, b) => b.localeCompare(a));
    const commonBtnStyle = "width: 95px; height: 38px; font-size: 0.9rem; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;";

    sortedIds.forEach(id => {
        const ev = events[id];
        if (ev.date < now) return;

        const list = ev.attendees || [];
        const joined = list.includes(loggedInUser);
        
        const fCount = list.filter(n => members.find(m => m.name === n)?.gender === 'ì—¬').length;
        const mCount = list.length - fCount;

        html += `
        <div id="event_${ev.id}" class="input-box" style="border-left:10px solid ${ev.mode==='regular'?'#6741d9':'#f08c00'}; padding:18px;">
            
            <div style="margin-bottom:15px;">
                <div style="font-size:0.85rem; color:#888;">${ev.date}</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <b style="font-size:1.35rem; color:#222;">${formatTime(ev.time)}</b>
                    <span style="font-size:0.75rem; background:#f1f3f5; color:#666; padding:2px 8px; border-radius:4px; font-weight:bold;">
                        ${ev.mode==='regular'?'âš–ï¸ ì •ê¸°':'âš¡ ë²ˆê°œ'}
                    </span>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; background:#f8f9fa; padding:12px; border-radius:12px; border:1px solid #eee;">
                <div style="font-size:0.9rem; color:#495057;">
                    <b style="font-size:1rem; color:#222;">ğŸ‘¥ ${list.length}ëª…</b> 
                    <div style="margin-top:2px; font-size:0.8rem; color:#888;">
                        <span style="color:#339af0;">ë‚¨ ${mCount}</span> / <span style="color:#ff922b;">ì—¬ ${fCount}</span>
                    </div>
                </div>
                
                <div style="display:flex; gap:6px;">
                    <button style="${commonBtnStyle} background:${joined?'#ff6b6b':'#20c997'}; color:white;" 
                        onclick="window.toggleEventJoin('${id}')">
                        ${joined ? 'ì°¸ì„ì·¨ì†Œ' : 'ì‹ ì²­í•˜ê¸°'}
                    </button>
                    
                    ${hasPower ? `
                        <button style="${commonBtnStyle} background:#6741d9; color:white;" 
                            onclick="window.activateSelectedEventDirect('${id}')">
                            ê²Œì„ì‹œì‘ ğŸš€
                        </button>
                        <button style="width: 40px; height: 38px; border-radius: 8px; border: 1px solid #e03131; background: #fff; color: #e03131; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0;" 
                            onclick="window.deleteEvent('${id}')">
                            ğŸ—‘ï¸
                        </button>
                        ` : ''}
                </div>
            </div>
            
            ${hasPower ? `
            <div style="margin-top:15px; display:flex; gap:5px; padding-top:10px; border-top:1px dashed #ddd;">
                <select id="adminAddSelect_${id}" class="btn-sm" style="flex:1; height:38px; border:1px solid var(--accent);">
                    <option value="">-- ëŒ€ë¦¬ ì‹ ì²­ (íšŒì› ì„ íƒ) --</option>
                    ${members.sort((a,b)=>a.name.localeCompare(b.name)).map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
                </select>
                <button class="btn-sm" style="background:var(--accent); color:white; border:none; width:60px;"
                    onclick="window.toggleEventJoin('${id}', document.getElementById('adminAddSelect_${id}').value)">
                    ì¶”ê°€
                </button>
            </div>
            ` : ''}

            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:15px;">
                ${list.map((name, idx) => {
                    const mInfo = members.find(m => m.name === name) || { gender: 'ë‚¨', handicap: 0 };
                    return `
                        <div style="background:${mInfo.gender==='ì—¬'?'#fff0f6':'#e7f5ff'}; border:1px solid ${mInfo.gender==='ì—¬'?'#ffdeeb':'#d0ebff'}; padding:6px 12px; border-radius:20px; font-size:0.85rem; display:flex; align-items:center;">
                            <span style="color:#adb5bd; font-size:0.7rem; margin-right:4px;">${idx + 1}</span> 
                            <b>${name}</b> 
                            <span style="margin-left:4px; color:#845ef7; font-weight:bold;">${mInfo.handicap}</span>
                            ${hasPower ? `<span style="color:#fa5252; margin-left:6px; cursor:pointer; font-weight:bold; font-size:1rem;" onclick="window.kickMember('${id}', '${name}')">Ã—</span>` : ''}
                        </div>`;
                }).join('') || '<div style="color:#dee2e6; width:100%; text-align:center; padding:10px;">ì²« ë²ˆì§¸ ì‹ ì²­ìê°€ ë˜ì–´ë³´ì„¸ìš”!</div>'}
            </div>
        </div>`;
    });

    area.innerHTML = html || '<div style="text-align:center; padding:50px; color:#adb5bd;">ëª¨ì„ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
};



window.activateSelectedEventDirect = function(id) {
    const ev = events[id];
    if(!ev) return;
    if(confirm(`[${ev.date}] ì¡°í¸ì„±ì„ ì‹œì‘í• ê¹Œìš”?`)) {
        db.ref('bowling_v14').update({
            'attendees': ev.attendees || [],
            'settings/mode': ev.mode,
            'settings/gameCount': ev.mode === 'lightning' ? 6 : 4,
            'settings/currentTab': 'groupPanel',
            'settings/currentAssignGame': 1, // ğŸ‘ˆ [ì¶”ê°€] ë°°ì • ëŒ€ìƒì„ 1Gë¡œ ë¦¬ì…‹
            'settings/currentRankView': 1,   // ğŸ‘ˆ [ì¶”ê°€] ë³´ëŠ” í™”ë©´ë„ 1Gë¡œ ë¦¬ì…‹
            'settings/currentInputGame': 1   // ğŸ‘ˆ [ì¶”ê°€] ì…ë ¥ í™”ë©´ë„ 1Gë¡œ ë¦¬ì…‹
        }).then(() => {
            window.showPanel('groupPanel', document.querySelectorAll('.tab-btn')[1]);
        });
    }
};

window.toggleEventJoin = function(id) {
    let list = (events[id] && events[id].attendees) ? [...events[id].attendees] : [];
    if(list.includes(loggedInUser)) list = list.filter(n => n !== loggedInUser);
    else list.push(loggedInUser);
    db.ref('bowling_v14/events/' + id + '/attendees').set(list);
};

window.activateSelectedEvent = function() {
    const id = document.getElementById('currentActiveEventId').value;
    if(!id || !events[id]) return alert("ì§„í–‰í•  ëª¨ì„ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”!");

    if(confirm("ì´ ëª…ë‹¨ìœ¼ë¡œ ì˜¤ëŠ˜ ê²Œì„ì„ ì‹œì‘í• ê¹Œìš”?")) {
        const ev = events[id];
        const gCount = ev.mode === 'lightning' ? 6 : 4;

        db.ref('bowling_v14').update({
            'attendees': ev.attendees || [],
            'settings/mode': ev.mode,
            'settings/gameCount': gCount,
            'settings/currentTab': 'groupPanel' 
        }).then(() => {
            alert("ğŸ¯ ëª…ë‹¨ ë¡œë“œ ì™„ë£Œ! ì¡°í¸ì„± í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            const tabBtns = document.querySelectorAll('.tab-btn');
            if (tabBtns[1]) {
                window.showPanel('groupPanel', tabBtns[1]);
            }
        });
    }
};

    window.changeAssignMethod = function(val) {
        if(db) {
            db.ref('bowling_v14/settings').update({ assignMethod: val })
                .then(() => console.log("ì¡°í¸ì„± ë°©ì‹ ë³€ê²½ ì™„ë£Œ: " + val));
        }
    };
    window.showPanel = function(id, btn) {
    // 1. í™”ë©´ ì „í™˜ (íƒ­ í™œì„±í™”)
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // 2. ë²„íŠ¼ ìƒ‰ê¹” ë³€ê²½
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');

    // 3. ë‹¤ë¥¸ íƒ­ ê°”ë‹¤ê°€ ì˜¤ë©´ ì…ë ¥ íŒ€ ì„ íƒ í•´ì œ
    if(id !== 'inputPanel') currentInputTeam = null;

    // 4. ê° íƒ­ë³„ë¡œ ì‹¤í–‰í•´ì•¼ í•  ê¸°ëŠ¥ë“¤
    if(id === 'attendPanel') window.renderAttendanceList();
    if(id === 'progressPanel') window.renderGameProgress();
    if(id === 'statsPanel') window.renderAllStats(); 
    if(id === 'memberPanel') window.renderMembers();

    // â˜…â˜…â˜… [ì—¬ê¸°ê°€ ì¶”ê°€ëœ ë¶€ë¶„ì…ë‹ˆë‹¤!] ì¡°í¸ì„± íƒ­ ê¸°ëŠ¥ â˜…â˜…â˜…
    if(id === 'groupPanel') {
        // ê²Œì„ íƒ­(1G, 2G...) ê·¸ë¦¬ê¸°
        if(typeof window.renderAssignGameTabs === 'function') window.renderAssignGameTabs();
        // ë ˆì¸ ì„¤ì •ì°½(ì¸ì›ìˆ˜, íŒ€ë²ˆí˜¸) ê·¸ë¦¬ê¸°
        if(typeof window.renderCustomLaneConfig === 'function') window.renderCustomLaneConfig();
        // [í•µì‹¬] ë²ˆê°œì¥ ì„ íƒìš© ì°¸ì„ì ëª…ë‹¨ ê·¸ë¦¬ê¸°!
        if(typeof window.renderBungaeJangSelect === 'function') window.renderBungaeJangSelect();
    }

    // 5. ì ìˆ˜ ì…ë ¥ íƒ­ ì²˜ë¦¬
    if(id === 'inputPanel') {
        if(loggedInUser) {
            document.getElementById('scoreSection').style.display = 'block';
            window.renderInputs(); 
        } else {
            document.getElementById('scoreSection').style.display = 'none';
        }
    }
};

    window.goToInput = function(gameNo, teamNo) { 
        currentInputGame = gameNo;
        currentInputTeam = teamNo; 
        const tabBtns = document.querySelectorAll('.tab-btn');
        const inputTabBtn = tabBtns[4]; 
        window.showPanel('inputPanel', inputTabBtn); 
    };
    
    window.clickInputTab = function(btn) {
        currentInputTeam = null;
        window.showPanel('inputPanel', btn);
    };
    
    window.showAllTeams = function() {
        currentInputTeam = null;
        window.renderInputs();
    };

    

    window.renderAssignGameTabs = function() {
    const area = document.getElementById('assignGameTabs');
    if(!area) return;

    let html = '';
    const count = (settings.mode === 'regular') ? 4 : (settings.gameCount || 6);
    
    for(let i=1; i<=count; i++) {
        const isActive = (currentTargetGame === i) ? 'active' : '';
        html += `<div class="rank-tab ${isActive}" style="flex:1; text-align:center;" onclick="window.setTargetGame(${i})">${i}G</div>`;
    }
    area.innerHTML = html;
};

window.setTargetGame = function(gameNo) {
    currentTargetGame = gameNo;
    window.renderAssignGameTabs();
    if(window.renderCustomLaneConfig) window.renderCustomLaneConfig();
    console.log(`${gameNo}G ì¡°í¸ì„± ëª¨ë“œë¡œ ì „í™˜!`);
};

    

// 2. ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤ì œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ (ì—¬ê¸°ì„œ runAssignmentë¥¼ ë¶€ë¦…ë‹ˆë‹¤)
window.runGeneralAssignment = function() {
    if (gameTeams[currentTargetGame]) {
        return alert(`âš ï¸ ì´ë¯¸ ${currentTargetGame}G íŒ€ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    db.ref('bowling_v14/casino').once('value', sn => {
        if (sn.exists()) {
            alert("ğŸ° ì¹´ì§€ë…¸ ë°°ì • ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤!");
        } else {
            window.runAssignment(); // ğŸ‘ˆ ì—¬ê¸°ì„œ ìœ„ì˜ í•¨ìˆ˜ë¥¼ ë¶€ë¦…ë‹ˆë‹¤.
        }
    });
};
window.startCasinoAssignment = function() {
    if (gameTeams[currentTargetGame]) {
        return alert(`âš ï¸ ì´ë¯¸ ${currentTargetGame}G íŒ€ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒˆë¡œ í•˜ì‹œë ¤ë©´ [ğŸ—‘ï¸ ì´ˆê¸°í™”]ë¥¼ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
    }

    let teamList = [];
    for(let k in laneSettings) if(k.startsWith('team_') && laneSettings[k] > 0) teamList.push(laneSettings[k]);
    
    if(teamList.length === 0) {
        return alert("ë¨¼ì € ì•„ë˜ [3. ë ˆì¸ë³„ ì¸ì› ì„¤ì •] ì¹¸ì— íŒ€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ì¹´ì§€ë…¸ ë°°ì •ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
    }

    if(confirm(`${currentTargetGame}G ì¹´ì§€ë…¸ ë°°ì •ì„ ì‹œì‘í• ê¹Œìš”?`)) {
        db.ref('bowling_v14/settings').update({
            'currentTab': 'casinoPanel', // ğŸ‘ˆ 3. ì¹´ì§€ë…¸ë¡œ ì´ë™ ëª…ë ¹
            'currentAssignGame': currentTargetGame 
        }).then(() => {
            window.showPanel('casinoPanel', document.querySelectorAll('.tab-btn')[2]);
        });
    }
};

window.renderStatsGameTabs = function() {
    const area = document.getElementById('statsGameTabs');
    if (!area) return;
    let html = '';
    const count = settings.gameCount || 4; 
    for (let i = 1; i <= count; i++) {
        const isActive = (currentStatsGame === i) ? 'active' : '';
        html += `<div class="rank-tab ${isActive}" 
                     style="flex:1; text-align:center; cursor:pointer;" 
                     onclick="currentStatsGame=${i}; window.renderAllStats();">${i}G</div>`;
    }
    area.innerHTML = html;
};
window.renderCurrentGameStats = function() {
    const teamArea = document.getElementById('currentTeamRankTable');
    const indivArea = document.getElementById('currentIndivRankTable');
    if (!teamArea || !indivArea) return;

    const gData = gameTeams[currentStatsGame] || [];
    if (gData.length === 0) {
        teamArea.innerHTML = '<div style="padding:30px; text-align:center; color:#999;">ì…ë ¥ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        indivArea.innerHTML = '';
        return;
    }

    // 1. íŒ€ ìˆœìœ„ ê³„ì‚°
    let teamRanks = gData.map(t => {
        let sum = (parseInt(t.matchHandy) || 0);
        t.members.forEach(m => {
            const mInfo = members.find(x => x.name === m.name) || {};
            sum += (parseInt(m.score) || 0) + (m.name.includes("ê³ ìŠ¤íŠ¸") ? 0 : (parseInt(mInfo.handicap) || 0));
        });
        return { teamNo: t.teamNo, total: sum, members: t.members.map(m=>m.name).join(', ') };
    }).sort((a, b) => b.total - a.total);

    teamArea.innerHTML = `
        <table class="stats-table">
            <thead><tr><th>ìˆœìœ„</th><th>íŒ€ (ë©¤ë²„)</th><th>ì´ì </th></tr></thead>
            <tbody>
                ${teamRanks.map((tr, i) => `
                    <tr>
                        <td>${i === 0 ? 'ğŸ¥‡' : i + 1}</td>
                        <td style="text-align:left; padding-left:15px;">
                            <b style="color:#2c3e50;">Team ${tr.teamNo}</b><br>
                            <small style="color:#adb5bd;">[ ${tr.members} ]</small>
                        </td>
                        <td style="font-weight:bold; color:#3498db;">${tr.total}</td>
                    </tr>`).join('')}
            </tbody>
        </table>`;

    // 2. ê°œì¸ ìˆœìœ„ ê³„ì‚°
    let indivMap = {};
    const totalGameCount = settings.gameCount || 4; 

    // â˜… [ì—¬ê¸°ì„œë¶€í„° ìˆ˜ì •ë¨] gameHeaders ë³€ìˆ˜ ì •ì˜ ì¶”ê°€ â˜…
    let gameHeaders = "";
    for (let i = 1; i <= totalGameCount; i++) {
        gameHeaders += `<th>${i}G</th>`;
    }

    for (let g = 1; g <= totalGameCount; g++) {
        const teams = gameTeams[g] || [];
        teams.forEach(t => {
            t.members.forEach(m => {
                if (!indivMap[m.name]) {
                    const mInfo = members.find(x => x.name === m.name) || { handicap: 0 };
                    indivMap[m.name] = { 
                        name: m.name, 
                        scores: Array(totalGameCount).fill('-'), 
                        accumulatedTotal: 0,
                        gamesPlayed: 0,
                        handicap: (m.name.includes("ê³ ìŠ¤íŠ¸") ? 0 : (parseInt(mInfo.handicap) || 0)),
                        gender: mInfo.gender || 'ë‚¨'
                    };
                }
                const s = parseInt(m.score) || 0;
                if(s > 0) {
                    indivMap[m.name].scores[g-1] = s;
                    indivMap[m.name].accumulatedTotal += s;
                    indivMap[m.name].gamesPlayed += 1;
                }
            });
        });
    }

    const genderFilter = currentGenderFilter || 'all'; 

    let indivList = Object.values(indivMap)
        .filter(p => !p.name.includes("ê³ ìŠ¤íŠ¸")) 
        .filter(p => genderFilter === 'all' || p.gender === genderFilter)
        .map(p => {
            p.finalTotal = p.accumulatedTotal + (p.handicap * p.gamesPlayed);
            return p;
        }).sort((a, b) => b.finalTotal - a.finalTotal);

    indivArea.innerHTML = `
        <div style="overflow-x:auto;">
            <table class="stats-table" style="margin-top:10px; min-width:350px;">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th>ì´ë¦„</th>
                        ${gameHeaders} <th style="background:#fff5f5; color:#e74c3c;">í•©ê³„</th>
                    </tr>
                </thead>
                <tbody>
                    ${indivList.map((p, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td style="font-weight:bold; white-space:nowrap;">${p.name}</td>
                            ${p.scores.map((s, idx) => `
                                <td style="${(s >= 200) ? 'color:#e74c3c; font-weight:bold;' : ((idx+1) === currentStatsGame ? 'color:#222;' : 'color:#adb5bd;')} ${(idx+1) === currentStatsGame ? 'background:#e7f5ff;' : ''}">
                                    ${s}
                                </td>
                            `).join('')}
                            <td style="color:#e74c3c; font-weight:bold; background:#fff5f5;">${p.finalTotal}</td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>`;
};

window.renderHistoricalStats = function() {
    const area = document.getElementById('historicalStatsTable');
    if (!area || !loggedInUser) return;

    if (!records || records.length === 0) {
        area.innerHTML = '<div style="padding:30px; text-align:center; color:#999;">ê¸°ë¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let latestDateStr = records.reduce((max, r) => (r.date > max ? r.date : max), "1900-01-01");
    let cutoff = new Date(latestDateStr); 

    if (currentStatsPeriod === '1m') cutoff.setMonth(cutoff.getMonth() - 1);
    else if (currentStatsPeriod === '3m') cutoff.setMonth(cutoff.getMonth() - 3);
    else if (currentStatsPeriod === '6m') cutoff.setMonth(cutoff.getMonth() - 6);
    else if (currentStatsPeriod === '12m') cutoff.setMonth(cutoff.getMonth() - 12);
    else cutoff.setFullYear(1900);

    let statsMap = {};
    records.forEach(r => {
        if (new Date(r.date) >= cutoff && r.scs) {
            const name = (r.name || "").trim();
            if (!name) return;
            if (!statsMap[name]) statsMap[name] = { name: name, total: 0, count: 0 };
            r.scs.forEach(s => {
                if (parseInt(s) > 0) {
                    statsMap[name].total += parseInt(s);
                    statsMap[name].count++;
                }
            });
        }
    });

    let statsList = Object.values(statsMap).map(s => ({
        ...s,
        avg: s.count > 0 ? Math.round(s.total / s.count) : 0
    })).sort((a, b) => b.avg - a.avg);

    let html = `
        <div style="margin-bottom:10px; font-size:0.9rem; color:var(--accent); font-weight:bold; text-align:center; background:#f0f7ff; padding:10px; border-radius:8px; border:1px solid #d0e3ff;">
            ğŸ“Š í†µê³„ ê¸°ì¤€ì¼: ${latestDateStr}
        </div>
        <table class="stats-table">
            <thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ê²Œì„ìˆ˜</th><th>ì´ì </th><th>AVG</th></tr></thead>
            <tbody>`;

    html += statsList.map((s, i) => {
        const avgClass = (s.avg >= 200) ? 'class="over-200"' : '';
        return `
            <tr>
                <td>${i + 1}</td>
                <td style="font-weight:bold;">${s.name}</td>
                <td>${s.count}</td>
                <td>${s.total}</td>
                <td ${avgClass}>${s.avg}</td>
            </tr>`;
    }).join('');

    area.innerHTML = html + `</tbody></table>`;
};
window.setStatsPeriod = function(period, btn) {
    currentStatsPeriod = period;

    const filterBtns = document.querySelectorAll('#statsPanel .filter-btn');
    filterBtns.forEach(b => b.classList.remove('active')); 
    if (btn) btn.classList.add('active'); 

    console.log(`ğŸ“… í†µê³„ ê¸°ê°„ ë³€ê²½: ${period}`);
    window.renderAllStats(); 
};
window.renderTodayTotalRank = function() {
    const totalArea = document.getElementById('todayTotalRankTable');
    if (!totalArea) return;

    let totalMap = {};
    for (let i = 1; i <= settings.gameCount; i++) {
        (gameTeams[i] || []).forEach(t => {
            t.members.forEach(m => {
                if (!totalMap[m.name]) totalMap[m.name] = { name: m.name, totalScore: 0, gameCount: 0 };
                const s = parseInt(m.score) || 0;
                if (s > 0) { totalMap[m.name].totalScore += s; totalMap[m.name].gameCount++; }
            });
        });
    }

    let totalList = Object.values(totalMap).sort((a, b) => b.totalScore - a.totalScore);

    let totalHtml = `
        <table class="stats-table" style="border: 2px solid var(--danger); margin-top: 10px;">
            <thead style="background: #fff5f5;">
                <tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ê²Œì„ìˆ˜</th><th>ì´ì (í•©ê³„)</th></tr>
            </thead>
            <tbody>`;

    totalHtml += totalList.map((s, i) => {
        const totalClass = (s.totalScore >= 200) ? 'class="over-200"' : '';
        return `
            <tr style="${i === 0 ? 'background: #fff9db; font-weight: bold;' : ''}">
                <td>${i + 1}</td>
                <td>${i === 0 ? 'ğŸ‘‘ ' : ''}${s.name}</td>
                <td>${s.gameCount}G</td>
                <td ${totalClass}>${s.totalScore}</td>
            </tr>`;
    }).join('');

    totalArea.innerHTML = totalList.length ? (totalHtml + `</tbody></table>`) : '<div style="padding:20px; text-align:center; color:#999;">ì˜¤ëŠ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
};
        
    window.saveSettings = function() {
    const mode = document.getElementById('setMode') ? document.getElementById('setMode').value : settings.mode;
    const cnt = document.getElementById('setGameCount') ? parseInt(document.getElementById('setGameCount').value) : settings.gameCount;
    const avg = parseInt(document.getElementById('setAvgCriteria').value) || 6;
    const method = document.getElementById('setAssignMethod').value;

    if(db) {
        db.ref('bowling_v14/settings').update({
            mode: mode,
            gameCount: cnt,
            avgCriteria: avg,
            assignMethod: method
        }).then(() => {
            const methodKOR = method === 'snake' ? 'ğŸ ìŠ¤ë„¤ì´í¬' : (method === 'ai' ? 'ğŸ¤– AI ë°¸ëŸ°ìŠ¤' : 'ğŸ² ëœë¤');
            
            alert(`âœ… ìš´ì˜ ì„¤ì • ë³€ê²½ ì™„ë£Œ!\n\n` +
                  `ğŸ“… ê°€ì¤‘ì¹˜ ë°˜ì˜ ê¸°ê°„: ${avg}ê°œì›”\n` +
                  `âš–ï¸ ê¸°ë³¸ ì¡°í¸ì„± ë°©ì‹: ${methodKOR}\n\n` +
                  `[í™•ì¸]ì„ ëˆ„ë¥´ë©´ ì„¤ì •ì´ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤.`);
            
            location.reload(); 
        });
    }
};

    window.toggleZone = function(n) {
    if(selectedBlocks.includes(n)) {
        selectedBlocks = selectedBlocks.filter(x => x !== n);
    } else {
        selectedBlocks.push(n);
    }
    
    db.ref('bowling_v14/selectedBlocks').set(selectedBlocks);

    for(let i=1; i<=5; i++) {
        const b = document.getElementById('z'+i);
        if(b) {
            if(selectedBlocks.includes(i)) b.classList.add('selected');
            else b.classList.remove('selected');
        }
    }
    
    window.renderCustomLaneConfig();
};
    window.renderCustomLaneConfig = function() {
    const c = document.getElementById('laneConfigArea');
    if(!c) return;
    
    if(selectedBlocks.length === 0) { 
        c.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#999;">[1. êµ¬ì—­ ì„ íƒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>'; 
        return; 
    }

    let html = '';
    selectedBlocks.sort((a,b)=>a-b).forEach(z => {
        const start = (z-1)*4 + 3; 
        [start, start+1, start+2, start+3].forEach(l => {
            let valCnt = laneSettings['cnt_'+l] || 0; 
            let valTeam = laneSettings['team_'+l] || 0;
            
            html += `
<div class="lane-box-v13">
    <div class="lane-label" style="font-weight:bold; color:var(--purple);">${l}L</div>
    
    <input type="number" inputmode="numeric" class="lane-input" placeholder="ì¸ì›"
           value="${valCnt > 0 ? valCnt : ''}" 
           onfocus="window.isConfigEditing=true;" 
           onblur="window.isConfigEditing=false;" 
           onchange="window.updateConfig('cnt_${l}', this.value)"
           style="width: 100%; height:40px; text-align: center; border: 1px solid #ccc; font-size:1.2rem;">
    
    <input type="number" inputmode="numeric" class="lane-input" placeholder="íŒ€"
           value="${valTeam > 0 ? valTeam : ''}" 
           onfocus="window.isConfigEditing=true;" 
           onblur="window.isConfigEditing=false;" 
           onchange="window.updateConfig('team_${l}', this.value)"
           style="width: 100%; height:40px; text-align: center; border: 1px solid #ccc; font-size:1.2rem; background:#f9f9f9;">
</div>`; // <--- ì´ ë¶€ë¶„ì˜ ë°±í‹±(`)ê³¼ ì„¸ë¯¸ì½œë¡ (;)ì€ ì´ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤!
        });
    });
    c.innerHTML = html;
};

window.updateConfig = function(k, v) { 
    laneSettings[k] = parseInt(v) || 0; 
    
    if(db) {
        db.ref('bowling_v14/laneSettings').set(laneSettings)
            .then(() => {
                console.log("ë ˆì¸ ì„¤ì • ì €ì¥ ì™„ë£Œ");
                window.renderCustomLaneConfig(); 
            });
    } else {
        window.renderCustomLaneConfig(); 
    }
};
    
    // 1. [ì‹¤ë ¥ ê³„ì‚°] ê³µì‹ ì •ëª¨ 12íšŒ ê¸°ì¤€ 3:7 ê°€ì¤‘ì¹˜
window.getWeightedStats = function(name) {
    if (!name || name.includes("ê³ ìŠ¤íŠ¸")) return { weightedAvg: 0, simpleAvg12: 0 };
    const allDates = [...new Set(records.map(r => r.date))].sort().reverse().slice(0, 12);
    if (allDates.length === 0) return { weightedAvg: 0, simpleAvg12: 0 };
    const recentWindow = allDates.slice(0, 6);
    const pastWindow = allDates.slice(6, 12);
    let recentScores = [], pastScores = [], totalScores12 = [];
    records.filter(r => r.name === name && allDates.includes(r.date)).forEach(r => {
        if(r.scs) r.scs.forEach(s => {
            if (s > 0) {
                totalScores12.push(s);
                if (recentWindow.includes(r.date)) recentScores.push(s);
                else if (pastWindow.includes(r.date)) pastScores.push(s);
            }
        });
    });
    const getAvg = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
    const simpleAvg12 = Math.round(getAvg(totalScores12));
    const recentAvg = getAvg(recentScores);
    const pastAvg = getAvg(pastScores);
    let weightedAvg = (recentAvg > 0 && pastAvg > 0) ? Math.round((pastAvg * 0.3) + (recentAvg * 0.7)) : Math.round(recentAvg || pastAvg || simpleAvg12 || 0);
    return { weightedAvg: weightedAvg || 0, simpleAvg12: simpleAvg12 || 0 };
};

// 2. [ë°°ì • ì—”ì§„] 5ì¸ì¡° ê³ ì •, ì§€ê·¸ì¬ê·¸ ë ˆì¸, ìë™ í˜ì´ì§€ ì´ë™
window.runAssignment = function() {
    try {
        console.log("ğŸš€ [ì •ë°€ ë°°ì • ì—”ì§„] ê°€ë™ ì‹œì‘...");

        // 1. [ë ˆì¸ í™•ì¸] ê´€ë¦¬ìê°€ ìˆ«ìë¥¼ ì ì€ ë ˆì¸ë§Œ ì°¾ì•„ëƒ…ë‹ˆë‹¤.
        let targetLanes = [];
        let totalCapacity = 0;

        for (let l = 1; l <= 20; l++) {
            let cnt = parseInt(laneSettings['cnt_' + l]) || 0;
            let team = parseInt(laneSettings['team_' + l]) || 0;
            if (cnt > 0 && team > 0) {
                targetLanes.push({ lane: l, cap: cnt, teamNo: team });
                totalCapacity += cnt;
            }
        }

        if (targetLanes.length === 0) return alert("âŒ [3. ë ˆì¸ë³„ ì¸ì› ì„¤ì •]ì— ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        // 2. [ì°¸ì„ì ì¤„ ì„¸ìš°ê¸°]
        const rankingList = attendees
            .filter(n => n && !n.includes("ê³ ìŠ¤íŠ¸"))
            .map(name => ({
                name: name.trim(),
                avg: (typeof window.getWeightedStats === 'function') ? window.getWeightedStats(name).weightedAvg : 0
            }))
            if (settings.assignMethod === 'random') {
            console.log("ğŸ² ëœë¤ ëª¨ë“œ: ëª…ë‹¨ì„ ì™„ì „íˆ ë’¤ì„ìŠµë‹ˆë‹¤.");
            rankingList.sort(() => Math.random() - 0.5); // ë¬´ì‘ìœ„ ì…”í”Œ
        } else {
            console.log("ğŸ¤– AI ëª¨ë“œ: ì—ë²„ë¦¬ì§€ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ë°¸ëŸ°ìŠ¤ë¥¼ ë§ì¶¥ë‹ˆë‹¤.");
            rankingList.sort((a, b) => b.avg - a.avg); // ì‹¤ë ¥ìˆœ ì •ë ¬
        }

        // â˜… [ë¬¸ì œ2 í•´ê²°] ë¬´ì¡°ê±´ 5ëª…ì´ ì•„ë‹ˆë¼, 'ì„¤ì •ëœ ì¸ì›(totalCapacity)'ê¹Œì§€ë§Œ ê³ ìŠ¤íŠ¸ ìƒì„±!
        while(rankingList.length < totalCapacity) {
            rankingList.push({ name: "ğŸ‘»ê³ ìŠ¤íŠ¸", avg: 0, isGhost: true });
        }

        // 3. [íŒ€ ë°°ì • ë¡œì§]
        const uniqueTeamNos = [...new Set(targetLanes.map(tl => tl.teamNo))].sort((a,b)=>a-b);
        let finalTeams = uniqueTeamNos.map(tNo => ({
            teamNo: tNo, members: [], totalAvg: 0
        }));

        const T = uniqueTeamNos.length;
        let topT = rankingList.slice(0, T).sort(() => Math.random() - 0.5);
        let others = rankingList.slice(T);

        // (1) ëŒ€ì¥ ë°°ì¹˜
        finalTeams.forEach((team, i) => {
            const myLanes = targetLanes.filter(tl => tl.teamNo === team.teamNo);
            if (myLanes.length > 0 && topT[i]) {
                topT[i].lane = myLanes[0].lane;
                team.members.push(topT[i]);
                team.totalAvg += topT[i].avg;
            }
        });

        // (2) ë‚˜ë¨¸ì§€ ë°°ì¹˜
        others.forEach(player => {
            let bestTeam = finalTeams.find(t => {
                const teamCap = targetLanes.filter(tl => tl.teamNo === t.teamNo).reduce((sum, tl) => sum + tl.cap, 0);
                return t.members.length < teamCap;
            });

            if (bestTeam) {
                const myLanes = targetLanes.filter(tl => tl.teamNo === bestTeam.teamNo);
                let targetLaneObj = myLanes.find(lObj => {
                    const currentCount = bestTeam.members.filter(m => m.lane === lObj.lane).length;
                    return currentCount < lObj.cap;
                });
                if (targetLaneObj) {
                    player.lane = targetLaneObj.lane;
                    bestTeam.members.push(player);
                    bestTeam.totalAvg += player.avg;
                }
            }
        });

        // 4. [ë§ˆë¬´ë¦¬ ë° ì €ì¥]
        const maxAvg = Math.max(...finalTeams.map(t => t.totalAvg));
        finalTeams.forEach(t => t.matchHandy = Math.max(0, Math.round(maxAvg - t.totalAvg)));
        
        gameTeams[currentTargetGame] = finalTeams;

        // 2. [í•µì‹¬ ìˆ˜ë¦¬] íŒ€ ë°ì´í„° ì €ì¥ + í™”ë©´ ì´ë™ ëª…ë ¹ì„ í•œ ë²ˆì— ì „ì†¡!
        db.ref('bowling_v14').update({
            [`gameTeams/${currentTargetGame}`]: finalTeams, // íŒ€ ë°ì´í„° ì €ì¥
            'settings/currentTab': 'progressPanel',        // ì§„í–‰ íƒ­ìœ¼ë¡œ ì´ë™
            'settings/currentRankView': currentTargetGame  // í˜„ì¬ ê²Œì„ ë³´ê¸° ì„¤ì •
        }).then(() => {
            // 3. ë¡œì»¬ í™”ë©´ì„ ë¨¼ì € ì¦‰ì‹œ ì „í™˜ (ë§‰í˜ ì—†ì´!)
            const tabBtns = document.querySelectorAll('.tab-btn');
            window.showPanel('progressPanel', tabBtns[3]);

            // 4. ëª¨ë“  ì‘ì—…ì´ ëë‚œ ë’¤ì— ì•Œë¦¼ì„ ë„ì›ë‹ˆë‹¤.
            console.log("âœ… ë°ì´í„° ì €ì¥ ë° í™”ë©´ ì´ë™ ëª…ë ¹ ì™„ë£Œ");
            alert(`âœ… ${currentTargetGame}G ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }).catch(err => {
            // 5. ì—¬ê¸°ê°€ ê´€ë¦¬ìë‹˜ì´ ë¬¼ì–´ë³´ì‹  'ì˜¤ë¥˜ ë°œìƒ' ì²˜ë¦¬ êµ¬ì—­ì…ë‹ˆë‹¤!
            console.error("ğŸš¨ DB ì €ì¥ ì¤‘ ì‹¤íŒ¨:", err);
            alert("ğŸš¨ ì¸í„°ë„· ì—°ê²°ì´ë‚˜ ê¶Œí•œ ë¬¸ì œë¡œ ë°°ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err.message);
        });

    } catch (err) {
        // ì´ catchëŠ” ì½”ë“œ ìì²´ì˜ ë¬¸ë²• ì˜¤ë¥˜ë‚˜ ì‹¤í–‰ ì˜¤ë¥˜ë¥¼ ì¡ìŠµë‹ˆë‹¤.
        alert("ğŸš¨ ë¡œì§ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    }
};

// 3. [í™”ë©´ ì¶œë ¥] ê°€ë¡œ 2ì—´(ì¢Œ3:ìš°2), í™”ì‚´í‘œ, ê³ ìŠ¤íŠ¸ í•¸ë”” ë³µêµ¬
window.renderGameProgress = function() {
    const tBox = document.getElementById('progTabs');
    let tHtml = '';
    for(let i=1; i<=settings.gameCount; i++) tHtml += `<div class="rank-tab ${currentRankView===i?'active':''}" onclick="currentRankView=${i};window.renderGameProgress()">${i}G</div>`;
    tBox.innerHTML = tHtml;
    const gData = gameTeams[currentRankView] || [];
    const renderMem = (m, teamMatchHandy) => {
        if(!m) return "";
        const isG = m.name.includes("ê³ ìŠ¤íŠ¸");
        const s = window.getWeightedStats(m.name);
        const mInfo = members.find(x => x.name === m.name) || {};
        const h = isG ? (parseInt(teamMatchHandy) || 0) : (parseInt(mInfo.handicap) || 0);
        const total = (parseInt(m.score) || 0) + h;
        let arrow = '';
        if(!isG) {
            if(s.weightedAvg > s.simpleAvg12) arrow = '<span style="color:red;">â–²</span>';
            else if(s.weightedAvg < s.simpleAvg12) arrow = '<span style="color:blue;">â–¼</span>';
            else arrow = '<span style="color:#999;">-</span>';
        }
        return `
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f1f1f1; align-items:center;">
                <div style="line-height:1.2;">
                    <b style="font-size:1.05rem;">${m.name}</b><br>
                    <small style="color:#666;">${!isG ? `(${s.simpleAvg12 || 0}) <b>${s.weightedAvg || 0}</b> ${arrow}` : 'ê³ ìŠ¤íŠ¸'} <b style="color:#8e44ad; margin-left:4px;">H:${h}</b></small>
                </div>
                <div style="font-size:1.15rem; font-weight:bold;">${total}</div>
            </div>`;
    };
    const cardsHtml = gData.map(t => {
        let teamSum = (parseInt(t.matchHandy) || 0);
        t.members.forEach(m => teamSum += (parseInt(m.score) || 0) + (m.name.includes("ê³ ìŠ¤íŠ¸") ? 0 : (parseInt(members.find(x=>x.name===m.name)?.handicap) || 0)));
        const L = [t.members[0], t.members[2], t.members[4]]; // 1, 3, 5ìœ„
        const R = [t.members[1], t.members[3]]; // 2, 4ìœ„
        return `
            <div class="team-card" style="margin-bottom:20px; border:2px solid #6c5ce7; border-radius:12px; overflow:hidden; background:white;">
                <div class="team-header" onclick="window.goToInput(${currentRankView}, ${t.teamNo})" style="background:#6c5ce7; color:white; padding:10px 15px; display:flex; justify-content:space-between; align-items:center;">
                    <b>Team ${t.teamNo} <small>(ì—ë²„í•©:${t.totalAvg})</small></b>
                    <span style="background:white; color:#6c5ce7; padding:2px 10px; border-radius:15px; font-weight:bold;">ì´ì : ${teamSum}</span>
                </div>
                <div style="display: flex;">
                    <div style="flex: 1.1; border-right: 1px dashed #ddd; padding: 10px;">
                        <div style="text-align:center; font-weight:bold; color:#3498db; font-size:0.8rem; background:#f0f8ff; border-radius:4px; margin-bottom:5px;">${L[0]?.lane || '?'}L (ì¢Œ)</div>
                        ${L.map(m => renderMem(m, t.matchHandy)).join('')}
                    </div>
                    <div style="flex: 1; padding: 10px;">
                        <div style="text-align:center; font-weight:bold; color:#e67e22; font-size:0.8rem; background:#fff5eb; border-radius:4px; margin-bottom:5px;">${R[0]?.lane || '?'}L (ìš°)</div>
                        ${R.map(m => renderMem(m, t.matchHandy)).join('')}
                    </div>
                </div>
                ${t.matchHandy > 0 ? `<div style="font-size:0.75rem; color:#8e44ad; padding:4px; text-align:center; background:#f3f0ff; border-top:1px solid #eee; font-weight:bold;">ğŸ›¡ï¸ ë§¤ì¹˜ í•¸ë”” ë³´ë„ˆìŠ¤ +${t.matchHandy}</div>` : ''}
            </div>`;
    }).join('') || '<div style="text-align:center; padding:50px; color:#999;">ë°ì´í„° ì—†ìŒ</div>';
    document.getElementById('teamCardArea').innerHTML = cardsHtml;
};

    window.updateScore = function(n, v) { (gameTeams[currentInputGame]||[]).forEach(t => t.members.forEach(m => { if(m.name===n) m.score = parseInt(v); })); };
    
// ê¸°ì¡´ window.saveAllScores í•¨ìˆ˜ë¥¼ ì°¾ì•„ì„œ ì´ê±¸ë¡œ êµì²´í•˜ì„¸ìš”!
window.saveAllScores = function() {
    if(window.isSaving) return;
    window.isSaving = true;

    // 1. ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
    if (!gameTeams || Object.keys(gameTeams).length === 0) {
        window.isSaving = false;
        return alert("ğŸš¨ ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    }

    try {
        // â˜… [í•µì‹¬] ë°ì´í„° ì„¸íƒ ê³¼ì • (Undefined ì œê±°) â˜…
        // ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ ë°”ê¿¨ë‹¤ê°€ ë‹¤ì‹œ ê°ì²´ë¡œ ë§Œë“¤ë©´, 
        // ë¹„ì–´ìˆëŠ” ê°’ë“¤ì´ ìë™ìœ¼ë¡œ ì •ë¦¬ë˜ì–´ DBê°€ ì¢‹ì•„í•©ë‹ˆë‹¤.
        const cleanData = JSON.parse(JSON.stringify(gameTeams));

        let updates = {};
        updates['bowling_v14/gameTeams'] = cleanData;

        // í™”ë©´ ì´ë™ ì„¤ì •
        let nextGame = (currentInputGame || 1) + 1;
        const maxGame = settings.gameCount || 4;
        if (nextGame > maxGame) nextGame = currentInputGame;

        updates['bowling_v14/settings/currentTab'] = 'statsPanel';
        updates['bowling_v14/settings/currentStatsGame'] = currentInputGame;
        updates['bowling_v14/settings/currentAssignGame'] = nextGame;
        updates['bowling_v14/settings/currentRankView'] = currentInputGame;

        db.ref().update(updates)
            .then(() => {
                alert(`âœ… ${currentInputGame}G ì €ì¥ ì„±ê³µ!`);
                if(document.querySelectorAll('.tab-btn')[5]) {
                    window.showPanel('statsPanel', document.querySelectorAll('.tab-btn')[5]);
                }
            })
            .catch(err => {
                alert("âŒ ì €ì¥ ê±°ë¶€ë¨ (ì›ì¸: " + err.message + ")");
            })
            .finally(() => {
                window.isSaving = false;
            });

    } catch (e) {
        window.isSaving = false;
        alert("ì €ì¥ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜: " + e.message);
    }
};

window.filterCurrentStats = function(gender, btn) {
    currentGenderFilter = gender;
    document.querySelectorAll('#statsPanel .filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    window.renderCurrentGameStats();
};
window.deleteEvent = function(id) {
    if (confirm("âš ï¸ ì´ ëª¨ì„ ê³µì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?\nì‹ ì²­ ëª…ë‹¨ë„ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) {
        db.ref('bowling_v14/events/' + id).remove()
        .then(() => alert("âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."))
        .catch(err => alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + err));
    }
};
window.kickMember = function(eventId, userName) {
    if(!confirm(`[${userName}] ë‹˜ì„ ëª…ë‹¨ì—ì„œ ì œì™¸í• ê¹Œìš”?`)) return;
    
    const ev = events[eventId];
    if(!ev || !ev.attendees) return;
    
    const newList = ev.attendees.filter(n => n !== userName);
    
    db.ref(`bowling_v14/events/${eventId}/attendees`).set(newList)
      .then(() => alert(`${userName} ë‹˜ì´ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`));
};  
 window.logout = function() { localStorage.clear(); location.reload(); };
    window.checkGender = function(sel) {
        document.getElementById('newMemHandicap').value = (sel.value === 'ì—¬' ? 12 : 0);
    };

    window.addMember = function() {
        const nameInput = document.getElementById('newMemName');
        const genderInput = document.getElementById('newMemGender');
        const handicapInput = document.getElementById('newMemHandicap');
        const name = nameInput.value.trim();
        const gender = genderInput.value;
        const handicap = parseInt(handicapInput.value) || 0;
        if(!name) return alert("ì´ë¦„ ì…ë ¥!");
        db.ref('bowling_v14/members').push({ name: name, gender: gender, handicap: handicap, pw: '1234' }).then(() => location.reload());
    };
    
    window.renderAttendanceList = function() {
    const a = document.getElementById('attendListArea');
    if(!a) return;
    const sorted = members.filter(m => m.status !== 'íƒˆí‡´').sort((a,b) => a.name.localeCompare(b.name));
    a.innerHTML = sorted.map(m => {
        const is = attendees.includes(m.name); 
            const nameStyle = is ? 'color:var(--green); font-weight:bold; font-size:1.2rem;' : 'color:#333; font-size:1.2rem;';
        const btnStyle = is ? 'background:var(--green); color:white; border-color:var(--green);' : 'background:#fff; color:#333; border-color:#ddd;';
        
        return `<div class="member-row" style="padding:12px;">
            <span style="${nameStyle}">${m.name}</span>
            <button class="btn-sm" style="${btnStyle}" onclick="window.toggleAtt('${m.name}')">${is?'ì°¸ì„ì¤‘':'ì°¸ì„'}</button>
        </div>`;
           }).join('');
        if(document.getElementById('attCount')) document.getElementById('attCount').innerText = attendees.length;
    };

    
// ========================================================
// ğŸŸ¡ [ìˆ˜ì •] ì´ë²¤íŠ¸ ì°¸ì„ ì‹ ì²­ (ê´€ë¦¬ì ëŒ€ë¦¬ ì‹ ì²­ ê¸°ëŠ¥ ì¶”ê°€)
// ========================================================
window.toggleEventJoin = function(id, userName) {
    // userNameì´ ì¸ìë¡œ ë“¤ì–´ì˜¤ë©´ ê·¸ ì´ë¦„ì„ ì“°ê³ , ì—†ìœ¼ë©´ ë¡œê·¸ì¸í•œ ë³¸ì¸ ì´ë¦„ì„ ì”ë‹ˆë‹¤.
    const targetName = (userName || loggedInUser || "").trim();
    
    if(!targetName) return alert("íšŒì› ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

    // ê´€ë¦¬ìê°€ ì•„ë‹Œë° ë‹¤ë¥¸ ì‚¬ëŒì„ ì¶”ê°€í•˜ë ¤ê³  í•˜ë©´ ë§‰ìŠµë‹ˆë‹¤.
    if (!isAdmin && targetName !== loggedInUser) {
        return alert("ğŸš« ë³¸ì¸ë§Œ ì‹ ì²­ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    }

    let list = (events[id] && events[id].attendees) ? [...events[id].attendees] : [];
    
    if(list.includes(targetName)) {
        // ì´ë¯¸ ìˆìœ¼ë©´ ëª…ë‹¨ì—ì„œ ì œê±°
        list = list.filter(n => n !== targetName);
    } else {
        // ì—†ìœ¼ë©´ ëª…ë‹¨ì— ì¶”ê°€
        list.push(targetName);
    }
    
    db.ref('bowling_v14/events/' + id + '/attendees').set(list).then(() => {
        if(userName) alert(`âœ… ${targetName} ë‹˜ ì²˜ë¦¬ ì™„ë£Œ!`);
    });
};

    

    window.deleteMember = function(key) { if(confirm("ì‚­ì œ?")) db.ref('bowling_v14/members/' + key).remove(); };
    window.deleteAllData = function() { if(confirm("ì´ˆê¸°í™”?")) db.ref('bowling_v14').remove().then(() => location.reload()); };
    window.resetAttendance = function() { if(confirm("ì´ˆê¸°í™”?")) db.ref('bowling_v14/attendees').set([]); };
    window.closeModal = function() { document.getElementById('modalOverlay').style.display='none'; };
    window.showAttendeePopup = function() { document.getElementById('modalOverlay').style.display='flex'; document.getElementById('modalTitle').innerText = `ì°¸ì„ì (${attendees.length}ëª…)`; document.getElementById('modalContent').innerHTML = attendees.join(', '); };
    window.toggleMode = function() {
    
    const nextMode = settings.mode === 'regular' ? 'lightning' : 'regular';
    
    const nextGameCount = (nextMode === 'lightning') ? 6 : 4;

    db.ref('bowling_v14/settings').update({ 
        mode: nextMode, 
        gameCount: nextGameCount, 
        currentTab: 'groupPanel'
    }).then(() => {
        const modeName = nextMode === 'lightning' ? 'âš¡ë²ˆê°œ(6G)' : 'âš–ï¸ì •ê¸°(4G)';
        alert(`${modeName} ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    });
};
    window.resetAssignment = function() {
    const myName = (loggedInUser || "").trim();
    const isBoss = isAdmin || (managers.jungmo === myName) || (managers.lightning === myName);

    if (!isBoss) {
        return alert("ğŸš« ì´ˆê¸°í™” ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    }

    const gIdx = currentTargetGame; 
    if (confirm(`âš ï¸ [ì™„ì „ ì´ˆê¸°í™”] í˜„ì¬ [${gIdx}G]ì˜ íŒ€ ë°°ì • ê²°ê³¼ì™€\nì…ë ¥ëœ 'ë ˆì¸/íŒ€ ì„¤ì •'ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        
        let updates = {};
        // 1. ê²°ê³¼ ì‚­ì œ
        updates[`bowling_v14/gameTeams/${gIdx}`] = null;
        updates['bowling_v14/casino'] = null;
        updates['bowling_v14/managers/lightning'] = null;

        // 2. [í•µì‹¬ ìˆ˜ì •] ë ˆì¸ ì„¤ì •ê³¼ êµ¬ì—­ ì„ íƒë„ ì‚­ì œ
        updates['bowling_v14/laneSettings'] = null; 
        updates['bowling_v14/selectedBlocks'] = null; 
        updates['bowling_v14/settings/currentAssignGame'] = 1;

        db.ref().update(updates).then(() => {
            // ë¡œì»¬ ë³€ìˆ˜ë„ ì¦‰ì‹œ ë¹„ì›€ (í™”ë©´ ê°±ì‹ ìš©)
            if(gameTeams[gIdx]) delete gameTeams[gIdx];
            laneSettings = {};
            selectedBlocks = [];

            // êµ¬ì—­ ë²„íŠ¼ ìƒ‰ê¹” ë¹¼ê¸°
            document.querySelectorAll('.zone-btn').forEach(b => b.classList.remove('selected'));

            alert(`âœ… ${gIdx}G ë°°ì • ê²°ê³¼ì™€ ì„¤ì •ì´ ê¹¨ë—í•˜ê²Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // í™”ë©´ ì¦‰ì‹œ ê°±ì‹ 
            if(window.renderCustomLaneConfig) window.renderCustomLaneConfig();
            if(window.renderAssignGameTabs) window.renderAssignGameTabs();
            if(window.updateUI) window.updateUI(); 
        });
    }
};
    window.saveHistory = function() { if(!gameTeams[currentRankView]) return; const h = { date: new Date().toISOString().split('T')[0], game: currentRankView, teams: gameTeams[currentRankView] }; db.ref('bowling_v14/history').push(h).then(() => alert("ì €ì¥ë¨")); };
    
 window.viewHistory = function() { db.ref('bowling_v14/history').limitToLast(5).once('value', sn => { const val = sn.val(); if(!val) return alert("ê¸°ë¡ì—†ìŒ"); let msg = "ğŸ“œ ìµœê·¼ê¸°ë¡\n"; Object.values(val).reverse().forEach(h => msg += `[${h.date} ${h.game}G]\n`); alert(msg); }); };
    
window.exportData = function() {
    if(!confirm("í˜„ì¬ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    db.ref('bowling_v14').once('value', sn => {
        const data = sn.val();
        if(!data) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        const fileName = `AceBowling_Backup_${new Date().toISOString().split('T')[0]}.json`;
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert("âœ… ë°±ì—… íŒŒì¼(JSON)ì´ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
};

window.importData = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm("âš ï¸ ì£¼ì˜: ì´ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ í˜„ì¬ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ê³  íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.\nì •ë§ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        event.target.value = ''; 
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if(!importedData.members && !importedData.records) {
                throw new Error("ì˜¬ë°”ë¥¸ ì—ì´ìŠ¤ ë³¼ë§ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
            }

            db.ref('bowling_v14').set(importedData).then(() => {
                alert("ğŸ‰ ë°ì´í„° ë³µêµ¬ ì„±ê³µ! ì•±ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                location.reload();
            });
        } catch (err) {
            alert("âŒ JSON ì½ê¸° ì‹¤íŒ¨: íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.\n(ì—ëŸ¬ë‚´ìš©: " + err.message + ")");
        }
    };
    reader.readAsText(file);
};;
window.downloadExcel = function() {
    db.ref('bowling_v14/records').once('value', (snapshot) => {
        const records = snapshot.val();
        if (!records) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        const allDates = [...new Set(Object.values(records).map(r => r.date))].sort();
        const allNames = [...new Set(Object.values(records).map(r => r.name))].sort();

        const header1 = ["ì´ë¦„", "í‰ê· ", "í•©ê³„"];
        const header2 = ["", "", ""];
        
        allDates.forEach(date => {
            header1.push(date, "", "", ""); 
            header2.push("1G", "2G", "3G", "4G");
        });

        const excelRows = [header1, header2];

        allNames.forEach(name => {
            const row = [name];
            let totalSum = 0;
            let totalGames = 0;
            const scoreCells = [];

            allDates.forEach(date => {
                const key = `${date}_${name.replace(/[.#$/[\]]/g, "_")}`;
                const rec = records[key];
                
                if (rec && rec.scs) {
                    const scs = rec.scs;
                    scoreCells.push(scs[0] || "", scs[1] || "", scs[2] || "", scs[3] || "");
                    totalSum += scs.reduce((a, b) => a + (parseInt(b) || 0), 0);
                    totalGames += scs.length;
                } else {
                    scoreCells.push("", "", "", ""); 
                }
            });

            const avg = totalGames > 0 ? (totalSum / totalGames).toFixed(1) : 0;
            row.push(avg, totalSum, ...scoreCells);
            excelRows.push(row);
        });

        const worksheet = XLSX.utils.aoa_to_sheet(excelRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "ì „ì²´ê¸°ë¡");

        const dateStr = new Date().toISOString().split('T')[0];
        XLSX.writeFile(workbook, `ì—ì´ìŠ¤ë³¼ë§_ì¥ë¶€_${dateStr}.xlsx`);
    });
};
window.deleteToday = function() {
    if (confirm("âš ï¸ [ì£¼ì˜] ì˜¤ëŠ˜ ìƒì„±ëœ 1~6G ì¡°í¸ì„±ê³¼ ì ìˆ˜ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(íšŒì› ëª…ë‹¨ê³¼ ê°€ì¤‘ì¹˜ ì„¤ì •ì€ ì•ˆì „í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.)")) {
        
        const check = prompt("ì •ë§ ì‚­ì œí•˜ì‹œë ¤ë©´ 'ì‚­ì œ'ë¼ê³  ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        
        if (check === "ì‚­ì œ") {
            db.ref('bowling_v14/gameTeams').remove()
                .then(() => {
                    alert("âœ… ì˜¤ëŠ˜ì˜ ëª¨ë“  ê²Œì„ ê¸°ë¡(1~6G)ì´ ê¹”ë”í•˜ê²Œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload(); 
                })
                .catch(err => alert("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err));
        } else {
            alert("âŒ ì…ë ¥ì´ í‹€ë ¸ìŠµë‹ˆë‹¤. ì‚­ì œë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤.");
        }
    }
};

    window.deleteAllData = function() {
        if (confirm("ğŸš¨ [ê²½ê³ ] íšŒì› ëª…ë‹¨, ëª¨ë“  ê³¼ê±° ê¸°ë¡, ì„¤ì •ì´ í†µì§¸ë¡œ ë‚ ì•„ê°‘ë‹ˆë‹¤!")) {
            const check = prompt("ë°ì´í„°ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í•˜ë ¤ë©´ 'ì‚­ì œ'ë¼ê³  ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            if (check === "ì‚­ì œ") {
                db.ref('bowling_v14').remove()
                    .then(() => {
                        alert("ğŸ’¥ ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì„ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.");
                        location.reload();
                    })
                    .catch(err => alert("âŒ ì´ˆê¸°í™” ì˜¤ë¥˜: " + err));
            } else {
                alert("ì…ë ¥ì´ í‹€ë ¸ìŠµë‹ˆë‹¤. ì‚­ì œë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤.");
            }
        }
    };

    window.resetAttendance = function() {
        if (confirm("ğŸ”„ í˜„ì¬ ì°¸ì„ ì²´í¬ëœ ì¸ì›ë“¤ì„ ëª¨ë‘ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            db.ref('bowling_v14/attendees').set([])
                .then(() => {
                    alert("âœ… ì°¸ì„ ëª…ë‹¨ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    if(window.renderAttendanceList) window.renderAttendanceList();
                })
                .catch(err => alert("âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: " + err));
        }
    };

    
    window.uploadExcel = function() {
        alert("ì—‘ì…€ ì¼ê´„ ë“±ë¡ ê¸°ëŠ¥ì€ í˜„ì¬ ê°œë°œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
    };
/* ğŸ’¾ [ì €ì¥ëœ ë¡œì§ ì ìš©] 
   - ì „ì²´ íšŒì›ì´ ì•„ë‹Œ, 'ì˜¤ëŠ˜ ì°¸ì„ì' ê¸°ì¤€ ìƒëŒ€í‰ê°€ 
   - íŒ€ ìˆ˜(T)ì— ë”°ë¼ ìœ ë™ì ìœ¼ë¡œ ë“±ê¸‰ ë¶€ì—¬ (ì ˆëŒ€í‰ê°€ X)
*/
window.getMyTier = function() {
    const myName = (loggedInUser || "").trim();
    if(!myName || !attendees.length) return null;
    
    // 1. [ì˜¤ëŠ˜ì˜ ì¤„ ì„¸ìš°ê¸°] ì°¸ì„ìë§Œ ì—ë²„ìˆœ ì •ë ¬
    const rankingList = attendees
        .filter(n => !n.includes("ê³ ìŠ¤íŠ¸")) 
        .map(name => {
            const stats = window.getWeightedStats(name);
            return { name: name.trim(), avg: parseFloat(stats.weightedAvg) || 0 };
        });
    rankingList.sort((a, b) => b.avg - a.avg); // 1ë“±ì´ ë§¨ ì•

    const myRank = rankingList.findIndex(player => player.name === myName);
    if(myRank === -1) return null;

    // 2. [ì˜¤ëŠ˜ì˜ ì»¤íŠ¸ë¼ì¸] íŒ€ ìˆ˜(T) ê³„ì‚°
    // (ë ˆì¸ ì„¤ì •ì´ ì—†ì–´ë„ ì°¸ì„ì ìˆ˜ì— ë§ì¶° ìë™ìœ¼ë¡œ ë¹„ìœ¨ì„ ë‚˜ëˆ•ë‹ˆë‹¤)
    let teamList = [];
    for(let k in laneSettings) {
        if(k.startsWith('team_') && parseInt(laneSettings[k]) > 0) {
            teamList.push(parseInt(laneSettings[k]));
        }
    }
    
    // ê¸°ë³¸ì ìœ¼ë¡œ ì„¤ì •ëœ íŒ€ ìˆ˜ë¥¼ ë”°ë¥´ë˜, 
    // ì„¤ì •ì´ ì—†ê±°ë‚˜ ì´ìƒí•˜ë©´ 'ì „ì²´ ì¸ì› / 4'ë¡œ ìë™ ê³„ì‚°í•˜ì—¬ ìœ ë™ì„±ì„ ì¤ë‹ˆë‹¤.
    let T = [...new Set(teamList)].length;
    if (T < 1) T = Math.ceil(rankingList.length / 4); 
    if (T < 1) T = 1; // ìµœì†Œ ë°©ì–´ ì½”ë“œ

    // 3. [ìƒëŒ€í‰ê°€ íŒì •] ë‚´ ë“±ìˆ˜ê°€ ì»¤íŠ¸ë¼ì¸ ì•ˆìª½ì¸ê°€?
    if(myRank < T) return 'red';               // ìƒìœ„ 1ê·¸ë£¹
    if(myRank < T * 2) return 'blue';          // ìƒìœ„ 2ê·¸ë£¹ (3~4ë“±ë„ ì—¬ê¸° í¬í•¨ë¨!)
    if(myRank < T * 3) return 'green';         // ìƒìœ„ 3ê·¸ë£¹
    return 'yellow';                           // ë‚˜ë¨¸ì§€
};

window.initCasino = function() {
    const myName = (loggedInUser || "").trim();
    if(!isAdmin && managers.jungmo !== myName) return alert("ğŸš« ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    if(!attendees || attendees.length === 0) return alert("ì°¸ì„ìë¥¼ ë¨¼ì € ì²´í¬í•´ì£¼ì„¸ìš”.");

    let teamPools = {}; 
    let maxTeamSize = 0; // íŒ€ë‹¹ ìµœëŒ€ ì¸ì›ìˆ˜ í™•ì¸ìš©

    // 1. ì„¤ì •ëœ ë ˆì¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ íŒ€ë³„ ìë¦¬ë¥¼ ëª¨ìë‹ˆë‹¤.
    selectedBlocks.forEach(z => {
        const start = (z - 1) * 4 + 3;
        for(let l = start; l < start + 4; l++) {
            let count = parseInt(laneSettings['cnt_' + l]) || 0;
            let teamNum = parseInt(laneSettings['team_' + l]) || 0;
            
            if(count > 0 && teamNum > 0) {
                if(!teamPools[teamNum]) teamPools[teamNum] = [];
                for(let i = 0; i < count; i++) {
                    teamPools[teamNum].push(l); 
                }
                if(teamPools[teamNum].length > maxTeamSize) maxTeamSize = teamPools[teamNum].length;
            }
        }
    });

    const uniqueTeamNos = Object.keys(teamPools).sort((a,b) => a-b);
    const T = uniqueTeamNos.length; 

    if(T === 0) return alert("ğŸš© ì¡°í¸ì„± í•˜ë‹¨ì— 'íŒ€ ë²ˆí˜¸'ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤!");

    // 2. ì¹´ì§€ë…¸ ìƒíƒœ ì´ˆê¸°í™” (Yellow ì´í›„ ë“±ê¸‰ë„ ìˆ˜ìš© ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„)
    let casinoState = { 
        settings: { status: 'open', totalSlots: attendees.length }, 
        red: {}, blue: {}, green: {}, yellow: {} 
    };

    // ê° íŒ€ì˜ ë ˆì¸ë“¤ì„ ëœë¤í•˜ê²Œ ì„ìŠµë‹ˆë‹¤.
    uniqueTeamNos.forEach(tNo => teamPools[tNo].sort(() => Math.random() - 0.5));

    // 3. [í•µì‹¬] íŒ€ë‹¹ ìµœëŒ€ ì¸ì›ìˆ˜(ì˜ˆ: 5ëª…)ë§Œí¼ ë°˜ë³µí•˜ë©° ì¹©ì„ ìƒì„±í•©ë‹ˆë‹¤.
    const tiers = ['red', 'blue', 'green', 'yellow', 'yellow']; // 4, 5ë²ˆì§¸ëŠ” ëª¨ë‘ ë…¸ë€ìƒ‰

    for(let round = 0; round < maxTeamSize; round++) {
        const currentTier = tiers[round] || 'yellow'; // 5ë²ˆì§¸ ì´í›„ë„ ë…¸ë€ìƒ‰ ì²˜ë¦¬
        let tierLanes = []; 

        uniqueTeamNos.forEach((tNo) => {
            if(teamPools[tNo] && teamPools[tNo].length > 0) {
                tierLanes.push(teamPools[tNo].shift());
            }
        });

        // ê°™ì€ ë“±ê¸‰ ë‚´ì—ì„œë„ ë ˆì¸ì´ ì„ì´ë„ë¡ ëœë¤ ì…”í”Œ
        tierLanes.sort(() => Math.random() - 0.5);

        tierLanes.forEach((laneNum, idx) => {
            // ê¸°ì¡´ ì¹© ê°œìˆ˜ë¥¼ í™•ì¸í•˜ì—¬ ë‹¤ìŒ ID ë¶€ì—¬
            const nextId = Object.keys(casinoState[currentTier]).length + 1;
            casinoState[currentTier][nextId] = {
                status: 'idle',
                owner: '',
                lane: laneNum
            };
        });
    }

    // 4. DB ì €ì¥
    db.ref('bowling_v14/casino').set(casinoState).then(() => {
        alert(`ğŸ° ì¹© ìƒì„± ì™„ë£Œ!\n- ì°¸ì—¬ì¸ì›: ${attendees.length}ëª…\n- 5ì¸ì¡° ëŒ€ì‘ ì¹© ì„¸íŒ…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    });
};
window.renderCasino = function() {
    db.ref('bowling_v14/casino').once('value', sn => {
        const data = sn.val() || {};
        ['red', 'blue', 'green', 'yellow'].forEach(tier => {
            const container = document.getElementById('chips_' + tier);
            const zone = document.getElementById('zone_' + tier);
            if (!container) return;

            const chips = data[tier] || {};
            const chipKeys = Object.keys(chips);

            if (zone) zone.style.display = (chipKeys.length > 0) ? 'block' : 'none';
            container.innerHTML = ''; 

            chipKeys.forEach(id => {
                const c = chips[id];
                const isPicked = c.status === 'picked';
                
                const div = document.createElement('div');
                div.className = `chip ${tier} ${isPicked ? 'selected' : ''}`;
                div.onclick = () => { if(!isPicked) window.pickChip(tier, id); };
                
                div.innerHTML = `
                    <div class="chip-inner">
                        <div class="chip-num" style="font-size: 1.3rem; font-weight: 900; color: #333;">
                            ${isPicked ? c.lane + 'L' : ''} 
                        </div>
                        <div class="chip-owner" style="color:var(--danger); font-size:11px; font-weight:bold; margin-top:2px;">
                            ${isPicked ? c.owner : ''}
                        </div>
                    </div>`;
                container.appendChild(div);
            });
        });
    });
};
/* ìˆ˜ì •ëœ ì—„ê²©í•œ ì¹© ì„ íƒ í•¨ìˆ˜ 
   - ì •ëª¨ì¥/ë²ˆê°œì¥ë„ ì˜ˆì™¸ ì—†ìŒ! ë¬´ì¡°ê±´ ìê¸° ìƒ‰ê¹”ë§Œ ì„ íƒ ê°€ëŠ¥
   - ì˜¤ì§ 'ì° ê´€ë¦¬ì'ë§Œ ì•„ë¬´ê±°ë‚˜ ì„ íƒ ê°€ëŠ¥
*/
window.pickChip = function(tier, id) {
    const myTier = window.getMyTier(); 
    const myName = (loggedInUser || "").trim();
    
    // [ìˆ˜ì •] ê´€ë¦¬ì ì˜ˆì™¸ ì‚­ì œ: ëˆ„êµ¬ë‚˜ ìê¸° í‹°ì–´ ì¹©ë§Œ ì„ íƒ ê°€ëŠ¥
    if (!myTier) return alert("ğŸš« ëª…ë‹¨ì— ì—†ëŠ” ìœ ì €ì…ë‹ˆë‹¤. (ì°¸ì„ ì²´í¬ í™•ì¸)");
    
    if (tier !== myTier) {
        return alert(`âš–ï¸ ê·œì¹™ ì¤€ìˆ˜!\níšŒì›ë‹˜ì€ ì˜¤ì§ [${myTier.toUpperCase()}] ì¹©ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    }

    db.ref('bowling_v14/casino').once('value', sn => {
        const data = sn.val() || {};
        let alreadyPicked = false;
        ['red', 'blue', 'green', 'yellow'].forEach(t => {
            if(data[t]) {
                Object.values(data[t]).forEach(c => { if(c.owner === myName) alreadyPicked = true; });
            }
        });

        if(alreadyPicked) return alert("ğŸš« ì´ë¯¸ ì¹©ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.");

        const chipRef = db.ref(`bowling_v14/casino/${tier}/${id}`);
        chipRef.transaction(current => {
            if(current && current.status === 'idle') {
                return { ...current, status: 'picked', owner: myName };
            }
            return; 
        }, (err, committed) => {
            if(!committed) alert("âš ï¸ ë‹¤ë¥¸ ë¶„ì´ ë¨¼ì € ì„ íƒí–ˆìŠµë‹ˆë‹¤!");
        });
    }); 
}; 

// ê¸°ì¡´ window.finishCasino í•¨ìˆ˜ë¥¼ ì°¾ì•„ì„œ ì´ê±¸ë¡œ í†µì§¸ë¡œ ë°”ê¾¸ì„¸ìš”!
window.finishCasino = function() {
    const myName = (loggedInUser || "").trim();
    const isBoss = isAdmin || (managers.jungmo === myName) || (managers.lightning === myName);
    if (!isBoss) return alert("ğŸš« ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

    if (!confirm("ë°°ì •ì„ ì¢…ë£Œí•˜ê³  ì§„í–‰ í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?")) return;

    db.ref('bowling_v14/casino').once('value', sn => {
        const data = sn.val() || {};
        
        // ... (ì¤‘ê°„ ìƒëµ: ì¹© ê³„ì‚° ë¡œì§ì€ ê·¸ëŒ€ë¡œ ë‘ ) ...
        // í¸ì˜ìƒ ì´ ë¶€ë¶„ì€ ê¸°ì¡´ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ, 
        // â˜…â˜…â˜… ì•„ë˜ì˜ db.ref ì €ì¥ ë¶€ë¶„ë§Œ í™•ì‹¤í•˜ê²Œ í™•ì¸í•´ì£¼ì„¸ìš”! â˜…â˜…â˜…

        let pickedOwners = [];
        ['red', 'blue', 'green', 'yellow', 'purple'].forEach(t => {
            if(data[t]) Object.values(data[t]).forEach(c => { if(c.status==='picked') pickedOwners.push(c.owner); });
        });
        let unpickedPeople = attendees.filter(name => !pickedOwners.includes(name));
        let finalTeamsMap = {}; 
        
        ['red', 'blue', 'green', 'yellow', 'purple'].forEach(tier => {
            if(!data[tier]) return;
            Object.values(data[tier]).forEach(c => {
                const teamNum = parseInt(laneSettings['team_' + c.lane]);
                if(!teamNum) return;
                if(!finalTeamsMap[teamNum]) finalTeamsMap[teamNum] = { teamNo: teamNum, members: [], totalAvg: 0, matchHandy: 0 };
                
                let isPicked = (c.status === 'picked');
                let memberName = isPicked ? c.owner : (unpickedPeople.length > 0 ? unpickedPeople.shift() : "ğŸ‘»ê³ ìŠ¤íŠ¸");
                let stats = window.getWeightedStats(memberName);
                let mInfo = members.find(x => x.name === memberName.trim()) || { handicap: 0 };
                let weightedAvg = memberName.includes("ê³ ìŠ¤íŠ¸") ? 0 : stats.weightedAvg;

                finalTeamsMap[teamNum].members.push({
                    name: memberName, lane: c.lane, avg: weightedAvg,
                    handy: parseInt(mInfo.handicap) || 0, score: 0, isGhost: memberName.includes("ê³ ìŠ¤íŠ¸")
                });
                finalTeamsMap[teamNum].totalAvg += weightedAvg;
            });
        });

        const teamArr = Object.values(finalTeamsMap).sort((a,b) => a.teamNo - b.teamNo);
        const maxAvg = Math.max(...teamArr.map(t => t.totalAvg)); 
        teamArr.forEach(t => t.matchHandy = (t.totalAvg < maxAvg) ? Math.round(maxAvg - t.totalAvg) : 0);
            
        // ... ì¹© ì •ì‚° ë¡œì§ ëë‚œ í›„ ...
        db.ref(`bowling_v14/gameTeams/${currentTargetGame}`).set(teamArr).then(() => {
            db.ref('bowling_v14/settings').update({
                'currentTab': 'progressPanel', // ğŸ‘ˆ 4. ì§„í–‰ìœ¼ë¡œ ì´ë™ ëª…ë ¹
                'currentRankView': currentTargetGame
            }).then(() => {
                db.ref('bowling_v14/casino').set(null);
                window.showPanel('progressPanel', document.querySelectorAll('.tab-btn')[3]);
                alert(`âœ… ${currentTargetGame}G ì¹´ì§€ë…¸ ë°°ì • ì¢…ë£Œ!`);
            });
        });
});
};
window.nextTeam = function(lane, current) {
    let next = (current >= 8) ? 0 : current + 1;
    window.updateConfig('team_' + lane, next);
};
    const now = new Date();
const offset = now.getTimezoneOffset() * 60000;
const finalToday = new Date(now.getTime() - offset).toISOString().split('T')[0];
    if(document.getElementById('progDate')) document.getElementById('progDate').value = finalToday;
    if(document.getElementById('inputDate')) document.getElementById('inputDate').value = finalToday;

(function() {
    const el = document.getElementById('excelInput');
    if (!el) return;

    el.onclick = function() { this.value = null; };

    el.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        alert("ğŸ“Š íŒŒì¼ì„ ì½ê³  ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...");

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (rows.length < 2) return alert("âŒ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");

                const headers = rows[0];
                const dataRows = rows.slice(1);
                
                let lastDate = "";
                const dateMap = headers.map((h, i) => {
                    if (i < 3) return null; 
                    if (h) {
                        let d = h.toString().split('.')[0].trim();
                        if(d.length === 8) d = `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`;
                        lastDate = d;
                    }
                    return lastDate;
                });

                let promises = []; 
                let memCnt = 0;

                dataRows.forEach((row) => {
                    const name = (row[2] || "").toString().trim();
                    if (!name || name === "ì´ë¦„") return;

                    if (!members.some(m => m.name === name)) {
                        promises.push(db.ref('bowling_v14/members').push({ name, gender: 'ë‚¨', handicap: 0, pw: '1234' }));
                        memCnt++;
                    }

                    let dayScores = {};
                    dateMap.forEach((date, idx) => {
                        if (!date) return;
                        const s = parseInt(row[idx]);
                        if (!isNaN(s) && s > 0) {
                            if (!dayScores[date]) dayScores[date] = [];
                            dayScores[date].push(s);
                        }
                    });

                    Object.keys(dayScores).forEach(date => {
                        const key = `${date}_${name.replace(/[.#$/[\]]/g, "_")}`;
                        promises.push(db.ref(`bowling_v14/records/${key}`).set({ 
                            date: date, name: name, scs: dayScores[date] 
                        }));
                    });
                });

                Promise.all(promises).then(() => {
                    alert(`âœ… ì—…ë¡œë“œ ì™„ë£Œ!\n- ì‹ ê·œ ë“±ë¡: ${memCnt}ëª…\n- ì´ ${promises.length}ê±´ì˜ ê¸°ë¡ì´ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();
                }).catch(err => {
                    alert("âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
                });

            } catch (err) {
                alert("âŒ ì—‘ì…€ íŒë… ì—ëŸ¬: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    };
})();

window.updateMember = function(key, name, currentHandy, currentGender) {
    const newGender = prompt(`${name}ë‹˜ì˜ ì„±ë³„ì„ ì…ë ¥í•˜ì„¸ìš” (ë‚¨/ì—¬):`, currentGender || 'ë‚¨');
    if (newGender === null) return;

    const newHandy = prompt(`${name}ë‹˜ì˜ ìƒˆë¡œìš´ í•¸ë””ìº¡ì„ ì…ë ¥í•˜ì„¸ìš”:`, currentHandy);
    if (newHandy === null) return;

    db.ref('bowling_v14/members/' + key).update({ 
        gender: newGender, 
        handicap: parseInt(newHandy) || 0 
    }).then(() => alert("âœ… ì •ë³´ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
};

window.updatePw = function(key, name, currentPw) {
    const newPw = prompt(`${name}ë‹˜ì˜ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, currentPw);
    if (newPw) {
        db.ref('bowling_v14/members/' + key).update({ pw: newPw })
          .then(() => alert("âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."));
    }
};

window.deleteMember = function(key, name) {
    if(confirm(`ğŸš¨ [${name}] íšŒì›ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ê¸°ë¡ì´ ì‚¬ë¼ì§€ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        db.ref('bowling_v14/members/' + key).remove()
          .then(() => alert("ğŸ—‘ï¸ ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
    }
};

window.renderMembers = function() { 
    const area = document.getElementById('memberListArea'); 
    if(!area) return; 

    if(!members || members.length === 0) {
        area.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">íšŒì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
        return;
    }

    area.innerHTML = members.sort((a,b)=>a.name.localeCompare(b.name)).map(m => `
        <div class="member-row" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <div style="display:flex; flex-direction:column;">
                <b style="font-size:1.2rem; color:#333;">${m.name}</b>
                <span style="font-size:0.9rem; color:#666;">
                    ${m.gender || 'ë‚¨'} / <span style="color:var(--purple); font-weight:bold;">H:${m.handicap || 0}</span>
                </span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-sm" style="background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:5px;" 
                    onclick="window.updateMember('${m.key}', '${m.name}', ${m.handicap}, '${m.gender||'ë‚¨'}')">ìˆ˜ì •</button>
                
                <button class="btn-sm" style="background:var(--warning); color:white; border:none; padding:8px 12px; border-radius:5px;" 
                    onclick="window.updatePw('${m.key}', '${m.name}', '${m.pw||'1234'}')">ë¹„ë²ˆ</button>
                
                <button class="btn-sm" style="background:var(--danger); color:white; border:none; padding:8px 12px; border-radius:5px;" 
                    onclick="window.deleteMember('${m.key}', '${m.name}')">ì‚­ì œ</button>
            </div>
        </div>
    `).join(''); 
};
// =========================================================
// 1. [ë³µêµ¬] ì •ê¸° ëª¨ì„ ì €ì¥ í•¨ìˆ˜ (ì´ê²Œ ê¹¨ì ¸ ìˆì—ˆìŠµë‹ˆë‹¤)
// =========================================================


// =========================================================
// 2. [ì‹ ê·œ] ë²ˆê°œ íˆìŠ¤í† ë¦¬ ê¸°ëŠ¥ (ì €ì¥/ê°ì§€/ë¶ˆëŸ¬ì˜¤ê¸° í†µí•©)
// =========================================================

// =========================================================
// ğŸŸ¡ [ìµœì¢… ìˆ˜ì •] ë²ˆê°œ íˆìŠ¤í† ë¦¬ (ê¸°ì–µë ¥ ê°•í™” ë²„ì „)
// =========================================================

// ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„°ë¥¼ ë‹´ì•„ë‘¡ë‹ˆë‹¤ (ì´ê²Œ ê¸°ì–µë ¥ì˜ í•µì‹¬!)
window.lightningHistoryCache = null;

// =========================================================
// ğŸŸ¡ [ìµœì¢… ì •ë°€ ìˆ˜ì •] ë²ˆê°œ íˆìŠ¤í† ë¦¬ ê¸°ëŠ¥ (ì €ì¥ ë° ì‹¤ì‹œê°„ í‘œì‹œ)
// =========================================================

// 1. ë°ì´í„°ë¥¼ ë‹´ì•„ë‘˜ ì „ì—­ ì£¼ë¨¸ë‹ˆ (íŒŒì¼ ìµœìƒë‹¨ì´ ì•„ë‹ˆì–´ë„ ì‘ë™í•˜ë„ë¡ ì—¬ê¸°ì— ë°°ì¹˜)
window.lightningHistoryCache = null;

// 2. ë²ˆê°œ ê¸°ë¡ ì €ì¥ í•¨ìˆ˜
window.saveLightningHistory = function() {
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const today = new Date(now.getTime() - offset).toISOString().split('T')[0];

    if(!confirm(`${today} ë²ˆê°œ ê¸°ë¡ì„ íˆìŠ¤í† ë¦¬ì— ë³´ê´€í• ê¹Œìš”?\n(ê°œì¸ ì—ë²„ì—ëŠ” ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)`)) return;

    // í˜„ì¬ í™”ë©´ì— ìˆëŠ” íŒ€/ì ìˆ˜ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ì„œë²„ì— ë³´ëƒ…ë‹ˆë‹¤.
    db.ref('bowling_v14/lightning_history/' + today).set({
        date: today,
        gameTeams: gameTeams, // ì „ì—­ ë³€ìˆ˜ gameTeams ì‚¬ìš©
        settings: settings || {} 
    }).then(() => {
        alert("ğŸ¯ ë²ˆê°œ íˆìŠ¤í† ë¦¬ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        // ì €ì¥ì´ ì™„ë£Œë˜ë©´ ì„œë²„ ê°ì‹œì(Listener)ê°€ ì•Œì•„ì„œ ë²„íŠ¼ì„ ìƒˆë¡œ ê·¸ë¦½ë‹ˆë‹¤.
    }).catch(err => {
        alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + err.message);
    });
};

// 3. [í•µì‹¬] ì‹¤ì‹œê°„ ê°ì‹œì (ì„œë²„ì— ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ë©´ ì¦‰ì‹œ ì£¼ë¨¸ë‹ˆì— ë„£ê³  ë²„íŠ¼ ê·¸ë¦¬ê¸°)
db.ref('bowling_v14/lightning_history').on('value', sn => {
    const data = sn.val();
    window.lightningHistoryCache = data || {}; // ì£¼ë¨¸ë‹ˆì— ì €ì¥
    
    // ë§Œì•½ í˜„ì¬ í†µê³„ í˜ì´ì§€ë¥¼ ë³´ê³  ìˆë‹¤ë©´ ë²„íŠ¼ì„ ì¦‰ì‹œ ê·¸ë ¤ì¤ë‹ˆë‹¤.
    if(typeof window.renderLightningHistoryButtons === 'function') {
        window.renderLightningHistoryButtons();
    }
});

// 4. ë‚ ì§œ ë²„íŠ¼ ëª©ë¡ ê·¸ë¦¬ê¸° (í†µê³„ íƒ­ ì—´ ë•Œ í˜¸ì¶œë¨)
window.renderLightningHistoryButtons = function() {
    const btnArea = document.getElementById('lightningDateButtons');
    if(!btnArea) return; // ë²„íŠ¼ ë„£ì„ ìë¦¬ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨

    const data = window.lightningHistoryCache;
    if(!data) {
        btnArea.innerHTML = '<span style="font-size:0.8rem; color:#ccc; padding:5px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>';
        return;
    }

    const dates = Object.keys(data).sort().reverse().slice(0, 4); // ìµœì‹ ìˆœ 4ê°œ

    if(dates.length === 0) {
        btnArea.innerHTML = '<span style="font-size:0.8rem; color:#ccc; padding:5px;">ğŸ“­ ê¸°ë¡ ì—†ìŒ</span>';
        return;
    }

    btnArea.innerHTML = dates.map(date => {
        const shortDate = date.split('-').slice(1).join('/');
        return `
            <button class="filter-btn" 
                style="padding:6px 14px; font-size:0.8rem; flex-shrink:0; margin-right:5px; background:#fcc419; color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1);" 
                onclick="window.loadLightningHistory('${date}')">
                ğŸ“‚ ${shortDate}
            </button>`;
    }).join('');
};

// 5. ê³¼ê±° ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ë²„íŠ¼ í´ë¦­ ì‹œ)
window.loadLightningHistory = function(date) {
    const historyData = window.lightningHistoryCache ? window.lightningHistoryCache[date] : null;
    
    if(!historyData || !historyData.gameTeams) {
        return alert("âš ï¸ í•´ë‹¹ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    if(!confirm(`ğŸ“‚ [${date}] ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ í™”ë©´ì˜ ì ìˆ˜ëŠ” ì‚¬ë¼ì§€ê³  ê³¼ê±° ê¸°ë¡ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.`)) return;

    // ë°ì´í„° êµì²´
    gameTeams = historyData.gameTeams;
    if(historyData.settings) settings = historyData.settings;

    alert(`âœ… ${date} ê¸°ë¡ ë³µì› ì™„ë£Œ!`);

    // í™”ë©´ ìƒˆë¡œê³ ì¹¨ (í†µê³„ íƒ­ ë‚´ìš© ê°±ì‹ )
    if(typeof window.renderAllStats === 'function') window.renderAllStats();
    
    // í†µê³„ íƒ­ìœ¼ë¡œ ê°•ì œ ì´ë™
    const tabBtns = document.querySelectorAll('.tab-btn');
    if(tabBtns[5]) window.showPanel('statsPanel', tabBtns[5]); 
};
/* ==========================================================================
   ğŸš€ [ì…ë ¥ ìµœì í™” íŒ¨ì¹˜] ì ìˆ˜ ì…ë ¥ ì‹œ ëŠê¹€ ë° ë°ì´í„° ì¦ë°œ ë°©ì§€ ì‹œìŠ¤í…œ
   ========================================================================== */

// 1. ì…ë ¥ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ì „ì—­ ë³€ìˆ˜ (ë°©ì–´ë§‰)
window.isScoreEditing = false;

// 2. ê¸°ì¡´ì˜ ë©ì²­í•œ ê°ì‹œìë¥¼ ë„ê³ , ë˜‘ë˜‘í•œ ê°ì‹œìë¡œ êµì²´í•©ë‹ˆë‹¤.
// (ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆê°€ ì¤‘ë³µ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ë¨¼ì € ì—°ê²°ì„ ëŠìŠµë‹ˆë‹¤)
if (db) {
    db.ref('bowling_v14').off(); 

    // âœ… [ìˆ˜ë¦¬ ì™„ë£Œ] í†µí•© ë°ì´í„° ê°ì‹œì
db.ref('bowling_v14').on('value', sn => {
    const val = sn.val() || {};
    
    members = val.members ? Object.keys(val.members).map(k => ({ ...val.members[k], key: k })) : [];
    attendees = val.attendees || [];
    records = val.records ? Object.keys(val.records).map(k => ({ ...val.records[k], key: k })) : [];
    events = val.events || {};

    // [í•µì‹¬] ì…ë ¥ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ íŒ€ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì ìˆ˜ ì¦ë°œì„ ë§‰ìŠµë‹ˆë‹¤.
    if (!window.isScoreEditing) {
        gameTeams = val.gameTeams || {};
    }

    if(val.settings) settings = val.settings;
    if(val.managers) managers = val.managers; 
    if(val.laneSettings) laneSettings = val.laneSettings; 
    if(val.selectedBlocks) selectedBlocks = val.selectedBlocks; 

    if (!window.initialLoadDone) {
        window.currentTargetGame = 1; 
        window.initialLoadDone = true; 
    }

    if (typeof window.updateUI === 'function' && !window.isScoreEditing) {
        window.updateUI();
    }
});
}

// 3. ì…ë ¥ì°½ ê·¸ë¦¬ê¸° í•¨ìˆ˜ ì—…ê·¸ë ˆì´ë“œ (í¬ì»¤ìŠ¤ ê°ì§€ ê¸°ëŠ¥ ì¶”ê°€)
window.renderInputs = function() {
    // 1. ì…ë ¥ ì¤‘ì¼ ë•ŒëŠ” í™”ë©´ì„ ìƒˆë¡œ ê·¸ë¦¬ì§€ ì•ŠìŒ (ìíŒ ìœ ì§€)
    if (window.isScoreEditing) return;

    const tabs = document.getElementById('inputTabs');
    let tHtml = '';
    const count = settings.gameCount || 4;
    for(let i=1; i<=count; i++) {
        tHtml += `<div class="rank-tab ${currentInputGame===i?'active':''}" onclick="currentInputGame=${i};window.renderInputs()">${i}G</div>`;
    }
    tabs.innerHTML = tHtml;

    const area = document.getElementById('inputGridArea');
    let gData = gameTeams[currentInputGame] || [];
    
    // íŒ€ í•„í„°ë§ (íŠ¹ì • íŒ€ë§Œ ë³´ê¸° ì„ íƒ ì‹œ)
    if(currentInputTeam) gData = gData.filter(t => t.teamNo == currentInputTeam);

    if (!gData || gData.length === 0) {
        area.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">âš ï¸ ë°°ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let h = '';
    gData.forEach(t => {
        h += `<div class="input-team-box">
                <div class="input-team-header">Team ${t.teamNo}</div>`;
        
        t.members.forEach(m => {
            const isG = m.name.includes("ê³ ìŠ¤íŠ¸") || m.isGhost;
            
            h += `
            <div class="score-row" style="display:flex; justify-content:space-between; align-items:center; padding:10px 15px; border-bottom:1px solid #eee;">
                <span class="score-name" style="flex:1; font-size:1.1rem; font-weight:bold; color:#333;">
                    ${m.name}
                </span>

                <input type="number" inputmode="numeric" pattern="[0-9]*" class="score-input"
                       value="${m.score||0}" 
                       ${isG ? 'readonly style="background:#f1f3f5; color:#777;"' : ''}
                       onfocus="window.isScoreEditing=true; if(this.value=='0') this.value='';" 
                       onblur="window.isScoreEditing=false;" 
                       oninput="if(this.value.length > 3) this.value = this.value.slice(0, 3); window.updateScore('${m.name}', this.value)"
                       style="width:80px; height:45px; font-size:1.5rem; text-align:center; border:2px solid #ccc; border-radius:8px;">
            </div>`;
        });
        h += `</div>`;
    });
    area.innerHTML = h;
};

// 4. [ë³´ë„ˆìŠ¤] ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹œ ë¶ˆí•„ìš”í•œ ì—°ì‚° ìµœì†Œí™”
window.updateScore = function(n, v) { 
    // ë¡œì»¬ ë°ì´í„°ë§Œ ë¹ ë¥´ê²Œ ë°”ê¿‰ë‹ˆë‹¤. (ì„œë²„ ì „ì†¡ X -> onblurì—ì„œ ì €ì¥)
    const teams = gameTeams[currentInputGame] || [];
    for(let t of teams) {
        for(let m of t.members) {
            if(m.name === n) {
                m.score = parseInt(v) || 0;
                return; // ì°¾ì•˜ìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ (ì†ë„ í–¥ìƒ)
            }
        }
    }
};
window.regularHistoryCache = null;

// ì‹¤ì‹œê°„ ê°ì‹œì
db.ref('bowling_v14/regular_history').on('value', sn => {
    window.regularHistoryCache = sn.val() || {};
    if(typeof window.renderRegularHistoryButtons === 'function') window.renderRegularHistoryButtons();
});

// ì •ëª¨ íˆìŠ¤í† ë¦¬ ë²„íŠ¼ ê·¸ë¦¬ê¸°
window.renderRegularHistoryButtons = function() {
    const btnArea = document.getElementById('regularDateButtons');
    if(!btnArea || !window.regularHistoryCache) return;

    const dates = Object.keys(window.regularHistoryCache).sort().reverse().slice(0, 4);
    if(dates.length === 0) {
        btnArea.innerHTML = '<span style="font-size:0.8rem; color:#ccc;">ğŸ“­ ê¸°ë¡ ì—†ìŒ</span>';
        return;
    }

    btnArea.innerHTML = dates.map(date => {
        const shortDate = date.split('-').slice(1).join('/');
        return `
            <button class="filter-btn" 
                style="padding:6px 14px; font-size:0.8rem; flex-shrink:0; background:#fa5252; color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer;" 
                onclick="window.loadRegularHistory('${date}')">
                ğŸ† ${shortDate}
            </button>`;
    }).join('');
};

// ì •ëª¨ íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
window.loadRegularHistory = function(date) {
    const historyData = window.regularHistoryCache ? window.regularHistoryCache[date] : null;
    if(!historyData || !historyData.gameTeams) return alert("âš ï¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    if(!confirm(`ğŸ† [${date}] ì •ê¸°ëª¨ì„ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ í™”ë©´ì˜ ì ìˆ˜ê°€ ê³¼ê±° ê¸°ë¡ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.`)) return;

    gameTeams = historyData.gameTeams;
    if(historyData.settings) settings = historyData.settings;
    alert(`âœ… ${date} ì •ê¸°ëª¨ì„ ê¸°ë¡ ë³µì› ì™„ë£Œ!`);
    window.renderAllStats();
};
/* ===============================================================
   [ëˆ„ë½ëœ ë¶€í’ˆ ì¶”ê°€] ì •ê¸°ëª¨ì„ íˆìŠ¤í† ë¦¬ ì €ì¥ ë° í™”ë©´ í‘œì‹œ ê¸°ëŠ¥
   =============================================================== */

// 1. [ì €ì¥] ì •ëª¨ ì ìˆ˜ ì €ì¥ ì‹œ 'íˆìŠ¤í† ë¦¬'ë„ í•¨ê»˜ ë°±ì—…í•˜ëŠ” ìµœì‹  ë²„ì „
window.finalizeToRecords = function() {
    if(!confirm("ì˜¤ëŠ˜ì˜ ëª¨ë“  ê²Œì„ ì ìˆ˜ë¥¼ ê°œì¸ ì¥ë¶€ì— ì˜êµ¬ ì €ì¥í•˜ê³ ,\nì˜¤ëŠ˜ì˜ íŒ€ êµ¬ì„±(ì •ëª¨ íˆìŠ¤í† ë¦¬)ë„ í•¨ê»˜ ë³´ê´€í• ê¹Œìš”?")) return;

    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const today = new Date(now.getTime() - offset).toISOString().split('T')[0];
    
    let updates = {};
    let saveCount = 0;
    let memberScores = {};

    // 1~4G(í˜¹ì€ 6G) ì ìˆ˜ ì·¨í•©
    for (let g = 1; g <= settings.gameCount; g++) {
        const teams = gameTeams[g] || [];
        teams.forEach(t => {
            t.members.forEach(m => {
                if (m.name.includes("ê³ ìŠ¤íŠ¸") || m.isGhost) return;
                if (!memberScores[m.name]) memberScores[m.name] = [];
                memberScores[m.name].push(parseInt(m.score) || 0);
            });
        });
    }

    // ì¥ë¶€ ê¸°ë¡ ìƒì„±
    Object.keys(memberScores).forEach(name => {
        const scs = memberScores[name];
        if (scs.some(s => s > 0)) {
            const safeKey = `${today}_${name.replace(/[.#$/[\]]/g, "_")}`;
            updates[`bowling_v14/records/${safeKey}`] = {
                date: today, name: name, scs: scs
            };
            saveCount++;
        }
    });

    if (saveCount === 0) return alert("ì €ì¥í•  ì ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

    // ğŸ¯ [í•µì‹¬] ì •ê¸°ëª¨ì„ ìŠ¤ëƒ…ìƒ· ì €ì¥ (ì´ ë¶€ë¶„ì´ ìˆì–´ì•¼ ê³¼ê±° ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!)
    updates[`bowling_v14/regular_history/${today}`] = {
        date: today,
        gameTeams: gameTeams,
        settings: settings
    };

    db.ref().update(updates).then(() => {
        alert(`ğŸ‰ ì„±ê³µ! ${saveCount}ëª…ì˜ ê¸°ë¡ ì €ì¥ ë° ì •ëª¨ íˆìŠ¤í† ë¦¬ ë³´ê´€ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        location.reload(); 
    }).catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err));
};

// 2. [í™”ë©´] í†µê³„ í˜ì´ì§€ì— 'ì •ëª¨ ê¸°ë¡(ë¹¨ê°•)'ê³¼ 'ë²ˆê°œ ê¸°ë¡(ë…¸ë‘)' ë²„íŠ¼ì„ ê°™ì´ ë³´ì—¬ì£¼ëŠ” ìµœì‹  ë²„ì „
window.renderAllStats = function() {
    if(typeof window.renderHistoricalStats === 'function') window.renderHistoricalStats();
    if(typeof window.renderStatsGameTabs === 'function') window.renderStatsGameTabs();
    if(typeof window.renderCurrentGameStats === 'function') window.renderCurrentGameStats(); 

    const panel = document.getElementById('statsPanel');
    if(!panel) return;

    // ê¸°ì¡´ íˆìŠ¤í† ë¦¬ ì˜ì—­ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
    const oldNav = document.getElementById('historyNavContainer');
    if(oldNav) oldNav.remove();
    const oldLight = document.getElementById('lightningHistoryNav'); // êµ¬í˜• ì”ì¬ ì œê±°
    if(oldLight) oldLight.remove();

    const navDiv = document.createElement('div');
    navDiv.id = 'historyNavContainer';
    
    navDiv.style.cssText = "margin-bottom:20px; padding:15px; background:#f8f9fa; border-radius:12px; border:1px solid #eee;";
    navDiv.innerHTML = `
        <div style="margin-bottom:12px;">
            <div style="font-size:0.8rem; color:#e03131; font-weight:bold; margin-bottom:5px;">ğŸ“… ìµœê·¼ ì •ê¸°ëª¨ì„ ê¸°ë¡</div>
            <div id="regularDateButtons" style="display:flex; gap:8px; overflow-x:auto; padding-bottom:5px;">
                 <span style="font-size:0.8rem; color:#ccc;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        </div>
        <div>
            <div style="font-size:0.8rem; color:#fab005; font-weight:bold; margin-bottom:5px;">âš¡ ìµœê·¼ ë²ˆê°œ ê¸°ë¡</div>
            <div id="lightningDateButtons" style="display:flex; gap:8px; overflow-x:auto; padding-bottom:5px;">
                 <span style="font-size:0.8rem; color:#ccc;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        </div>
    `;
    panel.prepend(navDiv);

    // ë²„íŠ¼ ê·¸ë¦¬ê¸° ì‹¤í–‰
    if(typeof window.renderRegularHistoryButtons === 'function') window.renderRegularHistoryButtons();
    if(typeof window.renderLightningHistoryButtons === 'function') window.renderLightningHistoryButtons();

    // í•˜ë‹¨ ì €ì¥ ë²„íŠ¼ êµ¬ì—­ (ê´€ë¦¬ì ì „ìš©)
    const totalRankArea = document.getElementById('todayTotalRankTable');
    if(totalRankArea && isAdmin) {
        const oldFinalize = document.getElementById('finalizeBtnArea');
        if(oldFinalize) oldFinalize.remove();
        const oldLightning = document.getElementById('lightningSaveArea');
        if(oldLightning) oldLightning.remove();

        const btnDiv = document.createElement('div');
        btnDiv.style.margin = "30px 0 10px 0";
        
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ë²„íŠ¼ ë‹¤ë¥´ê²Œ í‘œì‹œ
        if (settings.mode === 'regular') {
            btnDiv.id = 'finalizeBtnArea';
            btnDiv.innerHTML = `
                <div style="background:#fff5f5; border:2px solid #ff8787; padding:15px; border-radius:12px; text-align:center;">
                    <p style="margin:0 0 12px 0; font-weight:bold; color:#e03131;">ğŸ“… ì˜¤ëŠ˜ ì •ëª¨ ì„±ì ì„ ìµœì¢… ì €ì¥í• ê¹Œìš”?</p>
                    <button class="universal-btn" style="background:#e03131; margin-bottom:0;" onclick="window.finalizeToRecords()">ğŸ“¥ ì •ëª¨ ìµœì¢… ì €ì¥ (ì—ë²„ ë°˜ì˜ + íˆìŠ¤í† ë¦¬ ë³´ê´€)</button>
                </div>`;
        } else {
            btnDiv.id = 'lightningSaveArea';
            btnDiv.innerHTML = `
                <div style="background:#fff9db; border:2px solid #fab005; padding:15px; border-radius:12px; text-align:center;">
                    <p style="margin:0 0 12px 0; font-weight:bold; color:#856404;">âš¡ ì˜¤ëŠ˜ ë²ˆê°œ ê¸°ë¡ì„ íˆìŠ¤í† ë¦¬ì— ë³´ê´€í• ê¹Œìš”?</p>
                    <button class="universal-btn" style="background:#fab005; color:#000; margin-bottom:0;" onclick="window.saveLightningHistory()">ğŸ“¥ ë²ˆê°œ ê¸°ë¡ ë³´ê´€ (ì—ë²„ ë¯¸ë°˜ì˜)</button>
                </div>`;
        }
        totalRankArea.parentNode.insertBefore(btnDiv, totalRankArea);
    }
};
// 1. [ì‹ ê·œ] ì¡°ìš©íˆ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (ì…ë ¥ì°½ ì´ë™í•  ë•Œ ì”€)
window.silentSave = function() {
    // ì•Œë¦¼ì°½(Alert) ì—†ì´ ë°ì´í„°ë§Œ ì¡°ìš©íˆ ì„œë²„ì— ë³´ëƒ…ë‹ˆë‹¤.
    db.ref('bowling_v14/gameTeams').set(gameTeams).then(() => {
        console.log("ìë™ ì €ì¥ ì™„ë£Œ (ì¡°ìš©í•¨)");
    });
};
// ì¹´í†¡ìš© ë§í¬ ë³µì‚¬ í•¨ìˆ˜
window.copyKakaoLink = function(id, date, mode) {
    const modeK = mode === 'regular' ? 'âš–ï¸ì •ê¸°ëª¨ì„' : 'âš¡ë²ˆê°œëª¨ì„';
    const jumpUrl = `https://beumjookim.github.io/ilsanacebc/index.html?eventId=${id}`;
    const text = `ğŸ³ [ì¼ì‚° ì—ì´ìŠ¤] ëª¨ì„ ì•ˆë‚´\n\nğŸ“… ì¼ì‹œ: ${date}\n${modeK}\n\nğŸ‘‡ ì•„ë˜ ë§í¬ë¥¼ ëˆ„ë¥´ë©´ ë°”ë¡œ ì‹ ì²­ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤!\n${jumpUrl}`;
    
    navigator.clipboard.writeText(text).then(() => {
        alert("âœ… ì¹´í†¡ìš© ê³µì§€ ë¬¸êµ¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nëŒ€í™”ë°©ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ì„¸ìš”.");
    });
};

// íŠ¹ì • ì´ë²¤íŠ¸ë¡œ ìë™ ìŠ¤í¬ë¡¤ ì í”„ í•¨ìˆ˜
window.jumpToSpecificEvent = function() {
    const targetId = sessionStorage.getItem('jumpToEvent');
    if (!targetId) return;

    setTimeout(() => {
        const element = document.getElementById('event_' + targetId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            element.style.border = "3px solid #fcc419"; // ë°˜ì§ ê°•ì¡°
            setTimeout(() => { element.style.border = "none"; }, 3000);
            sessionStorage.removeItem('jumpToEvent'); // ì í”„ í›„ ê¸°ì–µ ì‚­ì œ
        }
    }, 1000);
};
// --- ì—¬ê¸°ë¶€í„° íŒŒì¼ ëê¹Œì§€ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ---

  // 1. ì¹´ì¹´ì˜¤ ì—´ì‡ (í‚¤) ê½‚ê¸° 
  try {
    if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
      Kakao.init('fa7a8ba02d5835b0aa4183eac217cb7a'); 
      console.log("ì¹´ì¹´ì˜¤ ì´ˆê¸°í™” ì„±ê³µ");
    }
  } catch (e) {
    console.log("ì´ˆê¸°í™” ì²´í¬ ì¤‘");
  }

  
// ğŸ” ì´ ë¶€ë¶„ì„ ë³µì‚¬í•´ì„œ ê¸°ì¡´ ê³µì§€ ê´€ë ¨ í•¨ìˆ˜ ìë¦¬ì— ë®ì–´ì“°ì„¸ìš”

// í˜„ì¬ ì–´ë–¤ ê³µì§€ë¥¼ ë³´ë‚´ëŠ”ì§€ ì €ì¥í•˜ëŠ” ë³€ìˆ˜
let currentNoticeType = 'app'; 

// ê³µì§€ì°½ ì—´ê¸° (ğŸ“¢ ë˜ëŠ” ğŸ’¬ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œ ì‹¤í–‰ë¨)
function openNoticePanel(type) {
    currentNoticeType = type;
    const panel = document.getElementById('admin-notice-panel');
    const titleInput = document.getElementById('noticeTitle');
    const imgInput = document.getElementById('noticeImg');
    const linkInput = document.getElementById('noticeLink');

    panel.style.display = 'block';

    // ì£¼ì†Œ ë’¤ì— /ê°€ ë¹ ì§€ë©´ 404 ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìœ¼ë‹ˆ ì •í™•í•œ ì£¼ì†Œë¥¼ ë„£ìŠµë‹ˆë‹¤.
    if (type === 'app') {
        titleInput.value = "ğŸ³ [ì°¸ì„ ì‹ ì²­] ì˜¤ëŠ˜ ëª¨ì„ ìˆìŠµë‹ˆë‹¤!";
        imgInput.value = "https://beumjookim.github.io/ilsanacebc/ace.png"; 
        linkInput.value = "https://beumjookim.github.io/ilsanacebc/"; 
    } else {
        titleInput.value = "â˜• [ì¹´í˜ ê³µì§€] ìƒˆë¡œìš´ ì†Œì‹ì„ í™•ì¸í•˜ì„¸ìš”!";
        imgInput.value = "https://beumjookim.github.io/ilsanacebc/notice_image.png"; 
        linkInput.value = "https://cafe.naver.com/ilsanacebc"; 
    }
}

// ì¹´í†¡ ì „ì†¡ ì‹¤í–‰ (ì‚¬ì§„ê³¼ ë²„íŠ¼ì— ë§í¬ë¥¼ ì™„ë²½í•˜ê²Œ ì‹¬ìŒ)
function sendNotice() {
    const title = document.getElementById('noticeTitle').value;
    const desc = document.getElementById('noticeDesc').value || 'ê³µì§€ ë‚´ìš©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.';
    const img = document.getElementById('noticeImg').value;
    const link = document.getElementById('noticeLink').value;

    try {
        if (!Kakao.isInitialized()) {
            Kakao.init('fa7a8ba02d5835b0aa4183eac217cb7a');
        }

        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: {
                title: title,
                description: desc,
                imageUrl: img,
                link: { mobileWebUrl: link, webUrl: link } // ì‚¬ì§„ í´ë¦­ ì‹œ ì´ë™
            },
            buttons: [{ 
                title: (currentNoticeType === 'app' ? 'ì°¸ì„ ì‹ ì²­í•˜ê¸°' : 'ì¹´í˜ ì´ë™í•˜ê¸°'), 
                link: { mobileWebUrl: link, webUrl: link } // ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë™
            }]
        });
        document.getElementById('admin-notice-panel').style.display = 'none';
        alert("âœ… ê³µì§€ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    } catch (e) {
        alert("ì¹´í†¡ ì „ì†¡ ì‹¤íŒ¨: " + e.message);
    }
}
// âš¡ ì´ ì½”ë“œê°€ ìˆì–´ì•¼ 'ë“±ë¡' ë²„íŠ¼ì´ ì‘ë™í•©ë‹ˆë‹¤!
function addBangaeMember() {
    var nameInput = document.getElementById('inputName');
    var name = nameInput.value.trim();

    if (!name) {
        alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
    }

    var list = document.getElementById('bangaeMemberList');
    var li = document.createElement('li');
    li.style = "padding: 8px 0; border-bottom: 1px solid #eee; display: flex; align-items: center;";

    // âœ… ì´ë¦„ ì˜†ì— ë²ˆê°œì¥ ì„ íƒ ë²„íŠ¼(radio)ê³¼ ì‚­ì œ ë²„íŠ¼(âŒ)ì„ í•¨ê»˜ ë§Œë“­ë‹ˆë‹¤.
    li.innerHTML = `
        <label style="flex:1; display:flex; align-items:center; cursor:pointer;">
            <input type="radio" name="leader" value="${name}" style="margin-right:10px;">
            <span>${name}</span>
        </label>
        <button onclick="this.parentElement.remove()" style="background:none; border:none; color:#ff4d4d; cursor:pointer;">âŒ</button>
    `;

    list.appendChild(li);
    nameInput.value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
    nameInput.focus();
}
</script> 
<div id="admin-notice-panel" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: 90%; max-width: 400px; background:#ffffff; z-index:10000; border:3px solid #FFEB33; padding:20px; border-radius:15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:2px solid #eee; padding-bottom:10px;">
        <h4 style="margin:0; color:#333; font-size:1.2rem;">ğŸ“¢ ê³µì§€ ë°œì†¡ (ì‚¬ì§„/URL ì§€ì •)</h4>
        <button onclick="document.getElementById('admin-notice-panel').style.display='none'" style="background:none; border:none; font-size:1.8rem; cursor:pointer;">&times;</button>
    </div>

    <div style="display:flex; flex-direction:column; gap:10px;">
        <input type="text" id="noticeTitle" placeholder="ì œëª©" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        <textarea id="noticeDesc" placeholder="ë‚´ìš©" style="width:100%; height:80px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none; box-sizing:border-box;"></textarea>
        
        <label style="font-size:0.8rem; font-weight:bold; color:#666;">ğŸ–¼ï¸ ì‚¬ì§„ ì£¼ì†Œ (ì§€ë‚œë²ˆ ì‚¬ì§„ ê¸°ë³¸ ì„¸íŒ…)</label>
        <input type="text" id="noticeImg" value="https://beumjookim.github.io/ilsanacebc/notice_image.png" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        
        <label style="font-size:0.8rem; font-weight:bold; color:#666;">ğŸ”— ì—°ê²°í•  URL (ë„¤ì´ë²„ ì¹´í˜ ë“±)</label>
        <input type="text" id="noticeLink" placeholder="ì´ë™í•  ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        
        <button onclick="sendNotice()" style="width:100%; background:#FFEB33; color:#3C1E1E; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; margin-top:10px;">ğŸš€ ê³µì§€ ì „ì†¡</button>
    </div>
</div>
</body>
</html>