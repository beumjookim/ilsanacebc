

<!DOCTYPE html>
<html lang="ko">
<head>
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>Ace Bowling V18.0 (Final)</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<link rel="manifest" href="./manifest.json?v=5">
<link rel="apple-touch-icon" href="ace.png?v=5">
<meta name="theme-color" content="#3498db">

<meta property="og:type" content="website">
<meta property="og:title" content="일산 에이스 볼링 클럽">
<meta property="og:description" content="⚖️ 정기모임 & ⚡ 번개모임 신청하기">
<meta property="og:image" content="https://beumjookim.github.io/ilsanacebc/ace.png?v=5">
<meta property="og:url" content="https://beumjookim.github.io/ilsanacebc/">

    <style>
    :root { 
        --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; 
        --warning: #f39c12; --bg: #f8f9fa; --green: #27ae60; 
        --dark: #34495e; --purple: #8e44ad; 
    }

    /* 1. 전체 틀 설정 (스크롤 가능 + 헤더 여백) */
    html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    
    /* 1. 바깥쪽 스크롤바를 아예 제거합니다 (핵심) */
    overflow: auto; 
    
    /* 2. 패딩이 전체 높이(100%)에 포함되도록 설정 (5G처럼 삐져나오는 것 방지) */
    box-sizing: border-box; 
    padding-top: 57px; 

    position: relative;
    width: 100%;
    background-color: var(--bg);
    font-family: 'Noto Sans KR', sans-serif;

    /* 모바일 최적화 유지 */
    -webkit-text-size-adjust: 100%; 
    -moz-text-size-adjust: 100%;
    text-size-adjust: 100%;
    font-size: 14px;
}
        
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        /* 2. 속알맹이 스크롤 (점수판만 부드럽게 오르내림) */
/* style 태그 안의 .container 부분을 찾아서 이렇게 단순하게 바꾸세요 */
.container {
    display: flex;
    flex-direction: column;
    height: 100%; /* ★ 화면 높이 100%로 고정 */
    overflow: hidden; /* ★ 여기서도 스크롤 금지 */
}
        .header {
    /* padding: 15px;  <-- 기존 거 지우고 아래로 변경 */
    padding: 15px 25px; /* 양옆 여백을 25px로 늘림 */
    background: #fff;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 2000;
}
        
        /* style 태그 안의 .tab-menu 부분을 이렇게 고쳐보세요 */
/* 📌 탭 메뉴를 헤더 바로 밑에 강제로 고정시키는 코드 */
.tab-menu {
    display: flex;
    gap: 5px;
    padding: 10px 15px; /* 양옆 여백 적당히 */
    background: #fff;
    border-bottom: 1px solid #ddd;
    
    /* ✅ 핵심 수정: sticky 대신 fixed를 씁니다! */
    position: fixed; 
    
    /* 헤더 높이가 약 55~60px 정도 됩니다. 그 바로 아래에 위치시킵니다. */
    top: 40px; 
    
    left: 0;
    width: 100%; /* 가로 꽉 채우기 */
    z-index: 1900; /* 헤더보다는 아래, 본문보다는 위에 */
    overflow-x: auto; /* 메뉴가 많으면 옆으로 스크롤 */
    white-space: nowrap;
    box-sizing: border-box; /* 패딩 포함해서 너비 계산 */
}

       .tab-btn { 
    flex-shrink: 0; /* ★ 버튼이 압축되지 않도록 설정 */
    padding: 10px 15px; /* 양옆 여백을 충분히 줌 */
    white-space: nowrap; /* 글자가 줄바꿈되지 않게 함 */
    border: 1px solid #eee; 
    background: #f8f9fa; 
    border-radius: 8px; 
    font-weight: bold; 
    cursor: pointer; 
    text-align: center; 
    color: #555; 
}
        
        /* 3. 입력창이 가려지지 않게 하단 여백 확보 */
.content-area {
    flex: 1; /* 남은 공간 꽉 채우기 */
    overflow-y: auto; /* ★ 오직 여기만 스크롤 허용! */
    -webkit-overflow-scrolling: touch; /* 아이폰에서 부드럽게 스크롤 */
    padding-bottom: 100px; /* 맨 아래 내용이 가려지지 않게 여유 공간 */
    /* [추가] 부모로부터 높이를 확실히 물려받도록 설정 */
    display: flex;
    flex-direction: column;
}
        .panel {
    display: none;
    padding: 0 20px; /* ★ 양옆에 20px 공백 추가! (박스가 화면 끝에 안 붙게 함) */
} .panel.active { display: block; }
        .input-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .universal-btn { width: 100%; padding: 15px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; color: white; font-size: 1rem; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-sm { padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; font-size: 0.8rem; font-weight: bold; background: white; color: #333; }
        
        /* 팀카드 디자인 */
        .team-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .team-header { background: var(--purple); color: white; padding: 12px 15px; font-weight: bold; display: flex; justify-content: space-between; cursor: pointer; font-size:1.1rem; }
        .team-body { padding: 0; background: white; }
        
        .lane-divider { display: flex; border-bottom: 1px solid #eee; }
        .lane-half { flex: 1; padding: 10px; }
        .lane-half:first-child { border-right: 1px dashed #ddd; }
        .lane-title { font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 5px; font-weight: bold; }

        .member-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f5f5f5; }
        
        /* 랭크 탭 */
        .rank-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .rank-tab { flex: 1; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; text-align: center; font-weight: bold; min-width: 50px; }
        .rank-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* 입력창 디자인 개선 */
        .input-team-box { border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px; overflow: hidden; }
        .input-team-header { background: #f1f3f5; padding: 10px; font-weight: bold; text-align: center; border-bottom: 1px solid #ddd; color: var(--primary); font-size: 1.1rem; }
        .score-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; background: white; }
        .score-name { font-size: 1.2rem; font-weight: bold; color: #333; }
        .score-input { width: 90px; padding: 12px; text-align: center; border: 2px solid #ccc; border-radius: 8px; font-size: 1.4rem; font-weight: bold; background: #fff; }
        .score-input:focus { border-color: var(--accent); background: #f0f8ff; outline: none; }

        /* 필터 안내 박스 */
        #filterInfo { display:none; background:#f3e5f5; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; color:#8e44ad; border:1px solid #e1bee7; }

        /* 조편성 설정 */
        .lane-config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px; }
        .lane-input { width: 100%; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-weight: bold; font-size:1.1rem; box-sizing: border-box; margin-top: 5px; background: #fff; }
        
        .zone-btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-weight: bold; color: #555; }
        .zone-btn.selected { background: #34495e; color: white; border-color: #34495e; }

        table.stats-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 10px; }
        table.stats-table th { background: #f1f3f5; padding: 8px; border: 1px solid #ddd; }
        table.stats-table td { padding: 8px; border: 1px solid #ddd; text-align: center; }

        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        .big-input { width: 100%; padding: 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 10px; box-sizing: border-box; }
        .big-select { width: 100%; padding: 12px; font-size: 1rem; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 10px; background:white; font-weight:bold; }
        
        .filter-btn { padding: 6px 10px; border: 1px solid #ddd; background: white; border-radius: 15px; cursor: pointer; margin-right: 3px; font-size: 0.8rem; margin-bottom: 5px; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .settings-label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); margin: 20px 0 10px 0; border-left: 4px solid var(--accent); padding-left: 10px; }
        
        #landingPage, #globalLoginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; color: white; }
        .enter-btn {
    margin-top: 40px;
    padding: 15px 50px;
    font-size: 1.2rem;
    font-weight: bold;
    color: white;
    background: rgba(255,255,255,0.1);
    border: 2px solid white;
    border-radius: 50px;
    cursor: pointer;

    /* ★ 아래 3줄을 꼭 추가하세요! (납작해짐 방지 & 중앙 정렬) ★ */
    max-height: none !important;  /* 높이 제한 풀기 */
    display: flex;                /* 유연한 박스로 변경 */
    align-items: center;          /* 세로 정중앙 맞춤 */
}
        
        .login-card { background: white; padding: 30px; border-radius: 15px; width: 80%; max-width: 350px; text-align: center; color: #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        
        /* 컨트롤 메뉴 */
        /* 카지노 배정 버튼 (특정 위치의 버튼만 조절) */
.control-top-container .universal-btn {
    font-size: 0.9rem !important; /* 글씨 크기 축소 */
    padding: 10px !important;    /* 구역 버튼과 비슷한 느낌으로 패딩 조절 */
}
        .box-manager { flex: 1; background: #e3f2fd; border: 2px solid #90caf9; color: #1565c0; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; display: flex; flex-direction: column; justify-content: center; }
        /* 일반 배정 버튼 */
.btn-run-v13 { 
    flex: 1.2; 
    background: #2980b9; 
    color: white; 
    border: none; 
    border-radius: 8px; 
    font-size: 0.9rem !important; /* 글씨 크기 축소 */
    font-weight: bold; 
    cursor: pointer; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
}

/* 초기화 버튼 */
.btn-reset-v13 { 
    flex: 0.8; 
    background: white; 
    color: #c0392b; 
    border: 2px solid #c0392b; 
    border-radius: 8px; 
    font-size: 0.85rem !important; /* 글씨 크기 축소 */
    font-weight: bold; 
    cursor: pointer; 
}
        
        .lane-box-v13 { background: white; border: 1px solid #ccc; border-radius: 8px; padding: 5px; text-align: center; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .lane-label { color: #8e44ad; font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }      

        /* ★★★ [반응형 핵심] 모바일(800px 이하)에서 세로로 강제 변경 ★★★ */
        @media screen and (max-width: 800px) {
            .lane-divider { display: flex !important; flex-direction: column !important; }
            .lane-half { width: 100% !important; border-right: none !important; border-bottom: 2px dashed #d1c4e9 !important; padding: 15px 10px !important; box-sizing: border-box; }
            .lane-half:last-child { border-bottom: none !important; }
            .lane-config-grid { grid-template-columns: repeat(2, 1fr) !important; }
            input, select, button { font-size: 16px !important; }
        }
        /* --- 카지노 칩 & 테이블 스타일 --- */
        #casinoPanel { background: #1a472a; border-radius: 15px; padding: 20px; color: white; }
        .casino-table { background: radial-gradient(circle, #27ae60, #1a472a); border: 10px solid #5d4037; border-radius: 30px; padding: 20px; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); text-align: center; }
        .chip-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 15px; }

        .chip { width: 75px; height: 75px; border-radius: 50%; position: relative; cursor: pointer; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; justify-content: center; align-items: center; box-shadow: 0 6px 10px rgba(0,0,0,0.5); border: 5px dashed rgba(255,255,255,0.3); }
        .chip:hover { transform: translateY(-5px) scale(1.05); }
        .chip.selected { opacity: 0.6; cursor: default; transform: scale(0.9); filter: grayscale(0.5); }
        .chip.red { background: radial-gradient(circle, #ff4d4d, #b30000); }
        .chip.blue { background: radial-gradient(circle, #4da6ff, #0059b3); }
        .chip.green { background: radial-gradient(circle, #5cd65c, #1e7b1e); }
        .chip.yellow { background: radial-gradient(circle, #f1c40f, #f39c12); }

        .chip-inner { width: 48px; height: 48px; background: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #333; font-weight: 900; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .chip-num { font-size: 1.3rem; }
        .chip-owner { font-size: 0.65rem; color: #d63031; font-weight: bold; margin-top: -3px; }
        .chip-lane { font-size: 1.1rem; color: #0984e3; }

        .lane-input-touch { width: 100%; height: 40px; line-height: 40px; text-align: center; border: 1px solid #ccc; border-radius: 6px; font-weight: bold; font-size: 1.2rem; background: #fff; cursor: pointer; user-select: none; margin-top: 5px; }
        .lane-input-touch:active { background: #e3f2fd; transform: scale(0.95); }
        .team-input-touch { background: #f9f9f9; color: var(--purple); }

        .admin-btn, #settings button { width: 280px !important; height: 45px !important; line-height: 45px !important; padding: 0 !important; margin: 10px auto !important; display: block !important; font-size: 16px !important; font-weight: bold !important; border-radius: 8px !important; text-align: center !important; border: none !important; cursor: pointer !important; }
        .excel-green { background-color: #28a745 !important; color: white !important; }
        .over-200 { color: #ff0000 !important; font-weight: bold !important; }
   /* 모바일에서 입력창 글씨가 너무 커지지 않게 조절 */
    input, select, button {
        font-size: 14px !important; /* 강제로 14px로 고정 */
        max-height: 40px;           /* 높이도 너무 커지지 않게 */
    }

    /* 점수 입력칸은 조금 커도 되지만 너무 크지 않게 */
    .score-input {
        font-size: 1.2rem !important; /* 1.4rem에서 약간 줄임 */
        padding: 8px !important;      /* 여백도 줄임 */
        height: 40px !important;
    }
  /* 🎰 카지노 칩 & 이중 셔플 스타일 통합본 */

/* 1. 칩이 배치되는 그리드 판 */
.chip-grid {
    display: grid;
    /* 모바일 대응: 최소 70px 크기로 빈틈없이 채움 */
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); 
    gap: 12px;
    margin-top: 10px;
    justify-items: center; /* 칩을 가운데 정렬 */
}

/* 2. 칩 바구니 (입체 효과의 토대) */
.casino-chip {
    width: 70px;
    height: 70px;
    perspective: 1000px; /* 뒤집힐 때의 깊이감 */
    cursor: pointer;
    margin: 5px;
}

/* 3. 실제 뒤집히는 알맹이 */
.chip-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); /* 부드러운 회전 */
    transform-style: preserve-3d;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* 테이블 위 그림자 */
    border-radius: 50%;
}

/* 칩이 선택(picked)되었을 때 180도 회전 */
.casino-chip.picked .chip-inner {
    transform: rotateY(180deg);
}

/* 4. 앞면(물음표)과 뒷면(레인번호) 공통 설정 */
.chip-front, .chip-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden; /* 뒤집혔을 때 반대편 안 보이게 */
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    border: 4px dashed rgba(255,255,255,0.4); /* 칩 특유의 점선 테두리 */
    box-sizing: border-box;
    font-weight: bold;
    color: white;
}

/* 앞면: 선택 전 "?" 표시 */
.chip-front {
    z-index: 2;
    font-size: 1.5rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

/* 뒷면: 선택 후 레인번호 표시 */
.chip-back {
    background: #2c3e50;
    color: white;
    transform: rotateY(180deg); /* 미리 뒤집어 놓음 */
    font-size: 0.8rem;
}

/* 5. 등급별 칩 색상 (앞면에 그라데이션 적용) */
.redChips .chip-front    { background: radial-gradient(#ff4d4d, #b30000); }
.blueChips .chip-front   { background: radial-gradient(#4d94ff, #0044cc); }
.yellowChips .chip-front { background: radial-gradient(#ffd633, #b38f00); }
.greenChips .chip-front  { background: radial-gradient(#5cd65c, #1e7b1e); }
.purpleChips .chip-front { background: radial-gradient(#a29bfe, #6c5ce7); }

/* 6. 구역 제목 (Ace, Pro 등) */
#casinoArea h3 {
    color: #fff;
    font-size: 0.95rem;
    margin: 25px 0 10px 0;
    border-left: 4px solid #f1c40f;
    padding-left: 10px;
    text-align: left;
    text-shadow: 1px 1px 2px #000;
}
   </style>
</head>
<body>

    <div id="landingPage">
        <h1 style="color:white; margin-bottom:20px; font-size:2.5rem;">ACE BOWLING</h1>
        <p style="color:#eee; font-weight:bold;">V18.0</p>
        <button class="enter-btn" onclick="window.showGlobalLogin()">앱 시작하기</button>
    </div>
<div id="admin-menu" style="display: none; background: #f0f0f0; padding: 10px; text-align: center; border-bottom: 1px solid #ccc;">
        <button onclick="toggleNoticePanel()" style="background:none; border:none; cursor:pointer;">
    <span style="font-size:2rem;">📢</span> 
    <br>
    <span style="font-size:0.8rem; font-weight:bold;">공지 발송</span>
</button>
    </div>

    <div id="main-content">
    <div id="globalLoginScreen" style="display:none;">
        <div class="login-card">
            <h2 style="color:var(--primary); margin-bottom:20px;">🔐 회원 로그인</h2>
            <input type="text" id="globalId" class="login-input" placeholder="이름">
            <input type="password" id="globalPw" class="login-input" placeholder="비밀번호">
            <button class="universal-btn" onclick="window.doGlobalLogin()" style="background:var(--accent);">로그인</button>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display:none;">
        <div class="header" style="
    position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: #ffffff; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 10px 15px; display: flex; 
    justify-content: space-between; align-items: center; box-sizing: border-box;
">
    
    <div style="display: flex; align-items: center; gap: 12px;">
    <h2 style="margin: 0; font-size: 0.9rem; white-space: nowrap; color: #333;">Ilsan Ace Team V18.0</h2>
    
    <div style="display: flex; align-items: center; gap: 6px;">
        <button onclick="openNoticePanel('app')" style="background: #3498db; border: 1px solid #2980b9; border-radius: 4px; padding: 4px 6px; cursor: pointer; display: flex; align-items: center;">
            <span style="font-size: 1.1rem; line-height: 1;">📢</span>
        </button>

        <button onclick="openNoticePanel('cafe')" style="background: #FFEB33; border: 1px solid #ebcf00; border-radius: 4px; padding: 4px 6px; cursor: pointer; display: flex; align-items: center;">
            <span style="font-size: 1.1rem; line-height: 1;">💬</span>
        </button>
    </div>
</div>

    <div style="display: flex; align-items: center; gap: 6px;">
        <span id="userInfo" style="font-weight: bold; color: var(--primary); font-size: 0.75rem; white-space: nowrap;"></span>
        <button id="logoutBtn" onclick="window.logout()" style="padding: 3px 6px; background: var(--danger); color: white; border: none; border-radius: 4px; font-size: 0.7rem; font-weight: bold; cursor: pointer; white-space: nowrap;">로그아웃</button>
    </div>
</div>



<div class="tab-menu" id="mainTabMenu">
    <button class="tab-btn active" onclick="window.showPanel('attendPanel', this)">1.참석</button>
    <button class="tab-btn" onclick="window.showPanel('groupPanel', this)">2.조편성</button>
    <button class="tab-btn" onclick="window.showPanel('casinoPanel', this)">🎰 카지노</button>
    <button class="tab-btn" onclick="window.showPanel('progressPanel', this)">3.진행</button>
    <button class="tab-btn" onclick="window.clickInputTab(this)">4.입력</button>
    <button class="tab-btn" onclick="window.showPanel('statsPanel', this)">통계</button>
    <button class="tab-btn" onclick="window.showPanel('archivePanel', this)">📂 기록보관소</button>
    <button class="tab-btn" onclick="window.showPanel('memberPanel', this)">회원관리</button>
    <button class="tab-btn" id="settingsTabBtn" onclick="window.showPanel('settingsPanel', this)" style="display:none;">⚙️ 설정</button>
</div>

        <div class="content-area">
            
            <div id="attendPanel" class="panel active">
                <div id="adminEventCreate" class="input-box" style="display:none; border:2px solid var(--accent);">
                    <h4 style="margin-top:0; color:var(--accent);">📅 새 모임 일정 등록 (공지)</h4>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="date" id="eventDate" class="big-input" style="flex:1.5; margin-bottom:0;">
                        <input type="time" id="eventExactTime" class="big-input" style="flex:1.2; margin-bottom:0;" value="14:00">
                    </div>
                    <select id="eventMode" class="big-select">
                        <option value="regular">⚖️ 정기모임 (4G)</option>
                        <option value="lightning">⚡ 번개모임 (6G)</option>
                    </select>
                    <button class="universal-btn" style="background:var(--accent); margin-bottom:0;" onclick="window.createEvent()">모임 일정 등록</button>
                </div>

                <div class="section-title">🗓️ 예정된 모임 및 참석 신청</div>
                <div id="eventListArea"></div>

                <input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none;">
            </div>

            <div id="groupPanel" class="panel">
    <div class="input-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="modeDisplay" style="margin:0; font-size:1.1rem; color:var(--primary);">⚖️ 정기모임 (4게임)</h3>
            <button class="btn-sm" onclick="window.toggleMode()" style="background:var(--dark); color:white;">🔄 모드 전환</button>
        </div>

        <div id="regularSection" style="display:none; gap:6px; margin-top:10px;">
            <button type="button" onclick="window.runGeneralAssignment()" 
                    style="flex:2; height:45px; background:#3498db; color:white; border:none; border-radius:8px; font-weight:bold;">⚖️ 일반 배정 시작</button>
            <button type="button" onclick="window.resetAssignment()" 
                    style="flex:1; height:45px; background:white; border:1px solid #c0392b; color:#c0392b; border-radius:8px; font-weight:bold;">🗑️ 초기화</button>
        </div>

        <div id="casinoSection" style="display:none; text-align:center; margin-top:10px; padding-top:15px; border-top:1px solid #eee;">
            <div style="margin-bottom:12px; font-weight:bold; color:var(--dark);">🎰 카지노 게임</div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="btnTeamMode" class="universal-btn" style="background:var(--accent); flex:1; margin-bottom:0;" onclick="window.setGameMode('team')">👥 팀전</button>
                <button id="btnSoloMode" class="universal-btn" style="background:#ccc; flex:1; margin-bottom:0;" onclick="window.setGameMode('individual')">👤 개인전</button>
            </div>
            <button class="universal-btn" style="background:var(--warning); color:#000; font-size:1.1rem;" onclick="window.initCasinoFromSetup()">🚀 게임 시작</button>
            <button class="universal-btn" style="background:white; border:1px solid #c0392b; color:#c0392b; margin-top:10px; font-size:0.9rem;" onclick="window.resetAssignment()">🗑️ 초기화</button>
        </div>
    </div>

    <div class="input-box">
        <div id="assignGameTabs" class="rank-tabs" style="margin-bottom: 15px;"></div>

        <label style="font-weight:bold; color:var(--warning); display:block; margin-bottom:5px;">1. 구역 선택 (레인 구조)</label>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button class="zone-btn" id="z1" onclick="window.toggleZone(1)">1구역</button>
            <button class="zone-btn" id="z2" onclick="window.toggleZone(2)">2구역</button>
            <button class="zone-btn" id="z3" onclick="window.toggleZone(3)">3구역</button>
            <button class="zone-btn" id="z4" onclick="window.toggleZone(4)">4구역</button>
            <button class="zone-btn" id="z5" onclick="window.toggleZone(5)">5구역</button>
        </div>

        <label style="font-weight:bold; color:var(--primary); display:block; margin-bottom:5px;">2. 참석 현황 및 레인 배정</label>
        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
        
        <label style="font-weight:bold; color:#27ae60; display:block; margin-bottom:5px;">1. 조편성 방식 선택</label>
        <select id="groupAssignMethod" class="big-select" style="margin-bottom:15px;" onchange="window.changeAssignMethod(this.value)">
            <option value="ai">🤖 AI 밸런스</option>
            <option value="random">🎲 랜덤 (무작위)</option>
        </select>

        <label style="font-weight:bold; color:#8e44ad; display:block; margin-bottom:8px;">2. 레인별 인원 설정</label>
        <div class="box-manager" style="background:#e8f4fc; border:1px solid #3498db; color:#2980b9; padding:8px; border-radius:6px; text-align:center; font-size:0.9rem; font-weight:bold; margin-bottom:10px;">
            <span style="font-size:0.8rem; opacity:0.8; margin-right:5px;">👑 관리자:</span>
            <span id="displayJungmoName">미정</span>
        </div>

        <div id="laneConfigArea" class="lane-config-grid"></div>
        <div style="text-align:right; font-weight:bold; margin-top:10px;">
            설정 인원 합계: <span id="totalConfigCount" style="color:var(--danger); font-size:1.1rem;">0</span>명
        </div>
    </div>

    <div style="background:#fff; padding:15px; border-radius:10px; border:1px solid #ddd; margin-top:10px;">
        <h4 style="margin-top:0; color:#e67e22;">⚡ 번개장(👑) 선택</h4>
        <p style="font-size:0.85rem; color:#888; margin-bottom:10px;">오늘 참석 신청한 명단입니다.</p>
        <div id="bangaeMemberList" style="display: flex; flex-direction: column; gap: 8px;">
            <div style="text-align:center; padding:20px; color:#ccc;">참석자가 없습니다.</div>
        </div>
    </div>
    
    
</div>
           <div id="casinoPanel" class="panel">
    <div class="casino-table">
        <h2 style="color: #f1c40f; margin-top:0; text-shadow: 2px 2px 4px #000;">🎰 ACE CASINO TABLE</h2>
        
        <div id="casinoStatus" style="font-size:1rem; margin-bottom:20px; color:#fff; font-weight:bold;">
            원하는 번호의 칩을 빠르게 선택하세요!
        </div>

        <div id="casinoArea" style="min-height: 250px; padding: 10px;">
            <p style="text-align:center; color:rgba(255,255,255,0.5); padding-top:50px;">
                관리자가 [카지노 판 새로 짜기]를 누르면<br>이 테이블 위에 칩이 나타납니다.
            </p>
        </div>

        <div id="adminCasinoControls" style="margin-top:40px; border-top:1px solid rgba(255,255,255,0.2); padding-top:20px;">
             <button class="universal-btn" style="background:#e67e22; margin-top:10px;" onclick="window.finishCasino()">👻 고스트 확인 및 배정 종료</button>
        </div>
    </div>
</div>
            

            <div id="progressPanel" class="panel">
                <div class="input-box">
                    <input type="date" id="progDate" class="big-input" style="width:auto; margin-bottom:15px;" onchange="window.renderGameProgress()">
                    <div id="progTabs" class="rank-tabs"></div>
                    <div id="teamCardArea"></div>
                </div>
            </div>

            <div id="inputPanel" class="panel">
                <div id="scoreSection">
                    <div class="input-box">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="margin:0;">📝 점수 입력 (<span id="inputGameTitle">1G</span>)</h3>
                            <button class="btn-sm" onclick="window.saveAllScores()" style="background:var(--accent); color:white; border:none;">💾 저장</button>
                        </div>
                        
                        <div id="filterInfo" style="display:none; background:#f3e5f5; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; color:#8e44ad; border:1px solid #e1bee7;">
                            <span id="filterTeamName"></span> 점수 입력 중...
                        </div>

                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <input type="date" id="inputDate" class="big-input" style="width:60%; margin:0;" onchange="window.renderInputs()">
                            <button class="btn-sm" onclick="window.showAllTeams()" style="background:#95a5a6; color:white;">📂 전체 보기</button>
                        </div>
                        
                        <div id="inputTabs" class="rank-tabs"></div>
                        <div id="inputGridArea" style="margin-top:15px;"></div>
                        
                        <button class="universal-btn" onclick="window.saveAllScores()" style="background:var(--accent); margin-top:20px;">💾 점수 저장 완료</button>
                    </div>
                <button class="universal-btn" onclick="window.saveAllScores()" style="background:var(--accent); margin-top:20px;">💾 점수 저장 완료</button>

<div style="margin-top: 40px; padding: 20px; border: 2px dashed #e67e22; border-radius: 12px; background: #fffcf9; text-align: center;">
    <h4 style="margin-top:0; color:#e67e22;">🏁 오늘 모임 최종 완료</h4>
    <p style="font-size: 0.85rem; color: #777; margin-bottom: 15px; line-height: 1.4;">
        모든 게임이 끝났나요?<br>
        기록을 <b>보관소(Archives)</b>로 옮기고 오늘 판을 비웁니다.
    </p>
    <button class="universal-btn" 
            style="background: #2c3e50; color: white; font-weight: bold; height: 50px; border: none; width: 100%;" 
            onclick="window.finishMeetingAndArchive()">
        🚀 기록 보관 및 다음 모임 준비
    </button>
</div>
                </div>
            </div>

            <div id="statsPanel" class="panel">
                <div class="input-box">
                    <div class="section-title">📈 기간별 개인 에버 (기록)</div>
                    <div style="margin-bottom:15px; display:flex; flex-wrap:wrap;">
                        <button class="filter-btn" onclick="window.setStatsPeriod('all', this)">전체</button>
<button class="filter-btn" onclick="window.setStatsPeriod('1m', this)">1개월</button>
<button class="filter-btn" onclick="window.setStatsPeriod('3m', this)">3개월</button>
<button class="filter-btn active" onclick="window.setStatsPeriod('6m', this)">6개월</button>
<button class="filter-btn" onclick="window.setStatsPeriod('12m', this)">12개월</button>
                    </div>
                    <div id="historicalStatsTable"></div>
                    <hr style="margin: 20px 0;">
                    <div class="section-title">⚡ 금일 게임별 순위</div>
                    <div id="statsGameTabs" class="rank-tabs"></div>
                    <h4 style="margin-top:10px;">🏆 팀 순위</h4>
                    <div id="currentTeamRankTable"></div>
                    <h4 style="margin-top:20px;">🏅 개인 순위</h4>

                    <div style="margin-bottom:10px; display:flex; gap:5px;">
                        <button class="filter-btn active" onclick="window.filterCurrentStats('all', this)">전체</button>
                        <button class="filter-btn" onclick="window.filterCurrentStats('남', this)">남성</button>
                        <button class="filter-btn" onclick="window.filterCurrentStats('여', this)">여성</button>
                    </div>
                    <div id="currentIndivRankTable"></div>
                    <div class="section-title" style="margin-top:40px; border-left:4px solid var(--danger);">👑 오늘의 최종 합계 순위 (전체 게임 누적)</div>
                    <div id="todayTotalRankTable"></div>      
                </div>
            </div>

            <div id="memberPanel" class="panel">
                <div id="adminMemberControls" class="input-box" style="display:none; border:2px solid var(--green);">
                    <h4 style="margin-top:0;">➕ 신규 회원 추가</h4>
                    <input type="text" id="newMemName" class="big-input" placeholder="이름 입력">
                    <div style="display:flex; gap:10px;">
                        <select id="newMemGender" class="big-select" onchange="window.checkGender(this)">
                            <option value="남">남성</option>
                            <option value="여">여성</option>
                        </select>
                        <input type="number" id="newMemHandicap" class="big-input" placeholder="핸디" value="0">
                    </div>
                    <button class="universal-btn" style="background:var(--green);" onclick="window.addMember()">회원 저장</button>
                </div>
                <div class="input-box">
                    <h4>📂 회원 목록</h4>
                    <div id="memberListArea"></div>
                </div>
            </div>

            <div id="settingsPanel" class="panel">
                <div id="adminJungmoSetting" class="input-box" style="display:none; border:2px solid var(--primary);">
                    <h3>👑 정모장 임명</h3>
                    <div style="margin-bottom:10px; font-weight:bold; color:var(--primary);">
                        현재 정모장: <span id="currentJungmoJangSetting" style="color:var(--accent);">없음</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="jungmoJangInput" class="big-input" placeholder="회원 이름 입력">
                        <button class="btn-sm" style="background:var(--primary); color:white;" onclick="window.setJungmoManager()">저장</button>
                    </div>
                </div>

                <div class="input-box" style="border:2px solid var(--accent);">
                    <h3 style="color:var(--accent); margin-top:0;">⚙️ 운영 기준 설정</h3>
                    <button onclick="document.getElementById('excelInput').click()" class="admin-btn excel-green">📊 정모점수명단 업로드</button>
                    <button onclick="downloadExcel()" class="admin-btn">📊 정모점수 다운로드</button>
                    
                    <label class="settings-label">가중치 에버 반영 기간 (개월)</label>
                    <input type="number" id="setAvgCriteria" class="big-input" value="6" placeholder="기본 6개월">
                    <small style="color:#666; display:block; margin-bottom:15px;">* 설정한 기간만큼의 성적을 계산하여 실력을 평가합니다.</small>

                    <label class="settings-label">기본 조편성 방식</label>
                    <select id="setAssignMethod" class="big-select">
                        <option value="ai">🤖 AI 밸런스</option>
                        <option value="random">🎲 랜덤 (무작위)</option>
                    </select>

                    <button class="universal-btn" style="background:var(--accent); margin-top:10px;" onclick="window.saveSettings()">⚙️ 기준값 저장</button>
                </div>
                <div class="input-box" style="border:2px solid var(--purple);">
                    <h4 style="color:var(--purple); margin-top:0;">💾 데이터 백업 및 복구</h4>
                    <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">* 현재 모든 데이터를 파일로 저장하거나 보관된 파일을 불러옵니다.</p>
                    
                    <div style="display:flex; gap:5px;">
                        <button class="universal-btn" style="background:var(--purple); flex:1;" onclick="window.exportData()">파일 내보내기</button>
                        <button class="universal-btn" style="background:var(--dark); flex:1;" onclick="document.getElementById('importFile').click()">파일 불러오기</button>
                    </div>
                    <input type="file" id="importFile" style="display:none;" accept=".json" onchange="window.importData(event)">
                </div>
                <div class="input-box" style="border:1px solid var(--danger);">
                    <h4 style="color:var(--danger); margin-top:0;">🚨 데이터 관리</h4>
                    <button class="universal-btn" style="background:var(--danger);" onclick="window.deleteToday()">🗑️ 오늘 점수만 삭제</button>
                    <button class="universal-btn" style="background:#8e44ad; margin-top:5px;" onclick="window.deleteAllData()">💥 데이터 완전 초기화</button>
                    <button class="universal-btn" style="background:#95a5a6; margin-top:5px;" onclick="window.resetAttendance()">🔄 참석 초기화</button>
                </div>
            </div>
        </div>

    <div id="modalOverlay" onclick="window.closeModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 id="modalTitle" style="margin-top:0;"></h3>
            <div id="modalContent"></div>
            <button class="universal-btn" style="background:#333; margin-top:20px;" onclick="window.closeModal()">닫기</button>
        </div>
    </div>

<script>
    let members=[], attendees=[], records=[], gameTeams={}, events={};
    let settings = { mode: 'regular', gameCount: 4, avgCriteria: 6, assignMethod: 'ai' };
    window.isConfigEditing = false; // 레인 설정 입력 중인지 확인하는 깃발
    let managers = { jungmo: '', lightning: '' }; 
    let selectedBlocks = [], laneSettings = {};   
    let db = null;
    // [추가] 주소창에서 특정 이벤트 ID가 있는지 확인하고 기억함
const urlParams = new URLSearchParams(window.location.search);
const jumpTarget = urlParams.get('eventId');
if (jumpTarget) sessionStorage.setItem('jumpToEvent', jumpTarget);
    let loggedInUser = localStorage.getItem('loggedInUser');
    let isAdmin = localStorage.getItem('ace_admin') === 'true';
    
    let currentRankView = 1, currentInputGame = 1, currentTargetGame = 1;
    // 기본값을 'all'에서 '6m'으로 변경합니다.
let currentStatsGame = 1, currentStatsPeriod = '6m', currentGenderFilter = 'all';
    let currentInputTeam = null; 

    firebase.initializeApp({ databaseURL: "https://ilsan-ace-bowling-team-default-rtdb.asia-southeast1.firebasedatabase.app" });
    db = firebase.database();

// 3. 엔터키로 다음 입력칸 이동
// 3. 엔터키로 다음 입력칸 이동
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        const inputs = Array.from(document.querySelectorAll('.lane-input'));
        const index = inputs.indexOf(document.activeElement);
        if (index > -1 && index < inputs.length - 1) {
            e.preventDefault(); 
            inputs[index + 1].focus(); 
            if(inputs[index + 1].value) inputs[index + 1].select();
        }
    }
});

// [핵심] 페이지 로드 시 네이버 주소 있으면 자동 이동
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get('target');
    
    // 만약 주소에 네이버 게시글 주소가 들어있다면? 바로 그곳으로 이동!
    if (targetUrl) {
        window.location.replace(decodeURIComponent(targetUrl));
        return;
    }

    // 카카오 초기화 (안전하게 로드 후 실행)
    try {
        if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
            Kakao.init('fa7a8ba02d5835b0aa4183eac217cb7a');
            console.log("카카오 초기화 성공");
        }
    } catch (e) { console.log("카카오 체크 중"); }
});
// 🛠️ [수리 완료] 회원 목록 그리기 함수 (강제 적용)
window.renderMembers = function() { 
    const area = document.getElementById('memberListArea'); 
    if(!area) return; 

    // 데이터가 아직 안 왔으면 로딩 표시
    if(!members || members.length === 0) {
        area.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">회원 데이터를 불러오는 중...<br>(데이터가 없다면 신규 등록해주세요)</div>';
        return;
    }

    // 이름순 정렬 후 목록 생성
    area.innerHTML = members.sort((a,b)=>a.name.localeCompare(b.name)).map(m => `
        <div class="member-row" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background:#fff;">
            <div style="display:flex; flex-direction:column;">
                <b style="font-size:1.2rem; color:#333;">${m.name}</b>
                <span style="font-size:0.9rem; color:#666;">
                    ${m.gender || '남'} / <span style="color:var(--purple); font-weight:bold;">H:${m.handicap || 0}</span>
                </span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-sm" style="background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:5px;" 
                    onclick="window.updateMember('${m.key}', '${m.name}', ${m.handicap}, '${m.gender||'남'}')">수정</button>
                
                <button class="btn-sm" style="background:var(--warning); color:white; border:none; padding:8px 12px; border-radius:5px;" 
                    onclick="window.updatePw('${m.key}', '${m.name}', '${m.pw||'1234'}')">비번</button>
                
                <button class="btn-sm" style="background:var(--danger); color:white; border:none; padding:8px 12px; border-radius:5px;" 
                    onclick="window.deleteMember('${m.key}', '${m.name}')">삭제</button>
            </div>
        </div>
    `).join(''); 
};
// 🛠️ [수리 완료] 배정 엔진 (인원 설정 없으면 자동 4인 기준 고스트 생성)
window.runAssignment = function() {
    try {
        console.log("🚀 [고스트 보장형] 배정 엔진 가동...");
        
        // 1. 활성화된 레인(팀 번호가 입력된 곳) 수집
        let activeLanes = [];
        for (let l = 1; l <= 20; l++) {
            let t = parseInt(laneSettings['team_' + l]) || 0;
            if (t > 0) activeLanes.push({ lane: l, teamNo: t });
        }

        if (activeLanes.length === 0) return alert("❌ 조편성 하단의 '팀 번호'를 입력해주세요.");

        // 2. 실제 참석자 명단 (고스트 제외)
        const realMembers = attendees.filter(n => n && !n.includes("고스트"));
        
        // 🧠 [핵심] 레인당 평균 인원 계산 (무조건 올림)
        // 예: 5명 / 2레인 = 2.5 -> 3명씩 필요
        let requiredPerLane = Math.ceil(realMembers.length / activeLanes.length);
        if (requiredPerLane < 1) requiredPerLane = 1;

        // 3. 총 필요한 자리수 계산 및 고스트 보충
        let totalSlots = activeLanes.length * requiredPerLane;
        
        const rankingList = realMembers.map(name => ({
            name: name.trim(),
            avg: (typeof window.getWeightedStats === 'function') ? window.getWeightedStats(name).weightedAvg : 0
        }));

        // 설정된 방식에 따라 정렬
        if (settings.assignMethod === 'random') rankingList.sort(() => Math.random() - 0.5); 
        else rankingList.sort((a, b) => b.avg - a.avg); 

        // 👻 부족한 만큼 고스트를 명단에 미리 채워넣음
        while(rankingList.length < totalSlots) {
            rankingList.push({ name: "👻고스트", avg: 0, isGhost: true });
        }

        // 4. 팀별 바구니 만들기
        const uniqueTeamNos = [...new Set(activeLanes.map(al => al.teamNo))].sort((a,b)=>a-b);
        let finalTeams = uniqueTeamNos.map(tNo => ({ teamNo: tNo, members: [], totalAvg: 0 }));

        // 5. 스네이크 배정 (지그재그로 공평하게)
        let teamIdx = 0;
        let direction = 1;

        rankingList.forEach((player) => {
            let team = finalTeams[teamIdx];
            
            // 해당 팀이 써야 할 레인들 중 빈자리 찾기
            let myLanes = activeLanes.filter(al => al.teamNo === team.teamNo);
            let targetLaneObj = myLanes.find(al => 
                team.members.filter(m => m.lane === al.lane).length < requiredPerLane
            );

            if (targetLaneObj) {
                player.lane = targetLaneObj.lane;
                team.members.push(player);
                team.totalAvg += player.avg;
            }

            // 다음 팀으로 (스네이크)
            teamIdx += direction;
            if (teamIdx >= finalTeams.length) { teamIdx = finalTeams.length - 1; direction = -1; }
            if (teamIdx < 0) { teamIdx = 0; direction = 1; }
        });

        // 6. 핸디 계산 및 저장
        const maxAvg = Math.max(...finalTeams.map(t => t.totalAvg));
        finalTeams.forEach(t => t.matchHandy = Math.max(0, Math.round(maxAvg - t.totalAvg)));
        
        gameTeams[currentTargetGame] = finalTeams;

        db.ref('bowling_v14').update({
            [`gameTeams/${currentTargetGame}`]: finalTeams,
            'settings/currentTab': 'progressPanel',
            'settings/currentRankView': currentTargetGame
        }).then(() => {
            window.showPanel('progressPanel', document.querySelectorAll('.tab-btn')[3]);
            alert(`✅ 배정 완료! (고스트 자동 보정됨)`);
        });

    } catch (err) {
        alert("🚨 배정 오류: " + err.message);
    }
};
// 4. 앱 진입 함수
window.enterApp = function() {
    const landing = document.getElementById('landingPage');
    if(landing) landing.style.display = 'none';
    if(typeof window.showGlobalLogin === 'function') window.showGlobalLogin();
};

/* ============================================================
   🚀 [통합 엔진] 앱 시작 및 화면 전환 로직 (최종 수정본)
   ============================================================ */

// 1. 앱 진입 및 로그인 처리
window.showGlobalLogin = function() {
    const landing = document.getElementById('landingPage');
    const loginScreen = document.getElementById('globalLoginScreen');
    const mainCont = document.getElementById('mainContainer');

    if (localStorage.getItem('loggedInUser')) {
        if(landing) landing.style.display = 'none';
        if(loginScreen) loginScreen.style.display = 'none';
        if(mainCont) mainCont.style.display = 'block';
        
        window.updateUI();
        const firstTabBtn = document.querySelectorAll('.tab-btn')[0];
        window.showPanel('attendPanel', firstTabBtn);
    } else {
        if(landing) landing.style.display = 'none';
        if(loginScreen) loginScreen.style.display = 'flex';
    }
};

// 2. 로그인 실행
window.doGlobalLogin = function() {
    const i = document.getElementById('globalId').value.trim();
    const p = document.getElementById('globalPw').value.trim();
    if((i==='관리자'||i==='김범주') && p==='6884') {
        localStorage.setItem('loggedInUser', i);
        localStorage.setItem('ace_admin', 'true');
        location.reload();
    } else {
        const m = members.find(x=>x.name===i);
        if(m && (m.pw||'1234')===p) {
            localStorage.setItem('loggedInUser', i);
            localStorage.setItem('ace_admin', 'false');
            location.reload();
        } else { alert("로그인 실패! 이름과 비밀번호를 확인하세요."); }
    }
};

// 3. 통합 패널 전환 (카지노 렌더링 포함)
window.showPanel = function(id, btn) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    const targetPanel = document.getElementById(id);
    if(targetPanel) targetPanel.classList.add('active');
    
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');

    if(id !== 'inputPanel') currentInputTeam = null;

    // 데이터 렌더링 연결
    if(id === 'attendPanel') window.renderAttendanceList();
    if(id === 'progressPanel') window.renderGameProgress();
    if(id === 'statsPanel') window.renderAllStats(); 
    if(id === 'memberPanel') window.renderMembers();
    if(id === 'archivePanel') window.renderArchiveDates(); // 기록보관소 추가

    if(id === 'groupPanel') {
        if(typeof window.renderAssignGameTabs === 'function') window.renderAssignGameTabs();
        if(typeof window.renderCustomLaneConfig === 'function') window.renderCustomLaneConfig();
        if(typeof window.renderBungaeJangSelect === 'function') window.renderBungaeJangSelect();
    }

    if(id === 'casinoPanel') {
        window.renderCasino(); // 카지노 렌더링 실행
    }

    if(id === 'inputPanel') {
        if(loggedInUser) {
            const scoreSec = document.getElementById('scoreSection');
            if(scoreSec) scoreSec.style.display = 'block';
            window.renderInputs(); 
        } else {
            const scoreSec = document.getElementById('scoreSection');
            if(scoreSec) scoreSec.style.display = 'none';
        }
    }
};



window.updateUI = function() {
    if(!loggedInUser) return;
    if(window.isConfigEditing || window.isScoreEditing) return;

    const myName = loggedInUser.trim();
    const isL = settings.mode === 'lightning'; // ⚡ 번개모임 여부 변수 (이미 있음)
    const uInfo = document.getElementById('userInfo');
    const settingsTab = document.getElementById('settingsTabBtn');
    
    if(uInfo) uInfo.innerText = `${loggedInUser} ${isAdmin ? '(관리자)' : ''}`;
    if(settingsTab) settingsTab.style.display = isAdmin ? 'block' : 'none';

    // 1. 구역 버튼 색상 (z1~z5)
    for(let i=1; i<=5; i++) {
        const btn = document.getElementById('z'+i);
        if(btn) {
            if(selectedBlocks.includes(i)) btn.classList.add('selected');
            else btn.classList.remove('selected');
        }
    }
    if(window.renderCustomLaneConfig) window.renderCustomLaneConfig(); 

    // 2. 상단 타이틀 표시
    const panelTitle = document.getElementById('modeDisplay');
    if(panelTitle) {
        panelTitle.innerHTML = isL ? 
            '<span style="color:#e67e22;">⚡ 번개모임 (6게임)</span>' : 
            '<span style="color:#2c3e50;">⚖️ 정기모임 (4게임)</span>';
    }

    // 🎯 [여기에 새로운 로직 추가됨] 정기/번개에 따른 버튼 구역 제어
    const regSec = document.getElementById('regularSection'); // 정기용 버튼 구역
    const casSec = document.getElementById('casinoSection'); // 번개용 카지노 구역

    if (isL) {
        // 번개일 때: 카지노 게임 박스만 보여줌
        if(regSec) regSec.style.display = 'none';
        if(casSec) casSec.style.display = 'block';
    } else {
        // 정기일 때: 일반 배정 버튼만 보여줌
        if(regSec) regSec.style.display = 'flex';
        if(casSec) casSec.style.display = 'none';
    }

    // 3. 운영진 명칭 및 권한 설정
    const jName = document.getElementById('displayJungmoName');
    const managerLabel = document.querySelector('.box-manager span:first-child');

    if (jName) {
        jName.innerText = isL ? (managers.lightning || '미정') : (managers.jungmo || '미정');
        if (managerLabel) {
            managerLabel.innerText = isL ? '⚡ 번개장' : '👑 정모장';
        }
    }

    const currentJungmoJang = (managers.jungmo || "").trim();
    const currentBungaeJang = (managers.lightning || "").trim();
    let hasPower = isAdmin || (isL ? currentBungaeJang === myName : currentJungmoJang === myName);

    // 4. 관리자 전용 박스 표시 여부
    const eventCreateBox = document.getElementById('adminEventCreate');
    const eventSelectBox = document.getElementById('activeMeetingSelector');
    const memAdminBox = document.getElementById('adminMemberControls');
    const jungmoSettingBox = document.getElementById('adminJungmoSetting');
    const bBox = document.getElementById('lightningManagerSelect');

    if(eventCreateBox) eventCreateBox.style.display = hasPower ? 'block' : 'none';
    if(eventSelectBox) eventSelectBox.style.display = hasPower ? 'block' : 'none';
    if(memAdminBox) memAdminBox.style.display = hasPower ? 'block' : 'none';
    if(jungmoSettingBox) jungmoSettingBox.style.display = isAdmin ? 'block' : 'none';
    
    if(bBox) {
        bBox.style.display = isL ? 'block' : 'none';
    }

    const jSettingName = document.getElementById('currentJungmoJangSetting');
    if (jSettingName) jSettingName.innerText = managers.jungmo || '없음';

    const bNameSpan = document.getElementById('currentBungaeJang');
    if (bNameSpan) bNameSpan.innerText = managers.lightning || '없음';

    // 5. 각종 렌더링 함수 실행
    if(typeof window.renderEventList === 'function') window.renderEventList();
    if(typeof window.renderAssignGameTabs === 'function') window.renderAssignGameTabs(); 
    if(typeof window.renderMembers === 'function') window.renderMembers();
    if(typeof window.renderCasino === 'function') window.renderCasino();
    if(typeof window.renderBungaeJangSelect === 'function') window.renderBungaeJangSelect();

    // 6. 설정값 동기화 및 패널별 추가 렌더링
    if(document.getElementById('groupAssignMethod')) 
        document.getElementById('groupAssignMethod').value = settings.assignMethod || 'snake';
    if(document.getElementById('setAssignMethod')) 
        document.getElementById('setAssignMethod').value = settings.assignMethod || 'snake';

    const activePanel = document.querySelector('.panel.active');
    if(activePanel) {
        if(activePanel.id === 'progressPanel' && typeof window.renderGameProgress === 'function') {
            window.renderGameProgress();
        }
        if(activePanel.id === 'inputPanel' && typeof window.renderInputs === 'function') {
            window.renderInputs();
        }
        if(activePanel.id === 'statsPanel' && typeof window.renderAllStats === 'function') {
            window.renderAllStats();
        }
        if(typeof window.jumpToSpecificEvent === 'function') window.jumpToSpecificEvent();
    }
};

window.createEvent = function() {
    const date = document.getElementById('eventDate').value;
    const exactTime = document.getElementById('eventExactTime').value; 
    const mode = document.getElementById('eventMode').value;
    
    if(!date || !exactTime) return alert("날짜와 시간을 모두 확인해 주세요!");

    const combinedTime = exactTime; 
    const id = `${date}_${exactTime.replace(':', '')}`; 
    
    db.ref('bowling_v14/events/' + id).set({ 
        id, 
        date, 
        time: combinedTime, 
        mode, 
        attendees: [] 
    }).then(() => {
        alert("✅ 모임 공지 완료!");
    });
};

const formatTime = (t) => {
    if(!t) return "";
    let [h, m] = t.split(':');
    h = parseInt(h);
    const ampm = h < 12 ? '오전' : '오후';
    h = h % 12 || 12; // 0시는 12시로 표시
    return `${ampm} ${String(h).padStart(2, '0')}:${m}`;
};

// [번개장 선택] 참석자 명단이 쭉 뜨고, 클릭하면 바로 번개장으로 지정됩니다.
window.renderBungaeJangSelect = function() {
    const listArea = document.getElementById('bangaeMemberList'); 
    if (!listArea) return;

    // 1. [중요] 참석자 명단에서 고스트는 제외하고 진짜 사람만 가져옵니다.
    const realAttendees = attendees.filter(n => n && !n.includes("고스트"));

    if (realAttendees.length === 0) {
        listArea.innerHTML = '<div style="color:#999; text-align:center; padding:20px; border:1px dashed #ddd;">참석 신청자가 없습니다.</div>';
        return;
    }

    const currentBoss = managers.lightning || "";

    // 2. 이름들을 나열하여 선택 가능한 버튼으로 만듭니다.
    let html = realAttendees.map(name => {
        const isSelected = (name === currentBoss);
        const style = isSelected 
            ? "background:#fff9db; border:2px solid #fab005; color:#e67e22; font-weight:bold;" 
            : "background:#f8f9fa; border:1px solid #eee; color:#333;";

        return `
            <div style="padding:12px 15px; border-radius:8px; cursor:pointer; display:flex; align-items:center; ${style}"
                 onclick="window.setLightningBoss('${name}')">
                <div style="width:18px; height:18px; border-radius:50%; border:2px solid ${isSelected?'#fab005':'#ccc'}; margin-right:10px; background:white; display:flex; align-items:center; justify-content:center;">
                    ${isSelected ? '<div style="width:10px; height:10px; border-radius:50%; background:#fab005;"></div>' : ''}
                </div>
                <span style="flex:1; font-size:1.1rem;">${name}</span>
                ${isSelected ? '<span>👑</span>' : ''}
            </div>
        `;
    }).join('');

    listArea.innerHTML = html;
};

// 번개장 클릭 시 저장 함수
window.setLightningBoss = function(name) {
    if(!confirm(`⚡ [${name}] 님을 오늘의 번개장으로 지정할까요?`)) return;
    
    db.ref('bowling_v14/managers/lightning').set(name).then(() => {
        // 성공 시 즉시 UI 갱신
        window.updateUI();
    });
};

window.renderEventList = function() {
    const area = document.getElementById('eventListArea');
    if(!area) return;

    const now = new Date().toISOString().split('T')[0];
    let html = '';

    const myName = (loggedInUser || "").trim();
    const isL = settings.mode === 'lightning';
    const hasPower = isAdmin || (isL ? (managers.lightning === myName) : (managers.jungmo === myName));

    const sortedIds = Object.keys(events || {}).sort((a, b) => b.localeCompare(a));
    const commonBtnStyle = "width: 95px; height: 38px; font-size: 0.9rem; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;";

    sortedIds.forEach(id => {
        const ev = events[id];
        if (ev.date < now) return;

        const list = ev.attendees || [];
        const joined = list.includes(loggedInUser);
        
        const fCount = list.filter(n => members.find(m => m.name === n)?.gender === '여').length;
        const mCount = list.length - fCount;

        html += `
        <div id="event_${ev.id}" class="input-box" style="border-left:10px solid ${ev.mode==='regular'?'#6741d9':'#f08c00'}; padding:18px;">
            
            <div style="margin-bottom:15px;">
                <div style="font-size:0.85rem; color:#888;">${ev.date}</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <b style="font-size:1.35rem; color:#222;">${formatTime(ev.time)}</b>
                    <span style="font-size:0.75rem; background:#f1f3f5; color:#666; padding:2px 8px; border-radius:4px; font-weight:bold;">
                        ${ev.mode==='regular'?'⚖️ 정기':'⚡ 번개'}
                    </span>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; background:#f8f9fa; padding:12px; border-radius:12px; border:1px solid #eee;">
                <div style="font-size:0.9rem; color:#495057;">
                    <b style="font-size:1rem; color:#222;">👥 ${list.length}명</b> 
                    <div style="margin-top:2px; font-size:0.8rem; color:#888;">
                        <span style="color:#339af0;">남 ${mCount}</span> / <span style="color:#ff922b;">여 ${fCount}</span>
                    </div>
                </div>
                
                <div style="display:flex; gap:6px;">
                    <button style="${commonBtnStyle} background:${joined?'#ff6b6b':'#20c997'}; color:white;" 
                        onclick="window.toggleEventJoin('${id}')">
                        ${joined ? '참석취소' : '신청하기'}
                    </button>
                    
                    ${hasPower ? `
                        <button style="${commonBtnStyle} background:#6741d9; color:white;" 
                            onclick="window.activateSelectedEventDirect('${id}')">
                            게임시작 🚀
                        </button>
                        <button style="width: 40px; height: 38px; border-radius: 8px; border: 1px solid #e03131; background: #fff; color: #e03131; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0;" 
                            onclick="window.deleteEvent('${id}')">
                            🗑️
                        </button>
                        ` : ''}
                </div>
            </div>
            
            ${hasPower ? `
            <div style="margin-top:15px; display:flex; gap:5px; padding-top:10px; border-top:1px dashed #ddd;">
                <select id="adminAddSelect_${id}" class="btn-sm" style="flex:1; height:38px; border:1px solid var(--accent);">
                    <option value="">-- 대리 신청 (회원 선택) --</option>
                    ${members.sort((a,b)=>a.name.localeCompare(b.name)).map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
                </select>
                <button class="btn-sm" style="background:var(--accent); color:white; border:none; width:60px;"
                    onclick="window.toggleEventJoin('${id}', document.getElementById('adminAddSelect_${id}').value)">
                    추가
                </button>
            </div>
            ` : ''}

            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:15px;">
                ${list.map((name, idx) => {
                    const mInfo = members.find(m => m.name === name) || { gender: '남', handicap: 0 };
                    return `
                        <div style="background:${mInfo.gender==='여'?'#fff0f6':'#e7f5ff'}; border:1px solid ${mInfo.gender==='여'?'#ffdeeb':'#d0ebff'}; padding:6px 12px; border-radius:20px; font-size:0.85rem; display:flex; align-items:center;">
                            <span style="color:#adb5bd; font-size:0.7rem; margin-right:4px;">${idx + 1}</span> 
                            <b>${name}</b> 
                            <span style="margin-left:4px; color:#845ef7; font-weight:bold;">${mInfo.handicap}</span>
                            ${hasPower ? `<span style="color:#fa5252; margin-left:6px; cursor:pointer; font-weight:bold; font-size:1rem;" onclick="window.kickMember('${id}', '${name}')">×</span>` : ''}
                        </div>`;
                }).join('') || '<div style="color:#dee2e6; width:100%; text-align:center; padding:10px;">첫 번째 신청자가 되어보세요!</div>'}
            </div>
        </div>`;
    });

    area.innerHTML = html || '<div style="text-align:center; padding:50px; color:#adb5bd;">모임 일정이 없습니다.</div>';
};

window.activateSelectedEventDirect = function(id) {
    const ev = events[id];
    if(!ev) return;
    if(confirm(`[${ev.date}] 조편성을 시작할까요?`)) {
        db.ref('bowling_v14').update({
            'attendees': ev.attendees || [],
            'settings/mode': ev.mode,
            'settings/gameCount': ev.mode === 'lightning' ? 6 : 4,
            'settings/currentTab': 'groupPanel',
            'settings/currentAssignGame': 1, 
            'settings/currentRankView': 1,   
            'settings/currentInputGame': 1   
        }).then(() => {
            window.showPanel('groupPanel', document.querySelectorAll('.tab-btn')[1]);
        });
    }
};

window.toggleEventJoin = function(id, userName) {
    const targetName = (userName || loggedInUser || "").trim();
    
    if(!targetName) return alert("회원 이름을 선택해주세요.");

    if (!isAdmin && targetName !== loggedInUser) {
        return alert("🚫 본인만 신청 가능합니다.");
    }

    let list = (events[id] && events[id].attendees) ? [...events[id].attendees] : [];
    
    if(list.includes(targetName)) {
        list = list.filter(n => n !== targetName);
    } else {
        list.push(targetName);
    }
    
    db.ref('bowling_v14/events/' + id + '/attendees').set(list).then(() => {
        if(userName) alert(`✅ ${targetName} 님 처리 완료!`);
    });
};

window.activateSelectedEvent = function() {
    const id = document.getElementById('currentActiveEventId').value;
    if(!id || !events[id]) return alert("진행할 모임을 먼저 선택해 주세요!");

    if(confirm("이 명단으로 오늘 게임을 시작할까요?")) {
        const ev = events[id];
        const gCount = ev.mode === 'lightning' ? 6 : 4;

        db.ref('bowling_v14').update({
            'attendees': ev.attendees || [],
            'settings/mode': ev.mode,
            'settings/gameCount': gCount,
            'settings/currentTab': 'groupPanel' 
        }).then(() => {
            alert("🎯 명단 로드 완료! 조편성 화면으로 이동합니다.");
            const tabBtns = document.querySelectorAll('.tab-btn');
            if (tabBtns[1]) {
                window.showPanel('groupPanel', tabBtns[1]);
            }
        });
    }
};

window.changeAssignMethod = function(val) {
    if(db) {
        db.ref('bowling_v14/settings').update({ assignMethod: val })
            .then(() => console.log("조편성 방식 변경 완료: " + val));
    }
};



window.goToInput = function(gameNo, teamNo) { 
    currentInputGame = gameNo;
    currentInputTeam = teamNo; 
    const tabBtns = document.querySelectorAll('.tab-btn');
    const inputTabBtn = tabBtns[4]; 
    window.showPanel('inputPanel', inputTabBtn); 
};

window.clickInputTab = function(btn) {
    currentInputTeam = null;
    window.showPanel('inputPanel', btn);
};

window.showAllTeams = function() {
    currentInputTeam = null;
    window.renderInputs();
};

window.renderAssignGameTabs = function() {
    const area = document.getElementById('assignGameTabs');
    if(!area) return;

    let html = '';
    const count = (settings.mode === 'regular') ? 4 : (settings.gameCount || 6);
    
    for(let i=1; i<=count; i++) {
        const isActive = (currentTargetGame === i) ? 'active' : '';
        html += `<div class="rank-tab ${isActive}" style="flex:1; text-align:center;" onclick="window.setTargetGame(${i})">${i}G</div>`;
    }
    area.innerHTML = html;
};

window.setTargetGame = function(gameNo) {
    currentTargetGame = gameNo;
    window.renderAssignGameTabs();
    if(window.renderCustomLaneConfig) window.renderCustomLaneConfig();
    console.log(`${gameNo}G 조편성 모드로 전환!`);
};

window.runGeneralAssignment = function() {
    if (gameTeams[currentTargetGame]) {
        return alert(`⚠️ 이미 ${currentTargetGame}G 팀 배정이 완료되었습니다.`);
    }

    db.ref('bowling_v14/casino').once('value', sn => {
        if (sn.exists()) {
            alert("🎰 카지노 배정 진행 중입니다!");
        } else {
            window.runAssignment(); 
        }
    });
};


window.renderStatsGameTabs = function() {
    const area = document.getElementById('statsGameTabs');
    if (!area) return;
    let html = '';
    const count = settings.gameCount || 4; 
    for (let i = 1; i <= count; i++) {
        const isActive = (currentStatsGame === i) ? 'active' : '';
        html += `<div class="rank-tab ${isActive}" 
                     style="flex:1; text-align:center; cursor:pointer;" 
                     onclick="currentStatsGame=${i}; window.renderAllStats();">${i}G</div>`;
    }
    area.innerHTML = html;
};

window.renderCurrentGameStats = function() {
    const teamArea = document.getElementById('currentTeamRankTable');
    const indivArea = document.getElementById('currentIndivRankTable');
    if (!teamArea || !indivArea) return;

    const gData = gameTeams[currentStatsGame] || [];
    if (gData.length === 0) {
        teamArea.innerHTML = '<div style="padding:30px; text-align:center; color:#999;">입력된 점수가 없습니다.</div>';
        indivArea.innerHTML = '';
        return;
    }

    let teamRanks = gData.map(t => {
        let sum = (parseInt(t.matchHandy) || 0);
        t.members.forEach(m => {
            const mInfo = members.find(x => x.name === m.name) || {};
            sum += (parseInt(m.score) || 0) + (m.name.includes("고스트") ? 0 : (parseInt(mInfo.handicap) || 0));
        });
        return { teamNo: t.teamNo, total: sum, members: t.members.map(m=>m.name).join(', ') };
    }).sort((a, b) => b.total - a.total);

    teamArea.innerHTML = `
        <table class="stats-table">
            <thead><tr><th>순위</th><th>팀 (멤버)</th><th>총점</th></tr></thead>
            <tbody>
                ${teamRanks.map((tr, i) => `
                    <tr>
                        <td>${i === 0 ? '🥇' : i + 1}</td>
                        <td style="text-align:left; padding-left:15px;">
                            <b style="color:#2c3e50;">Team ${tr.teamNo}</b><br>
                            <small style="color:#adb5bd;">[ ${tr.members} ]</small>
                        </td>
                        <td style="font-weight:bold; color:#3498db;">${tr.total}</td>
                    </tr>`).join('')}
            </tbody>
        </table>`;

    let indivMap = {};
    const totalGameCount = settings.gameCount || 4; 

    let gameHeaders = "";
    for (let i = 1; i <= totalGameCount; i++) {
        gameHeaders += `<th>${i}G</th>`;
    }

    for (let g = 1; g <= totalGameCount; g++) {
        const teams = gameTeams[g] || [];
        teams.forEach(t => {
            t.members.forEach(m => {
                if (!indivMap[m.name]) {
                    const mInfo = members.find(x => x.name === m.name) || { handicap: 0 };
                    indivMap[m.name] = { 
                        name: m.name, 
                        scores: Array(totalGameCount).fill('-'), 
                        accumulatedTotal: 0,
                        gamesPlayed: 0,
                        handicap: (m.name.includes("고스트") ? 0 : (parseInt(mInfo.handicap) || 0)),
                        gender: mInfo.gender || '남'
                    };
                }
                const s = parseInt(m.score) || 0;
                if(s > 0) {
                    indivMap[m.name].scores[g-1] = s;
                    indivMap[m.name].accumulatedTotal += s;
                    indivMap[m.name].gamesPlayed += 1;
                }
            });
        });
    }

    const genderFilter = currentGenderFilter || 'all'; 

    let indivList = Object.values(indivMap)
        .filter(p => !p.name.includes("고스트")) 
        .filter(p => genderFilter === 'all' || p.gender === genderFilter)
        .map(p => {
            p.finalTotal = p.accumulatedTotal + (p.handicap * p.gamesPlayed);
            return p;
        }).sort((a, b) => b.finalTotal - a.finalTotal);

    indivArea.innerHTML = `
        <div style="overflow-x:auto;">
            <table class="stats-table" style="margin-top:10px; min-width:350px;">
                <thead>
                    <tr>
                        <th>순위</th>
                        <th>이름</th>
                        ${gameHeaders} <th style="background:#fff5f5; color:#e74c3c;">합계</th>
                    </tr>
                </thead>
                <tbody>
                    ${indivList.map((p, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td style="font-weight:bold; white-space:nowrap;">${p.name}</td>
                            ${p.scores.map((s, idx) => `
                                <td style="${(s >= 200) ? 'color:#e74c3c; font-weight:bold;' : ((idx+1) === currentStatsGame ? 'color:#222;' : 'color:#adb5bd;')} ${(idx+1) === currentStatsGame ? 'background:#e7f5ff;' : ''}">
                                    ${s}
                                </td>
                            `).join('')}
                            <td style="color:#e74c3c; font-weight:bold; background:#fff5f5;">${p.finalTotal}</td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>`;
};

window.renderHistoricalStats = function() {
    const area = document.getElementById('historicalStatsTable');
    if (!area || !loggedInUser) return;

    if (!records || records.length === 0) {
        area.innerHTML = '<div style="padding:30px; text-align:center; color:#999;">기록 데이터가 없습니다.</div>';
        return;
    }

    // 1. [클럽 공통 기준선] 장부에 있는 모든 날짜를 중복 없이 추출해서 최신순 정렬
    const allSessionDates = [...new Set(records.map(r => r.date))].sort().reverse();
    
    // 2. [12회차 윈도우 확정] 선택된 기간 버튼에 따라 클럽 공통의 기준 날짜 범위를 정함
    let n = 12; // 기본 6개월 = 12회차
    if (currentStatsPeriod === '1m') n = 2;
    else if (currentStatsPeriod === '3m') n = 6;
    else if (currentStatsPeriod === '6m') n = 12;
    else if (currentStatsPeriod === '12m') n = 24;
    else n = 999; // 전체보기

    // 클럽의 최근 N회차 날짜들만 딱 자릅니다. (이게 공통의 '자'입니다)
    const clubWindowDates = (n === 999) ? allSessionDates : allSessionDates.slice(0, n);
    const oldestDate = clubWindowDates[clubWindowDates.length - 1]; // 가장 오래된 기준 날짜

    // 3. [개인별 계산] 모든 회원을 돌면서 '클럽 윈도우' 안에 있는 점수만 합산
    let statsMap = {};
    records.forEach(r => {
        // 이 기록의 날짜가 클럽의 최근 12회차 안에 포함되는가?
        if (clubWindowDates.includes(r.date) && r.scs) {
            const name = (r.name || "").trim();
            if (!name) return;
            if (!statsMap[name]) statsMap[name] = { name: name, total: 0, count: 0, attendedSessions: 0 };
            
            let dailyHasScore = false;
            r.scs.forEach(s => {
                const score = parseInt(s) || 0;
                if (score > 0) {
                    statsMap[name].total += score;
                    statsMap[name].count++;
                    dailyHasScore = true;
                }
            });
            if(dailyHasScore) statsMap[name].attendedSessions++;
        }
    });

    // 4. 리스트 변환 및 정렬
    let statsList = Object.values(statsMap).map(s => ({
        ...s,
        avg: s.count > 0 ? Math.round(s.total / s.count) : 0
    })).sort((a, b) => b.avg - a.avg);

    // 5. 화면 출력 (기준 안내 문구 수정)
    let html = `
        <div style="margin-bottom:10px; font-size:0.85rem; color:#1565c0; text-align:center; background:#e3f2fd; padding:10px; border-radius:8px; border:1px solid #90caf9;">
            📅 <b>클럽 최근 ${clubWindowDates.length}회차 기준</b><br>
            <span style="font-size:0.75rem; color:#666;">(${oldestDate} ~ ${allSessionDates[0]})</span>
        </div>
        <table class="stats-table">
            <thead><tr><th>순위</th><th>이름</th><th>출석/회차</th><th>게임수</th><th>AVG</th></tr></thead>
            <tbody>`;

    html += statsList.map((s, i) => {
        const avgClass = (s.avg >= 200) ? 'class="over-200"' : '';
        return `
            <tr>
                <td>${i + 1}</td>
                <td style="font-weight:bold;">${s.name}</td>
                <td style="font-size:0.8rem; color:#666;">${s.attendedSessions}/${clubWindowDates.length}</td>
                <td>${s.count}</td>
                <td ${avgClass}>${s.avg}</td>
            </tr>`;
    }).join('');

    area.innerHTML = html + `</tbody></table>`;
};

window.setStatsPeriod = function(period, btn) {
    currentStatsPeriod = period;
    const filterBtns = document.querySelectorAll('#statsPanel .filter-btn');
    filterBtns.forEach(b => b.classList.remove('active')); 
    if (btn) btn.classList.add('active'); 
    console.log(`📅 통계 기간 변경: ${period}`);
    window.renderAllStats(); 
};

window.renderTodayTotalRank = function() {
    const totalArea = document.getElementById('todayTotalRankTable');
    if (!totalArea) return;

    let totalMap = {};
    for (let i = 1; i <= settings.gameCount; i++) {
        (gameTeams[i] || []).forEach(t => {
            t.members.forEach(m => {
                if (!totalMap[m.name]) totalMap[m.name] = { name: m.name, totalScore: 0, gameCount: 0 };
                const s = parseInt(m.score) || 0;
                if (s > 0) { totalMap[m.name].totalScore += s; totalMap[m.name].gameCount++; }
            });
        });
    }

    let totalList = Object.values(totalMap).sort((a, b) => b.totalScore - a.totalScore);

    let totalHtml = `
        <table class="stats-table" style="border: 2px solid var(--danger); margin-top: 10px;">
            <thead style="background: #fff5f5;">
                <tr><th>순위</th><th>이름</th><th>게임수</th><th>총점(합계)</th></tr>
            </thead>
            <tbody>`;

    totalHtml += totalList.map((s, i) => {
        const totalClass = (s.totalScore >= 200) ? 'class="over-200"' : '';
        return `
            <tr style="${i === 0 ? 'background: #fff9db; font-weight: bold;' : ''}">
                <td>${i + 1}</td>
                <td>${i === 0 ? '👑 ' : ''}${s.name}</td>
                <td>${s.gameCount}G</td>
                <td ${totalClass}>${s.totalScore}</td>
            </tr>`;
    }).join('');

    totalArea.innerHTML = totalList.length ? (totalHtml + `</tbody></table>`) : '<div style="padding:20px; text-align:center; color:#999;">오늘 데이터가 없습니다.</div>';
};

window.saveSettings = function() {
    const mode = document.getElementById('setMode') ? document.getElementById('setMode').value : settings.mode;
    const cnt = document.getElementById('setGameCount') ? parseInt(document.getElementById('setGameCount').value) : settings.gameCount;
    const avg = parseInt(document.getElementById('setAvgCriteria').value) || 6;
    const method = document.getElementById('setAssignMethod').value;

    if(db) {
        db.ref('bowling_v14/settings').update({
            mode: mode,
            gameCount: cnt,
            avgCriteria: avg,
            assignMethod: method
        }).then(() => {
            const methodKOR = method === 'snake' ? '🐍 스네이크' : (method === 'ai' ? '🤖 AI 밸런스' : '🎲 랜덤');
            alert(`✅ 운영 설정 변경 완료!\n\n` +
                  `📅 가중치 반영 기간: ${avg}개월\n` +
                  `⚖️ 기본 조편성 방식: ${methodKOR}\n\n` +
                  `[확인]을 누르면 설정이 즉시 적용됩니다.`);
            location.reload(); 
        });
    }
};

window.toggleZone = function(n) {
    if(selectedBlocks.includes(n)) {
        selectedBlocks = selectedBlocks.filter(x => x !== n);
    } else {
        selectedBlocks.push(n);
    }
    db.ref('bowling_v14/selectedBlocks').set(selectedBlocks);
    for(let i=1; i<=5; i++) {
        const b = document.getElementById('z'+i);
        if(b) {
            if(selectedBlocks.includes(i)) b.classList.add('selected');
            else b.classList.remove('selected');
        }
    }
    window.renderCustomLaneConfig();
};

window.renderCustomLaneConfig = function() {
    const c = document.getElementById('laneConfigArea');
    if(!c) return;
    
    if(selectedBlocks.length === 0) { 
        c.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#999;">[1. 구역 선택] 버튼을 눌러주세요.</div>'; 
        return; 
    }

    let html = '';
    selectedBlocks.sort((a,b)=>a-b).forEach(z => {
        const start = (z-1)*4 + 3; 
        [start, start+1, start+2, start+3].forEach(l => {
            let valCnt = laneSettings['cnt_'+l] || 0; 
            let valTeam = laneSettings['team_'+l] || 0;
            
            html += `
            <div class="lane-box-v13">
                <div class="lane-label" style="font-weight:bold; color:var(--purple);">${l}L</div>
                
                <input type="number" inputmode="numeric" class="lane-input" placeholder="인원"
                       value="${valCnt > 0 ? valCnt : ''}" 
                       onfocus="window.isConfigEditing=true;" 
                       onblur="window.isConfigEditing=false;" 
                       onchange="window.updateConfig('cnt_${l}', this.value)"
                       style="width: 100%; height:40px; text-align: center; border: 1px solid #ccc; font-size:1.2rem;">
                
                <input type="number" inputmode="numeric" class="lane-input" placeholder="팀"
                       value="${valTeam > 0 ? valTeam : ''}" 
                       onfocus="window.isConfigEditing=true;" 
                       onblur="window.isConfigEditing=false;" 
                       onchange="window.updateConfig('team_${l}', this.value)"
                       style="width: 100%; height:40px; text-align: center; border: 1px solid #ccc; font-size:1.2rem; background:#f9f9f9;">
            </div>`; 
        });
    });
    c.innerHTML = html;
};

window.updateConfig = function(k, v) { 
    laneSettings[k] = parseInt(v) || 0; 
    if(db) {
        db.ref('bowling_v14/laneSettings').set(laneSettings)
            .then(() => {
                console.log("레인 설정 저장 완료");
                window.renderCustomLaneConfig(); 
            });
    } else {
        window.renderCustomLaneConfig(); 
    }
};

// 조편성 및 핸디캡용 엔진도 '클럽 12회차' 기준으로 동기화
window.getWeightedStats = function(name) {
    if (!name || name.includes("고스트")) return { weightedAvg: 0, simpleAvg12: 0 };

    // 1. [클럽 공통 기준] 최근 12회차 날짜 리스트 (전체 바구니)
    const allSessionDates = [...new Set(records.map(r => r.date))].sort().reverse().slice(0, 12);
    
    // 2. [가중치 구간 분리] 최근 6회차 vs 과거 6회차
    const recentWindow = allSessionDates.slice(0, 6);
    const pastWindow = allSessionDates.slice(6, 12);

    let recentScores = [], pastScores = [], totalScores12 = [];

    // 3. 해당 회원의 기록을 뒤져서 각 구간에 배분
    records.filter(r => r.name === name && allSessionDates.includes(r.date)).forEach(r => {
        if(r.scs) r.scs.forEach(s => {
            const score = parseInt(s) || 0;
            if (score > 0) {
                totalScores12.push(score);
                if (recentWindow.includes(r.date)) recentScores.push(score);
                else if (pastWindow.includes(r.date)) pastScores.push(score);
            }
        });
    });

    // 4. 구간별 평균 계산
    const getAvg = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
    
    const simpleAvg12 = Math.round(getAvg(totalScores12)); // 통계 탭 표시용 (단순평균)
    const recentAvg = getAvg(recentScores);
    const pastAvg = getAvg(pastScores);

    // 5. [핵심] 가중치 적용 (최근 70% : 과거 30%)
    // 만약 한쪽 구간에 기록이 없다면 있는 쪽 점수를 100% 반영합니다.
    let weightedAvg = 0;
    if (recentAvg > 0 && pastAvg > 0) {
        weightedAvg = Math.round((recentAvg * 0.7) + (pastAvg * 0.3));
    } else {
        weightedAvg = Math.round(recentAvg || pastAvg || simpleAvg12);
    }

    return { 
        weightedAvg: weightedAvg || 0, // 조편성 엔진이 사용할 '진짜 실력'
        simpleAvg12: simpleAvg12 || 0  // 통계 화면에 보여줄 '공식 에버'
    };
};



window.renderGameProgress = function() {
    const tBox = document.getElementById('progTabs');
    let tHtml = '';
    for(let i=1; i<=settings.gameCount; i++) tHtml += `<div class="rank-tab ${currentRankView===i?'active':''}" onclick="currentRankView=${i};window.renderGameProgress()">${i}G</div>`;
    tBox.innerHTML = tHtml;
    const gData = gameTeams[currentRankView] || [];
    const renderMem = (m, teamMatchHandy) => {
        if(!m) return "";
        const isG = m.name.includes("고스트");
        const s = window.getWeightedStats(m.name);
        const mInfo = members.find(x => x.name === m.name) || {};
        const h = isG ? (parseInt(teamMatchHandy) || 0) : (parseInt(mInfo.handicap) || 0);
        const total = (parseInt(m.score) || 0) + h;
        let arrow = '';
        if(!isG) {
            if(s.weightedAvg > s.simpleAvg12) arrow = '<span style="color:red;">▲</span>';
            else if(s.weightedAvg < s.simpleAvg12) arrow = '<span style="color:blue;">▼</span>';
            else arrow = '<span style="color:#999;">-</span>';
        }
        return `
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f1f1f1; align-items:center;">
                <div style="line-height:1.2;">
                    <b style="font-size:1.05rem;">${m.name}</b><br>
                    <small style="color:#666;">${!isG ? `(${s.simpleAvg12 || 0}) <b>${s.weightedAvg || 0}</b> ${arrow}` : '고스트'} <b style="color:#8e44ad; margin-left:4px;">H:${h}</b></small>
                </div>
                <div style="font-size:1.15rem; font-weight:bold;">${total}</div>
            </div>`;
    };
    const cardsHtml = gData.map(t => {
        let teamSum = (parseInt(t.matchHandy) || 0);
        t.members.forEach(m => teamSum += (parseInt(m.score) || 0) + (m.name.includes("고스트") ? 0 : (parseInt(members.find(x=>x.name===m.name)?.handicap) || 0)));
        const L = [t.members[0], t.members[2], t.members[4]]; 
        const R = [t.members[1], t.members[3]]; 
        return `
            <div class="team-card" style="margin-bottom:20px; border:2px solid #6c5ce7; border-radius:12px; overflow:hidden; background:white;">
                <div class="team-header" onclick="window.goToInput(${currentRankView}, ${t.teamNo})" style="background:#6c5ce7; color:white; padding:10px 15px; display:flex; justify-content:space-between; align-items:center;">
                    <b>Team ${t.teamNo} <small>(에버합:${t.totalAvg})</small></b>
                    <span style="background:white; color:#6c5ce7; padding:2px 10px; border-radius:15px; font-weight:bold;">총점: ${teamSum}</span>
                </div>
                <div style="display: flex;">
                    <div style="flex: 1.1; border-right: 1px dashed #ddd; padding: 10px;">
                        <div style="text-align:center; font-weight:bold; color:#3498db; font-size:0.8rem; background:#f0f8ff; border-radius:4px; margin-bottom:5px;">${L[0]?.lane || '?'}L (좌)</div>
                        ${L.map(m => renderMem(m, t.matchHandy)).join('')}
                    </div>
                    <div style="flex: 1; padding: 10px;">
                        <div style="text-align:center; font-weight:bold; color:#e67e22; font-size:0.8rem; background:#fff5eb; border-radius:4px; margin-bottom:5px;">${R[0]?.lane || '?'}L (우)</div>
                        ${R.map(m => renderMem(m, t.matchHandy)).join('')}
                    </div>
                </div>
                ${t.matchHandy > 0 ? `<div style="font-size:0.75rem; color:#8e44ad; padding:4px; text-align:center; background:#f3f0ff; border-top:1px solid #eee; font-weight:bold;">🛡️ 매치 핸디 보너스 +${t.matchHandy}</div>` : ''}
            </div>`;
    }).join('') || '<div style="text-align:center; padding:50px; color:#999;">데이터 없음</div>';
    document.getElementById('teamCardArea').innerHTML = cardsHtml;
};

window.updateScore = function(n, v) { (gameTeams[currentInputGame]||[]).forEach(t => t.members.forEach(m => { if(m.name===n) m.score = parseInt(v); })); };

window.saveAllScores = function() {
    if(window.isSaving) return;
    window.isSaving = true;

    if (!gameTeams || Object.keys(gameTeams).length === 0) {
        window.isSaving = false;
        return alert("🚨 저장할 데이터가 없습니다.");
    }

    try {
        const cleanData = JSON.parse(JSON.stringify(gameTeams));
        let updates = {};
        updates['bowling_v14/gameTeams'] = cleanData;

        let nextGame = (currentInputGame || 1) + 1;
        const maxGame = settings.gameCount || 4;
        if (nextGame > maxGame) nextGame = currentInputGame;

        updates['bowling_v14/settings/currentTab'] = 'statsPanel';
        updates['bowling_v14/settings/currentStatsGame'] = currentInputGame;
        updates['bowling_v14/settings/currentAssignGame'] = nextGame;
        updates['bowling_v14/settings/currentRankView'] = currentInputGame;

        db.ref().update(updates)
            .then(() => {
                alert(`✅ ${currentInputGame}G 저장 성공!`);
                if(document.querySelectorAll('.tab-btn')[5]) {
                    window.showPanel('statsPanel', document.querySelectorAll('.tab-btn')[5]);
                }
            })
            .catch(err => {
                alert("❌ 저장 거부됨 (원인: " + err.message + ")");
            })
            .finally(() => {
                window.isSaving = false;
            });

    } catch (e) {
        window.isSaving = false;
        alert("저장 준비 중 오류: " + e.message);
    }
};

window.filterCurrentStats = function(gender, btn) {
    currentGenderFilter = gender;
    document.querySelectorAll('#statsPanel .filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    window.renderCurrentGameStats();
};

window.deleteEvent = function(id) {
    if (confirm("⚠️ 이 모임 공지를 삭제할까요?\n조편성 대기 중인 명단도 함께 초기화됩니다.")) {
        // 1. 공지 삭제
        db.ref('bowling_v14/events/' + id).remove()
        .then(() => {
            // 2. 현재 진행 중인 명단(attendees)과 번개장 정보도 함께 삭제
            let updates = {};
            updates['bowling_v14/attendees'] = [];
            updates['bowling_v14/managers/lightning'] = null;
            
            db.ref().update(updates).then(() => {
                alert("✅ 공지 및 관련 명단이 모두 삭제되었습니다.");
            });
        })
        .catch(err => alert("❌ 삭제 실패: " + err));
    }
};

window.kickMember = function(eventId, userName) {
    if(!confirm(`[${userName}] 님을 명단에서 제외할까요?`)) return;
    const ev = events[eventId];
    if(!ev || !ev.attendees) return;
    const newList = ev.attendees.filter(n => n !== userName);
    db.ref(`bowling_v14/events/${eventId}/attendees`).set(newList)
      .then(() => alert(`${userName} 님이 제외되었습니다.`));
};  

window.logout = function() { localStorage.clear(); location.reload(); };

window.checkGender = function(sel) {
    document.getElementById('newMemHandicap').value = (sel.value === '여' ? 12 : 0);
};

window.addMember = function() {
    const nameInput = document.getElementById('newMemName');
    const genderInput = document.getElementById('newMemGender');
    const handicapInput = document.getElementById('newMemHandicap');
    const name = nameInput.value.trim();
    const gender = genderInput.value;
    const handicap = parseInt(handicapInput.value) || 0;
    if(!name) return alert("이름 입력!");
    db.ref('bowling_v14/members').push({ name: name, gender: gender, handicap: handicap, pw: '1234' }).then(() => location.reload());
};

window.renderAttendanceList = function() {
    const a = document.getElementById('attendListArea');
    if(!a) return;
    const sorted = members.filter(m => m.status !== '탈퇴').sort((a,b) => a.name.localeCompare(b.name));
    a.innerHTML = sorted.map(m => {
        const is = attendees.includes(m.name); 
            const nameStyle = is ? 'color:var(--green); font-weight:bold; font-size:1.2rem;' : 'color:#333; font-size:1.2rem;';
        const btnStyle = is ? 'background:var(--green); color:white; border-color:var(--green);' : 'background:#fff; color:#333; border-color:#ddd;';
        
        return `<div class="member-row" style="padding:12px;">
            <span style="${nameStyle}">${m.name}</span>
            <button class="btn-sm" style="${btnStyle}" onclick="window.toggleAtt('${m.name}')">${is?'참석중':'참석'}</button>
        </div>`;
           }).join('');
        if(document.getElementById('attCount')) document.getElementById('attCount').innerText = attendees.length;
};

window.toggleEventJoin = function(id, userName) {
    const targetName = (userName || loggedInUser || "").trim();
    if(!targetName) return alert("회원 이름을 선택해주세요.");
    if (!isAdmin && targetName !== loggedInUser) {
        return alert("🚫 본인만 신청 가능합니다.");
    }
    let list = (events[id] && events[id].attendees) ? [...events[id].attendees] : [];
    if(list.includes(targetName)) {
        list = list.filter(n => n !== targetName);
    } else {
        list.push(targetName);
    }
    db.ref('bowling_v14/events/' + id + '/attendees').set(list).then(() => {
        if(userName) alert(`✅ ${targetName} 님 처리 완료!`);
    });
};

window.deleteMember = function(key) { if(confirm("삭제?")) db.ref('bowling_v14/members/' + key).remove(); };
window.deleteAllData = function() { if(confirm("초기화?")) db.ref('bowling_v14').remove().then(() => location.reload()); };
window.resetAttendance = function() { if(confirm("초기화?")) db.ref('bowling_v14/attendees').set([]); };
window.closeModal = function() { document.getElementById('modalOverlay').style.display='none'; };
window.showAttendeePopup = function() { document.getElementById('modalOverlay').style.display='flex'; document.getElementById('modalTitle').innerText = `참석자 (${attendees.length}명)`; document.getElementById('modalContent').innerHTML = attendees.join(', '); };

window.toggleMode = function() {
    const nextMode = settings.mode === 'regular' ? 'lightning' : 'regular';
    const nextGameCount = (nextMode === 'lightning') ? 6 : 4;
    db.ref('bowling_v14/settings').update({ 
        mode: nextMode, 
        gameCount: nextGameCount, 
        currentTab: 'groupPanel'
    }).then(() => {
        const modeName = nextMode === 'lightning' ? '⚡번개(6G)' : '⚖️정기(4G)';
        alert(`${modeName} 모드로 전환되었습니다!`);
    });
};

window.resetAssignment = function() {
    const myName = (loggedInUser || "").trim();
    const isBoss = isAdmin || (managers.jungmo === myName) || (managers.lightning === myName);
    if (!isBoss) return alert("🚫 초기화 권한이 없습니다.");

    const gIdx = currentTargetGame; 
    if (confirm(`⚠️ [완전 초기화] 현재 [${gIdx}G]의 결과와\n참석자 명단(번개장 선택 포함)을 모두 삭제하시겠습니까?`)) {
        let updates = {};
        updates[`bowling_v14/gameTeams/${gIdx}`] = null;
        updates['bowling_v14/casino'] = null;
        updates['bowling_v14/managers/lightning'] = null;
        updates['bowling_v14/laneSettings'] = null; 
        updates['bowling_v14/selectedBlocks'] = null; 
        
        // ✨ [핵심 추가] 참석자 명단(attendees)도 함께 비웁니다!
        updates['bowling_v14/attendees'] = []; 
        updates['bowling_v14/settings/currentAssignGame'] = 1;

        db.ref().update(updates).then(() => {
            // 로컬 변수도 즉시 비워줍니다 (충돌 방지)
            attendees = []; 
            alert(`✅ 모든 데이터가 깨끗하게 초기화되었습니다.`);
            location.reload(); // 확실한 화면 갱신을 위해 리로드 추천
        });
    }
};

window.saveHistory = function() { if(!gameTeams[currentRankView]) return; const h = { date: new Date().toISOString().split('T')[0], game: currentRankView, teams: gameTeams[currentRankView] }; db.ref('bowling_v14/history').push(h).then(() => alert("저장됨")); };
window.viewHistory = function() { db.ref('bowling_v14/history').limitToLast(5).once('value', sn => { const val = sn.val(); if(!val) return alert("기록없음"); let msg = "📜 최근기록\n"; Object.values(val).reverse().forEach(h => msg += `[${h.date} ${h.game}G]\n`); alert(msg); }); };

window.exportData = function() {
    if(!confirm("현재의 모든 데이터를 JSON 파일로 백업하시겠습니까?")) return;
    db.ref('bowling_v14').once('value', sn => {
        const data = sn.val();
        if(!data) return alert("내보낼 데이터가 없습니다.");
        const fileName = `AceBowling_Backup_${new Date().toISOString().split('T')[0]}.json`;
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("✅ 백업 파일(JSON)이 다운로드 폴더에 저장되었습니다.");
    });
};

window.importData = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!confirm("⚠️ 주의: 이 파일을 불러오면 현재의 모든 데이터가 삭제되고 파일 내용으로 덮어씌워집니다.\n정말로 진행하시겠습니까?")) {
        event.target.value = ''; 
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if(!importedData.members && !importedData.records) {
                throw new Error("올바른 에이스 볼링 백업 파일이 아닙니다.");
            }
            db.ref('bowling_v14').set(importedData).then(() => {
                alert("🎉 데이터 복구 성공! 앱을 새로고침합니다.");
                location.reload();
            });
        } catch (err) {
            alert("❌ JSON 읽기 실패: 파일이 손상되었거나 형식이 맞지 않습니다.\n(에러내용: " + err.message + ")");
        }
    };
    reader.readAsText(file);
};

window.downloadExcel = function() {
    db.ref('bowling_v14/records').once('value', (snapshot) => {
        const records = snapshot.val();
        if (!records) return alert("내보낼 데이터가 없습니다.");
        const allDates = [...new Set(Object.values(records).map(r => r.date))].sort();
        const allNames = [...new Set(Object.values(records).map(r => r.name))].sort();
        const header1 = ["이름", "평균", "합계"];
        const header2 = ["", "", ""];
        allDates.forEach(date => {
            header1.push(date, "", "", ""); 
            header2.push("1G", "2G", "3G", "4G");
        });
        const excelRows = [header1, header2];
        allNames.forEach(name => {
            const row = [name];
            let totalSum = 0;
            let totalGames = 0;
            const scoreCells = [];
            allDates.forEach(date => {
                const key = `${date}_${name.replace(/[.#$/[\]]/g, "_")}`;
                const rec = records[key];
                if (rec && rec.scs) {
                    const scs = rec.scs;
                    scoreCells.push(scs[0] || "", scs[1] || "", scs[2] || "", scs[3] || "");
                    totalSum += scs.reduce((a, b) => a + (parseInt(b) || 0), 0);
                    totalGames += scs.length;
                } else {
                    scoreCells.push("", "", "", ""); 
                }
            });
            const avg = totalGames > 0 ? (totalSum / totalGames).toFixed(1) : 0;
            row.push(avg, totalSum, ...scoreCells);
            excelRows.push(row);
        });
        const worksheet = XLSX.utils.aoa_to_sheet(excelRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "전체기록");
        const dateStr = new Date().toISOString().split('T')[0];
        XLSX.writeFile(workbook, `에이스볼링_장부_${dateStr}.xlsx`);
    });
};

window.deleteToday = function() {
    if (confirm("⚠️ [주의] 오늘 생성된 1~6G 조편성과 점수를 모두 삭제하시겠습니까?\n(회원 명단과 가중치 설정은 안전하게 유지됩니다.)")) {
        const check = prompt("정말 삭제하시려면 '삭제'라고 정확히 입력해 주세요.");
        if (check === "삭제") {
            db.ref('bowling_v14/gameTeams').remove()
                .then(() => {
                    alert("✅ 오늘의 모든 게임 기록(1~6G)이 깔끔하게 삭제되었습니다.");
                    location.reload(); 
                })
                .catch(err => alert("❌ 삭제 중 오류 발생: " + err));
        } else {
            alert("❌ 입력이 틀렸습니다. 삭제를 취소합니다.");
        }
    }
};

window.deleteAllData = function() {
    if (confirm("🚨 [경고] 회원 명단, 모든 과거 기록, 설정이 통째로 날아갑니다!")) {
        const check = prompt("데이터를 완전히 초기화하려면 '삭제'라고 정확히 입력해 주세요.");
        if (check === "삭제") {
            db.ref('bowling_v14').remove()
                .then(() => {
                    alert("💥 모든 데이터가 초기화되었습니다. 앱을 처음부터 다시 시작합니다.");
                    location.reload();
                })
                .catch(err => alert("❌ 초기화 오류: " + err));
        } else {
            alert("입력이 틀렸습니다. 삭제를 취소합니다.");
        }
    }
};

window.resetAttendance = function() {
    if (confirm("🔄 현재 참석 체크된 인원들을 모두 해제하시겠습니까?")) {
        db.ref('bowling_v14/attendees').set([])
            .then(() => {
                alert("✅ 참석 명단이 초기화되었습니다.");
                if(window.renderAttendanceList) window.renderAttendanceList();
            })
            .catch(err => alert("❌ 초기화 중 오류: " + err));
    }
};



window.getMyTier = function() {
    const myName = (loggedInUser || "").trim();
    if(!myName || !attendees.length) return null;
    const rankingList = attendees
        .filter(n => !n.includes("고스트")) 
        .map(name => {
            const stats = window.getWeightedStats(name);
            return { name: name.trim(), avg: parseFloat(stats.weightedAvg) || 0 };
        });
    rankingList.sort((a, b) => b.avg - a.avg); 
    const myRank = rankingList.findIndex(player => player.name === myName);
    if(myRank === -1) return null;
    let teamList = [];
    for(let k in laneSettings) {
        if(k.startsWith('team_') && parseInt(laneSettings[k]) > 0) {
            teamList.push(parseInt(laneSettings[k]));
        }
    }
    let T = [...new Set(teamList)].length;
    if (T < 1) T = Math.ceil(rankingList.length / 4); 
    if (T < 1) T = 1; 
    if(myRank < T) return 'red';               
    if(myRank < T * 2) return 'blue';          
    if(myRank < T * 3) return 'green';         
    if(myRank < T * 4) return 'yellow';        
    return 'purple'; // 5번째 티어 안내 추가
};

window.finishCasino = function() {
    if (!isAdmin) return alert("관리자만 종료할 수 있습니다.");
    if (!confirm("카지노 배정을 종료하고 진행 페이지로 이동할까요?")) return;

    // 1. 현재 카지노 칩 결과(casinoData)를 기반으로 공식 팀(gameTeams) 생성
    const newTeams = {};
    const currentLanes = selectedBlocks || [1, 2, 3, 4, 5]; // 현재 선택된 구역/레인

    // 카지노 칩 데이터를 순회하며 팀 구성
    Object.keys(casinoData || {}).forEach(uid => {
        const chip = casinoData[uid];
        if (chip && chip.lane && chip.team) {
            const laneKey = chip.lane + 'L'; // 예: 1L
            const teamKey = chip.team;      // 예: A or B
            
            if (!newTeams[laneKey]) newTeams[laneKey] = {};
            if (!newTeams[laneKey][teamKey]) newTeams[laneKey][teamKey] = [];
            
            // 참가자 이름 찾기 (members 데이터 참조)
            const member = members[uid];
            if (member) {
                newTeams[laneKey][teamKey].push({
                    uid: uid,
                    name: member.name,
                    handy: member.handy || 0,
                    avg: member.avg || 0
                });
            }
        }
    });

    // 2. Firebase에 공식 팀 데이터 저장 (이게 되어야 진행 페이지에 뜸)
    const updates = {};
    updates['bowling_v14/gameTeams'] = newTeams;
    updates['bowling_v14/casino/status'] = 'finished'; // 카지노 종료 상태로 변경

    db.ref().update(updates).then(() => {
        alert("✅ 팀 배정이 완료되었습니다! 진행 페이지로 이동합니다.");
        
        // 3. 진행 페이지(progressPanel)로 화면 전환
        window.showPanel('progressPanel');
        
        // 4. 즉시 화면 갱신 (핸디, 가중치 등이 계산되어 그려짐)
        if (typeof window.renderGameProgress === 'function') {
            window.renderGameProgress();
        }
    }).catch(err => {
        console.error("카지노 종료 중 오류:", err);
        alert("데이터 저장에 실패했습니다.");
    });
};

window.nextTeam = function(lane, current) {
    let next = (current >= 8) ? 0 : current + 1;
    window.updateConfig('team_' + lane, next);
};

if(document.getElementById('progDate')) document.getElementById('progDate').value = new Date().toISOString().split('T')[0];
if(document.getElementById('inputDate')) document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];

window.lightningHistoryCache = null;

window.saveLightningHistory = function() {
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const today = new Date(now.getTime() - offset).toISOString().split('T')[0];

    if(!confirm(`${today} 번개 기록을 히스토리에 보관할까요?\n(개인 에버에는 반영되지 않습니다)`)) return;

    db.ref('bowling_v14/lightning_history/' + today).set({
        date: today,
        gameTeams: gameTeams,
        settings: settings || {} 
    }).then(() => {
        alert("🎯 번개 히스토리에 안전하게 저장되었습니다!");
    }).catch(err => {
        alert("❌ 저장 실패: " + err.message);
    });
};

db.ref('bowling_v14/lightning_history').on('value', sn => {
    const data = sn.val();
    window.lightningHistoryCache = data || {}; 
    
    if(typeof window.renderLightningHistoryButtons === 'function') {
        window.renderLightningHistoryButtons();
    }
});

window.renderLightningHistoryButtons = function() {
    const btnArea = document.getElementById('lightningDateButtons');
    if(!btnArea) return; 

    const data = window.lightningHistoryCache;
    if(!data) {
        btnArea.innerHTML = '<span style="font-size:0.8rem; color:#ccc; padding:5px;">불러오는 중...</span>';
        return;
    }

    const dates = Object.keys(data).sort().reverse().slice(0, 4); 

    if(dates.length === 0) {
        btnArea.innerHTML = '<span style="font-size:0.8rem; color:#ccc; padding:5px;">📭 기록 없음</span>';
        return;
    }

    btnArea.innerHTML = dates.map(date => {
        const shortDate = date.split('-').slice(1).join('/');
        return `
            <button class="filter-btn" 
                style="padding:6px 14px; font-size:0.8rem; flex-shrink:0; margin-right:5px; background:#fcc419; color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1);" 
                onclick="window.loadLightningHistory('${date}')">
                📂 ${shortDate}
            </button>`;
    }).join('');
};

window.loadLightningHistory = function(date) {
    const historyData = window.lightningHistoryCache ? window.lightningHistoryCache[date] : null;
    
    if(!historyData || !historyData.gameTeams) {
        return alert("⚠️ 해당 날짜의 데이터를 찾을 수 없습니다.");
    }

    if(!confirm(`📂 [${date}] 기록을 불러오시겠습니까?\n현재 화면의 점수는 사라지고 과거 기록으로 바뀝니다.`)) return;

    gameTeams = historyData.gameTeams;
    if(historyData.settings) settings = historyData.settings;

    alert(`✅ ${date} 기록 복원 완료!`);

    if(typeof window.renderAllStats === 'function') window.renderAllStats();
    
    const tabBtns = document.querySelectorAll('.tab-btn');
    if(tabBtns[5]) window.showPanel('statsPanel', tabBtns[5]); 
};

window.isScoreEditing = false;

// ✅ [수정된 마스터 감시자] 점수 증발 방지 및 화면 동기화 통합
if (db) {
    db.ref('bowling_v14').off(); // 기존에 꼬여있을지 모르는 모든 감시를 일단 해제

    // ✅ 실시간 데이터 동기화 마스터 엔진
if (db) {
    db.ref('bowling_v14').on('value', sn => {
        const val = sn.val() || {};
        
        members = val.members ? Object.keys(val.members).map(k => ({ ...val.members[k], key: k })) : [];
        attendees = val.attendees || [];
        records = val.records ? Object.keys(val.records).map(k => ({ ...val.records[k], key: k })) : [];
        events = val.events || {};
        
        // ✨ [핵심 추가] 카지노 데이터를 전역 변수 'casino'에 저장
        window.casino = val.casino || null; 
        
        if(val.settings) settings = val.settings;
        if(val.managers) managers = val.managers; 
        if(val.laneSettings) laneSettings = val.laneSettings || {}; 
        if(val.selectedBlocks) selectedBlocks = val.selectedBlocks || []; 

        if (!window.isScoreEditing && !window.isConfigEditing) {
            gameTeams = val.gameTeams || {};
            window.updateUI();
        }
    });
}
}
window.renderInputs = function() {
    const tabs = document.getElementById('inputTabs');
    const area = document.getElementById('inputGridArea');
    if (!area) return;

    const myName = (loggedInUser || "").trim();
    // 🛡️ [권한 체크 1] 운영진(관리자, 정모장, 번개장) 여부 확인
    const isPowerfulManager = isAdmin || (managers.jungmo === myName) || (managers.lightning === myName);
    
    const count = settings.gameCount || 4;
    let tHtml = '';
    for(let i=1; i<=count; i++) {
        tHtml += `<div class="rank-tab ${currentInputGame===i?'active':''}" onclick="currentInputGame=${i};window.renderInputs()">${i}G</div>`;
    }
    tabs.innerHTML = tHtml;

    let gData = gameTeams[currentInputGame] || [];
    if (gData.length === 0) {
        area.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">⚠️ 배정된 데이터가 없습니다.</div>';
        return;
    }

    let h = '';
    gData.forEach(t => {
        const teamLeader = t.members[0] ? t.members[0].name : "";
        const isTeamLeader = (myName === teamLeader);
        const isMyTeam = t.members.some(m => m.name === myName);

        // 👁️ [시각적 격리] 운영진이 아니고 내 팀도 아니면 화면에서 숨김
        if (!isPowerfulManager && !isMyTeam) return;

        h += `<div class="input-team-box" style="border: 2px solid ${isMyTeam ? 'var(--accent)' : '#eee'};">
                <div class="input-team-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>Team ${t.teamNo} (레인: ${t.members[0].lane}L)</span>
                    ${isTeamLeader ? '<span style="font-size:0.7rem; background:white; color:var(--accent); padding:2px 6px; border-radius:4px; font-weight:bold;">👑 팀장(1번)</span>' : ''}
                </div>`;
        
        t.members.forEach(m => {
            const isMe = (m.name === myName);
            const isGhost = m.name.includes("고스트") || m.isGhost;
            
            // 🛡️ [입력 권한] 본인, 해당 팀장, 또는 운영진(관리자/정모장/번개장)만 수정 가능
            const canEdit = isMe || isTeamLeader || isPowerfulManager;

            h += `
            <div class="score-row" style="display:flex; justify-content:space-between; align-items:center; padding:10px 15px; border-bottom:1px solid #eee;">
                <span class="score-name" style="${isMe ? 'color:var(--accent); font-weight:bold;' : ''}">
                    ${m.name} ${isMe ? '(나)' : ''}
                </span>

                <input type="number" inputmode="numeric" class="score-input"
                       value="${m.score||0}" 
                       ${(!canEdit || isGhost) ? 'readonly style="background:#f8f9fa; color:#ccc;"' : ''}
                       onfocus="window.isScoreEditing=true; if(this.value=='0') this.value='';" 
                       onblur="window.isScoreEditing=false; if(${canEdit}) window.syncScoreDirect('${currentInputGame}', '${t.teamNo}', '${m.name}', this.value)"
                       oninput="if(this.value.length > 3) this.value = this.value.slice(0, 3); if(parseInt(this.value) > 300) this.value = 300;"
                       style="width:80px; height:40px; font-size:1.3rem; text-align:center; border:2px solid #ccc; border-radius:8px;">
            </div>`;
        });

        // 💾 [저장 권한] 팀장 또는 운영진(관리자/정모장/번개장)에게만 버튼 노출
        if (isTeamLeader || isPowerfulManager) {
            h += `
            <div style="padding:15px; background:#f0f7ff; text-align:center;">
                <button class="universal-btn" style="background:var(--accent); margin:0;" onclick="window.saveAllScores()">
                    💾 Team ${t.teamNo} 점수 최종 확정
                </button>
            </div>`;
        }
        h += `</div>`;
    });
    area.innerHTML = h || '<div style="padding:40px; text-align:center; color:#999;">회원님의 팀 정보를 찾을 수 없습니다.</div>';
};;

window.regularHistoryCache = null;

db.ref('bowling_v14/regular_history').on('value', sn => {
    window.regularHistoryCache = sn.val() || {};
    if(typeof window.renderRegularHistoryButtons === 'function') window.renderRegularHistoryButtons();
});

window.renderRegularHistoryButtons = function() {
    const btnArea = document.getElementById('regularDateButtons');
    if(!btnArea || !window.regularHistoryCache) return;

    const dates = Object.keys(window.regularHistoryCache).sort().reverse().slice(0, 4);
    if(dates.length === 0) {
        btnArea.innerHTML = '<span style="font-size:0.8rem; color:#ccc;">📭 기록 없음</span>';
        return;
    }

    btnArea.innerHTML = dates.map(date => {
        const shortDate = date.split('-').slice(1).join('/');
        return `
            <button class="filter-btn" 
                style="padding:6px 14px; font-size:0.8rem; flex-shrink:0; background:#fa5252; color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer;" 
                onclick="window.loadRegularHistory('${date}')">
                🏆 ${shortDate}
            </button>`;
    }).join('');
};

window.loadRegularHistory = function(date) {
    const historyData = window.regularHistoryCache ? window.regularHistoryCache[date] : null;
    if(!historyData || !historyData.gameTeams) return alert("⚠️ 데이터를 찾을 수 없습니다.");

    if(!confirm(`🏆 [${date}] 정기모임 기록을 불러오시겠습니까?\n현재 화면의 점수가 과거 기록으로 대체됩니다.`)) return;

    gameTeams = historyData.gameTeams;
    if(historyData.settings) settings = historyData.settings;
    alert(`✅ ${date} 정기모임 기록 복원 완료!`);
    window.renderAllStats();
};

window.finalizeToRecords = function() {
    if(!confirm("오늘의 모든 게임 점수를 개인 장부에 영구 저장하고,\n오늘의 팀 구성(정모 히스토리)도 함께 보관할까요?")) return;

    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const today = new Date(now.getTime() - offset).toISOString().split('T')[0];
    
    let updates = {};
    let saveCount = 0;
    let memberScores = {};

    for (let g = 1; g <= settings.gameCount; g++) {
        const teams = gameTeams[g] || [];
        teams.forEach(t => {
            t.members.forEach(m => {
                if (m.name.includes("고스트") || m.isGhost) return;
                if (!memberScores[m.name]) memberScores[m.name] = [];
                memberScores[m.name].push(parseInt(m.score) || 0);
            });
        });
    }

    Object.keys(memberScores).forEach(name => {
        const scs = memberScores[name];
        if (scs.some(s => s > 0)) {
            const safeKey = `${today}_${name.replace(/[.#$/[\]]/g, "_")}`;
            updates[`bowling_v14/records/${safeKey}`] = {
                date: today, name: name, scs: scs
            };
            saveCount++;
        }
    });

    if (saveCount === 0) return alert("저장할 점수 데이터가 없습니다.");

    updates[`bowling_v14/regular_history/${today}`] = {
        date: today,
        gameTeams: gameTeams,
        settings: settings
    };

    db.ref().update(updates).then(() => {
        alert(`🎉 성공! ${saveCount}명의 기록 저장 및 정모 히스토리 보관이 완료되었습니다.`);
        location.reload(); 
    }).catch(err => alert("저장 실패: " + err));
};

window.renderAllStats = function() {
    if(typeof window.renderHistoricalStats === 'function') window.renderHistoricalStats();
    if(typeof window.renderStatsGameTabs === 'function') window.renderStatsGameTabs();
    if(typeof window.renderCurrentGameStats === 'function') window.renderCurrentGameStats(); 

    const panel = document.getElementById('statsPanel');
    if(!panel) return;

    const totalRankArea = document.getElementById('todayTotalRankTable');
    if(totalRankArea && isAdmin) {
        const oldFinalize = document.getElementById('finalizeBtnArea');
        if(oldFinalize) oldFinalize.remove();
        const oldLightning = document.getElementById('lightningSaveArea');
        if(oldLightning) oldLightning.remove();

        const btnDiv = document.createElement('div');
        btnDiv.style.margin = "30px 0 10px 0";
        
        if (settings.mode === 'regular') {
            btnDiv.id = 'finalizeBtnArea';
            btnDiv.innerHTML = `
                <div style="background:#fff5f5; border:2px solid #ff8787; padding:15px; border-radius:12px; text-align:center;">
                    <p style="margin:0 0 12px 0; font-weight:bold; color:#e03131;">📅 오늘 정모 성적을 최종 저장할까요?</p>
                    <button class="universal-btn" style="background:#e03131; margin-bottom:0;" onclick="window.finalizeToRecords()">📥 정모 최종 저장 (에버 반영 + 히스토리 보관)</button>
                </div>`;
        } else {
            btnDiv.id = 'lightningSaveArea';
            btnDiv.innerHTML = `
                <div style="background:#fff9db; border:2px solid #fab005; padding:15px; border-radius:12px; text-align:center;">
                    <p style="margin:0 0 12px 0; font-weight:bold; color:#856404;">⚡ 오늘 번개 기록을 히스토리에 보관할까요?</p>
                    <button class="universal-btn" style="background:#fab005; color:#000; margin-bottom:0;" onclick="window.saveLightningHistory()">📥 번개 기록 보관 (에버 미반영)</button>
                </div>`;
        }
        totalRankArea.parentNode.insertBefore(btnDiv, totalRankArea);
    }
};

window.silentSave = function() {
    db.ref('bowling_v14/gameTeams').set(gameTeams).then(() => {
        console.log("자동 저장 완료 (조용함)");
    });
};

window.copyKakaoLink = function(id, date, mode) {
    const modeK = mode === 'regular' ? '⚖️정기모임' : '⚡번개모임';
    const jumpUrl = `https://beumjookim.github.io/ilsanacebc/index.html?eventId=${id}`;
    const text = `🎳 [일산 에이스] 모임 안내\n\n📅 일시: ${date}\n${modeK}\n\n👇 아래 링크를 누르면 바로 신청 화면으로 이동합니다!\n${jumpUrl}`;
    
    navigator.clipboard.writeText(text).then(() => {
        alert("✅ 카톡용 공지 문구가 복사되었습니다!\n대화방에 붙여넣기(Ctrl+V) 하세요.");
    });
};

window.jumpToSpecificEvent = function() {
    const targetId = sessionStorage.getItem('jumpToEvent');
    if (!targetId) return;

    setTimeout(() => {
        const element = document.getElementById('event_' + targetId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            element.style.border = "3px solid #fcc419"; 
            setTimeout(() => { element.style.border = "none"; }, 3000);
            sessionStorage.removeItem('jumpToEvent'); 
        }
    }, 1000);
};

  try {
    if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
      Kakao.init('fa7a8ba02d5835b0aa4183eac217cb7a'); 
      console.log("카카오 초기화 성공");
    }
  } catch (e) {
    console.log("초기화 체크 중");
  }

let currentNoticeType = 'app'; 

window.openNoticePanel = function(type) {
    currentNoticeType = type;
    const panel = document.getElementById('admin-notice-panel');
    const titleInput = document.getElementById('noticeTitle');
    const imgInput = document.getElementById('noticeImg');
    const linkInput = document.getElementById('noticeLink');

    panel.style.display = 'block';

    if (type === 'app') {
        titleInput.value = "🎳 [참석 신청] 오늘 모임 있습니다!";
        imgInput.value = "https://beumjookim.github.io/ilsanacebc/ace.png"; 
        linkInput.value = "https://beumjookim.github.io/ilsanacebc/";
    } else {
        titleInput.value = "☕ [카페 공지] 새로운 소식을 확인하세요!";
        imgInput.value = "https://beumjookim.github.io/ilsanacebc/notice_image.png"; 
        linkInput.value = ""; 
        linkInput.placeholder = "여기에 카페 글 주소를 붙여넣으세요";
    }
}

// 4. 공지 발송 (스마트 주소 적용 + 404 원천 봉쇄)
// 4. 공지 발송 (유형에 따라 사진 자동 선택 + 404 방지)
window.sendNotice = function() {
    const title = document.getElementById('noticeTitle').value || '일산 에이스 공지';
    const desc = document.getElementById('noticeDesc').value || '상세 내용을 확인하세요.';
    
    // 🚨 [핵심 수정] 공지 유형에 따라 사진을 다르게 설정합니다.
    let photoUrl = "";
    if (currentNoticeType === 'app') {
        // 앱 참석 공지일 때는 우리 팀 로고(ace.png) 사용
        photoUrl = "https://beumjookim.github.io/ilsanacebc/ace.png";
    } else {
        // 카페 공지일 때는 단체 사진(notice_image.png) 사용
        photoUrl = "https://beumjookim.github.io/ilsanacebc/notice_image.png";
    }

    // 캐시 방지를 위해 시간값 추가 (사진이 즉시 바뀌어 보이게 함)
    const img = photoUrl + "?v=" + new Date().getTime();
    
    let link = document.getElementById('noticeLink').value.trim();

    // 주소 자동 감지
    let currentUrl = window.location.href.split('?')[0]; 
    let finalLink = currentUrl;
    
    if (link) {
        if (!link.startsWith('http')) link = 'https://' + link;
        finalLink += "?target=" + encodeURIComponent(link);
    }

    try {
        if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
            Kakao.init('fa7a8ba02d5835b0aa4183eac217cb7a');
        }

        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: {
                title: title,
                description: desc,
                imageUrl: img, // 위에서 결정된 사진이 들어갑니다
                link: { mobileWebUrl: finalLink, webUrl: finalLink }
            },
            buttons: [{ 
                title: (currentNoticeType === 'app' ? '참석 신청하기' : '게시글 바로가기'), 
                link: { mobileWebUrl: finalLink, webUrl: finalLink } 
            }]
        });
        document.getElementById('admin-notice-panel').style.display = 'none';
        alert("✅ 공지가 발송되었습니다!");
    } catch (e) {
        alert("카톡 전송 실패: " + e.message);
    }
};

window.addBangaeMember = function() {
    var nameInput = document.getElementById('inputName');
    var name = nameInput.value.trim();

    if (!name) {
        alert("이름을 입력해주세요!");
        return;
    }

    var list = document.getElementById('bangaeMemberList');
    var li = document.createElement('li');
    li.style = "padding: 8px 0; border-bottom: 1px solid #eee; display: flex; align-items: center;";

    li.innerHTML = `
        <label style="flex:1; display:flex; align-items:center; cursor:pointer;">
            <input type="radio" name="leader" value="${name}" style="margin-right:10px;">
            <span>${name}</span>
        </label>
        <button onclick="this.parentElement.remove()" style="background:none; border:none; color:#ff4d4d; cursor:pointer;">❌</button>
    `;

    list.appendChild(li);
    nameInput.value = ''; 
    nameInput.focus();
}
// 👑 정모장 임명 저장 함수 (추가)
window.setJungmoManager = function() {
    const name = document.getElementById('jungmoJangInput').value.trim();
    if (!name) return alert("임명할 회원의 이름을 입력해주세요.");

    if (confirm(`👑 [${name}] 님을 정모장으로 임명하시겠습니까?`)) {
        db.ref('bowling_v14/managers/jungmo').set(name).then(() => {
            alert(`✅ [${name}] 님이 정모장으로 임명되었습니다!`);
            document.getElementById('jungmoJangInput').value = ''; // 입력창 비우기
            window.updateUI(); // 즉시 화면 갱신
        }).catch(err => alert("🚨 저장 오류: " + err.message));
    }
};
// 📊 [진짜 엔진] 엑셀 파일 선택 시 자동으로 데이터를 분석해서 Firebase에 저장
document.getElementById('excelInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm("⚠️ 엑셀의 데이터를 분석하여 장부에 등록하시겠습니까?\n(기존 데이터와 날짜/이름이 겹치면 엑셀 내용으로 덮어씌워집니다)")) {
        e.target.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });

        // 1. 날짜 라인 분석 (첫 번째 줄에서 날짜 추출)
        const dateRow = rows[0];
        const dates = [];
        let currentTempDate = "";
        for (let i = 3; i < dateRow.length; i++) {
            if (dateRow[i]) currentTempDate = dateRow[i]; // 날짜가 적힌 칸 기억
            dates[i] = currentTempDate; // 병합된 칸들도 같은 날짜로 인식
        }

        // 2. 점수 데이터 분석 (세 번째 줄부터 시작)
        let updates = {};
        let count = 0;

        for (let i = 2; i < rows.length; i++) {
            const row = rows[i];
            const name = (row[0] || "").toString().trim();
            if (!name || name === "이름") continue;

            // 각 날짜별로 4게임씩 묶어서 추출
            for (let j = 3; j < row.length; j += 4) {
                const targetDate = dates[j];
                if (!targetDate) continue;

                // 4게임 점수 가져오기 (0점이나 빈칸 제외)
                const scs = [
                    parseInt(row[j]) || 0,
                    parseInt(row[j+1]) || 0,
                    parseInt(row[j+2]) || 0,
                    parseInt(row[j+3]) || 0
                ].filter(s => s > 0);

                if (scs.length > 0) {
                    const safeKey = `${targetDate}_${name.replace(/[.#$/[\]]/g, "_")}`;
                    updates[`bowling_v14/records/${safeKey}`] = {
                        date: targetDate,
                        name: name,
                        scs: scs
                    };
                    count++;
                }
            }
        }

        // 3. Firebase에 일괄 전송
        if (Object.keys(updates).length > 0) {
            db.ref().update(updates).then(() => {
                alert(`🎉 성공! ${count}개의 게임 기록을 엑셀에서 가져왔습니다.\n앱을 새로고침하여 확인하세요!`);
                location.reload();
            }).catch(err => alert("🚨 업로드 오류: " + err.message));
        } else {
            alert("❌ 엑셀에서 읽을 수 있는 점수 데이터가 없습니다.");
        }
    };
    reader.readAsArrayBuffer(file);
});
// 📂 [기록보관소] 전용 로직
window.showArchiveDetail = function(date, type) {
    const history = (type === 'regular') ? window.regularHistoryCache : window.lightningHistoryCache;
    const data = history[date];
    if (!data) return;

    const detailArea = document.getElementById('archiveDetailView');
    let html = `<h4 style="text-align:center; color:#1565c0;">[${date}] ${type==='regular'?'정기모임':'번개'} 결과</h4>`;

    // 해당 날짜의 게임별 팀 성적 그리기
    const targetTeams = data.gameTeams;
    Object.keys(targetTeams).forEach(gameNo => {
        html += `<div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px; border-left:5px solid #1565c0;">
                    <b style="font-size:1rem;">${gameNo}G 결과</b>`;
        
        targetTeams[gameNo].forEach(t => {
            let teamSum = (parseInt(t.matchHandy) || 0);
            t.members.forEach(m => {
                const mInfo = members.find(x => x.name === m.name) || {handicap: 0};
                teamSum += (parseInt(m.score) || 0) + (m.name.includes("고스트") ? 0 : (parseInt(mInfo.handicap) || 0));
            });

            html += `<div style="margin-top:8px; background:#fff; padding:8px; border:1px solid #eee; border-radius:5px;">
                        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">
                            <span>Team ${t.teamNo}</span>
                            <span style="color:#1565c0;">팀 합계: ${teamSum}</span>
                        </div>
                        <div style="font-size:0.8rem; color:#666;">
                            ${t.members.map(m => `${m.name}(${m.score||0})`).join(', ')}
                        </div>
                     </div>`;
        });
        html += `</div>`;
    });

    detailArea.innerHTML = html;
};

// 기록보관소 탭을 열 때 날짜 목록을 뿌려줍니다.
// 📂 [업그레이드] 기록보관소 날짜 버튼 생성 엔진
window.renderArchiveDates = function() {
    const area = document.getElementById('archiveDateList');
    if (!area) return;

    // 1. 모든 히스토리 데이터 합치기
    const regHistory = window.regularHistoryCache || {};
    const lightHistory = window.lightningHistoryCache || {};

    const regDates = Object.keys(regHistory).map(d => ({date: d, type: 'regular'}));
    const lightDates = Object.keys(lightHistory).map(d => ({date: d, type: 'lightning'}));
    
    // 2. 최신 날짜순으로 정렬 (2026-02-22 -> 2026-02-21 ...)
    const allDates = [...regDates, ...lightDates].sort((a, b) => b.date.localeCompare(a.date));

    if (allDates.length === 0) {
        area.innerHTML = '<div style="color:#999; padding:20px; text-align:center; width:100%;">저장된 기록이 없습니다.</div>';
        return;
    }

    // 3. 버튼 컨테이너 설정 (가로 스크롤 및 간격 유지)
    area.style.display = "flex";
    area.style.gap = "10px";
    area.style.overflowX = "auto";
    area.style.padding = "10px 5px";
    area.style.webkitOverflowScrolling = "touch"; // 아이폰 부드러운 스크롤

    // 4. 날짜 버튼 생성 (전체 날짜 표시 + 압축 방지)
    area.innerHTML = allDates.map(item => `
        <button onclick="window.showArchiveDetail('${item.date}', '${item.type}')" 
                style="padding:12px 20px; border-radius:30px; border:none; 
                       background:${item.type==='regular'?'#e03131':'#fab005'}; 
                       color:white; font-weight:bold; white-space:nowrap; 
                       cursor:pointer; font-size:1rem; flex-shrink:0; 
                       box-shadow:0 4px 6px rgba(0,0,0,0.1);
                       transition: transform 0.1s;">
            ${item.type==='regular'?'🏆':'⚡'} ${item.date}
        </button>
    `).join('');
};
// 👤 회원 정보 수정 함수
window.updateMember = function(key, name, handicap, gender) {
    const newName = prompt("수정할 이름을 입력하세요:", name);
    if (newName === null) return; // 취소 시 중단
    
    const newHandicap = prompt(`${newName} 님의 새로운 핸디캡을 입력하세요:`, handicap);
    if (newHandicap === null) return;

    const newGender = prompt("성별을 입력하세요 (남/여):", gender);
    if (newGender === null) return;

    // Firebase 데이터 업데이트
    db.ref('bowling_v14/members/' + key).update({
        name: newName.trim(),
        handicap: parseInt(newHandicap) || 0,
        gender: (newGender === '여' ? '여' : '남')
    }).then(() => {
        alert("✅ 회원 정보가 수정되었습니다.");
        // 페이지 새로고침 없이 목록만 갱신하거나 전체 리로드
        location.reload(); 
    }).catch(err => alert("🚨 수정 실패: " + err.message));
};

// 🔐 비밀번호 변경 함수
window.updatePw = function(key, name, currentPw) {
    const newPw = prompt(`[${name}] 님의 새로운 비밀번호를 입력하세요:`, currentPw);
    
    if (newPw === null) return; // 취소 시 중단
    if (newPw.trim() === "") return alert("비밀번호를 입력해야 합니다.");

    db.ref('bowling_v14/members/' + key).update({
        pw: newPw.trim()
    }).then(() => {
        alert(`✅ [${name}] 님의 비밀번호가 변경되었습니다.`);
    }).catch(err => alert("🚨 변경 실패: " + err.message));
};

// showPanel 함수에 보관소 탭 감지 추가
const oldShowPanel = window.showPanel;
window.showPanel = function(id, btn) {
    if (id === 'archivePanel') window.renderArchiveDates();
    oldShowPanel(id, btn);
};
window.syncScoreDirect = function(gameNo, teamNo, userName, newScore) {
    const scoreVal = parseInt(newScore) || 0;
    
    // 1. 로컬 데이터 즉시 업데이트
    if(gameTeams[gameNo]) {
        gameTeams[gameNo].forEach(t => {
            if(t.teamNo == teamNo) {
                t.members.forEach(m => { if(m.name === userName) m.score = scoreVal; });
            }
        });
    }

    // 2. Firebase의 특정 경로만 '정밀 타격' 업데이트 (충돌 방지 핵심)
    db.ref(`bowling_v14/gameTeams/${gameNo}`).once('value', sn => {
        const teams = sn.val() || [];
        const teamIdx = teams.findIndex(t => t.teamNo == teamNo);
        if(teamIdx > -1) {
            const memberIdx = teams[teamIdx].members.findIndex(m => m.name === userName);
            if(memberIdx > -1) {
                db.ref(`bowling_v14/gameTeams/${gameNo}/${teamIdx}/members/${memberIdx}/score`).set(scoreVal);
            }
        }
    });
};
window.assignTeams = function() {
    const myName = (loggedInUser || "").trim();
    const isBoss = isAdmin || (managers.jungmo === myName) || (managers.lightning === myName);
    if (!isBoss) return alert("🚫 조편성 권한이 없습니다.");

    const isIndividualMode = document.getElementById('modeIndividual')?.checked; // 개인전 스위치 확인
    const selectedMembers = Array.from(document.querySelectorAll('.member-item.selected')).map(el => {
        const name = el.getAttribute('data-name');
        return members.find(m => m.name === name);
    });

    if (selectedMembers.length === 0) return alert("인원을 선택해주세요.");

    let finalTeams = [];

    if (isIndividualMode) {
        // 🎲 [번개 개인전] 완전 랜덤 배정 로직
        let shuffled = [...selectedMembers];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        let pointer = 0;
        laneSettings.forEach(config => {
            const teamMembers = shuffled.slice(pointer, pointer + config.count);
            if (teamMembers.length > 0) {
                finalTeams.push({
                    teamNo: config.teamNo,
                    lane: config.lane,
                    // ✨ 모든 회원을 'red'(Ace)로 강제 설정
                    members: teamMembers.map(m => ({ ...m, color: 'red', lane: config.lane }))
                });
            }
            pointer += config.count;
        });
    } else {
        // ⚖️ 기존 [정기전] 실력 기반 밸런싱 로직 (기존 로직 유지)
        // ... (이 부분은 기존의 복잡한 밸런싱 코드가 그대로 들어갑니다)
    }

    // 서버 저장 및 모드 기록
    const updateData = {};
    updateData[`bowling_v14/gameTeams/${currentTargetGame}`] = finalTeams;
    updateData[`bowling_v14/settings/mode`] = isIndividualMode ? 'individual' : 'team';
    
    db.ref().update(updateData).then(() => {
        alert(`${isIndividualMode ? '⚡ 번개 랜덤 개인전' : '⚖️ 정기 팀전'} 조편성이 완료되었습니다.`);
    });
};
window.renderInputs = function() {
    const area = document.getElementById('inputGridArea');
    const myName = (loggedInUser || "").trim();
    const isPowerfulManager = isAdmin || (managers.jungmo === myName) || (managers.lightning === myName);
    const isIndividualMode = (settings.mode === 'individual');

    let gData = gameTeams[currentInputGame] || [];
    let h = '';

    gData.forEach(t => {
        const isMyTeam = t.members.some(m => m.name === myName);
        if (!isPowerfulManager && !isMyTeam) return; // 👁️ 내 레인 아니면 숨김

        const boxTitle = isIndividualMode ? `Lane ${t.members[0].lane}` : `Team ${t.teamNo}`;
        h += `<div class="input-team-box" style="border: 2px solid ${isMyTeam ? 'var(--accent)' : '#eee'};">
                <div class="input-team-header">${boxTitle}</div>`;
        
        t.members.forEach(m => {
            const isMe = (m.name === myName);
            // 🛡️ [권한] 본인이거나 운영진만 수정 가능
            const canEdit = isMe || isPowerfulManager;

            h += `
            <div class="score-row" style="display:flex; justify-content:space-between; align-items:center; padding:10px 15px; border-bottom:1px solid #eee;">
                <span class="score-name" style="${isMe ? 'color:var(--accent); font-weight:bold;' : ''}">${m.name}</span>
                <input type="number" inputmode="numeric" class="score-input"
                       value="${m.score||0}" 
                       ${!canEdit ? 'readonly style="background:#f8f9fa; color:#ccc;"' : ''}
                       onblur="if(${canEdit}) window.syncScoreDirect('${currentInputGame}', '${t.teamNo}', '${m.name}', this.value)"
                       style="width:80px; height:40px; font-size:1.3rem; text-align:center; border-radius:8px;">
            </div>`;
        });

        // 💾 [저장] 1번(레인장) 또는 운영진만 노출
        const isLeader = (myName === (t.members[0]?.name || ""));
        if (isLeader || isPowerfulManager) {
            h += `<div style="padding:15px; text-align:center;">
                    <button class="universal-btn" style="background:var(--accent); margin:0;" onclick="window.saveAllScores()">💾 점수 확정</button>
                  </div>`;
        }
        h += `</div>`;
    });
    area.innerHTML = h || '<div style="padding:40px; text-align:center;">표시할 데이터가 없습니다.</div>';
};

// 실시간 개별 점수 전송 함수
window.syncScoreDirect = function(gameNo, teamNo, userName, newScore) {
    const scoreVal = parseInt(newScore) || 0;
    db.ref(`bowling_v14/gameTeams/${gameNo}`).once('value', sn => {
        const teams = sn.val() || [];
        const tIdx = teams.findIndex(t => t.teamNo == teamNo);
        if(tIdx > -1) {
            const mIdx = teams[tIdx].members.findIndex(m => m.name === userName);
            if(mIdx > -1) {
                db.ref(`bowling_v14/gameTeams/${gameNo}/${tIdx}/members/${mIdx}/score`).set(scoreVal);
            }
        }
    });
};
window.getWeightedStats = function(name) {
    if (!name || name.includes("고스트")) return { weightedAvg: 0, simpleAvg12: 0 };

    // ✨ [핵심] isLightning이 true인 기록은 아예 계산에서 빼버림
    const validRecords = records.filter(r => r.name === name && !r.isLightning);
    
    const allSessionDates = [...new Set(records
        .filter(r => !r.isLightning) // 번개 모임 날짜는 회차 카운트에서도 제외
        .map(r => r.date))]
        .sort().reverse().slice(0, 12);
    
    let totalScore = 0, gameCount = 0;
    validRecords.filter(r => allSessionDates.includes(r.date)).forEach(r => {
        if(r.scs) r.scs.forEach(s => {
            if (parseInt(s) > 0) { totalScore += parseInt(s); gameCount++; }
        });
    });

    const avg = gameCount > 0 ? Math.round(totalScore / gameCount) : 0;
    return { weightedAvg: avg, simpleAvg12: avg };
};
/* ============================================================
   🎰 [카지노 엔진] 이중 셔플 및 권한 제어 시스템
   ============================================================ */

// 1. 카지노 판 초기화 (이중 셔플 핵심)
/* ============================================================
   🎰 [카지노 엔진] 수정본 (객체 구조 및 이름 배열 대응)
   ============================================================ */
window.initCasino = function() {
    // 1. 레인 설정값 가져오기
    let allSlots = [];
    for (let l = 1; l <= 20; l++) {
        const count = parseInt(laneSettings['cnt_' + l]) || 0;
        const teamNo = parseInt(laneSettings['team_' + l]) || 0;
        if (count > 0 && teamNo > 0) {
            for (let i = 0; i < count; i++) {
                allSlots.push({ lane: l, teamNo: teamNo });
            }
        }
    }

    if (allSlots.length === 0) return alert("❌ [조편성]에서 레인과 팀 번호를 먼저 설정해주세요!");

    // 🌀 [이중 셔플 - 1단계] 레인 자리 자체를 무작위로 마구 섞음 (배후의 섞기)
    allSlots.sort(() => Math.random() - 0.5);

    // 2. 등급별 인원 파악 및 칩 생성
    const createChips = (color) => {
        // 해당 등급의 사람 수만큼 칩 생성 (자리 배분)
        let groupCount = attendees.filter(n => window.calculateTierByName(n) === color).length;
        if (settings.mode === 'individual') groupCount = (color === 'red') ? attendees.length : 0;

        return Array.from({length: groupCount}, (_, i) => ({
            id: `${color}_${i}`,
            color: color,
            slot: allSlots.pop() || {lane: '?', teamNo: 0}, // 섞인 자리를 칩 뒤에 숨김
            pickedBy: null
        }));
    };

    const casinoData = {
        redChips: createChips('red'), blueChips: createChips('blue'),
        greenChips: createChips('green'), yellowChips: createChips('yellow'),
        purpleChips: createChips('purple'), status: 'ongoing'
    };

    db.ref('bowling_v14/casino').set(casinoData).then(() => {
        alert("🎰 이중 셔플 완료! 이제 카지노 탭에서 본인 등급의 칩을 뽑으세요.");
    });
};

// 💡 보조 함수: 이름으로 등급(티어)을 실시간 계산
window.calculateTierByName = function(name) {
    if (!attendees || attendees.length === 0) return 'purple'; // 기본값
    const rankingList = attendees.map(n => {
        const s = window.getWeightedStats(n);
        return { name: n, avg: s.weightedAvg || 0 };
    }).sort((a, b) => b.avg - a.avg);
    
    const myRank = rankingList.findIndex(p => p.name === name);
    const T = Math.ceil(rankingList.length / 5) || 1; // 5분할로 변경
    
    if(myRank < T) return 'red';
    if(myRank < T * 2) return 'blue';
    if(myRank < T * 3) return 'green';
    if(myRank < T * 4) return 'yellow';
    return 'purple'; // 나머지 하위 그룹은 보라색
};
    
//* 2. 카지노 화면 렌더링 */
window.renderCasino = function() {
    const area = document.getElementById('casinoArea');
    if (!window.casino || !area) return;

    let h = `<div class="casino-welcome-msg">🎰 본인 에버 등급의 칩을 클릭하세요!</div>`;

    const renderGroup = (chips, title, className) => {
        if (!chips || chips.length === 0) return '';
        
        let html = `<h3>● ${title}</h3>`;
        html += `<div class="chip-grid ${className}">`;
        
        chips.forEach(c => {
            const isPicked = !!c.pickedBy;
            html += `
                <div class="casino-chip ${isPicked ? 'picked' : ''}" 
                     onclick="if(!${isPicked}) window.pickCasinoChip('${c.id}', '${c.color}')">
                    <div class="chip-inner">
                        <div class="chip-front">?</div>
                        <div class="chip-back">
                            <b class="lane-number">${c.slot.lane}L</b>
                            <span class="picker-name">${c.pickedBy || ''}</span>
                        </div>
                    </div>
                </div>`;
        });
        html += `</div>`;
        return html;
    };

    h += renderGroup(window.casino.redChips, "빨간 칩 (Ace)", "redChips");
    h += renderGroup(window.casino.blueChips, "파란 칩 (Pro)", "blueChips");
    h += renderGroup(window.casino.greenChips, "초록 칩 (Junior)", "greenChips");
    h += renderGroup(window.casino.yellowChips, "노란 칩 (Senior)", "yellowChips");
    h += renderGroup(window.casino.purpleChips, "보라 칩 (Special)", "purpleChips");

    area.innerHTML = h;
};

/* 1. 모드 선택 상태 관리 */
let currentCasinoMode = 'team'; 

window.setGameMode = function(mode) {
    currentCasinoMode = mode;
    const teamBtn = document.getElementById('btnTeamMode');
    const soloBtn = document.getElementById('btnSoloMode');
    if (mode === 'individual') {
        soloBtn.style.background = "#e74c3c"; soloBtn.style.color = "#fff";
        teamBtn.style.background = "#ccc";   teamBtn.style.color = "#555";
    } else {
        teamBtn.style.background = "var(--accent)"; teamBtn.style.color = "#fff";
        soloBtn.style.background = "#ccc";          soloBtn.style.color = "#555";
    }
};

/* 2. 조편성 탭에서 호출하는 카지노 생성 함수 */
window.initCasinoFromSetup = function() {
    if(!confirm(`${currentCasinoMode === 'individual' ? '[개인전]' : '[팀전]'} 모드로 카지노 판을 깔까요?`)) return;
    
    settings.mode = currentCasinoMode; 
    window.initCasino(); 
    
    // 카지노 탭(3번째 버튼)으로 자동 이동
    const casinoTabBtn = document.querySelectorAll('.tab-btn')[2];
    window.showPanel('casinoPanel', casinoTabBtn);
};
window.finishMeetingAndArchive = function() {
    const today = document.getElementById('inputDate').value;
    if (!today) return alert("날짜가 선택되지 않았습니다.");

    if (!confirm(`${today} 모임 결과를 기록보관소에 저장하고 모든 판을 초기화할까요?\n(저장된 기록은 통계에서 확인 가능합니다)`)) return;

    // 1. 현재 데이터 가져오기 (점수, 팀구성, 설정 등)
    const archiveData = {
        date: today,
        mode: settings.mode,
        scores: gameScores || {},
        teams: gameTeams || {},
        managers: managers || {},
        timestamp: Date.now()
    };

    // 2. 기록보관소(archives)에 저장
    // 날짜를 키값으로 하여 중복 저장을 방지하거나 목록화합니다.
    const archiveRef = db.ref(`bowling_v14/archives/${today.replace(/-/g, '')}`);
    
    archiveRef.set(archiveData).then(() => {
        // 3. 기록 저장 성공 시 현재 모임 데이터 초기화
        const updates = {};
        updates['bowling_v14/gameScores'] = null;      // 점수 초기화
        updates['bowling_v14/gameTeams'] = null;       // 팀구성 초기화
        updates['bowling_v14/laneSettings'] = null;    // 레인설정 초기화
        updates['bowling_v14/casino'] = null;          // 카지노판 초기화
        updates['bowling_v14/settings/currentAssignGame'] = '1G'; // 1게임으로 리셋
        updates['bowling_v14/attendance'] = null;      // 참석 명단 초기화 (새 모임 준비)

        return db.ref().update(updates);
    }).then(() => {
        alert("📊 기록 보관이 완료되었습니다!\n새로운 모임을 시작할 준비가 되었습니다.");
        location.reload(); // 화면 갱신하여 클린한 상태로 시작
    }).catch(err => {
        console.error(err);
        alert("기록 저장 중 오류가 발생했습니다.");
    });
};
/* 3. 칩 선택 로직 (보완 완료) */
window.pickCasinoChip = function(chipId, color) {
    const myName = (loggedInUser || "").trim();
    if (!myName) return alert("로그인이 필요합니다.");

    // ✅ 보완: 5가지 색상의 모든 칩을 합쳐서 중복 선택 확인
    const allChips = [
        ...(window.casino.redChips || []),
        ...(window.casino.blueChips || []),
        ...(window.casino.greenChips || []),
        ...(window.casino.yellowChips || []),
        ...(window.casino.purpleChips || [])
    ];

    const alreadyPicked = allChips.some(c => c.pickedBy === myName);
    
    if (alreadyPicked) return alert("이미 칩을 뽑으셨습니다!");

    const chipKey = `${color}Chips`;
    const chipIdx = window.casino[chipKey].findIndex(c => c.id === chipId);

    if (chipIdx > -1) {
        // Firebase 업데이트
        db.ref(`bowling_v14/casino/${chipKey}/${chipIdx}/pickedBy`).set(myName);
        db.ref(`bowling_v14/casino/pickedCount`).transaction(count => (count || 0) + 1);
    }
};
</script> 

<div id="admin-notice-panel" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: 90%; max-width: 400px; background:#fff; z-index:10000; border:3px solid #FFEB33; padding:20px; border-radius:15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
        <h4 style="margin:0; color:#333;">📢 공지 발송 설정</h4>
        <button onclick="document.getElementById('admin-notice-panel').style.display='none'" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
    </div>

    <div style="display:flex; flex-direction:column; gap:10px;">
        <input type="text" id="noticeTitle" placeholder="공지 제목" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        <textarea id="noticeDesc" placeholder="공지 상세 내용" style="width:100%; height:70px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none; box-sizing:border-box;"></textarea>
        
        <label style="font-size:0.75rem; font-weight:bold; color:#666;">🖼️ 사진 주소 (URL)</label>
        <input type="text" id="noticeImg" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        
        <label style="font-size:0.75rem; font-weight:bold; color:#e74c3c;">🔗 연결할 URL (네이버 글 주소 복사/붙여넣기)</label>
        <input type="text" id="noticeLink" style="width:100%; padding:10px; border:2px solid #FFEB33; border-radius:8px; box-sizing:border-box; background:#fffdeb;">
        
        <button onclick="sendNotice()" style="width:100%; background:#FFEB33; color:#3C1E1E; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; margin-top:5px;">🚀 카톡 공지 보내기</button>
    </div>

</div> 
</div>
</body>
</html>