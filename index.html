<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Ace Bowling V18.0 (Final)</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3498db">

<link rel="shortcut icon" href="./icon-192x192.png">
    
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    <link rel="icon" sizes="512x512" href="./icon-512x512.png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --warning: #f39c12; --bg: #f8f9fa; --green: #27ae60; --dark: #34495e; --purple: #8e44ad; }
        /* 1. ê²‰í‹€ ê³ ì • (í‚¤ë³´ë“œê°€ ì˜¬ë¼ì™€ë„ ì „ì²´ í™”ë©´ì´ ë°€ë¦¬ì§€ ì•ŠìŒ) */
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    position: fixed;
    width: 100%;
    
    /* â˜… ì—¬ê¸°ë¶€í„° ì¶”ê°€ëœ ì½”ë“œì…ë‹ˆë‹¤ â˜… */
    -webkit-text-size-adjust: 100%; /* ì•„ì´í° ê¸€ì ë»¥íŠ€ê¸° ê¸ˆì§€ */
    -moz-text-size-adjust: 100%;    /* íŒŒì´ì–´í­ìŠ¤ ê¸ˆì§€ */
    text-size-adjust: 100%;         /* í‘œì¤€ ê¸ˆì§€ */
    font-size: 14px;                /* ê¸°ë³¸ ê¸€ì í¬ê¸° ê³ ì • */
}
        
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        /* 2. ì†ì•Œë§¹ì´ ìŠ¤í¬ë¡¤ (ì ìˆ˜íŒë§Œ ë¶€ë“œëŸ½ê²Œ ì˜¤ë¥´ë‚´ë¦¼) */
.container {
    height: 100%;             /* ì „ì²´ ë†’ì´ ì‚¬ìš© */
    overflow-y: auto;         /* ë‚´ìš©ì´ ë§ìœ¼ë©´ ì´ ì•ˆì—ì„œë§Œ ìŠ¤í¬ë¡¤ */
    -webkit-overflow-scrolling: touch; /* ì•„ì´í°ì—ì„œ ë¶€ë“œëŸ½ê²Œ */
    display: flex;
    flex-direction: column;
}
        .header { padding: 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 2000; }
        
        .tab-menu { display: flex; gap: 5px; padding: 10px; background: #fff; border-bottom: 1px solid #ddd; position: sticky; top: 53px; z-index: 1900; overflow-x: auto; white-space: nowrap; }
        .tab-btn { flex: 1; padding: 12px 0; border: 1px solid #eee; background: #f8f9fa; border-radius: 8px; font-weight: bold; cursor: pointer; min-width: 60px; text-align: center; color: #555; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* 3. ì…ë ¥ì°½ì´ ê°€ë ¤ì§€ì§€ ì•Šê²Œ í•˜ë‹¨ ì—¬ë°± í™•ë³´ */
.content-area {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 300px;    /* í‚¤ë³´ë“œ ì˜¬ë¼ì˜¬ ê³µê°„ ë¯¸ë¦¬ í™•ë³´ */
}
        .panel { display: none; } .panel.active { display: block; }
        .input-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .universal-btn { width: 100%; padding: 15px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; color: white; font-size: 1rem; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-sm { padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; font-size: 0.8rem; font-weight: bold; background: white; color: #333; }
        
        /* íŒ€ì¹´ë“œ ë””ìì¸ */
        .team-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .team-header { background: var(--purple); color: white; padding: 12px 15px; font-weight: bold; display: flex; justify-content: space-between; cursor: pointer; font-size:1.1rem; }
        .team-body { padding: 0; background: white; }
        
        .lane-divider { display: flex; border-bottom: 1px solid #eee; }
        .lane-half { flex: 1; padding: 10px; }
        .lane-half:first-child { border-right: 1px dashed #ddd; }
        .lane-title { font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 5px; font-weight: bold; }

        .member-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f5f5f5; }
        
        /* ë­í¬ íƒ­ */
        .rank-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .rank-tab { flex: 1; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; text-align: center; font-weight: bold; min-width: 50px; }
        .rank-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* ì…ë ¥ì°½ ë””ìì¸ ê°œì„  */
        .input-team-box { border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px; overflow: hidden; }
        .input-team-header { background: #f1f3f5; padding: 10px; font-weight: bold; text-align: center; border-bottom: 1px solid #ddd; color: var(--primary); font-size: 1.1rem; }
        .score-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; background: white; }
        .score-name { font-size: 1.2rem; font-weight: bold; color: #333; }
        .score-input { width: 90px; padding: 12px; text-align: center; border: 2px solid #ccc; border-radius: 8px; font-size: 1.4rem; font-weight: bold; background: #fff; }
        .score-input:focus { border-color: var(--accent); background: #f0f8ff; outline: none; }

        /* í•„í„° ì•ˆë‚´ ë°•ìŠ¤ */
        #filterInfo { display:none; background:#f3e5f5; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; color:#8e44ad; border:1px solid #e1bee7; }

        /* ì¡°í¸ì„± ì„¤ì • */
        .lane-config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px; }
        .lane-input { width: 100%; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-weight: bold; font-size:1.1rem; box-sizing: border-box; margin-top: 5px; background: #fff; }
        
        .zone-btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-weight: bold; color: #555; }
        .zone-btn.selected { background: #34495e; color: white; border-color: #34495e; }

        table.stats-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 10px; }
        table.stats-table th { background: #f1f3f5; padding: 8px; border: 1px solid #ddd; }
        table.stats-table td { padding: 8px; border: 1px solid #ddd; text-align: center; }

        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        .big-input { width: 100%; padding: 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 10px; box-sizing: border-box; }
        .big-select { width: 100%; padding: 12px; font-size: 1rem; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 10px; background:white; font-weight:bold; }
        
        .filter-btn { padding: 6px 10px; border: 1px solid #ddd; background: white; border-radius: 15px; cursor: pointer; margin-right: 3px; font-size: 0.8rem; margin-bottom: 5px; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .settings-label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); margin: 20px 0 10px 0; border-left: 4px solid var(--accent); padding-left: 10px; }
        
        #landingPage, #globalLoginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; color: white; }
        .enter-btn { margin-top: 40px; padding: 15px 50px; font-size: 1.2rem; font-weight: bold; color: white; background: rgba(255,255,255,0.1); border: 2px solid white; border-radius: 50px; cursor: pointer; }
        
        .login-card { background: white; padding: 30px; border-radius: 15px; width: 80%; max-width: 350px; text-align: center; color: #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        
        /* ì»¨íŠ¸ë¡¤ ë©”ë‰´ */
        .control-top-container { display: flex; gap: 8px; margin-bottom: 15px; }
        .box-manager { flex: 1; background: #e3f2fd; border: 2px solid #90caf9; color: #1565c0; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; display: flex; flex-direction: column; justify-content: center; }
        .btn-run-v13 { flex: 1.2; background: #2980b9; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .btn-reset-v13 { flex: 0.8; background: white; color: #c0392b; border: 2px solid #c0392b; border-radius: 8px; font-size: 0.9rem; font-weight: bold; cursor: pointer; }
        
        .lane-box-v13 { background: white; border: 1px solid #ccc; border-radius: 8px; padding: 5px; text-align: center; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .lane-label { color: #8e44ad; font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }      

        /* â˜…â˜…â˜… [ë°˜ì‘í˜• í•µì‹¬] ëª¨ë°”ì¼(800px ì´í•˜)ì—ì„œ ì„¸ë¡œë¡œ ê°•ì œ ë³€ê²½ â˜…â˜…â˜… */
        @media screen and (max-width: 800px) {
            .lane-divider { display: flex !important; flex-direction: column !important; }
            .lane-half { width: 100% !important; border-right: none !important; border-bottom: 2px dashed #d1c4e9 !important; padding: 15px 10px !important; box-sizing: border-box; }
            .lane-half:last-child { border-bottom: none !important; }
            .lane-config-grid { grid-template-columns: repeat(2, 1fr) !important; }
            input, select, button { font-size: 16px !important; }
        }
        /* --- ì¹´ì§€ë…¸ ì¹© & í…Œì´ë¸” ìŠ¤íƒ€ì¼ --- */
        #casinoPanel { background: #1a472a; border-radius: 15px; padding: 20px; color: white; }
        .casino-table { background: radial-gradient(circle, #27ae60, #1a472a); border: 10px solid #5d4037; border-radius: 30px; padding: 20px; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); text-align: center; }
        .chip-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 15px; }

        .chip { width: 75px; height: 75px; border-radius: 50%; position: relative; cursor: pointer; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; justify-content: center; align-items: center; box-shadow: 0 6px 10px rgba(0,0,0,0.5); border: 5px dashed rgba(255,255,255,0.3); }
        .chip:hover { transform: translateY(-5px) scale(1.05); }
        .chip.selected { opacity: 0.6; cursor: default; transform: scale(0.9); filter: grayscale(0.5); }
        .chip.red { background: radial-gradient(circle, #ff4d4d, #b30000); }
        .chip.blue { background: radial-gradient(circle, #4da6ff, #0059b3); }
        .chip.green { background: radial-gradient(circle, #5cd65c, #1e7b1e); }
        .chip.yellow { background: radial-gradient(circle, #f1c40f, #f39c12); }

        .chip-inner { width: 48px; height: 48px; background: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #333; font-weight: 900; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .chip-num { font-size: 1.3rem; }
        .chip-owner { font-size: 0.65rem; color: #d63031; font-weight: bold; margin-top: -3px; }
        .chip-lane { font-size: 1.1rem; color: #0984e3; }

        .lane-input-touch { width: 100%; height: 40px; line-height: 40px; text-align: center; border: 1px solid #ccc; border-radius: 6px; font-weight: bold; font-size: 1.2rem; background: #fff; cursor: pointer; user-select: none; margin-top: 5px; }
        .lane-input-touch:active { background: #e3f2fd; transform: scale(0.95); }
        .team-input-touch { background: #f9f9f9; color: var(--purple); }

        .admin-btn, #settings button { width: 280px !important; height: 45px !important; line-height: 45px !important; padding: 0 !important; margin: 10px auto !important; display: block !important; font-size: 16px !important; font-weight: bold !important; border-radius: 8px !important; text-align: center !important; border: none !important; cursor: pointer !important; }
        .excel-green { background-color: #28a745 !important; color: white !important; }
        .over-200 { color: #ff0000 !important; font-weight: bold !important; }
   /* ëª¨ë°”ì¼ì—ì„œ ì…ë ¥ì°½ ê¸€ì”¨ê°€ ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šê²Œ ì¡°ì ˆ */
    input, select, button {
        font-size: 14px !important; /* ê°•ì œë¡œ 14pxë¡œ ê³ ì • */
        max-height: 40px;           /* ë†’ì´ë„ ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šê²Œ */
    }

    /* ì ìˆ˜ ì…ë ¥ì¹¸ì€ ì¡°ê¸ˆ ì»¤ë„ ë˜ì§€ë§Œ ë„ˆë¬´ í¬ì§€ ì•Šê²Œ */
    .score-input {
        font-size: 1.2rem !important; /* 1.4remì—ì„œ ì•½ê°„ ì¤„ì„ */
        padding: 8px !important;      /* ì—¬ë°±ë„ ì¤„ì„ */
        height: 40px !important;
    }
   </style>
</head>
<body>

    <div id="landingPage">
        <h1 style="color:white; margin-bottom:20px; font-size:2.5rem;">ACE BOWLING</h1>
        <p style="color:#eee; font-weight:bold;">V18.0</p>
        <button class="enter-btn" onclick="window.showGlobalLogin()">ì•± ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="globalLoginScreen" style="display:none;">
        <div class="login-card">
            <h2 style="color:var(--primary); margin-bottom:20px;">ğŸ” íšŒì› ë¡œê·¸ì¸</h2>
            <input type="text" id="globalId" class="login-input" placeholder="ì´ë¦„">
            <input type="password" id="globalPw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="universal-btn" onclick="window.doGlobalLogin()" style="background:var(--accent);">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display:none;">
        <div class="header">
            <h2 style="margin:0; font-size:1.3rem;">Ace Bowling V18.0</h2>
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="userInfo" style="font-weight:bold; color:var(--primary); font-size:0.9rem;"></span>
                <button id="logoutBtn" onclick="window.logout()" style="padding:6px 12px; background:var(--danger); color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="tab-menu" id="mainTabMenu">
            <button class="tab-btn active" onclick="window.showPanel('attendPanel', this)">1.ì°¸ì„</button>
            <button class="tab-btn" onclick="window.showPanel('groupPanel', this)">2.ì¡°í¸ì„±</button>
            <button class="tab-btn" onclick="window.showPanel('casinoPanel', this)">ğŸ° ì¹´ì§€ë…¸</button>
            <button class="tab-btn" onclick="window.showPanel('progressPanel', this)">3.ì§„í–‰</button>
            <button class="tab-btn" onclick="window.clickInputTab(this)">4.ì…ë ¥</button>
            <button class="tab-btn" onclick="window.showPanel('statsPanel', this)">í†µê³„</button>
            <button class="tab-btn" onclick="window.showPanel('memberPanel', this)">íšŒì›ê´€ë¦¬</button>
            <button class="tab-btn" id="settingsTabBtn" onclick="window.showPanel('settingsPanel', this)" style="display:none;">âš™ï¸ ì„¤ì •</button>
        </div>

        <div class="content-area">
            
            <div id="attendPanel" class="panel active">
                <div id="adminEventCreate" class="input-box" style="display:none; border:2px solid var(--accent);">
                    <h4 style="margin-top:0; color:var(--accent);">ğŸ“… ìƒˆ ëª¨ì„ ì¼ì • ë“±ë¡ (ê³µì§€)</h4>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="date" id="eventDate" class="big-input" style="flex:1.5; margin-bottom:0;">
                        <input type="time" id="eventExactTime" class="big-input" style="flex:1.2; margin-bottom:0;" value="14:00">
                    </div>
                    <select id="eventMode" class="big-select">
                        <option value="regular">âš–ï¸ ì •ê¸°ëª¨ì„ (4G)</option>
                        <option value="lightning">âš¡ ë²ˆê°œëª¨ì„ (6G)</option>
                    </select>
                    <button class="universal-btn" style="background:var(--accent); margin-bottom:0;" onclick="window.createEvent()">ëª¨ì„ ì¼ì • ë“±ë¡</button>
                </div>

                <div class="section-title">ğŸ—“ï¸ ì˜ˆì •ëœ ëª¨ì„ ë° ì°¸ì„ ì‹ ì²­</div>
                <div id="eventListArea"></div>

                <input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none;">
            </div>

            <div id="groupPanel" class="panel">
                <div class="input-box">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 id="modeDisplay" style="margin:0; font-size:1.1rem; color:var(--primary);">âš–ï¸ ì •ê¸°ëª¨ì„ (4ê²Œì„)</h3>
                        <button class="btn-sm" onclick="window.toggleMode()" style="background:var(--dark); color:white;">ğŸ”„ ëª¨ë“œ ì „í™˜</button>
                    </div>

                    <div id="assignGameTabs" class="rank-tabs" style="margin: 15px 0;"></div>

                    <label style="font-weight:bold; color:var(--warning); display:block; margin-bottom:5px;">1. êµ¬ì—­ ì„ íƒ (ë ˆì¸ êµ¬ì¡°)</label>
                    <div style="display:flex; gap:5px; margin-bottom:15px;">
                        <button class="zone-btn" id="z1" onclick="window.toggleZone(1)">1êµ¬ì—­</button>
                        <button class="zone-btn" id="z2" onclick="window.toggleZone(2)">2êµ¬ì—­</button>
                        <button class="zone-btn" id="z3" onclick="window.toggleZone(3)">3êµ¬ì—­</button>
                        <button class="zone-btn" id="z4" onclick="window.toggleZone(4)">4êµ¬ì—­</button>
                        <button class="zone-btn" id="z5" onclick="window.toggleZone(5)">5êµ¬ì—­</button>
                    </div>
                </div>

                <div class="preset-container" style="margin: 20px 0; padding: 12px; background: #fdfdfd; border-radius: 10px; border: 1px dashed #ccc; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);">
                    <label style="font-weight:bold; display:block; margin-bottom:10px; color:#2c3e50; font-size:0.9rem;">âš¡ ì¡°í¸ì„± í€µ ìë™ ì„¤ì •</label>
                    <div style="display:flex; gap:6px;">
                        <button type="button" class="btn-sm" style="flex:1; background:#3498db; color:white; border:none; height:42px; border-radius:6px; font-weight:bold;" onclick="window.applyPreset(2)">2ì¸ì¡°</button>
                        <button type="button" class="btn-sm" style="flex:1; background:#27ae60; color:white; border:none; height:42px; border-radius:6px; font-weight:bold;" onclick="window.applyPreset(3)">3ì¸ì¡°</button>
                        <button type="button" class="btn-sm" style="flex:1; background:#e67e22; color:white; border:none; height:42px; border-radius:6px; font-weight:bold;" onclick="window.applyPreset(4)">4ì¸ì¡°</button>
                    </div>
                </div>

                <label style="font-weight:bold; color:var(--primary); display:block; margin-bottom:5px;">2. ì°¸ì„ í˜„í™© ë° ë ˆì¸ ë°°ì •</label>
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                <label style="font-weight:bold; color:#27ae60; display:block; margin-bottom:5px;">2-1. ì¡°í¸ì„± ë°©ì‹ ì„ íƒ</label>
                <select id="groupAssignMethod" class="big-select" style="margin-bottom:15px;" onchange="window.changeAssignMethod(this.value)">
                    <option value="ai">ğŸ¤– AI ë°¸ëŸ°ìŠ¤</option>
                    <option value="random">ğŸ² ëœë¤ (ë¬´ì‘ìœ„)</option>
                </select>

                <label style="font-weight:bold; color:#8e44ad; display:block; margin-bottom:8px;">3. ë ˆì¸ë³„ ì¸ì› ì„¤ì •</label>
                <div class="control-top-container">
                    <div class="box-manager">
                        <span style="font-size:0.8rem; opacity:0.8;">ğŸ‘‘ ì •ëª¨ì¥</span>
                        <span id="displayJungmoName">ë¯¸ì •</span>
                    </div>
                    
                    <button class="btn-run-v13" onclick="window.runGeneralAssignment()">âš–ï¸ ì¼ë°˜ ë°°ì •</button>
                    
                    <button class="universal-btn" style="background:#f39c12; flex:1; margin-bottom:0;" 
                            onclick="window.startCasinoAssignment()">ğŸ° ì¹´ì§€ë…¸ ë°°ì •</button>
                            
                    <button class="btn-reset-v13" onclick="window.resetAssignment()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                </div>
                <div id="laneConfigArea" class="lane-config-grid"></div>
                <div style="text-align:right; font-weight:bold; margin-top:10px;">
                    ì„¤ì • ì¸ì› í•©ê³„: <span id="totalConfigCount" style="color:var(--danger); font-size:1.1rem;">0</span>ëª…
                </div>

                <div id="lightningManagerSelect" class="input-box" style="display:none; border:2px solid #f39c12; background:#fffcf5; margin-top:20px;">
                    <h3 style="color:#d35400; margin-top:0;">âš¡ ë²ˆê°œì¥ ì„ ì¶œ</h3>
                    <div style="display:flex; gap:5px;">
                        <select id="bungaeJangSelect" class="big-select" style="margin-bottom:0;"></select>
                        <button class="btn-sm" style="background:#f39c12; color:white; width:80px;" onclick="window.setBungaeManager()">ì„ëª…</button>
                    </div>
                    <div style="margin-top:10px; font-weight:bold;">í˜„ì¬ ë²ˆê°œì¥: <span id="currentBungaeJang" style="color:#d35400;">ì—†ìŒ</span></div>
                </div>
            </div>

            <div id="casinoPanel" class="panel">
                <div class="casino-table">
                    <h2 style="color: #f1c40f; margin-top:0; text-shadow: 2px 2px 4px #000;">ğŸ° ACE CASINO TABLE</h2>
                    <div id="casinoStatus" style="font-size:1rem; margin-bottom:20px; color:#fff; font-weight:bold;">
                        ì›í•˜ëŠ” ë²ˆí˜¸ì˜ ì¹©ì„ ë¹ ë¥´ê²Œ ì„ íƒí•˜ì„¸ìš”!
                    </div>
                    
                    <div class="tier-zone" id="zone_red">
                        <div style="color:#ff7675; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">ğŸ”´ RED CHIPS (ìƒìœ„)</div>
                        <div id="chips_red" class="chip-container"></div>
                    </div>
                    <div class="tier-zone" id="zone_blue" style="margin-top:25px;">
                        <div style="color:#74b9ff; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">ğŸ”µ BLUE CHIPS (ì¤‘ìœ„)</div>
                        <div id="chips_blue" class="chip-container"></div>
                    </div>
                    <div class="tier-zone" id="zone_green" style="margin-top:25px; display:none;">
                        <div style="color:#55efc4; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">ğŸŸ¢ GREEN CHIPS (í•˜ìœ„)</div>
                        <div id="chips_green" class="chip-container"></div>
                    </div>
                    <div class="tier-zone" id="zone_yellow" style="margin-top:25px; display:none;">
                        <div style="color:#f1c40f; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">ğŸŸ¡ YELLOW CHIPS (ìµœí•˜ìœ„)</div>
                        <div id="chips_yellow" class="chip-container"></div>
                    </div>
                    <div id="adminCasinoControls" style="margin-top:40px; border-top:1px solid rgba(255,255,255,0.2); padding-top:20px;">
                        <button class="universal-btn" style="background:#f1c40f; color:#000;" onclick="window.initCasino()">ğŸ² ì¹´ì§€ë…¸íŒ ìƒˆë¡œ ê¹”ê¸° (ì¹© ìƒì„±)</button>
                        <button class="universal-btn" style="background:#e67e22; margin-top:10px;" onclick="window.finishCasino()">ğŸ‘» ê³ ìŠ¤íŠ¸ í™•ì¸ ë° ë°°ì • ì¢…ë£Œ</button>
                    </div>
                </div>
            </div>

            <div id="progressPanel" class="panel">
                <div class="input-box">
                    <input type="date" id="progDate" class="big-input" style="width:auto; margin-bottom:15px;" onchange="window.renderGameProgress()">
                    <div id="progTabs" class="rank-tabs"></div>
                    <div id="teamCardArea"></div>
                </div>
            </div>

            <div id="inputPanel" class="panel">
                <div id="scoreSection">
                    <div class="input-box">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="margin:0;">ğŸ“ ì ìˆ˜ ì…ë ¥ (<span id="inputGameTitle">1G</span>)</h3>
                            <button class="btn-sm" onclick="window.saveAllScores()" style="background:var(--accent); color:white; border:none;">ğŸ’¾ ì €ì¥</button>
                        </div>
                        
                        <div id="filterInfo" style="display:none; background:#f3e5f5; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; color:#8e44ad; border:1px solid #e1bee7;">
                            <span id="filterTeamName"></span> ì ìˆ˜ ì…ë ¥ ì¤‘...
                        </div>

                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <input type="date" id="inputDate" class="big-input" style="width:60%; margin:0;" onchange="window.renderInputs()">
                            <button class="btn-sm" onclick="window.showAllTeams()" style="background:#95a5a6; color:white;">ğŸ“‚ ì „ì²´ ë³´ê¸°</button>
                        </div>
                        
                        <div id="inputTabs" class="rank-tabs"></div>
                        <div id="inputGridArea" style="margin-top:15px;"></div>
                        
                        <button class="universal-btn" onclick="window.saveAllScores()" style="background:var(--accent); margin-top:20px;">ğŸ’¾ ì ìˆ˜ ì €ì¥ ì™„ë£Œ</button>
                    </div>
                </div>
            </div>

            <div id="statsPanel" class="panel">
                <div class="input-box">
                    <div class="section-title">ğŸ“ˆ ê¸°ê°„ë³„ ê°œì¸ ì—ë²„ (ê¸°ë¡)</div>
                    <div style="margin-bottom:15px; display:flex; flex-wrap:wrap;">
                        <button class="filter-btn active" id="btn_period_all" onclick="window.setStatsPeriod('all', this)">ì „ì²´</button>
                        <button class="filter-btn" onclick="window.setStatsPeriod('1m', this)">1ê°œì›”</button>
                        <button class="filter-btn" onclick="window.setStatsPeriod('3m', this)">3ê°œì›”</button>
                        <button class="filter-btn" onclick="window.setStatsPeriod('6m', this)">6ê°œì›”</button>
                        <button class="filter-btn" onclick="window.setStatsPeriod('12m', this)">12ê°œì›”</button>
                    </div>
                    <div id="historicalStatsTable"></div>
                    <hr style="margin: 20px 0;">
                    <div class="section-title">âš¡ ê¸ˆì¼ ê²Œì„ë³„ ìˆœìœ„</div>
                    <div id="statsGameTabs" class="rank-tabs"></div>
                    <h4 style="margin-top:10px;">ğŸ† íŒ€ ìˆœìœ„</h4>
                    <div id="currentTeamRankTable"></div>
                    <h4 style="margin-top:20px;">ğŸ… ê°œì¸ ìˆœìœ„</h4>

                    <div style="margin-bottom:10px; display:flex; gap:5px;">
                        <button class="filter-btn active" onclick="window.filterCurrentStats('all', this)">ì „ì²´</button>
                        <button class="filter-btn" onclick="window.filterCurrentStats('ë‚¨', this)">ë‚¨ì„±</button>
                        <button class="filter-btn" onclick="window.filterCurrentStats('ì—¬', this)">ì—¬ì„±</button>
                    </div>
                    <div id="currentIndivRankTable"></div>
                    <div class="section-title" style="margin-top:40px; border-left:4px solid var(--danger);">ğŸ‘‘ ì˜¤ëŠ˜ì˜ ìµœì¢… í•©ê³„ ìˆœìœ„ (ì „ì²´ ê²Œì„ ëˆ„ì )</div>
                    <div id="todayTotalRankTable"></div>      
                </div>
            </div>

            <div id="memberPanel" class="panel">
                <div id="adminMemberControls" class="input-box" style="display:none; border:2px solid var(--green);">
                    <h4 style="margin-top:0;">â• ì‹ ê·œ íšŒì› ì¶”ê°€</h4>
                    <input type="text" id="newMemName" class="big-input" placeholder="ì´ë¦„ ì…ë ¥">
                    <div style="display:flex; gap:10px;">
                        <select id="newMemGender" class="big-select" onchange="window.checkGender(this)">
                            <option value="ë‚¨">ë‚¨ì„±</option>
                            <option value="ì—¬">ì—¬ì„±</option>
                        </select>
                        <input type="number" id="newMemHandicap" class="big-input" placeholder="í•¸ë””" value="0">
                    </div>
                    <button class="universal-btn" style="background:var(--green);" onclick="window.addMember()">íšŒì› ì €ì¥</button>
                </div>
                <div class="input-box">
                    <h4>ğŸ“‚ íšŒì› ëª©ë¡</h4>
                    <div id="memberListArea"></div>
                </div>
            </div>

            <div id="settingsPanel" class="panel">
                <div id="adminJungmoSetting" class="input-box" style="display:none; border:2px solid var(--primary);">
                    <h3>ğŸ‘‘ ì •ëª¨ì¥ ì„ëª…</h3>
                    <div style="margin-bottom:10px; font-weight:bold; color:var(--primary);">
                        í˜„ì¬ ì •ëª¨ì¥: <span id="currentJungmoJangSetting" style="color:var(--accent);">ì—†ìŒ</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="jungmoJangInput" class="big-input" placeholder="íšŒì› ì´ë¦„ ì…ë ¥">
                        <button class="btn-sm" style="background:var(--primary); color:white;" onclick="window.setJungmoManager()">ì €ì¥</button>
                    </div>
                </div>

                <div class="input-box" style="border:2px solid var(--accent);">
                    <h3 style="color:var(--accent); margin-top:0;">âš™ï¸ ìš´ì˜ ê¸°ì¤€ ì„¤ì •</h3>
                    <button onclick="document.getElementById('excelInput').click()" class="admin-btn excel-green">ğŸ“Š ì •ëª¨ì ìˆ˜ëª…ë‹¨ ì—…ë¡œë“œ</button>
                    <button onclick="downloadExcel()" class="admin-btn">ğŸ“Š ì •ëª¨ì ìˆ˜ ë‹¤ìš´ë¡œë“œ</button>
                    
                    <label class="settings-label">ê°€ì¤‘ì¹˜ ì—ë²„ ë°˜ì˜ ê¸°ê°„ (ê°œì›”)</label>
                    <input type="number" id="setAvgCriteria" class="big-input" value="6" placeholder="ê¸°ë³¸ 6ê°œì›”">
                    <small style="color:#666; display:block; margin-bottom:15px;">* ì„¤ì •í•œ ê¸°ê°„ë§Œí¼ì˜ ì„±ì ì„ ê³„ì‚°í•˜ì—¬ ì‹¤ë ¥ì„ í‰ê°€í•©ë‹ˆë‹¤.</small>

                    <label class="settings-label">ê¸°ë³¸ ì¡°í¸ì„± ë°©ì‹</label>
                    <select id="setAssignMethod" class="big-select">
                        <option value="ai">ğŸ¤– AI ë°¸ëŸ°ìŠ¤</option>
                        <option value="random">ğŸ² ëœë¤ (ë¬´ì‘ìœ„)</option>
                    </select>

                    <button class="universal-btn" style="background:var(--accent); margin-top:10px;" onclick="window.saveSettings()">âš™ï¸ ê¸°ì¤€ê°’ ì €ì¥</button>
                </div>
                <div class="input-box" style="border:2px solid var(--purple);">
                    <h4 style="color:var(--purple); margin-top:0;">ğŸ’¾ ë°ì´í„° ë°±ì—… ë° ë³µêµ¬</h4>
                    <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">* í˜„ì¬ ëª¨ë“  ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ê±°ë‚˜ ë³´ê´€ëœ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
                    
                    <div style="display:flex; gap:5px;">
                        <button class="universal-btn" style="background:var(--purple); flex:1;" onclick="window.exportData()">íŒŒì¼ ë‚´ë³´ë‚´ê¸°</button>
                        <button class="universal-btn" style="background:var(--dark); flex:1;" onclick="document.getElementById('importFile').click()">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                    <input type="file" id="importFile" style="display:none;" accept=".json" onchange="window.importData(event)">
                </div>
                <div class="input-box" style="border:1px solid var(--danger);">
                    <h4 style="color:var(--danger); margin-top:0;">ğŸš¨ ë°ì´í„° ê´€ë¦¬</h4>
                    <button class="universal-btn" style="background:var(--danger);" onclick="window.deleteToday()">ğŸ—‘ï¸ ì˜¤ëŠ˜ ì ìˆ˜ë§Œ ì‚­ì œ</button>
                    <button class="universal-btn" style="background:#8e44ad; margin-top:5px;" onclick="window.deleteAllData()">ğŸ’¥ ë°ì´í„° ì™„ì „ ì´ˆê¸°í™”</button>
                    <button class="universal-btn" style="background:#95a5a6; margin-top:5px;" onclick="window.resetAttendance()">ğŸ”„ ì°¸ì„ ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

    <div id="modalOverlay" onclick="window.closeModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 id="modalTitle" style="margin-top:0;"></h3>
            <div id="modalContent"></div>
            <button class="universal-btn" style="background:#333; margin-top:20px;" onclick="window.closeModal()">ë‹«ê¸°</button>
        </div>
    </div>

<script>
    let members=[], attendees=[], records=[], gameTeams={}, events={};
    let settings = { mode: 'regular', gameCount: 4, avgCriteria: 6, assignMethod: 'ai' };
    let managers = { jungmo: '', lightning: '' }; 
    let selectedBlocks = [], laneSettings = {};   
    let db = null;
    let loggedInUser = localStorage.getItem('loggedInUser');
    let isAdmin = localStorage.getItem('ace_admin') === 'true';
    
    let currentRankView = 1, currentInputGame = 1, currentTargetGame = 1;
    let currentStatsGame = 1, currentStatsPeriod = 'all', currentGenderFilter = 'all';
    let currentInputTeam = null; 

    firebase.initializeApp({ databaseURL: "https://ilsan-ace-bowling-team-default-rtdb.asia-southeast1.firebasedatabase.app" });
    db = firebase.database();

    db.ref('bowling_v14').on('value', sn => {
    const val = sn.val() || {};
    
    members = val.members ? Object.keys(val.members).map(k => ({ ...val.members[k], key: k })) : [];
    attendees = val.attendees || [];
    gameTeams = val.gameTeams || {};
    records = val.records ? Object.keys(val.records).map(k => ({ ...val.records[k], key: k })) : [];
    
    if(val.settings) settings = val.settings;
    if(val.managers) managers = val.managers; 
    if(val.laneSettings) laneSettings = val.laneSettings; 
    if(val.selectedBlocks) selectedBlocks = val.selectedBlocks; 
    events = val.events || {};

    if (!window.initialLoadDone) {
        window.currentTargetGame = 1; 
        window.initialLoadDone = true; 
    }

    if (typeof window.updateUI === 'function') {
        window.updateUI();
    }
});


// ========================================================
// ğŸ› ï¸ ì´ ë©ì–´ë¦¬ë¥¼ í†µì§¸ë¡œ ë³µì‚¬í•´ì„œ ì—ëŸ¬ ë‚˜ëŠ” ìœ„ì¹˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
// ========================================================
// 1. ì„¤ì • ë° í™”ë©´ ì´ë™ ë™ê¸°í™”
db.ref('bowling_v14/settings').on('value', sn => {
    const val = sn.val();
    if (!val || !val.currentTab) return;

    if (val.currentAssignGame) currentTargetGame = val.currentAssignGame;
    if (val.currentRankView) currentRankView = val.currentRankView;
    if (val.currentInputGame) currentInputGame = val.currentInputGame;

    if (val.currentInputGame && window.renderInputs) {
        window.renderInputs();
    }

    const tabBtns = document.querySelectorAll('.tab-btn');
    let btnIdx = 0; 
    if (val.currentTab === 'groupPanel') btnIdx = 1;
    else if (val.currentTab === 'casinoPanel') btnIdx = 2;
    else if (val.currentTab === 'progressPanel') btnIdx = 3;
    else if (val.currentTab === 'inputPanel') btnIdx = 4;
    else if (val.currentTab === 'statsPanel') btnIdx = 5;

    window.showPanel(val.currentTab, tabBtns[btnIdx]);
});

// 2. ì¹´ì§€ë…¸ ì‹¤ì‹œê°„ ê°ì§€
db.ref('bowling_v14/casino').on('value', () => {
    if(window.renderCasino) window.renderCasino();
});   

// 3. ì—”í„°í‚¤ë¡œ ë‹¤ìŒ ì…ë ¥ì¹¸ ì´ë™
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        const inputs = Array.from(document.querySelectorAll('.lane-input'));
        const index = inputs.indexOf(document.activeElement);
        if (index > -1 && index < inputs.length - 1) {
            e.preventDefault(); 
            inputs[index + 1].focus(); 
        }
    }
});

// 4. ì•± ì§„ì… í•¨ìˆ˜
window.enterApp = function() {
    const landing = document.getElementById('landingPage');
    if(landing) landing.style.display = 'none';
    if(typeof window.showGlobalLogin === 'function') window.showGlobalLogin();
};

    window.showGlobalLogin = function() {
        if(localStorage.getItem('loggedInUser')) {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('globalLoginScreen').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            window.updateUI();

            const firstTabBtn = document.querySelectorAll('.tab-btn')[0];
            window.showPanel('attendPanel', firstTabBtn);
            
        } else {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('globalLoginScreen').style.display = 'flex';
        }
    };

    window.doGlobalLogin = function() {
        const i = document.getElementById('globalId').value.trim();
        const p = document.getElementById('globalPw').value.trim();
        if((i==='ê´€ë¦¬ì'||i==='ê¹€ë²”ì£¼') && p==='6884') {
            localStorage.setItem('loggedInUser', i);
            localStorage.setItem('ace_admin', 'true');
            location.reload();
        } else {
            const m = members.find(x=>x.name===i);
            if(m && (m.pw||'1234')===p) {
                localStorage.setItem('loggedInUser', i);
                localStorage.setItem('ace_admin', 'false');
                location.reload();
            } else alert("ë¡œê·¸ì¸ ì‹¤íŒ¨! ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        }
    };

    
window.updateUI = function() {
    if(!loggedInUser) return;

    const myName = loggedInUser.trim();
    const isL = settings.mode === 'lightning';
    const uInfo = document.getElementById('userInfo');
    const settingsTab = document.getElementById('settingsTabBtn');
    
    if(uInfo) uInfo.innerText = `${loggedInUser} ${isAdmin ? '(ê´€ë¦¬ì)' : ''}`;
    if(settingsTab) settingsTab.style.display = isAdmin ? 'block' : 'none';

    for(let i=1; i<=5; i++) {
        const btn = document.getElementById('z'+i);
        if(btn) {
            if(selectedBlocks.includes(i)) btn.classList.add('selected');
            else btn.classList.remove('selected');
        }
    }
    if(window.renderCustomLaneConfig) window.renderCustomLaneConfig(); 

    const panelTitle = document.getElementById('modeDisplay');
    if(panelTitle) {
        panelTitle.innerHTML = isL ? 
            '<span style="color:#e67e22;">âš¡ ë²ˆê°œëª¨ì„ (6ê²Œì„)</span>' : 
            '<span style="color:#2c3e50;">âš–ï¸ ì •ê¸°ëª¨ì„ (4ê²Œì„)</span>';
    }

    const jName = document.getElementById('displayJungmoName');
    const managerLabel = document.querySelector('.box-manager span:first-child');

    if (jName) {
        jName.innerText = isL ? (managers.lightning || 'ë¯¸ì •') : (managers.jungmo || 'ë¯¸ì •');
        
        if (managerLabel) {
            managerLabel.innerText = isL ? 'âš¡ ë²ˆê°œì¥' : 'ğŸ‘‘ ì •ëª¨ì¥';
        }
    }

    const currentJungmoJang = (managers.jungmo || "").trim();
    const currentBungaeJang = (managers.lightning || "").trim();
    let hasPower = isAdmin || (isL ? currentBungaeJang === myName : currentJungmoJang === myName);

    const eventCreateBox = document.getElementById('adminEventCreate');
    const eventSelectBox = document.getElementById('activeMeetingSelector');
    const memAdminBox = document.getElementById('adminMemberControls');
    const jungmoSettingBox = document.getElementById('adminJungmoSetting');
    const bBox = document.getElementById('lightningManagerSelect');

    if(eventCreateBox) eventCreateBox.style.display = hasPower ? 'block' : 'none';
    if(eventSelectBox) eventSelectBox.style.display = hasPower ? 'block' : 'none';
    if(memAdminBox) memAdminBox.style.display = hasPower ? 'block' : 'none';
    if(jungmoSettingBox) jungmoSettingBox.style.display = isAdmin ? 'block' : 'none';
    
    if(bBox) {
        bBox.style.display = isL ? 'block' : 'none';
        if(isL && typeof window.renderBungaeJangSelect === 'function') window.renderBungaeJangSelect();
    }

    const jSettingName = document.getElementById('currentJungmoJangSetting');
    if (jSettingName) jSettingName.innerText = managers.jungmo || 'ì—†ìŒ';

    const bNameSpan = document.getElementById('currentBungaeJang');
    if (bNameSpan) bNameSpan.innerText = managers.lightning || 'ì—†ìŒ';

    if(typeof window.renderEventList === 'function') window.renderEventList();
    if(typeof window.renderAssignGameTabs === 'function') window.renderAssignGameTabs(); 
    if(typeof window.renderMembers === 'function') window.renderMembers();
    if(typeof window.renderCasino === 'function') window.renderCasino();

    if(document.getElementById('groupAssignMethod')) 
        document.getElementById('groupAssignMethod').value = settings.assignMethod || 'snake';
    if(document.getElementById('setAssignMethod')) 
        document.getElementById('setAssignMethod').value = settings.assignMethod || 'snake';
const activePanel = document.querySelector('.panel.active');
    if(activePanel) {
        // ì§„í–‰ í™”ë©´ì´ë©´ ì ìˆ˜íŒ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if(activePanel.id === 'progressPanel' && typeof window.renderGameProgress === 'function') {
            window.renderGameProgress();
        }
        // ì…ë ¥ í™”ë©´ì´ë©´ ì…ë ¥ì°½ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if(activePanel.id === 'inputPanel' && typeof window.renderInputs === 'function') {
            window.renderInputs();
        }
        // í†µê³„ í™”ë©´ì´ë©´ í†µê³„í‘œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if(activePanel.id === 'statsPanel' && typeof window.renderAllStats === 'function') {
            window.renderAllStats();
        }
    }
    };
window.createEvent = function() {
    const date = document.getElementById('eventDate').value;
    const exactTime = document.getElementById('eventExactTime').value; 
    const mode = document.getElementById('eventMode').value;
    
    if(!date || !exactTime) return alert("ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ í™•ì¸í•´ ì£¼ì„¸ìš”!");

    const combinedTime = exactTime; 
    const id = `${date}_${exactTime.replace(':', '')}`; 
    
    db.ref('bowling_v14/events/' + id).set({ 
        id, 
        date, 
        time: combinedTime, 
        mode, 
        attendees: [] 
    }).then(() => {
        alert("âœ… ëª¨ì„ ê³µì§€ ì™„ë£Œ!");
    });
};
    const formatTime = (t) => {
        if(!t) return "";
        let [h, m] = t.split(':');
        h = parseInt(h);
        const ampm = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
        h = h % 12 || 12; // 0ì‹œëŠ” 12ì‹œë¡œ í‘œì‹œ
        return `${ampm} ${String(h).padStart(2, '0')}:${m}`;
    };
window.renderBungaeJangSelect = function() {
    const sel = document.getElementById('bungaeJangSelect');
    if (!sel) return;

    const list = attendees || [];
    let html = '<option value="">-- ë²ˆê°œì¥ ì„ íƒ --</option>';

    if (list.length === 0) {
        html = '<option value="">ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤</option>';
    } else {
        list.forEach(name => {
            const isSelected = (managers.lightning === name) ? 'selected' : '';
            html += `<option value="${name}" ${isSelected}>${name}</option>`;
        });
    }

    sel.innerHTML = html;
};
    window.renderEventList = function() {
    const area = document.getElementById('eventListArea');
    if(!area) return;

    const now = new Date().toISOString().split('T')[0];
    let html = '';

    const myName = (loggedInUser || "").trim();
    const isL = settings.mode === 'lightning';
    const hasPower = isAdmin || (isL ? (managers.lightning === myName) : (managers.jungmo === myName));

    const sortedIds = Object.keys(events || {}).sort((a, b) => b.localeCompare(a));
    const commonBtnStyle = "width: 95px; height: 38px; font-size: 0.9rem; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;";

    sortedIds.forEach(id => {
        const ev = events[id];
        if (ev.date < now) return;

        const list = ev.attendees || [];
        const joined = list.includes(loggedInUser);
        
        const fCount = list.filter(n => members.find(m => m.name === n)?.gender === 'ì—¬').length;
        const mCount = list.length - fCount;

        html += `
        <div class="input-box" style="border-left:10px solid ${ev.mode==='regular'?'#6741d9':'#f08c00'}; padding:18px; margin-bottom:25px; border-radius:15px; box-shadow:0 6px 15px rgba(0,0,0,0.06);">
            
            <div style="margin-bottom:15px;">
                <div style="font-size:0.85rem; color:#888;">${ev.date}</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <b style="font-size:1.35rem; color:#222;">${formatTime(ev.time)}</b>
                    <span style="font-size:0.75rem; background:#f1f3f5; color:#666; padding:2px 8px; border-radius:4px; font-weight:bold;">
                        ${ev.mode==='regular'?'âš–ï¸ ì •ê¸°':'âš¡ ë²ˆê°œ'}
                    </span>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; background:#f8f9fa; padding:12px; border-radius:12px; border:1px solid #eee;">
                <div style="font-size:0.9rem; color:#495057;">
                    <b style="font-size:1rem; color:#222;">ğŸ‘¥ ${list.length}ëª…</b> 
                    <div style="margin-top:2px; font-size:0.8rem; color:#888;">
                        <span style="color:#339af0;">ë‚¨ ${mCount}</span> / <span style="color:#ff922b;">ì—¬ ${fCount}</span>
                    </div>
                </div>
                
                <div style="display:flex; gap:6px;">
                    <button style="${commonBtnStyle} background:${joined?'#ff6b6b':'#20c997'}; color:white;" 
                        onclick="window.toggleEventJoin('${id}')">
                        ${joined ? 'ì°¸ì„ì·¨ì†Œ' : 'ì‹ ì²­í•˜ê¸°'}
                    </button>
                    
                    ${hasPower ? `
                        <button style="${commonBtnStyle} background:#6741d9; color:white;" 
                            onclick="window.activateSelectedEventDirect('${id}')">
                            ê²Œì„ì‹œì‘ ğŸš€
                        </button>
                        <button style="width: 40px; height: 38px; border-radius: 8px; border: 1px solid #e03131; background: #fff; color: #e03131; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0;" 
                            onclick="window.deleteEvent('${id}')">
                            ğŸ—‘ï¸
                        </button>
                        ` : ''}
                </div>
            </div>

            ${hasPower ? `
            <div style="margin-top:15px; display:flex; gap:5px; padding-top:10px; border-top:1px dashed #ddd;">
                <select id="adminAddSelect_${id}" class="btn-sm" style="flex:1; height:38px; border:1px solid var(--accent);">
                    <option value="">-- ëŒ€ë¦¬ ì‹ ì²­ (íšŒì› ì„ íƒ) --</option>
                    ${members.sort((a,b)=>a.name.localeCompare(b.name)).map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
                </select>
                <button class="btn-sm" style="background:var(--accent); color:white; border:none; width:60px;"
                    onclick="window.toggleEventJoin('${id}', document.getElementById('adminAddSelect_${id}').value)">
                    ì¶”ê°€
                </button>
            </div>
            ` : ''}

            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:15px;">
                ${list.map((name, idx) => {
                    const mInfo = members.find(m => m.name === name) || { gender: 'ë‚¨', handicap: 0 };
                    return `
                        <div style="background:${mInfo.gender==='ì—¬'?'#fff0f6':'#e7f5ff'}; border:1px solid ${mInfo.gender==='ì—¬'?'#ffdeeb':'#d0ebff'}; padding:6px 12px; border-radius:20px; font-size:0.85rem; display:flex; align-items:center;">
                            <span style="color:#adb5bd; font-size:0.7rem; margin-right:4px;">${idx + 1}</span> 
                            <b>${name}</b> 
                            <span style="margin-left:4px; color:#845ef7; font-weight:bold;">${mInfo.handicap}</span>
                            ${hasPower ? `<span style="color:#fa5252; margin-left:6px; cursor:pointer; font-weight:bold; font-size:1rem;" onclick="window.kickMember('${id}', '${name}')">Ã—</span>` : ''}
                        </div>`;
                }).join('') || '<div style="color:#dee2e6; width:100%; text-align:center; padding:10px;">ì²« ë²ˆì§¸ ì‹ ì²­ìê°€ ë˜ì–´ë³´ì„¸ìš”!</div>'}
            </div>
        </div>`;
    });

    area.innerHTML = html || '<div style="text-align:center; padding:50px; color:#adb5bd;">ëª¨ì„ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
};



window.activateSelectedEventDirect = function(id) {
    const ev = events[id];
    if(!ev) return;
    if(confirm(`[${ev.date}] ëª¨ì„ ì‹ ì²­ì ${ev.attendees ? ev.attendees.length : 0}ëª…ìœ¼ë¡œ ì¡°í¸ì„±ì„ ì‹œì‘í• ê¹Œìš”?`)) {
        db.ref('bowling_v14').update({
            'attendees': ev.attendees || [],
            'settings/mode': ev.mode,
            'settings/gameCount': ev.mode === 'lightning' ? 6 : 4,
            'settings/currentTab': 'groupPanel'
        }).then(() => {
            alert("ğŸ¯ ëª…ë‹¨ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!");
            window.showPanel('groupPanel', document.querySelectorAll('.tab-btn')[1]);
        });
    }
};

window.toggleEventJoin = function(id) {
    let list = (events[id] && events[id].attendees) ? [...events[id].attendees] : [];
    if(list.includes(loggedInUser)) list = list.filter(n => n !== loggedInUser);
    else list.push(loggedInUser);
    db.ref('bowling_v14/events/' + id + '/attendees').set(list);
};

window.activateSelectedEvent = function() {
    const id = document.getElementById('currentActiveEventId').value;
    if(!id || !events[id]) return alert("ì§„í–‰í•  ëª¨ì„ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”!");

    if(confirm("ì´ ëª…ë‹¨ìœ¼ë¡œ ì˜¤ëŠ˜ ê²Œì„ì„ ì‹œì‘í• ê¹Œìš”?")) {
        const ev = events[id];
        const gCount = ev.mode === 'lightning' ? 6 : 4;

        db.ref('bowling_v14').update({
            'attendees': ev.attendees || [],
            'settings/mode': ev.mode,
            'settings/gameCount': gCount,
            'settings/currentTab': 'groupPanel' 
        }).then(() => {
            alert("ğŸ¯ ëª…ë‹¨ ë¡œë“œ ì™„ë£Œ! ì¡°í¸ì„± í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            const tabBtns = document.querySelectorAll('.tab-btn');
            if (tabBtns[1]) {
                window.showPanel('groupPanel', tabBtns[1]);
            }
        });
    }
};

    window.changeAssignMethod = function(val) {
        if(db) {
            db.ref('bowling_v14/settings').update({ assignMethod: val })
                .then(() => console.log("ì¡°í¸ì„± ë°©ì‹ ë³€ê²½ ì™„ë£Œ: " + val));
        }
    };
    window.showPanel = function(id, btn) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');

        if(id !== 'inputPanel') currentInputTeam = null;

        if(id === 'attendPanel') window.renderAttendanceList();
        if(id === 'progressPanel') window.renderGameProgress();
        if(id === 'statsPanel') window.renderAllStats(); 
        if(id === 'inputPanel') {
            if(loggedInUser) {
                document.getElementById('scoreSection').style.display = 'block';
                window.renderInputs(); 
            } else {
                document.getElementById('scoreSection').style.display = 'none';
            }
        }
        if(id === 'memberPanel') window.renderMembers();
    };

    window.goToInput = function(gameNo, teamNo) { 
        currentInputGame = gameNo;
        currentInputTeam = teamNo; 
        const tabBtns = document.querySelectorAll('.tab-btn');
        const inputTabBtn = tabBtns[4]; 
        window.showPanel('inputPanel', inputTabBtn); 
    };
    
    window.clickInputTab = function(btn) {
        currentInputTeam = null;
        window.showPanel('inputPanel', btn);
    };
    
    window.showAllTeams = function() {
        currentInputTeam = null;
        window.renderInputs();
    };

    

    window.setJungmoManager = function() {
        const name = document.getElementById('jungmoJangInput').value.trim();
        if(db) db.ref('bowling_v14/managers/jungmo').set(name).then(()=>alert("ì •ëª¨ì¥ ì„¤ì • ì™„ë£Œ"));
    };
    window.setBungaeManager = function() {
        const name = document.getElementById('bungaeJangSelect').value;
        if(!name) return alert("íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        if(db) db.ref('bowling_v14/managers/lightning').set(name).then(()=>alert("ë²ˆê°œì¥ ì„¤ì • ì™„ë£Œ"));
    };

    window.renderAssignGameTabs = function() {
    const area = document.getElementById('assignGameTabs');
    if(!area) return;

    let html = '';
    const count = (settings.mode === 'regular') ? 4 : (settings.gameCount || 6);
    
    for(let i=1; i<=count; i++) {
        const isActive = (currentTargetGame === i) ? 'active' : '';
        html += `<div class="rank-tab ${isActive}" style="flex:1; text-align:center;" onclick="window.setTargetGame(${i})">${i}G</div>`;
    }
    area.innerHTML = html;
};

window.setTargetGame = function(gameNo) {
    currentTargetGame = gameNo;
    window.renderAssignGameTabs();
    if(window.renderCustomLaneConfig) window.renderCustomLaneConfig();
    console.log(`${gameNo}G ì¡°í¸ì„± ëª¨ë“œë¡œ ì „í™˜!`);
};

    

// 2. ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤ì œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ (ì—¬ê¸°ì„œ runAssignmentë¥¼ ë¶€ë¦…ë‹ˆë‹¤)
window.runGeneralAssignment = function() {
    if (gameTeams[currentTargetGame]) {
        return alert(`âš ï¸ ì´ë¯¸ ${currentTargetGame}G íŒ€ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    db.ref('bowling_v14/casino').once('value', sn => {
        if (sn.exists()) {
            alert("ğŸ° ì¹´ì§€ë…¸ ë°°ì • ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤!");
        } else {
            window.runAssignment(); // ğŸ‘ˆ ì—¬ê¸°ì„œ ìœ„ì˜ í•¨ìˆ˜ë¥¼ ë¶€ë¦…ë‹ˆë‹¤.
        }
    });
};
window.startCasinoAssignment = function() {
    if (gameTeams[currentTargetGame]) {
        return alert(`âš ï¸ ì´ë¯¸ ${currentTargetGame}G íŒ€ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒˆë¡œ í•˜ì‹œë ¤ë©´ [ğŸ—‘ï¸ ì´ˆê¸°í™”]ë¥¼ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
    }

    let teamList = [];
    for(let k in laneSettings) if(k.startsWith('team_') && laneSettings[k] > 0) teamList.push(laneSettings[k]);
    
    if(teamList.length === 0) {
        return alert("ë¨¼ì € ì•„ë˜ [3. ë ˆì¸ë³„ ì¸ì› ì„¤ì •] ì¹¸ì— íŒ€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ì¹´ì§€ë…¸ ë°°ì •ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
    }

    if(confirm(`${currentTargetGame}G ì¹´ì§€ë…¸ ë°°ì •ì„ ì‹œì‘í• ê¹Œìš”?\ní™•ì¸ ì‹œ ëª¨ë“  ì°¸ê°€ìì˜ í™”ë©´ì´ ì¹´ì§€ë…¸ë¡œ ì´ë™í•©ë‹ˆë‹¤.`)) {
        
        db.ref('bowling_v14/settings').update({
            currentTab: 'casinoPanel',
            currentAssignGame: currentTargetGame 
        });

        const tabBtns = document.querySelectorAll('.tab-btn');
        if(tabBtns[2]) window.showPanel('casinoPanel', tabBtns[2]);
    }
};

window.renderStatsGameTabs = function() {
    const area = document.getElementById('statsGameTabs');
    if (!area) return;
    let html = '';
    const count = settings.gameCount || 4; 
    for (let i = 1; i <= count; i++) {
        const isActive = (currentStatsGame === i) ? 'active' : '';
        html += `<div class="rank-tab ${isActive}" 
                     style="flex:1; text-align:center; cursor:pointer;" 
                     onclick="currentStatsGame=${i}; window.renderAllStats();">${i}G</div>`;
    }
    area.innerHTML = html;
};
window.renderCurrentGameStats = function() {
    const teamArea = document.getElementById('currentTeamRankTable');
    const indivArea = document.getElementById('currentIndivRankTable');
    if (!teamArea || !indivArea) return;

    const gData = gameTeams[currentStatsGame] || [];
    if (gData.length === 0) {
        teamArea.innerHTML = '<div style="padding:30px; text-align:center; color:#999;">ì…ë ¥ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        indivArea.innerHTML = '';
        return;
    }

    let teamRanks = gData.map(t => {
        let sum = (parseInt(t.matchHandy) || 0);
        t.members.forEach(m => {
            const mInfo = members.find(x => x.name === m.name) || {};
            sum += (parseInt(m.score) || 0) + (m.name.includes("ê³ ìŠ¤íŠ¸") ? 0 : (parseInt(mInfo.handicap) || 0));
        });
        return { teamNo: t.teamNo, total: sum, members: t.members.map(m=>m.name).join(', ') };
    }).sort((a, b) => b.total - a.total);

    teamArea.innerHTML = `
        <table class="stats-table">
            <thead><tr><th>ìˆœìœ„</th><th>íŒ€ (ë©¤ë²„)</th><th>ì´ì </th></tr></thead>
            <tbody>
                ${teamRanks.map((tr, i) => `
                    <tr>
                        <td>${i === 0 ? 'ğŸ¥‡' : i + 1}</td>
                        <td style="text-align:left; padding-left:15px;">
                            <b style="color:#2c3e50;">Team ${tr.teamNo}</b><br>
                            <small style="color:#adb5bd;">[ ${tr.members} ]</small>
                        </td>
                        <td style="font-weight:bold; color:#3498db;">${tr.total}</td>
                    </tr>`).join('')}
            </tbody>
        </table>`;

    let indivMap = {};
    const totalGameCount = settings.gameCount || 4; 

    for (let g = 1; g <= totalGameCount; g++) {
        const teams = gameTeams[g] || [];
        teams.forEach(t => {
            t.members.forEach(m => {
                if (!indivMap[m.name]) {
                    const mInfo = members.find(x => x.name === m.name) || { handicap: 0 };
                    indivMap[m.name] = { 
                        name: m.name, 
                        scores: Array(totalGameCount).fill('-'), 
                        accumulatedTotal: 0,
                        gamesPlayed: 0,
                        handicap: (m.name.includes("ê³ ìŠ¤íŠ¸") ? 0 : (parseInt(mInfo.handicap) || 0)),
                        gender: mInfo.gender || 'ë‚¨'
                    };
                }
                const s = parseInt(m.score) || 0;
                if(s > 0) {
                    indivMap[m.name].scores[g-1] = s;
                    indivMap[m.name].accumulatedTotal += s;
                    indivMap[m.name].gamesPlayed += 1;
                }
            });
        });
    }

    const genderFilter = currentGenderFilter || 'all'; 

let indivList = Object.values(indivMap)
    .filter(p => genderFilter === 'all' || p.gender === genderFilter) 
    .map(p => {
        p.finalTotal = p.accumulatedTotal + (p.handicap * p.gamesPlayed);
        return p;
    }).sort((a, b) => b.finalTotal - a.finalTotal);

    let gameHeaders = "";
    for (let i = 1; i <= totalGameCount; i++) {
        gameHeaders += `<th style="width:45px;">${i}G</th>`;
    }

    indivArea.innerHTML = `
        <div style="overflow-x:auto;">
            <table class="stats-table" style="margin-top:10px; min-width:350px;">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th>ì´ë¦„</th>
                        ${gameHeaders}
                        <th style="background:#fff5f5; color:#e74c3c;">í•©ê³„</th>
                    </tr>
                </thead>
                <tbody>
                    ${indivList.map((p, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td style="font-weight:bold; white-space:nowrap;">${p.name}</td>
                            ${p.scores.map((s, idx) => `
                                <td style="${(s >= 200) ? 'color:#e74c3c; font-weight:bold;' : ((idx+1) === currentStatsGame ? 'color:#222;' : 'color:#adb5bd;')} ${(idx+1) === currentStatsGame ? 'background:#e7f5ff;' : ''}">
    ${s}
</td>
                            `).join('')}
                            <td style="color:#e74c3c; font-weight:bold; background:#fff5f5;">${p.finalTotal}</td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>`;
};

window.renderHistoricalStats = function() {
    const area = document.getElementById('historicalStatsTable');
    if (!area || !loggedInUser) return;

    if (!records || records.length === 0) {
        area.innerHTML = '<div style="padding:30px; text-align:center; color:#999;">ê¸°ë¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let latestDateStr = records.reduce((max, r) => (r.date > max ? r.date : max), "1900-01-01");
    let cutoff = new Date(latestDateStr); 

    if (currentStatsPeriod === '1m') cutoff.setMonth(cutoff.getMonth() - 1);
    else if (currentStatsPeriod === '3m') cutoff.setMonth(cutoff.getMonth() - 3);
    else if (currentStatsPeriod === '6m') cutoff.setMonth(cutoff.getMonth() - 6);
    else if (currentStatsPeriod === '12m') cutoff.setMonth(cutoff.getMonth() - 12);
    else cutoff.setFullYear(1900);

    let statsMap = {};
    records.forEach(r => {
        if (new Date(r.date) >= cutoff && r.scs) {
            const name = (r.name || "").trim();
            if (!name) return;
            if (!statsMap[name]) statsMap[name] = { name: name, total: 0, count: 0 };
            r.scs.forEach(s => {
                if (parseInt(s) > 0) {
                    statsMap[name].total += parseInt(s);
                    statsMap[name].count++;
                }
            });
        }
    });

    let statsList = Object.values(statsMap).map(s => ({
        ...s,
        avg: s.count > 0 ? Math.round(s.total / s.count) : 0
    })).sort((a, b) => b.avg - a.avg);

    let html = `
        <div style="margin-bottom:10px; font-size:0.9rem; color:var(--accent); font-weight:bold; text-align:center; background:#f0f7ff; padding:10px; border-radius:8px; border:1px solid #d0e3ff;">
            ğŸ“Š í†µê³„ ê¸°ì¤€ì¼: ${latestDateStr}
        </div>
        <table class="stats-table">
            <thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ê²Œì„ìˆ˜</th><th>ì´ì </th><th>AVG</th></tr></thead>
            <tbody>`;

    html += statsList.map((s, i) => {
        const avgClass = (s.avg >= 200) ? 'class="over-200"' : '';
        return `
            <tr>
                <td>${i + 1}</td>
                <td style="font-weight:bold;">${s.name}</td>
                <td>${s.count}</td>
                <td>${s.total}</td>
                <td ${avgClass}>${s.avg}</td>
            </tr>`;
    }).join('');

    area.innerHTML = html + `</tbody></table>`;
};
window.setStatsPeriod = function(period, btn) {
    currentStatsPeriod = period;

    const filterBtns = document.querySelectorAll('#statsPanel .filter-btn');
    filterBtns.forEach(b => b.classList.remove('active')); 
    if (btn) btn.classList.add('active'); 

    console.log(`ğŸ“… í†µê³„ ê¸°ê°„ ë³€ê²½: ${period}`);
    window.renderAllStats(); 
};
window.renderTodayTotalRank = function() {
    const totalArea = document.getElementById('todayTotalRankTable');
    if (!totalArea) return;

    let totalMap = {};
    for (let i = 1; i <= settings.gameCount; i++) {
        (gameTeams[i] || []).forEach(t => {
            t.members.forEach(m => {
                if (!totalMap[m.name]) totalMap[m.name] = { name: m.name, totalScore: 0, gameCount: 0 };
                const s = parseInt(m.score) || 0;
                if (s > 0) { totalMap[m.name].totalScore += s; totalMap[m.name].gameCount++; }
            });
        });
    }

    let totalList = Object.values(totalMap).sort((a, b) => b.totalScore - a.totalScore);

    let totalHtml = `
        <table class="stats-table" style="border: 2px solid var(--danger); margin-top: 10px;">
            <thead style="background: #fff5f5;">
                <tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ê²Œì„ìˆ˜</th><th>ì´ì (í•©ê³„)</th></tr>
            </thead>
            <tbody>`;

    totalHtml += totalList.map((s, i) => {
        const totalClass = (s.totalScore >= 200) ? 'class="over-200"' : '';
        return `
            <tr style="${i === 0 ? 'background: #fff9db; font-weight: bold;' : ''}">
                <td>${i + 1}</td>
                <td>${i === 0 ? 'ğŸ‘‘ ' : ''}${s.name}</td>
                <td>${s.gameCount}G</td>
                <td ${totalClass}>${s.totalScore}</td>
            </tr>`;
    }).join('');

    totalArea.innerHTML = totalList.length ? (totalHtml + `</tbody></table>`) : '<div style="padding:20px; text-align:center; color:#999;">ì˜¤ëŠ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
};
        
    window.saveSettings = function() {
    const mode = document.getElementById('setMode') ? document.getElementById('setMode').value : settings.mode;
    const cnt = document.getElementById('setGameCount') ? parseInt(document.getElementById('setGameCount').value) : settings.gameCount;
    const avg = parseInt(document.getElementById('setAvgCriteria').value) || 6;
    const method = document.getElementById('setAssignMethod').value;

    if(db) {
        db.ref('bowling_v14/settings').update({
            mode: mode,
            gameCount: cnt,
            avgCriteria: avg,
            assignMethod: method
        }).then(() => {
            const methodKOR = method === 'snake' ? 'ğŸ ìŠ¤ë„¤ì´í¬' : (method === 'ai' ? 'ğŸ¤– AI ë°¸ëŸ°ìŠ¤' : 'ğŸ² ëœë¤');
            
            alert(`âœ… ìš´ì˜ ì„¤ì • ë³€ê²½ ì™„ë£Œ!\n\n` +
                  `ğŸ“… ê°€ì¤‘ì¹˜ ë°˜ì˜ ê¸°ê°„: ${avg}ê°œì›”\n` +
                  `âš–ï¸ ê¸°ë³¸ ì¡°í¸ì„± ë°©ì‹: ${methodKOR}\n\n` +
                  `[í™•ì¸]ì„ ëˆ„ë¥´ë©´ ì„¤ì •ì´ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤.`);
            
            location.reload(); 
        });
    }
};

    window.toggleZone = function(n) {
    if(selectedBlocks.includes(n)) {
        selectedBlocks = selectedBlocks.filter(x => x !== n);
    } else {
        selectedBlocks.push(n);
    }
    
    db.ref('bowling_v14/selectedBlocks').set(selectedBlocks);

    for(let i=1; i<=5; i++) {
        const b = document.getElementById('z'+i);
        if(b) {
            if(selectedBlocks.includes(i)) b.classList.add('selected');
            else b.classList.remove('selected');
        }
    }
    
    window.renderCustomLaneConfig();
};
    window.renderCustomLaneConfig = function() {
    const c = document.getElementById('laneConfigArea');
    if(!c) return;
    
    let html = '';
    if(selectedBlocks.length === 0) { 
        c.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#999; border:2px dashed #ddd; border-radius:10px;">ìƒë‹¨ì˜ <b>[1. êµ¬ì—­ ì„ íƒ]</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>'; 
        document.getElementById('totalConfigCount').innerText = '0'; 
        return; 
    }

    selectedBlocks.sort((a,b)=>a-b).forEach(z => {
        const s = (z-1)*4 + 3; 
        [s, s+1, s+2, s+3].forEach(l => {
            let valCnt = laneSettings['cnt_'+l] || 0; 
            let valTeam = laneSettings['team_'+l] || 0;
            
            html += `
            <div class="lane-box-v13">
                <div class="lane-label" style="font-weight:bold; color:var(--purple);">${l}L</div>
                
                <input type="number" 
                       inputmode="numeric" 
                       class="lane-input" 
                       placeholder="ì¸ì›" 
                       value="${valCnt > 0 ? valCnt : ''}" 
                       onfocus="if(this.value=='0') this.value='';
                       onchange="window.updateConfig('cnt_${l}', this.value)"
                       style="width: 100%; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 8px; margin-top:5px; font-size:1.1rem; box-sizing:border-box;">
                
                <input type="number" 
                       inputmode="numeric" 
                       class="lane-input" 
                       placeholder="íŒ€" 
                       value="${valTeam > 0 ? valTeam : ''}" 
                       onfocus="if(this.value=='0') this.value='';
                       onchange="window.updateConfig('team_${l}', this.value)"
                       style="width: 100%; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 8px; margin-top:5px; font-size:1.1rem; background:#f9f9f9; box-sizing:border-box;">
            </div>`;
        });
    });

    c.innerHTML = html;
    let t = 0; 
    for(let k in laneSettings) if(k.startsWith('cnt_')) t += (parseInt(laneSettings[k]) || 0);
    const totalArea = document.getElementById('totalConfigCount');
    if(totalArea) totalArea.innerText = t;
};
window.applyPreset = function(size) {
    if (selectedBlocks.length === 0) return alert("ë¨¼ì € êµ¬ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
    if (attendees.length === 0) return alert("ì°¸ì„ìê°€ ì—†ìŠµë‹ˆë‹¤.");

    const total = attendees.length;
    const teamCount = Math.ceil(total / size); 
    let currentLaneIdx = 0;
    let newSettings = {};

    const lanes = [];
    selectedBlocks.sort((a,b)=>a-b).forEach(z => {
        const start = (z - 1) * 4 + 3;
        for(let i=0; i<4; i++) lanes.push(start + i);
    });

    for (let t = 1; t <= teamCount; t++) {
        for (let p = 0; p < size; p++) {
            if (currentLaneIdx >= lanes.length) break;
            const lane = lanes[currentLaneIdx];
            newSettings['cnt_' + lane] = (newSettings['cnt_' + lane] || 0) + 1;
            newSettings['team_' + lane] = t; 
            currentLaneIdx++;
        }
    }

    laneSettings = newSettings; 

    db.ref('bowling_v14/laneSettings').set(newSettings).then(() => {
        alert(`âœ… ${size}ì¸ì¡° ìë™ ì„¤ì • ì™„ë£Œ!\nì´ ${teamCount}ê°œ íŒ€ì´ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        window.renderCustomLaneConfig(); 
    });
};

window.updateConfig = function(k, v) { 
    laneSettings[k] = parseInt(v) || 0; 
    
    if(db) {
        db.ref('bowling_v14/laneSettings').set(laneSettings)
            .then(() => {
                console.log("ë ˆì¸ ì„¤ì • ì €ì¥ ì™„ë£Œ");
                window.renderCustomLaneConfig(); 
            });
    } else {
        window.renderCustomLaneConfig(); 
    }
};
    
    // 1. [ì‹¤ë ¥ ê³„ì‚°] ê³µì‹ ì •ëª¨ 12íšŒ ê¸°ì¤€ 3:7 ê°€ì¤‘ì¹˜
window.getWeightedStats = function(name) {
    if (!name || name.includes("ê³ ìŠ¤íŠ¸")) return { weightedAvg: 0, simpleAvg12: 0 };
    const allDates = [...new Set(records.map(r => r.date))].sort().reverse().slice(0, 12);
    if (allDates.length === 0) return { weightedAvg: 0, simpleAvg12: 0 };
    const recentWindow = allDates.slice(0, 6);
    const pastWindow = allDates.slice(6, 12);
    let recentScores = [], pastScores = [], totalScores12 = [];
    records.filter(r => r.name === name && allDates.includes(r.date)).forEach(r => {
        if(r.scs) r.scs.forEach(s => {
            if (s > 0) {
                totalScores12.push(s);
                if (recentWindow.includes(r.date)) recentScores.push(s);
                else if (pastWindow.includes(r.date)) pastScores.push(s);
            }
        });
    });
    const getAvg = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
    const simpleAvg12 = Math.round(getAvg(totalScores12));
    const recentAvg = getAvg(recentScores);
    const pastAvg = getAvg(pastScores);
    let weightedAvg = (recentAvg > 0 && pastAvg > 0) ? Math.round((pastAvg * 0.3) + (recentAvg * 0.7)) : Math.round(recentAvg || pastAvg || simpleAvg12 || 0);
    return { weightedAvg: weightedAvg || 0, simpleAvg12: simpleAvg12 || 0 };
};

// 2. [ë°°ì • ì—”ì§„] 5ì¸ì¡° ê³ ì •, ì§€ê·¸ì¬ê·¸ ë ˆì¸, ìë™ í˜ì´ì§€ ì´ë™
window.runAssignment = function() {
    if(selectedBlocks.length === 0 || attendees.length === 0) return alert("êµ¬ì—­ê³¼ ì°¸ì„ìë¥¼ í™•ì¸í•˜ì„¸ìš”.");

    const teamCount = selectedBlocks.length * 2;
    const totalPeople = attendees.length;
    
    // íŒ€ë³„ ê¸°ë³¸ ë°°ì • ì¸ì› ê³„ì‚° (ì˜ˆ: 16ëª…/4íŒ€ = 4ëª…)
    const baseSize = Math.floor(totalPeople / teamCount);
    const remainder = totalPeople % teamCount;

    let women = [], men = [];
    attendees.forEach(n => {
        const s = window.getWeightedStats(n);
        const m = members.find(x => x.name === n) || {gender:'ë‚¨', handicap:0};
        const p = { name: n, avg: s.weightedAvg, gender: m.gender, isGhost: false, handicap: m.handicap || 0, score: 0 };
        if(p.gender === 'ì—¬') women.push(p); else men.push(p);
    });

    let finalTeams = [];
    for(let i=0; i<teamCount; i++) {
        // ì‹¤ì œ ì‚¬ëŒì´ ë“¤ì–´ê°ˆ ìë¦¬ ìˆ˜ (remainderê°€ ìˆìœ¼ë©´ ì¼ë¶€ íŒ€ì€ +1ëª…)
        let cap = baseSize + (i < remainder ? 1 : 0);
        finalTeams.push({ teamNo: i + 1, humanCap: cap, capacity: 5, members: [], totalAvg: 0 });
    }

    // 1. ì—¬ì„± ì‹¤ë ¥ìˆœ ê· ë“± ë¶„ë°°
    women.sort((a,b)=>b.avg-a.avg).forEach((p, i) => { 
        finalTeams[i % teamCount].members.push(p); 
        finalTeams[i % teamCount].totalAvg += p.avg; 
    });
    
    // 2. ë‚¨ì„± ì‹¤ë ¥ìˆœ ë°¸ëŸ°ìŠ¤ ë¶„ë°°
    men.sort((a,b)=>b.avg-a.avg).forEach(p => {
        let targets = finalTeams.filter(t => t.members.length < t.humanCap);
        targets.sort((a,b) => a.totalAvg - b.totalAvg);
        if(targets.length > 0) { 
            targets[0].members.push(p); 
            targets[0].totalAvg += p.avg; 
        }
    });

    // 3. [í•µì‹¬ ìˆ˜ì •] ì¸ì›ì´ ë¶€ì¡±í•  ë•Œë§Œ ê³ ìŠ¤íŠ¸ íˆ¬ì… (ê¸°ì¡´ capacity ëŒ€ì‹  humanCap ê¸°ì¤€)
    finalTeams.forEach(t => { 
        // humanCapê¹Œì§€ëŠ” ì´ë¯¸ ì‚¬ëŒì´ ì°¼ìœ¼ë¯€ë¡œ, ì´ ë£¨í”„ëŠ” ì¸ì›ì´ ë”± ë§ìœ¼ë©´ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        while(t.members.length < t.humanCap) {
            t.members.push({ name: "ğŸ‘»ê³ ìŠ¤íŠ¸", avg: 0, gender: "ë‚¨", isGhost: true, handicap: 0, score: 0 });
        }
    });

    // 4. ë ˆì¸ ë°°ì¹˜ ë° ë§¤ì¹˜í•¸ë”” ê³„ì‚°
    let lanePairs = [];
    selectedBlocks.sort((a,b)=>a-b).forEach(z => { lanePairs.push([(z-1)*4+3, (z-1)*4+4], [(z-1)*4+5, (z-1)*4+6]); });
    const maxAvg = Math.max(...finalTeams.map(t => t.totalAvg));

    finalTeams.sort((a,b) => a.teamNo - b.teamNo).forEach((t, i) => {
        const pair = lanePairs[i] || [0,0];
        t.members.sort((a,b) => b.avg - a.avg);
        // ì§€ê·¸ì¬ê·¸ ë°°ì¹˜ (1,3,5ìœ„ ì¢Œì¸¡ / 2,4ìœ„ ìš°ì¸¡)
        t.members.forEach((m, idx) => { m.lane = (idx % 2 === 0) ? pair[0] : pair[1]; });
        t.matchHandy = Math.max(0, Math.round(maxAvg - t.totalAvg));
    });

    // 5. ì €ì¥ ë° í™”ë©´ ì „í™˜
    gameTeams[currentTargetGame] = finalTeams;
    db.ref('bowling_v14/gameTeams').set(gameTeams).then(() => {
        alert(`âœ… ${currentTargetGame}G ë°°ì • ì™„ë£Œ!`);
        currentRankView = currentTargetGame;
        // ë°°ì • ì¦‰ì‹œ [ì§„í–‰] íƒ­ìœ¼ë¡œ ì´ë™
        window.showPanel('progressPanel', document.querySelectorAll('.tab-btn')[3]); 
    });
};

// 3. [í™”ë©´ ì¶œë ¥] ê°€ë¡œ 2ì—´(ì¢Œ3:ìš°2), í™”ì‚´í‘œ, ê³ ìŠ¤íŠ¸ í•¸ë”” ë³µêµ¬
window.renderGameProgress = function() {
    const tBox = document.getElementById('progTabs');
    let tHtml = '';
    for(let i=1; i<=settings.gameCount; i++) tHtml += `<div class="rank-tab ${currentRankView===i?'active':''}" onclick="currentRankView=${i};window.renderGameProgress()">${i}G</div>`;
    tBox.innerHTML = tHtml;
    const gData = gameTeams[currentRankView] || [];
    const renderMem = (m, teamMatchHandy) => {
        if(!m) return "";
        const isG = m.name.includes("ê³ ìŠ¤íŠ¸");
        const s = window.getWeightedStats(m.name);
        const mInfo = members.find(x => x.name === m.name) || {};
        const h = isG ? (parseInt(teamMatchHandy) || 0) : (parseInt(mInfo.handicap) || 0);
        const total = (parseInt(m.score) || 0) + h;
        let arrow = '';
        if(!isG) {
            if(s.weightedAvg > s.simpleAvg12) arrow = '<span style="color:red;">â–²</span>';
            else if(s.weightedAvg < s.simpleAvg12) arrow = '<span style="color:blue;">â–¼</span>';
            else arrow = '<span style="color:#999;">-</span>';
        }
        return `
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f1f1f1; align-items:center;">
                <div style="line-height:1.2;">
                    <b style="font-size:1.05rem;">${m.name}</b><br>
                    <small style="color:#666;">${!isG ? `(${s.simpleAvg12 || 0}) <b>${s.weightedAvg || 0}</b> ${arrow}` : 'ê³ ìŠ¤íŠ¸'} <b style="color:#8e44ad; margin-left:4px;">H:${h}</b></small>
                </div>
                <div style="font-size:1.15rem; font-weight:bold;">${total}</div>
            </div>`;
    };
    const cardsHtml = gData.map(t => {
        let teamSum = (parseInt(t.matchHandy) || 0);
        t.members.forEach(m => teamSum += (parseInt(m.score) || 0) + (m.name.includes("ê³ ìŠ¤íŠ¸") ? 0 : (parseInt(members.find(x=>x.name===m.name)?.handicap) || 0)));
        const L = [t.members[0], t.members[2], t.members[4]]; // 1, 3, 5ìœ„
        const R = [t.members[1], t.members[3]]; // 2, 4ìœ„
        return `
            <div class="team-card" style="margin-bottom:20px; border:2px solid #6c5ce7; border-radius:12px; overflow:hidden; background:white;">
                <div class="team-header" onclick="window.goToInput(${currentRankView}, ${t.teamNo})" style="background:#6c5ce7; color:white; padding:10px 15px; display:flex; justify-content:space-between; align-items:center;">
                    <b>Team ${t.teamNo} <small>(ì—ë²„í•©:${t.totalAvg})</small></b>
                    <span style="background:white; color:#6c5ce7; padding:2px 10px; border-radius:15px; font-weight:bold;">ì´ì : ${teamSum}</span>
                </div>
                <div style="display: flex;">
                    <div style="flex: 1.1; border-right: 1px dashed #ddd; padding: 10px;">
                        <div style="text-align:center; font-weight:bold; color:#3498db; font-size:0.8rem; background:#f0f8ff; border-radius:4px; margin-bottom:5px;">${L[0]?.lane || '?'}L (ì¢Œ)</div>
                        ${L.map(m => renderMem(m, t.matchHandy)).join('')}
                    </div>
                    <div style="flex: 1; padding: 10px;">
                        <div style="text-align:center; font-weight:bold; color:#e67e22; font-size:0.8rem; background:#fff5eb; border-radius:4px; margin-bottom:5px;">${R[0]?.lane || '?'}L (ìš°)</div>
                        ${R.map(m => renderMem(m, t.matchHandy)).join('')}
                    </div>
                </div>
                ${t.matchHandy > 0 ? `<div style="font-size:0.75rem; color:#8e44ad; padding:4px; text-align:center; background:#f3f0ff; border-top:1px solid #eee; font-weight:bold;">ğŸ›¡ï¸ ë§¤ì¹˜ í•¸ë”” ë³´ë„ˆìŠ¤ +${t.matchHandy}</div>` : ''}
            </div>`;
    }).join('') || '<div style="text-align:center; padding:50px; color:#999;">ë°ì´í„° ì—†ìŒ</div>';
    document.getElementById('teamCardArea').innerHTML = cardsHtml;
};

    window.updateScore = function(n, v) { (gameTeams[currentInputGame]||[]).forEach(t => t.members.forEach(m => { if(m.name===n) m.score = parseInt(v); })); };
    
window.saveAllScores = function() { 
    db.ref('bowling_v14/gameTeams').set(gameTeams).then(() => {
        
        currentStatsGame = currentInputGame; 

        db.ref('bowling_v14/settings').update({ 
            currentTab: 'statsPanel',
            currentStatsGame: currentInputGame 
        });

        alert(`âœ… ${currentInputGame}G ì ìˆ˜ ì €ì¥ ì™„ë£Œ! ì‹¤ì‹œê°„ í†µê³„ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
        
        const tabBtns = document.querySelectorAll('.tab-btn');
        if(tabBtns[5]) {
            window.showPanel('statsPanel', tabBtns[5]);
        }

    }).catch(err => {
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err);
    });
};

window.filterCurrentStats = function(gender, btn) {
    currentGenderFilter = gender;
    document.querySelectorAll('#statsPanel .filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    window.renderCurrentGameStats();
};
window.deleteEvent = function(id) {
    if (confirm("âš ï¸ ì´ ëª¨ì„ ê³µì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?\nì‹ ì²­ ëª…ë‹¨ë„ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) {
        db.ref('bowling_v14/events/' + id).remove()
        .then(() => alert("âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."))
        .catch(err => alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + err));
    }
};
window.kickMember = function(eventId, userName) {
    if(!confirm(`[${userName}] ë‹˜ì„ ëª…ë‹¨ì—ì„œ ì œì™¸í• ê¹Œìš”?`)) return;
    
    const ev = events[eventId];
    if(!ev || !ev.attendees) return;
    
    const newList = ev.attendees.filter(n => n !== userName);
    
    db.ref(`bowling_v14/events/${eventId}/attendees`).set(newList)
      .then(() => alert(`${userName} ë‹˜ì´ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`));
};  
 window.logout = function() { localStorage.clear(); location.reload(); };
    window.checkGender = function(sel) {
        document.getElementById('newMemHandicap').value = (sel.value === 'ì—¬' ? 12 : 0);
    };

    window.addMember = function() {
        const nameInput = document.getElementById('newMemName');
        const genderInput = document.getElementById('newMemGender');
        const handicapInput = document.getElementById('newMemHandicap');
        const name = nameInput.value.trim();
        const gender = genderInput.value;
        const handicap = parseInt(handicapInput.value) || 0;
        if(!name) return alert("ì´ë¦„ ì…ë ¥!");
        db.ref('bowling_v14/members').push({ name: name, gender: gender, handicap: handicap, pw: '1234' }).then(() => location.reload());
    };
    
    window.renderAttendanceList = function() {
    const a = document.getElementById('attendListArea');
    if(!a) return;
    const sorted = members.filter(m => m.status !== 'íƒˆí‡´').sort((a,b) => a.name.localeCompare(b.name));
    a.innerHTML = sorted.map(m => {
        const is = attendees.includes(m.name); 
            const nameStyle = is ? 'color:var(--green); font-weight:bold; font-size:1.2rem;' : 'color:#333; font-size:1.2rem;';
        const btnStyle = is ? 'background:var(--green); color:white; border-color:var(--green);' : 'background:#fff; color:#333; border-color:#ddd;';
        
        return `<div class="member-row" style="padding:12px;">
            <span style="${nameStyle}">${m.name}</span>
            <button class="btn-sm" style="${btnStyle}" onclick="window.toggleAtt('${m.name}')">${is?'ì°¸ì„ì¤‘':'ì°¸ì„'}</button>
        </div>`;
           }).join('');
        if(document.getElementById('attCount')) document.getElementById('attCount').innerText = attendees.length;
    };

    
// ========================================================
// ğŸŸ¡ [ìˆ˜ì •] ì´ë²¤íŠ¸ ì°¸ì„ ì‹ ì²­ (ê´€ë¦¬ì ëŒ€ë¦¬ ì‹ ì²­ ê¸°ëŠ¥ ì¶”ê°€)
// ========================================================
window.toggleEventJoin = function(id, userName) {
    // userNameì´ ì¸ìë¡œ ë“¤ì–´ì˜¤ë©´ ê·¸ ì´ë¦„ì„ ì“°ê³ , ì—†ìœ¼ë©´ ë¡œê·¸ì¸í•œ ë³¸ì¸ ì´ë¦„ì„ ì”ë‹ˆë‹¤.
    const targetName = (userName || loggedInUser || "").trim();
    
    if(!targetName) return alert("íšŒì› ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

    // ê´€ë¦¬ìê°€ ì•„ë‹Œë° ë‹¤ë¥¸ ì‚¬ëŒì„ ì¶”ê°€í•˜ë ¤ê³  í•˜ë©´ ë§‰ìŠµë‹ˆë‹¤.
    if (!isAdmin && targetName !== loggedInUser) {
        return alert("ğŸš« ë³¸ì¸ë§Œ ì‹ ì²­ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    }

    let list = (events[id] && events[id].attendees) ? [...events[id].attendees] : [];
    
    if(list.includes(targetName)) {
        // ì´ë¯¸ ìˆìœ¼ë©´ ëª…ë‹¨ì—ì„œ ì œê±°
        list = list.filter(n => n !== targetName);
    } else {
        // ì—†ìœ¼ë©´ ëª…ë‹¨ì— ì¶”ê°€
        list.push(targetName);
    }
    
    db.ref('bowling_v14/events/' + id + '/attendees').set(list).then(() => {
        if(userName) alert(`âœ… ${targetName} ë‹˜ ì²˜ë¦¬ ì™„ë£Œ!`);
    });
};

    

    window.deleteMember = function(key) { if(confirm("ì‚­ì œ?")) db.ref('bowling_v14/members/' + key).remove(); };
    window.deleteAllData = function() { if(confirm("ì´ˆê¸°í™”?")) db.ref('bowling_v14').remove().then(() => location.reload()); };
    window.resetAttendance = function() { if(confirm("ì´ˆê¸°í™”?")) db.ref('bowling_v14/attendees').set([]); };
    window.closeModal = function() { document.getElementById('modalOverlay').style.display='none'; };
    window.showAttendeePopup = function() { document.getElementById('modalOverlay').style.display='flex'; document.getElementById('modalTitle').innerText = `ì°¸ì„ì (${attendees.length}ëª…)`; document.getElementById('modalContent').innerHTML = attendees.join(', '); };
    window.toggleMode = function() {
    
    const nextMode = settings.mode === 'regular' ? 'lightning' : 'regular';
    
    const nextGameCount = (nextMode === 'lightning') ? 6 : 4;

    db.ref('bowling_v14/settings').update({ 
        mode: nextMode, 
        gameCount: nextGameCount, 
        currentTab: 'groupPanel'
    }).then(() => {
        const modeName = nextMode === 'lightning' ? 'âš¡ë²ˆê°œ(6G)' : 'âš–ï¸ì •ê¸°(4G)';
        alert(`${modeName} ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    });
};
    window.resetAssignment = function() {
    const myName = (loggedInUser || "").trim();
    const isBoss = isAdmin || (managers.jungmo === myName) || (managers.lightning === myName);

    if (!isBoss) {
        return alert("ğŸš« ì´ˆê¸°í™” ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    }

    const gIdx = currentTargetGame; 
    if (confirm(`âš ï¸ [ì™„ì „ ì´ˆê¸°í™”] í˜„ì¬ [${gIdx}G]ì˜ íŒ€ ë°°ì • ê²°ê³¼ì™€\nì…ë ¥ëœ 'ë ˆì¸/íŒ€ ì„¤ì •'ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        
        let updates = {};
        // 1. ê²°ê³¼ ì‚­ì œ
        updates[`bowling_v14/gameTeams/${gIdx}`] = null;
        updates['bowling_v14/casino'] = null;
        updates['bowling_v14/managers/lightning'] = null;

        // 2. [í•µì‹¬ ìˆ˜ì •] ë ˆì¸ ì„¤ì •ê³¼ êµ¬ì—­ ì„ íƒë„ ì‚­ì œ
        updates['bowling_v14/laneSettings'] = null; 
        updates['bowling_v14/selectedBlocks'] = null; 

        db.ref().update(updates).then(() => {
            // ë¡œì»¬ ë³€ìˆ˜ë„ ì¦‰ì‹œ ë¹„ì›€ (í™”ë©´ ê°±ì‹ ìš©)
            if(gameTeams[gIdx]) delete gameTeams[gIdx];
            laneSettings = {};
            selectedBlocks = [];

            // êµ¬ì—­ ë²„íŠ¼ ìƒ‰ê¹” ë¹¼ê¸°
            document.querySelectorAll('.zone-btn').forEach(b => b.classList.remove('selected'));

            alert(`âœ… ${gIdx}G ë°°ì • ê²°ê³¼ì™€ ì„¤ì •ì´ ê¹¨ë—í•˜ê²Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // í™”ë©´ ì¦‰ì‹œ ê°±ì‹ 
            if(window.renderCustomLaneConfig) window.renderCustomLaneConfig();
            if(window.renderAssignGameTabs) window.renderAssignGameTabs();
            if(window.updateUI) window.updateUI(); 
        });
    }
};
    window.saveHistory = function() { if(!gameTeams[currentRankView]) return; const h = { date: new Date().toISOString().split('T')[0], game: currentRankView, teams: gameTeams[currentRankView] }; db.ref('bowling_v14/history').push(h).then(() => alert("ì €ì¥ë¨")); };
    
 window.viewHistory = function() { db.ref('bowling_v14/history').limitToLast(5).once('value', sn => { const val = sn.val(); if(!val) return alert("ê¸°ë¡ì—†ìŒ"); let msg = "ğŸ“œ ìµœê·¼ê¸°ë¡\n"; Object.values(val).reverse().forEach(h => msg += `[${h.date} ${h.game}G]\n`); alert(msg); }); };
    
window.exportData = function() {
    if(!confirm("í˜„ì¬ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    db.ref('bowling_v14').once('value', sn => {
        const data = sn.val();
        if(!data) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        const fileName = `AceBowling_Backup_${new Date().toISOString().split('T')[0]}.json`;
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert("âœ… ë°±ì—… íŒŒì¼(JSON)ì´ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
};

window.importData = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm("âš ï¸ ì£¼ì˜: ì´ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ í˜„ì¬ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ê³  íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.\nì •ë§ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        event.target.value = ''; 
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if(!importedData.members && !importedData.records) {
                throw new Error("ì˜¬ë°”ë¥¸ ì—ì´ìŠ¤ ë³¼ë§ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
            }

            db.ref('bowling_v14').set(importedData).then(() => {
                alert("ğŸ‰ ë°ì´í„° ë³µêµ¬ ì„±ê³µ! ì•±ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                location.reload();
            });
        } catch (err) {
            alert("âŒ JSON ì½ê¸° ì‹¤íŒ¨: íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.\n(ì—ëŸ¬ë‚´ìš©: " + err.message + ")");
        }
    };
    reader.readAsText(file);
};;
window.downloadExcel = function() {
    db.ref('bowling_v14/records').once('value', (snapshot) => {
        const records = snapshot.val();
        if (!records) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        const allDates = [...new Set(Object.values(records).map(r => r.date))].sort();
        const allNames = [...new Set(Object.values(records).map(r => r.name))].sort();

        const header1 = ["ì´ë¦„", "í‰ê· ", "í•©ê³„"];
        const header2 = ["", "", ""];
        
        allDates.forEach(date => {
            header1.push(date, "", "", ""); 
            header2.push("1G", "2G", "3G", "4G");
        });

        const excelRows = [header1, header2];

        allNames.forEach(name => {
            const row = [name];
            let totalSum = 0;
            let totalGames = 0;
            const scoreCells = [];

            allDates.forEach(date => {
                const key = `${date}_${name.replace(/[.#$/[\]]/g, "_")}`;
                const rec = records[key];
                
                if (rec && rec.scs) {
                    const scs = rec.scs;
                    scoreCells.push(scs[0] || "", scs[1] || "", scs[2] || "", scs[3] || "");
                    totalSum += scs.reduce((a, b) => a + (parseInt(b) || 0), 0);
                    totalGames += scs.length;
                } else {
                    scoreCells.push("", "", "", ""); 
                }
            });

            const avg = totalGames > 0 ? (totalSum / totalGames).toFixed(1) : 0;
            row.push(avg, totalSum, ...scoreCells);
            excelRows.push(row);
        });

        const worksheet = XLSX.utils.aoa_to_sheet(excelRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "ì „ì²´ê¸°ë¡");

        const dateStr = new Date().toISOString().split('T')[0];
        XLSX.writeFile(workbook, `ì—ì´ìŠ¤ë³¼ë§_ì¥ë¶€_${dateStr}.xlsx`);
    });
};
window.deleteToday = function() {
    if (confirm("âš ï¸ [ì£¼ì˜] ì˜¤ëŠ˜ ìƒì„±ëœ 1~6G ì¡°í¸ì„±ê³¼ ì ìˆ˜ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(íšŒì› ëª…ë‹¨ê³¼ ê°€ì¤‘ì¹˜ ì„¤ì •ì€ ì•ˆì „í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.)")) {
        
        const check = prompt("ì •ë§ ì‚­ì œí•˜ì‹œë ¤ë©´ 'ì‚­ì œ'ë¼ê³  ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        
        if (check === "ì‚­ì œ") {
            db.ref('bowling_v14/gameTeams').remove()
                .then(() => {
                    alert("âœ… ì˜¤ëŠ˜ì˜ ëª¨ë“  ê²Œì„ ê¸°ë¡(1~6G)ì´ ê¹”ë”í•˜ê²Œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload(); 
                })
                .catch(err => alert("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err));
        } else {
            alert("âŒ ì…ë ¥ì´ í‹€ë ¸ìŠµë‹ˆë‹¤. ì‚­ì œë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤.");
        }
    }
};

    window.deleteAllData = function() {
        if (confirm("ğŸš¨ [ê²½ê³ ] íšŒì› ëª…ë‹¨, ëª¨ë“  ê³¼ê±° ê¸°ë¡, ì„¤ì •ì´ í†µì§¸ë¡œ ë‚ ì•„ê°‘ë‹ˆë‹¤!")) {
            const check = prompt("ë°ì´í„°ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í•˜ë ¤ë©´ 'ì‚­ì œ'ë¼ê³  ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            if (check === "ì‚­ì œ") {
                db.ref('bowling_v14').remove()
                    .then(() => {
                        alert("ğŸ’¥ ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì„ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.");
                        location.reload();
                    })
                    .catch(err => alert("âŒ ì´ˆê¸°í™” ì˜¤ë¥˜: " + err));
            } else {
                alert("ì…ë ¥ì´ í‹€ë ¸ìŠµë‹ˆë‹¤. ì‚­ì œë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤.");
            }
        }
    };

    window.resetAttendance = function() {
        if (confirm("ğŸ”„ í˜„ì¬ ì°¸ì„ ì²´í¬ëœ ì¸ì›ë“¤ì„ ëª¨ë‘ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            db.ref('bowling_v14/attendees').set([])
                .then(() => {
                    alert("âœ… ì°¸ì„ ëª…ë‹¨ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    if(window.renderAttendanceList) window.renderAttendanceList();
                })
                .catch(err => alert("âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: " + err));
        }
    };

    
    window.uploadExcel = function() {
        alert("ì—‘ì…€ ì¼ê´„ ë“±ë¡ ê¸°ëŠ¥ì€ í˜„ì¬ ê°œë°œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
    };
window.getMyTier = function() {
    const myName = (loggedInUser || "").trim();
    if(!myName || !attendees.length) return null;
    
    const rankingList = attendees
        .filter(n => !n.includes("ê³ ìŠ¤íŠ¸")) 
        .map(name => {
            const stats = window.getWeightedStats(name);
            return { 
                name: name.trim(), 
                avg: parseFloat(stats.weightedAvg) || 0 
            };
        });

    rankingList.sort((a, b) => b.avg - a.avg);

    const myRank = rankingList.findIndex(player => player.name === myName);
    if(myRank === -1) return null;

    let teamList = [];
    for(let k in laneSettings) {
        if(k.startsWith('team_') && parseInt(laneSettings[k]) > 0) {
            teamList.push(parseInt(laneSettings[k]));
        }
    }
    
    const T = [...new Set(teamList)].length || (selectedBlocks.length * 2) || 2;

    if(myRank < T) return 'red';          
    if(myRank < T * 2) return 'blue';      
    if(myRank < T * 3) return 'green';     
    return 'yellow';                       
};

window.initCasino = function() {
    const myName = (loggedInUser || "").trim();
    if(!isAdmin && managers.jungmo !== myName) return alert("ğŸš« ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    if(!attendees || attendees.length === 0) return alert("ì°¸ì„ìë¥¼ ë¨¼ì € ì²´í¬í•´ì£¼ì„¸ìš”.");

    let teamPools = {}; 
    let totalSeatCount = 0;

    selectedBlocks.forEach(z => {
        const start = (z - 1) * 4 + 3;
        for(let l = start; l < start + 4; l++) {
            let count = parseInt(laneSettings['cnt_' + l]) || 0;
            let teamNum = parseInt(laneSettings['team_' + l]) || 0;
            
            if(count > 0 && teamNum > 0) {
                if(!teamPools[teamNum]) teamPools[teamNum] = [];
                for(let i = 0; i < count; i++) {
                    teamPools[teamNum].push(l); 
                    totalSeatCount++;
                }
            }
        }
    });

    const uniqueTeamNos = Object.keys(teamPools).sort((a,b) => a-b);
    const T = uniqueTeamNos.length; 

    if(T === 0) return alert("ğŸš© ì¡°í¸ì„± í•˜ë‹¨ì— 'íŒ€ ë²ˆí˜¸'ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤! (ì˜ˆ: 1, 2)");

    let casinoState = { settings: { status: 'open', totalSlots: totalSeatCount }, red: {}, blue: {}, green: {}, yellow: {} };
    const tiers = ['red', 'blue', 'green', 'yellow'];

    uniqueTeamNos.forEach(tNo => teamPools[tNo].sort(() => Math.random() - 0.5));

    for(let round = 0; round < 4; round++) {
        const currentTier = tiers[round];
        let tierLanes = []; 

        uniqueTeamNos.forEach((tNo) => {
            if(teamPools[tNo] && teamPools[tNo].length > 0) {
                tierLanes.push(teamPools[tNo].shift());
            }
        });

        tierLanes.sort(() => Math.random() - 0.5);

        tierLanes.forEach((laneNum, idx) => {
            casinoState[currentTier][idx + 1] = {
                status: 'idle',
                owner: '',
                lane: laneNum
            };
        });
    }

    db.ref('bowling_v14/casino').set(casinoState).then(() => {
        alert(`ğŸ° ë“±ê¸‰ë³„ ì¹© ìƒì„± ì™„ë£Œ! (ì´ ${T}ê°œ íŒ€ ê¸°ì¤€)`);
    });
};
window.renderCasino = function() {
    db.ref('bowling_v14/casino').once('value', sn => {
        const data = sn.val() || {};
        ['red', 'blue', 'green', 'yellow'].forEach(tier => {
            const container = document.getElementById('chips_' + tier);
            const zone = document.getElementById('zone_' + tier);
            if (!container) return;

            const chips = data[tier] || {};
            const chipKeys = Object.keys(chips);

            if (zone) zone.style.display = (chipKeys.length > 0) ? 'block' : 'none';
            container.innerHTML = ''; 

            chipKeys.forEach(id => {
                const c = chips[id];
                const isPicked = c.status === 'picked';
                
                const div = document.createElement('div');
                div.className = `chip ${tier} ${isPicked ? 'selected' : ''}`;
                div.onclick = () => { if(!isPicked) window.pickChip(tier, id); };
                
                div.innerHTML = `
                    <div class="chip-inner">
                        <div class="chip-num" style="font-size: 1.3rem; font-weight: 900; color: #333;">
                            ${isPicked ? c.lane + 'L' : ''} 
                        </div>
                        <div class="chip-owner" style="color:var(--danger); font-size:11px; font-weight:bold; margin-top:2px;">
                            ${isPicked ? c.owner : ''}
                        </div>
                    </div>`;
                container.appendChild(div);
            });
        });
    });
};
window.pickChip = function(tier, id) {
    const myTier = window.getMyTier(); 
    const myName = (loggedInUser || "").trim();
    const isBoss = isAdmin || (managers.jungmo === myName) || (managers.lightning === myName);

    db.ref('bowling_v14/casino').once('value', sn => {
        const data = sn.val() || {};
        
        if (!isBoss) {
            if (!myTier) return alert("ğŸš« ì°¸ì„ ëª…ë‹¨ì— ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.");
            if (tier !== myTier) return alert(`âš–ï¸ íšŒì›ë‹˜ì€ [${myTier.toUpperCase()}] ë“±ê¸‰ ì¹©ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        }

        let alreadyPicked = false;
        ['red', 'blue', 'green', 'yellow', 'purple'].forEach(t => {
            if(data[t]) {
                Object.values(data[t]).forEach(c => {
                    if(c.owner === myName) alreadyPicked = true;
                });
            }
        });

        if(alreadyPicked) return alert("ğŸš« ì´ë¯¸ ì¹©ì„ ë½‘ìœ¼ì…¨ìŠµë‹ˆë‹¤!");

        const chipRef = db.ref(`bowling_v14/casino/${tier}/${id}`);
        chipRef.transaction(current => {
            if(current && current.status === 'idle') {
                return { ...current, status: 'picked', owner: myName };
            }
            return;
        }, (err, committed) => {
            if(!committed) alert("âš ï¸ ì´ë¯¸ ë‹¤ë¥¸ ë¶„ì´ ì„ íƒí–ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }); 
}; 

window.finishCasino = function() {
    const myName = (loggedInUser || "").trim();
    const isBoss = isAdmin || (managers.jungmo === myName) || (managers.lightning === myName);
    if (!isBoss) return alert("ğŸš« ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

    if (!confirm("ë°°ì •ì„ ì¢…ë£Œí•˜ê³  ì§„í–‰ í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?")) return;

    db.ref('bowling_v14/casino').once('value', sn => {
        const data = sn.val() || {};
        if (!data) return;

        let pickedOwners = [];
        ['red', 'blue', 'green', 'yellow', 'purple'].forEach(t => {
            if(data[t]) {
                Object.values(data[t]).forEach(c => {
                    if(c.status === 'picked') pickedOwners.push(c.owner);
                });
            }
        });

        let unpickedPeople = attendees.filter(name => !pickedOwners.includes(name));
        let finalTeamsMap = {}; 
        
        ['red', 'blue', 'green', 'yellow', 'purple'].forEach(tier => {
            if(!data[tier]) return;
            Object.values(data[tier]).forEach(c => {
                const teamNum = parseInt(laneSettings['team_' + c.lane]);
                if(!teamNum) return;
                
                if(!finalTeamsMap[teamNum]) {
                    finalTeamsMap[teamNum] = { teamNo: teamNum, members: [], totalAvg: 0, matchHandy: 0 };
                }

                let isPicked = (c.status === 'picked');
                let memberName = isPicked ? c.owner : (unpickedPeople.length > 0 ? unpickedPeople.shift() : "ğŸ‘»ê³ ìŠ¤íŠ¸");
                
                let stats = window.getWeightedStats(memberName);
                let mInfo = members.find(x => x.name === memberName.trim()) || { handicap: 0 };
                let weightedAvg = memberName.includes("ê³ ìŠ¤íŠ¸") ? 0 : stats.weightedAvg;

                finalTeamsMap[teamNum].members.push({
                    name: memberName,
                    lane: c.lane,
                    avg: weightedAvg,
                    handy: parseInt(mInfo.handicap) || 0,
                    score: 0,
                    isGhost: memberName.includes("ê³ ìŠ¤íŠ¸")
                });
                finalTeamsMap[teamNum].totalAvg += weightedAvg;
            });
        });

        const teamArr = Object.values(finalTeamsMap).sort((a,b) => a.teamNo - b.teamNo);
        const maxAvg = Math.max(...teamArr.map(t => t.totalAvg)); 
        teamArr.forEach(t => {
            t.matchHandy = (t.totalAvg < maxAvg) ? Math.round(maxAvg - t.totalAvg) : 0;
        });
              
        db.ref(`bowling_v14/gameTeams/${currentTargetGame}`).set(teamArr).then(() => {
            db.ref('bowling_v14/settings').update({
                currentTab: 'progressPanel',
                currentRankView: currentTargetGame,
                currentInputGame: currentTargetGame
            });
            alert(`âœ… ${currentTargetGame}G ë°°ì • ì™„ë£Œ!`);
            db.ref('bowling_v14/casino').set(null);
        });
    }); 
}; 

window.nextCnt = function(lane, current) {
    let next = 0;
    if (current === 0) next = 2;
    else if (current === 2) next = 3;
    else if (current === 3) next = 4;
    else next = 0;
    
    window.updateConfig('cnt_' + lane, next);
};

window.nextTeam = function(lane, current) {
    let next = (current >= 8) ? 0 : current + 1;
    window.updateConfig('team_' + lane, next);
};
    const now = new Date();
const offset = now.getTimezoneOffset() * 60000;
const finalToday = new Date(now.getTime() - offset).toISOString().split('T')[0];
    if(document.getElementById('progDate')) document.getElementById('progDate').value = finalToday;
    if(document.getElementById('inputDate')) document.getElementById('inputDate').value = finalToday;

(function() {
    const el = document.getElementById('excelInput');
    if (!el) return;

    el.onclick = function() { this.value = null; };

    el.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        alert("ğŸ“Š íŒŒì¼ì„ ì½ê³  ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...");

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (rows.length < 2) return alert("âŒ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");

                const headers = rows[0];
                const dataRows = rows.slice(1);
                
                let lastDate = "";
                const dateMap = headers.map((h, i) => {
                    if (i < 3) return null; 
                    if (h) {
                        let d = h.toString().split('.')[0].trim();
                        if(d.length === 8) d = `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`;
                        lastDate = d;
                    }
                    return lastDate;
                });

                let promises = []; 
                let memCnt = 0;

                dataRows.forEach((row) => {
                    const name = (row[2] || "").toString().trim();
                    if (!name || name === "ì´ë¦„") return;

                    if (!members.some(m => m.name === name)) {
                        promises.push(db.ref('bowling_v14/members').push({ name, gender: 'ë‚¨', handicap: 0, pw: '1234' }));
                        memCnt++;
                    }

                    let dayScores = {};
                    dateMap.forEach((date, idx) => {
                        if (!date) return;
                        const s = parseInt(row[idx]);
                        if (!isNaN(s) && s > 0) {
                            if (!dayScores[date]) dayScores[date] = [];
                            dayScores[date].push(s);
                        }
                    });

                    Object.keys(dayScores).forEach(date => {
                        const key = `${date}_${name.replace(/[.#$/[\]]/g, "_")}`;
                        promises.push(db.ref(`bowling_v14/records/${key}`).set({ 
                            date: date, name: name, scs: dayScores[date] 
                        }));
                    });
                });

                Promise.all(promises).then(() => {
                    alert(`âœ… ì—…ë¡œë“œ ì™„ë£Œ!\n- ì‹ ê·œ ë“±ë¡: ${memCnt}ëª…\n- ì´ ${promises.length}ê±´ì˜ ê¸°ë¡ì´ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();
                }).catch(err => {
                    alert("âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
                });

            } catch (err) {
                alert("âŒ ì—‘ì…€ íŒë… ì—ëŸ¬: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    };
})();

window.updateMember = function(key, name, currentHandy, currentGender) {
    const newGender = prompt(`${name}ë‹˜ì˜ ì„±ë³„ì„ ì…ë ¥í•˜ì„¸ìš” (ë‚¨/ì—¬):`, currentGender || 'ë‚¨');
    if (newGender === null) return;

    const newHandy = prompt(`${name}ë‹˜ì˜ ìƒˆë¡œìš´ í•¸ë””ìº¡ì„ ì…ë ¥í•˜ì„¸ìš”:`, currentHandy);
    if (newHandy === null) return;

    db.ref('bowling_v14/members/' + key).update({ 
        gender: newGender, 
        handicap: parseInt(newHandy) || 0 
    }).then(() => alert("âœ… ì •ë³´ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
};

window.updatePw = function(key, name, currentPw) {
    const newPw = prompt(`${name}ë‹˜ì˜ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, currentPw);
    if (newPw) {
        db.ref('bowling_v14/members/' + key).update({ pw: newPw })
          .then(() => alert("âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."));
    }
};

window.deleteMember = function(key, name) {
    if(confirm(`ğŸš¨ [${name}] íšŒì›ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ê¸°ë¡ì´ ì‚¬ë¼ì§€ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        db.ref('bowling_v14/members/' + key).remove()
          .then(() => alert("ğŸ—‘ï¸ ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
    }
};

window.renderMembers = function() { 
    const area = document.getElementById('memberListArea'); 
    if(!area) return; 

    if(!members || members.length === 0) {
        area.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">íšŒì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
        return;
    }

    area.innerHTML = members.sort((a,b)=>a.name.localeCompare(b.name)).map(m => `
        <div class="member-row" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <div style="display:flex; flex-direction:column;">
                <b style="font-size:1.2rem; color:#333;">${m.name}</b>
                <span style="font-size:0.9rem; color:#666;">
                    ${m.gender || 'ë‚¨'} / <span style="color:var(--purple); font-weight:bold;">H:${m.handicap || 0}</span>
                </span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-sm" style="background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:5px;" 
                    onclick="window.updateMember('${m.key}', '${m.name}', ${m.handicap}, '${m.gender||'ë‚¨'}')">ìˆ˜ì •</button>
                
                <button class="btn-sm" style="background:var(--warning); color:white; border:none; padding:8px 12px; border-radius:5px;" 
                    onclick="window.updatePw('${m.key}', '${m.name}', '${m.pw||'1234'}')">ë¹„ë²ˆ</button>
                
                <button class="btn-sm" style="background:var(--danger); color:white; border:none; padding:8px 12px; border-radius:5px;" 
                    onclick="window.deleteMember('${m.key}', '${m.name}')">ì‚­ì œ</button>
            </div>
        </div>
    `).join(''); 
};
// =========================================================
// 1. [ë³µêµ¬] ì •ê¸° ëª¨ì„ ì €ì¥ í•¨ìˆ˜ (ì´ê²Œ ê¹¨ì ¸ ìˆì—ˆìŠµë‹ˆë‹¤)
// =========================================================


// =========================================================
// 2. [ì‹ ê·œ] ë²ˆê°œ íˆìŠ¤í† ë¦¬ ê¸°ëŠ¥ (ì €ì¥/ê°ì§€/ë¶ˆëŸ¬ì˜¤ê¸° í†µí•©)
// =========================================================

// =========================================================
// ğŸŸ¡ [ìµœì¢… ìˆ˜ì •] ë²ˆê°œ íˆìŠ¤í† ë¦¬ (ê¸°ì–µë ¥ ê°•í™” ë²„ì „)
// =========================================================

// ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„°ë¥¼ ë‹´ì•„ë‘¡ë‹ˆë‹¤ (ì´ê²Œ ê¸°ì–µë ¥ì˜ í•µì‹¬!)
window.lightningHistoryCache = null;

// =========================================================
// ğŸŸ¡ [ìµœì¢… ì •ë°€ ìˆ˜ì •] ë²ˆê°œ íˆìŠ¤í† ë¦¬ ê¸°ëŠ¥ (ì €ì¥ ë° ì‹¤ì‹œê°„ í‘œì‹œ)
// =========================================================

// 1. ë°ì´í„°ë¥¼ ë‹´ì•„ë‘˜ ì „ì—­ ì£¼ë¨¸ë‹ˆ (íŒŒì¼ ìµœìƒë‹¨ì´ ì•„ë‹ˆì–´ë„ ì‘ë™í•˜ë„ë¡ ì—¬ê¸°ì— ë°°ì¹˜)
window.lightningHistoryCache = null;

// 2. ë²ˆê°œ ê¸°ë¡ ì €ì¥ í•¨ìˆ˜
window.saveLightningHistory = function() {
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const today = new Date(now.getTime() - offset).toISOString().split('T')[0];

    if(!confirm(`${today} ë²ˆê°œ ê¸°ë¡ì„ íˆìŠ¤í† ë¦¬ì— ë³´ê´€í• ê¹Œìš”?\n(ê°œì¸ ì—ë²„ì—ëŠ” ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)`)) return;

    // í˜„ì¬ í™”ë©´ì— ìˆëŠ” íŒ€/ì ìˆ˜ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ì„œë²„ì— ë³´ëƒ…ë‹ˆë‹¤.
    db.ref('bowling_v14/lightning_history/' + today).set({
        date: today,
        gameTeams: gameTeams, // ì „ì—­ ë³€ìˆ˜ gameTeams ì‚¬ìš©
        settings: settings || {} 
    }).then(() => {
        alert("ğŸ¯ ë²ˆê°œ íˆìŠ¤í† ë¦¬ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        // ì €ì¥ì´ ì™„ë£Œë˜ë©´ ì„œë²„ ê°ì‹œì(Listener)ê°€ ì•Œì•„ì„œ ë²„íŠ¼ì„ ìƒˆë¡œ ê·¸ë¦½ë‹ˆë‹¤.
    }).catch(err => {
        alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + err.message);
    });
};

// 3. [í•µì‹¬] ì‹¤ì‹œê°„ ê°ì‹œì (ì„œë²„ì— ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ë©´ ì¦‰ì‹œ ì£¼ë¨¸ë‹ˆì— ë„£ê³  ë²„íŠ¼ ê·¸ë¦¬ê¸°)
db.ref('bowling_v14/lightning_history').on('value', sn => {
    const data = sn.val();
    window.lightningHistoryCache = data || {}; // ì£¼ë¨¸ë‹ˆì— ì €ì¥
    
    // ë§Œì•½ í˜„ì¬ í†µê³„ í˜ì´ì§€ë¥¼ ë³´ê³  ìˆë‹¤ë©´ ë²„íŠ¼ì„ ì¦‰ì‹œ ê·¸ë ¤ì¤ë‹ˆë‹¤.
    if(typeof window.renderLightningHistoryButtons === 'function') {
        window.renderLightningHistoryButtons();
    }
});

// 4. ë‚ ì§œ ë²„íŠ¼ ëª©ë¡ ê·¸ë¦¬ê¸° (í†µê³„ íƒ­ ì—´ ë•Œ í˜¸ì¶œë¨)
window.renderLightningHistoryButtons = function() {
    const btnArea = document.getElementById('lightningDateButtons');
    if(!btnArea) return; // ë²„íŠ¼ ë„£ì„ ìë¦¬ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨

    const data = window.lightningHistoryCache;
    if(!data) {
        btnArea.innerHTML = '<span style="font-size:0.8rem; color:#ccc; padding:5px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>';
        return;
    }

    const dates = Object.keys(data).sort().reverse().slice(0, 4); // ìµœì‹ ìˆœ 4ê°œ

    if(dates.length === 0) {
        btnArea.innerHTML = '<span style="font-size:0.8rem; color:#ccc; padding:5px;">ğŸ“­ ê¸°ë¡ ì—†ìŒ</span>';
        return;
    }

    btnArea.innerHTML = dates.map(date => {
        const shortDate = date.split('-').slice(1).join('/');
        return `
            <button class="filter-btn" 
                style="padding:6px 14px; font-size:0.8rem; flex-shrink:0; margin-right:5px; background:#fcc419; color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1);" 
                onclick="window.loadLightningHistory('${date}')">
                ğŸ“‚ ${shortDate}
            </button>`;
    }).join('');
};

// 5. ê³¼ê±° ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ë²„íŠ¼ í´ë¦­ ì‹œ)
window.loadLightningHistory = function(date) {
    const historyData = window.lightningHistoryCache ? window.lightningHistoryCache[date] : null;
    
    if(!historyData || !historyData.gameTeams) {
        return alert("âš ï¸ í•´ë‹¹ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    if(!confirm(`ğŸ“‚ [${date}] ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ í™”ë©´ì˜ ì ìˆ˜ëŠ” ì‚¬ë¼ì§€ê³  ê³¼ê±° ê¸°ë¡ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.`)) return;

    // ë°ì´í„° êµì²´
    gameTeams = historyData.gameTeams;
    if(historyData.settings) settings = historyData.settings;

    alert(`âœ… ${date} ê¸°ë¡ ë³µì› ì™„ë£Œ!`);

    // í™”ë©´ ìƒˆë¡œê³ ì¹¨ (í†µê³„ íƒ­ ë‚´ìš© ê°±ì‹ )
    if(typeof window.renderAllStats === 'function') window.renderAllStats();
    
    // í†µê³„ íƒ­ìœ¼ë¡œ ê°•ì œ ì´ë™
    const tabBtns = document.querySelectorAll('.tab-btn');
    if(tabBtns[5]) window.showPanel('statsPanel', tabBtns[5]); 
};
/* ==========================================================================
   ğŸš€ [ì…ë ¥ ìµœì í™” íŒ¨ì¹˜] ì ìˆ˜ ì…ë ¥ ì‹œ ëŠê¹€ ë° ë°ì´í„° ì¦ë°œ ë°©ì§€ ì‹œìŠ¤í…œ
   ========================================================================== */

// 1. ì…ë ¥ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ì „ì—­ ë³€ìˆ˜ (ë°©ì–´ë§‰)
window.isScoreEditing = false;

// 2. ê¸°ì¡´ì˜ ë©ì²­í•œ ê°ì‹œìë¥¼ ë„ê³ , ë˜‘ë˜‘í•œ ê°ì‹œìë¡œ êµì²´í•©ë‹ˆë‹¤.
// (ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆê°€ ì¤‘ë³µ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ë¨¼ì € ì—°ê²°ì„ ëŠìŠµë‹ˆë‹¤)
if (db) {
    db.ref('bowling_v14').off(); 

    db.ref('bowling_v14').on('value', sn => {
        const val = sn.val() || {};

        // [í•µì‹¬] ì…ë ¥ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤! (ì ìˆ˜ ì‚¬ë¼ì§ ë°©ì§€)
        if (!window.isScoreEditing) {
            gameTeams = val.gameTeams || {};
        } else {
            console.log("ğŸ›¡ï¸ ì…ë ¥ ì¤‘ì´ë¯€ë¡œ ì„œë²„ ë°ì´í„° ë®ì–´ì“°ê¸°ë¥¼ ë°©ì–´í–ˆìŠµë‹ˆë‹¤.");
        }
        
        // ë‚˜ë¨¸ì§€ ë°ì´í„°ëŠ” ì •ìƒì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        members = val.members ? Object.keys(val.members).map(k => ({ ...val.members[k], key: k })) : [];
        attendees = val.attendees || [];
        records = val.records ? Object.keys(val.records).map(k => ({ ...val.records[k], key: k })) : [];
        if(val.settings) settings = val.settings;
        if(val.managers) managers = val.managers;
        if(val.laneSettings) laneSettings = val.laneSettings;
        if(val.selectedBlocks) selectedBlocks = val.selectedBlocks;
        events = val.events || {};

        if (!window.initialLoadDone) {
            window.currentTargetGame = 1;
            window.initialLoadDone = true;
        }

        // ì…ë ¥ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ í™”ë©´ì„ ìƒˆë¡œ ê·¸ë¦½ë‹ˆë‹¤ (ë ‰ ë°©ì§€)
        if (typeof window.updateUI === 'function' && !window.isScoreEditing) {
            window.updateUI();
        }
    });
}

// 3. ì…ë ¥ì°½ ê·¸ë¦¬ê¸° í•¨ìˆ˜ ì—…ê·¸ë ˆì´ë“œ (í¬ì»¤ìŠ¤ ê°ì§€ ê¸°ëŠ¥ ì¶”ê°€)
window.renderInputs = function() {
    // ì…ë ¥ ì¤‘ í™”ë©´ í”ë“¤ë¦¼ ë°©ì§€
    if (window.isScoreEditing) return; 

    const tabs = document.getElementById('inputTabs');
    let tHtml = ''; 
    for(let i=1; i<=settings.gameCount; i++) {
        tHtml += `<div class="rank-tab ${currentInputGame===i?'active':''}" onclick="currentInputGame=${i};window.renderInputs()">${i}G</div>`;
    }
    tabs.innerHTML = tHtml;
    document.getElementById('inputGameTitle').innerText = `${currentInputGame}G`;
    
    let gData = gameTeams[currentInputGame] || [];
    if(currentInputTeam) {
        gData = gData.filter(t => t.teamNo == currentInputTeam);
        document.getElementById('filterInfo').style.display = 'block';
        document.getElementById('filterTeamName').innerText = `Team ${currentInputTeam}`;
    } else {
        document.getElementById('filterInfo').style.display = 'none';
    }

    const area = document.getElementById('inputGridArea');
    if (!gData || gData.length === 0) {
        area.innerHTML = '<div style="padding:40px; text-align:center; color:#999; border:2px dashed #ddd; border-radius:10px;">âš ï¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let h = '';
    gData.forEach(t => {
        h += `<div class="input-team-box"><div class="input-team-header">Team ${t.teamNo}</div>`;
        t.members.forEach(m => {
            const isG = m.name.includes("ê³ ìŠ¤íŠ¸") || m.isGhost;
            // â˜…í•µì‹¬ ìˆ˜ì •: div(ì¤„ ì „ì²´)ë¥¼ í´ë¦­í•˜ë©´ -> ë‚´ë¶€ì˜ inputì„ ì°¾ì•„ì„œ ê°•ì œë¡œ í¬ì»¤ìŠ¤(focus)ë¥¼ ì¤ë‹ˆë‹¤.
            // ì´ì œ ì´ë¦„ì„ ëˆ„ë¥´ê±°ë‚˜ ì˜†ì— ë¹ˆ ê³µê°„ì„ ëˆŒëŸ¬ë„ ìíŒì´ ë‚´ë ¤ê°€ì§€ ì•ŠìŠµë‹ˆë‹¤.
            h += `<div class="score-row" onclick="const inp = this.querySelector('input'); if(inp) inp.focus();">
                <span class="score-name">${m.name}</span>
                <input type="number" 
                       inputmode="numeric" 
                       pattern="[0-9]*" 
                       class="score-input" 
                       value="${m.score||0}" 
                       ${isG ? 'readonly style="background:#f1f3f5; color:#777;"' : ''}
                       onclick="event.stopPropagation();" 
                       onfocus="window.isScoreEditing=true; if(this.value=='0') this.value='';" 
                       onblur="window.isScoreEditing=false; window.silentSave();" 
                       oninput="if(this.value.length > 3) this.value = this.value.slice(0, 3); if(this.value > 300) this.value = 300; window.updateScore('${m.name}', this.value)">
            </div>`;
        });
        h += `</div>`;
    });
    area.innerHTML = h;
};

// 4. [ë³´ë„ˆìŠ¤] ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹œ ë¶ˆí•„ìš”í•œ ì—°ì‚° ìµœì†Œí™”
window.updateScore = function(n, v) { 
    // ë¡œì»¬ ë°ì´í„°ë§Œ ë¹ ë¥´ê²Œ ë°”ê¿‰ë‹ˆë‹¤. (ì„œë²„ ì „ì†¡ X -> onblurì—ì„œ ì €ì¥)
    const teams = gameTeams[currentInputGame] || [];
    for(let t of teams) {
        for(let m of t.members) {
            if(m.name === n) {
                m.score = parseInt(v) || 0;
                return; // ì°¾ì•˜ìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ (ì†ë„ í–¥ìƒ)
            }
        }
    }
};
window.regularHistoryCache = null;

// ì‹¤ì‹œê°„ ê°ì‹œì
db.ref('bowling_v14/regular_history').on('value', sn => {
    window.regularHistoryCache = sn.val() || {};
    if(typeof window.renderRegularHistoryButtons === 'function') window.renderRegularHistoryButtons();
});

// ì •ëª¨ íˆìŠ¤í† ë¦¬ ë²„íŠ¼ ê·¸ë¦¬ê¸°
window.renderRegularHistoryButtons = function() {
    const btnArea = document.getElementById('regularDateButtons');
    if(!btnArea || !window.regularHistoryCache) return;

    const dates = Object.keys(window.regularHistoryCache).sort().reverse().slice(0, 4);
    if(dates.length === 0) {
        btnArea.innerHTML = '<span style="font-size:0.8rem; color:#ccc;">ğŸ“­ ê¸°ë¡ ì—†ìŒ</span>';
        return;
    }

    btnArea.innerHTML = dates.map(date => {
        const shortDate = date.split('-').slice(1).join('/');
        return `
            <button class="filter-btn" 
                style="padding:6px 14px; font-size:0.8rem; flex-shrink:0; background:#fa5252; color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer;" 
                onclick="window.loadRegularHistory('${date}')">
                ğŸ† ${shortDate}
            </button>`;
    }).join('');
};

// ì •ëª¨ íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
window.loadRegularHistory = function(date) {
    const historyData = window.regularHistoryCache ? window.regularHistoryCache[date] : null;
    if(!historyData || !historyData.gameTeams) return alert("âš ï¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    if(!confirm(`ğŸ† [${date}] ì •ê¸°ëª¨ì„ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ í™”ë©´ì˜ ì ìˆ˜ê°€ ê³¼ê±° ê¸°ë¡ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.`)) return;

    gameTeams = historyData.gameTeams;
    if(historyData.settings) settings = historyData.settings;
    alert(`âœ… ${date} ì •ê¸°ëª¨ì„ ê¸°ë¡ ë³µì› ì™„ë£Œ!`);
    window.renderAllStats();
};
/* ===============================================================
   [ëˆ„ë½ëœ ë¶€í’ˆ ì¶”ê°€] ì •ê¸°ëª¨ì„ íˆìŠ¤í† ë¦¬ ì €ì¥ ë° í™”ë©´ í‘œì‹œ ê¸°ëŠ¥
   =============================================================== */

// 1. [ì €ì¥] ì •ëª¨ ì ìˆ˜ ì €ì¥ ì‹œ 'íˆìŠ¤í† ë¦¬'ë„ í•¨ê»˜ ë°±ì—…í•˜ëŠ” ìµœì‹  ë²„ì „
window.finalizeToRecords = function() {
    if(!confirm("ì˜¤ëŠ˜ì˜ ëª¨ë“  ê²Œì„ ì ìˆ˜ë¥¼ ê°œì¸ ì¥ë¶€ì— ì˜êµ¬ ì €ì¥í•˜ê³ ,\nì˜¤ëŠ˜ì˜ íŒ€ êµ¬ì„±(ì •ëª¨ íˆìŠ¤í† ë¦¬)ë„ í•¨ê»˜ ë³´ê´€í• ê¹Œìš”?")) return;

    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const today = new Date(now.getTime() - offset).toISOString().split('T')[0];
    
    let updates = {};
    let saveCount = 0;
    let memberScores = {};

    // 1~4G(í˜¹ì€ 6G) ì ìˆ˜ ì·¨í•©
    for (let g = 1; g <= settings.gameCount; g++) {
        const teams = gameTeams[g] || [];
        teams.forEach(t => {
            t.members.forEach(m => {
                if (m.name.includes("ê³ ìŠ¤íŠ¸") || m.isGhost) return;
                if (!memberScores[m.name]) memberScores[m.name] = [];
                memberScores[m.name].push(parseInt(m.score) || 0);
            });
        });
    }

    // ì¥ë¶€ ê¸°ë¡ ìƒì„±
    Object.keys(memberScores).forEach(name => {
        const scs = memberScores[name];
        if (scs.some(s => s > 0)) {
            const safeKey = `${today}_${name.replace(/[.#$/[\]]/g, "_")}`;
            updates[`bowling_v14/records/${safeKey}`] = {
                date: today, name: name, scs: scs
            };
            saveCount++;
        }
    });

    if (saveCount === 0) return alert("ì €ì¥í•  ì ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

    // ğŸ¯ [í•µì‹¬] ì •ê¸°ëª¨ì„ ìŠ¤ëƒ…ìƒ· ì €ì¥ (ì´ ë¶€ë¶„ì´ ìˆì–´ì•¼ ê³¼ê±° ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!)
    updates[`bowling_v14/regular_history/${today}`] = {
        date: today,
        gameTeams: gameTeams,
        settings: settings
    };

    db.ref().update(updates).then(() => {
        alert(`ğŸ‰ ì„±ê³µ! ${saveCount}ëª…ì˜ ê¸°ë¡ ì €ì¥ ë° ì •ëª¨ íˆìŠ¤í† ë¦¬ ë³´ê´€ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        location.reload(); 
    }).catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err));
};

// 2. [í™”ë©´] í†µê³„ í˜ì´ì§€ì— 'ì •ëª¨ ê¸°ë¡(ë¹¨ê°•)'ê³¼ 'ë²ˆê°œ ê¸°ë¡(ë…¸ë‘)' ë²„íŠ¼ì„ ê°™ì´ ë³´ì—¬ì£¼ëŠ” ìµœì‹  ë²„ì „
window.renderAllStats = function() {
    if(typeof window.renderHistoricalStats === 'function') window.renderHistoricalStats();
    if(typeof window.renderStatsGameTabs === 'function') window.renderStatsGameTabs();
    if(typeof window.renderCurrentGameStats === 'function') window.renderCurrentGameStats(); 

    const panel = document.getElementById('statsPanel');
    if(!panel) return;

    // ê¸°ì¡´ íˆìŠ¤í† ë¦¬ ì˜ì—­ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
    const oldNav = document.getElementById('historyNavContainer');
    if(oldNav) oldNav.remove();
    const oldLight = document.getElementById('lightningHistoryNav'); // êµ¬í˜• ì”ì¬ ì œê±°
    if(oldLight) oldLight.remove();

    const navDiv = document.createElement('div');
    navDiv.id = 'historyNavContainer';
    
    navDiv.style.cssText = "margin-bottom:20px; padding:15px; background:#f8f9fa; border-radius:12px; border:1px solid #eee;";
    navDiv.innerHTML = `
        <div style="margin-bottom:12px;">
            <div style="font-size:0.8rem; color:#e03131; font-weight:bold; margin-bottom:5px;">ğŸ“… ìµœê·¼ ì •ê¸°ëª¨ì„ ê¸°ë¡</div>
            <div id="regularDateButtons" style="display:flex; gap:8px; overflow-x:auto; padding-bottom:5px;">
                 <span style="font-size:0.8rem; color:#ccc;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        </div>
        <div>
            <div style="font-size:0.8rem; color:#fab005; font-weight:bold; margin-bottom:5px;">âš¡ ìµœê·¼ ë²ˆê°œ ê¸°ë¡</div>
            <div id="lightningDateButtons" style="display:flex; gap:8px; overflow-x:auto; padding-bottom:5px;">
                 <span style="font-size:0.8rem; color:#ccc;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        </div>
    `;
    panel.prepend(navDiv);

    // ë²„íŠ¼ ê·¸ë¦¬ê¸° ì‹¤í–‰
    if(typeof window.renderRegularHistoryButtons === 'function') window.renderRegularHistoryButtons();
    if(typeof window.renderLightningHistoryButtons === 'function') window.renderLightningHistoryButtons();

    // í•˜ë‹¨ ì €ì¥ ë²„íŠ¼ êµ¬ì—­ (ê´€ë¦¬ì ì „ìš©)
    const totalRankArea = document.getElementById('todayTotalRankTable');
    if(totalRankArea && isAdmin) {
        const oldFinalize = document.getElementById('finalizeBtnArea');
        if(oldFinalize) oldFinalize.remove();
        const oldLightning = document.getElementById('lightningSaveArea');
        if(oldLightning) oldLightning.remove();

        const btnDiv = document.createElement('div');
        btnDiv.style.margin = "30px 0 10px 0";
        
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ë²„íŠ¼ ë‹¤ë¥´ê²Œ í‘œì‹œ
        if (settings.mode === 'regular') {
            btnDiv.id = 'finalizeBtnArea';
            btnDiv.innerHTML = `
                <div style="background:#fff5f5; border:2px solid #ff8787; padding:15px; border-radius:12px; text-align:center;">
                    <p style="margin:0 0 12px 0; font-weight:bold; color:#e03131;">ğŸ“… ì˜¤ëŠ˜ ì •ëª¨ ì„±ì ì„ ìµœì¢… ì €ì¥í• ê¹Œìš”?</p>
                    <button class="universal-btn" style="background:#e03131; margin-bottom:0;" onclick="window.finalizeToRecords()">ğŸ“¥ ì •ëª¨ ìµœì¢… ì €ì¥ (ì—ë²„ ë°˜ì˜ + íˆìŠ¤í† ë¦¬ ë³´ê´€)</button>
                </div>`;
        } else {
            btnDiv.id = 'lightningSaveArea';
            btnDiv.innerHTML = `
                <div style="background:#fff9db; border:2px solid #fab005; padding:15px; border-radius:12px; text-align:center;">
                    <p style="margin:0 0 12px 0; font-weight:bold; color:#856404;">âš¡ ì˜¤ëŠ˜ ë²ˆê°œ ê¸°ë¡ì„ íˆìŠ¤í† ë¦¬ì— ë³´ê´€í• ê¹Œìš”?</p>
                    <button class="universal-btn" style="background:#fab005; color:#000; margin-bottom:0;" onclick="window.saveLightningHistory()">ğŸ“¥ ë²ˆê°œ ê¸°ë¡ ë³´ê´€ (ì—ë²„ ë¯¸ë°˜ì˜)</button>
                </div>`;
        }
        totalRankArea.parentNode.insertBefore(btnDiv, totalRankArea);
    }
};
// 1. [ì‹ ê·œ] ì¡°ìš©íˆ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (ì…ë ¥ì°½ ì´ë™í•  ë•Œ ì”€)
window.silentSave = function() {
    // ì•Œë¦¼ì°½(Alert) ì—†ì´ ë°ì´í„°ë§Œ ì¡°ìš©íˆ ì„œë²„ì— ë³´ëƒ…ë‹ˆë‹¤.
    db.ref('bowling_v14/gameTeams').set(gameTeams).then(() => {
        console.log("ìë™ ì €ì¥ ì™„ë£Œ (ì¡°ìš©í•¨)");
    });
};


</script>
</body>
</html>